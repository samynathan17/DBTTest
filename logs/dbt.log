2021-05-14 01:51:17.409295 (Thread-167): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3469a42190>]}
2021-05-14 01:51:17.425041 (Thread-168): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464fad1c0>]}
2021-05-14 01:51:17.476303 (Thread-167): sending response (<Response 184 bytes [200 OK]>) to 10.0.7.15
2021-05-14 01:51:17.477122 (Thread-168): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.158
2021-05-14 01:51:17.528847 (Thread-165): Acquiring new snowflake connection "model.DBTTest.HS_SF".
2021-05-14 01:51:18.949332 (Thread-169): handling status request
2021-05-14 01:51:18.949925 (Thread-169): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464045490>]}
2021-05-14 01:51:18.950632 (Thread-169): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.159
2021-05-14 01:51:19.005001 (Thread-170): handling status request
2021-05-14 01:51:19.009595 (Thread-170): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34563c8be0>]}
2021-05-14 01:51:19.010326 (Thread-170): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.254
2021-05-14 01:51:19.243026 (Thread-171): handling status request
2021-05-14 01:51:19.254157 (Thread-171): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464b555b0>]}
2021-05-14 01:51:19.254912 (Thread-171): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.159
2021-05-14 01:51:19.590115 (Thread-165): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-14 01:51:19.590278 (Thread-165): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-14 01:51:19.590345 (Thread-165): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-14 01:51:19.590400 (Thread-165): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-14 01:51:19.590451 (Thread-165): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-14 01:51:19.591253 (Thread-165): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-14 01:51:19.591594 (Thread-165): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-14 01:51:19.591918 (Thread-165): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-14 01:51:19.592191 (Thread-165): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-14 01:51:19.592461 (Thread-165): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-14 01:51:19.592730 (Thread-165): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-14 01:51:19.593015 (Thread-165): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-14 01:51:19.593294 (Thread-165): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-14 01:51:19.944405 (Thread-165): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.Views
- models.DBTTest.Targets
- models.DBTTest.Stage_Layer
- models.DBTTest.utils
- seeds.DBTTest

2021-05-14 01:51:20.449852 (Thread-172): handling status request
2021-05-14 01:51:20.450299 (Thread-172): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464831f40>]}
2021-05-14 01:51:20.452259 (Thread-172): sending response (<Response 6248 bytes [200 OK]>) to 10.0.40.40
2021-05-14 01:51:20.470776 (Thread-173): handling status request
2021-05-14 01:51:20.471176 (Thread-173): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464831280>]}
2021-05-14 01:51:20.473154 (Thread-173): sending response (<Response 6248 bytes [200 OK]>) to 10.0.16.40
2021-05-14 01:51:21.640177 (Thread-174): handling status request
2021-05-14 01:51:21.640618 (Thread-174): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464831dc0>]}
2021-05-14 01:51:21.642618 (Thread-174): sending response (<Response 6248 bytes [200 OK]>) to 10.0.0.70
2021-05-14 01:51:39.668190 (MainThread): Connection 'model.DBTTest.HS_SF' was properly closed.
2021-05-14 01:51:40.635307 (Thread-176): handling status request
2021-05-14 01:51:40.635769 (Thread-176): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464e4d670>]}
2021-05-14 01:51:40.636538 (Thread-176): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.254
2021-05-14 01:51:40.641013 (Thread-177): handling status request
2021-05-14 01:51:40.641329 (Thread-177): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f346480b3d0>]}
2021-05-14 01:51:40.641986 (Thread-177): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.40
2021-05-14 01:51:40.668069 (Thread-178): handling status request
2021-05-14 01:51:40.668590 (Thread-178): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3465030790>]}
2021-05-14 01:51:40.669335 (Thread-178): sending response (<Response 184 bytes [200 OK]>) to 10.0.1.54
2021-05-14 01:51:40.691550 (Thread-175): Got an acceptable cached parse result
2021-05-14 01:51:40.811643 (Thread-175): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-14 01:51:42.162423 (Thread-179): handling status request
2021-05-14 01:51:42.168108 (Thread-179): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f345614b580>]}
2021-05-14 01:51:42.169208 (Thread-179): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.158
2021-05-14 01:51:42.175999 (Thread-180): handling status request
2021-05-14 01:51:42.186266 (Thread-180): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f345755e4c0>]}
2021-05-14 01:51:42.187411 (Thread-180): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.181
2021-05-14 01:51:42.239107 (Thread-181): handling status request
2021-05-14 01:51:42.245899 (Thread-181): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34562ecb80>]}
2021-05-14 01:51:42.246624 (Thread-181): sending response (<Response 184 bytes [200 OK]>) to 10.0.6.48
2021-05-14 01:51:42.797616 (Thread-175): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-14 01:51:42.797785 (Thread-175): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-14 01:51:42.797848 (Thread-175): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-14 01:51:42.797903 (Thread-175): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-14 01:51:42.797954 (Thread-175): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-14 01:51:42.798793 (Thread-175): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-14 01:51:42.799130 (Thread-175): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-14 01:51:42.799409 (Thread-175): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-14 01:51:42.799660 (Thread-175): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-14 01:51:42.799911 (Thread-175): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-14 01:51:42.800151 (Thread-175): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-14 01:51:42.800385 (Thread-175): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-14 01:51:42.800618 (Thread-175): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-14 01:51:43.125960 (Thread-175): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.Views
- models.DBTTest.Targets
- models.DBTTest.Stage_Layer
- models.DBTTest.utils
- seeds.DBTTest

2021-05-14 01:51:43.744566 (Thread-182): handling status request
2021-05-14 01:51:43.745033 (Thread-182): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464fd5e20>]}
2021-05-14 01:51:43.747062 (Thread-182): sending response (<Response 6258 bytes [200 OK]>) to 10.0.1.71
2021-05-14 01:51:43.759276 (Thread-183): handling status request
2021-05-14 01:51:43.759621 (Thread-183): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464c3eb20>]}
2021-05-14 01:51:43.761555 (Thread-183): sending response (<Response 6258 bytes [200 OK]>) to 10.0.43.109
2021-05-14 01:51:43.778924 (Thread-184): handling status request
2021-05-14 01:51:43.779304 (Thread-184): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464c3e790>]}
2021-05-14 01:51:43.895981 (Thread-184): sending response (<Response 6258 bytes [200 OK]>) to 10.0.16.40
2021-05-14 01:52:53.224622 (Thread-185): handling status request
2021-05-14 01:52:53.227769 (Thread-185): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464992280>]}
2021-05-14 01:52:53.229764 (Thread-185): sending response (<Response 6258 bytes [200 OK]>) to 10.0.18.219
2021-05-14 01:52:54.084053 (Thread-186): handling run_sql request
2021-05-14 01:52:54.084491 (Thread-186): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464c3edc0>]}
2021-05-14 01:52:54.085744 (Thread-186): Connection 'model.DBTTest.SF_HF_segmented' was properly closed.
2021-05-14 01:52:55.165150 (Thread-186): sending response (<Response 137 bytes [200 OK]>) to 10.0.1.54
2021-05-14 01:52:55.188272 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 01:52:55.214214 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 01:52:55.214747 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 01:52:55.214865 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 01:52:55.228793 (Thread-1): finished collecting timing info
2021-05-14 01:52:55.237524 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 01:52:55.237623 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where f_types_timeframe='Q'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 01:52:55.237684 (Thread-1): Opening a new connection, currently in state init
2021-05-14 01:52:55.728097 (Thread-187): handling poll request
2021-05-14 01:52:55.728582 (Thread-187): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464f188b0>]}
2021-05-14 01:52:55.730930 (Thread-187): sending response (<Response 14160 bytes [200 OK]>) to 10.0.0.70
2021-05-14 01:52:57.280850 (Thread-188): handling poll request
2021-05-14 01:52:57.281321 (Thread-188): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464f748b0>]}
2021-05-14 01:52:57.282227 (Thread-188): sending response (<Response 398 bytes [200 OK]>) to 10.0.32.149
2021-05-14 01:52:58.491709 (Thread-1): SQL status: SUCCESS 0 in 3.25 seconds
2021-05-14 01:52:58.492139 (Thread-1): finished collecting timing info
2021-05-14 01:52:58.492519 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 01:52:58.825494 (Thread-189): handling poll request
2021-05-14 01:52:58.825942 (Thread-189): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464f744f0>]}
2021-05-14 01:52:58.830254 (Thread-189): sending response (<Response 59784 bytes [200 OK]>) to 10.0.42.245
2021-05-14 01:53:12.895436 (Thread-190): handling status request
2021-05-14 01:53:12.898112 (Thread-190): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464f74a00>]}
2021-05-14 01:53:12.900326 (Thread-190): sending response (<Response 6258 bytes [200 OK]>) to 10.0.1.71
2021-05-14 01:53:13.796379 (Thread-191): handling run_sql request
2021-05-14 01:53:13.796831 (Thread-191): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464f741c0>]}
2021-05-14 01:53:14.871709 (Thread-191): sending response (<Response 137 bytes [200 OK]>) to 10.0.34.159
2021-05-14 01:53:14.894946 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 01:53:14.917847 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 01:53:14.918370 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 01:53:14.918488 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 01:53:14.932489 (Thread-1): finished collecting timing info
2021-05-14 01:53:14.941326 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 01:53:14.941434 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where f_types_timeframe='M'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 01:53:14.941498 (Thread-1): Opening a new connection, currently in state init
2021-05-14 01:53:15.428166 (Thread-192): handling poll request
2021-05-14 01:53:15.429430 (Thread-192): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464b2f820>]}
2021-05-14 01:53:15.431618 (Thread-192): sending response (<Response 14160 bytes [200 OK]>) to 10.0.32.149
2021-05-14 01:53:16.905999 (Thread-193): handling poll request
2021-05-14 01:53:16.906440 (Thread-193): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464f74250>]}
2021-05-14 01:53:16.907340 (Thread-193): sending response (<Response 398 bytes [200 OK]>) to 10.0.0.70
2021-05-14 01:53:18.382797 (Thread-1): SQL status: SUCCESS 0 in 3.44 seconds
2021-05-14 01:53:18.383239 (Thread-1): finished collecting timing info
2021-05-14 01:53:18.383604 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 01:53:18.450150 (Thread-194): handling poll request
2021-05-14 01:53:18.450633 (Thread-194): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464f18400>]}
2021-05-14 01:53:18.452010 (Thread-194): sending response (<Response 1336 bytes [200 OK]>) to 10.0.4.158
2021-05-14 01:53:20.017518 (Thread-195): handling poll request
2021-05-14 01:53:20.017989 (Thread-195): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464992dc0>]}
2021-05-14 01:53:20.021937 (Thread-195): sending response (<Response 58846 bytes [200 OK]>) to 10.0.6.48
2021-05-14 01:53:44.823950 (Thread-196): handling status request
2021-05-14 01:53:44.824400 (Thread-196): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3456326c10>]}
2021-05-14 01:53:44.826665 (Thread-196): sending response (<Response 6258 bytes [200 OK]>) to 10.0.1.54
2021-05-14 01:53:45.703474 (Thread-197): handling run_sql request
2021-05-14 01:53:45.703930 (Thread-197): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464ae8040>]}
2021-05-14 01:53:46.798939 (Thread-197): sending response (<Response 137 bytes [200 OK]>) to 10.0.17.254
2021-05-14 01:53:46.823201 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 01:53:46.846532 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 01:53:46.847062 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 01:53:46.847175 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 01:53:46.861654 (Thread-1): finished collecting timing info
2021-05-14 01:53:46.870754 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 01:53:46.870846 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='M'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 01:53:46.870922 (Thread-1): Opening a new connection, currently in state init
2021-05-14 01:53:47.328718 (Thread-198): handling poll request
2021-05-14 01:53:47.329248 (Thread-198): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464c02bb0>]}
2021-05-14 01:53:47.331451 (Thread-198): sending response (<Response 14159 bytes [200 OK]>) to 10.0.18.219
2021-05-14 01:53:48.859356 (Thread-199): handling poll request
2021-05-14 01:53:48.859792 (Thread-199): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464c02d00>]}
2021-05-14 01:53:48.860687 (Thread-199): sending response (<Response 398 bytes [200 OK]>) to 10.0.6.48
2021-05-14 01:53:50.422110 (Thread-200): handling poll request
2021-05-14 01:53:50.422549 (Thread-200): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464c02670>]}
2021-05-14 01:53:50.423439 (Thread-200): sending response (<Response 398 bytes [200 OK]>) to 10.0.17.254
2021-05-14 01:53:51.925654 (Thread-201): handling poll request
2021-05-14 01:53:51.926173 (Thread-201): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34564bbcd0>]}
2021-05-14 01:53:51.927127 (Thread-201): sending response (<Response 398 bytes [200 OK]>) to 10.0.31.167
2021-05-14 01:53:53.411459 (Thread-202): handling poll request
2021-05-14 01:53:53.411919 (Thread-202): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464c02ac0>]}
2021-05-14 01:53:53.412811 (Thread-202): sending response (<Response 398 bytes [200 OK]>) to 10.0.31.167
2021-05-14 01:53:55.066343 (Thread-1): SQL status: SUCCESS 500 in 8.20 seconds
2021-05-14 01:53:55.089306 (Thread-1): finished collecting timing info
2021-05-14 01:53:55.089764 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 01:53:55.481969 (Thread-203): handling poll request
2021-05-14 01:53:55.482416 (Thread-203): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34565379a0>]}
2021-05-14 01:53:55.491701 (Thread-203): sending response (<Response 150704 bytes [200 OK]>) to 10.0.36.181
2021-05-14 01:54:12.017067 (Thread-204): handling status request
2021-05-14 01:54:12.019317 (Thread-204): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3456537910>]}
2021-05-14 01:54:12.021476 (Thread-204): sending response (<Response 6258 bytes [200 OK]>) to 10.0.16.40
2021-05-14 01:54:12.763801 (Thread-205): handling run_sql request
2021-05-14 01:54:12.764253 (Thread-205): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3456537a30>]}
2021-05-14 01:54:13.840209 (Thread-205): sending response (<Response 137 bytes [200 OK]>) to 10.0.29.105
2021-05-14 01:54:13.863436 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 01:54:13.890598 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 01:54:13.891184 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 01:54:13.891302 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 01:54:13.905784 (Thread-1): finished collecting timing info
2021-05-14 01:54:13.914472 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 01:54:13.914595 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Q'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 01:54:13.914661 (Thread-1): Opening a new connection, currently in state init
2021-05-14 01:54:14.394175 (Thread-206): handling poll request
2021-05-14 01:54:14.394648 (Thread-206): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566ec9a0>]}
2021-05-14 01:54:14.396842 (Thread-206): sending response (<Response 14159 bytes [200 OK]>) to 10.0.16.40
2021-05-14 01:54:15.991523 (Thread-207): handling poll request
2021-05-14 01:54:15.991968 (Thread-207): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566ecc10>]}
2021-05-14 01:54:15.992848 (Thread-207): sending response (<Response 398 bytes [200 OK]>) to 10.0.7.15
2021-05-14 01:54:17.556598 (Thread-208): handling poll request
2021-05-14 01:54:17.557085 (Thread-208): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566ecfa0>]}
2021-05-14 01:54:17.557982 (Thread-208): sending response (<Response 398 bytes [200 OK]>) to 10.0.4.158
2021-05-14 01:54:19.068608 (Thread-209): handling poll request
2021-05-14 01:54:19.069081 (Thread-209): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566ec610>]}
2021-05-14 01:54:19.069994 (Thread-209): sending response (<Response 398 bytes [200 OK]>) to 10.0.29.105
2021-05-14 01:54:20.546008 (Thread-210): handling poll request
2021-05-14 01:54:20.546457 (Thread-210): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566ec1f0>]}
2021-05-14 01:54:20.547345 (Thread-210): sending response (<Response 398 bytes [200 OK]>) to 10.0.34.159
2021-05-14 01:54:20.845331 (Thread-1): SQL status: SUCCESS 500 in 6.93 seconds
2021-05-14 01:54:20.867893 (Thread-1): finished collecting timing info
2021-05-14 01:54:20.868342 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 01:54:21.988797 (Thread-211): handling poll request
2021-05-14 01:54:21.989257 (Thread-211): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566e4940>]}
2021-05-14 01:54:21.999256 (Thread-211): sending response (<Response 147862 bytes [200 OK]>) to 10.0.16.40
2021-05-14 01:54:38.557681 (Thread-213): handling status request
2021-05-14 01:54:38.558150 (Thread-213): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34560c1130>]}
2021-05-14 01:54:38.558928 (Thread-213): sending response (<Response 184 bytes [200 OK]>) to 10.0.1.71
2021-05-14 01:54:38.752762 (Thread-214): handling status request
2021-05-14 01:54:38.753518 (Thread-215): handling status request
2021-05-14 01:54:38.753993 (Thread-214): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3455f1fe20>]}
2021-05-14 01:54:38.775509 (Thread-215): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3464f570d0>]}
2021-05-14 01:54:38.776307 (Thread-214): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.254
2021-05-14 01:54:38.780838 (Thread-212): Got an acceptable cached parse result
2021-05-14 01:54:38.930471 (Thread-215): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.159
2021-05-14 01:54:38.985640 (Thread-212): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-14 01:54:40.107595 (Thread-216): handling status request
2021-05-14 01:54:40.108078 (Thread-216): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3456764130>]}
2021-05-14 01:54:40.108820 (Thread-216): sending response (<Response 184 bytes [200 OK]>) to 10.0.18.219
2021-05-14 01:54:40.377835 (Thread-217): handling status request
2021-05-14 01:54:40.391129 (Thread-217): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3456fba160>]}
2021-05-14 01:54:40.391854 (Thread-217): sending response (<Response 184 bytes [200 OK]>) to 10.0.29.105
2021-05-14 01:54:40.414220 (Thread-218): handling status request
2021-05-14 01:54:40.414593 (Thread-218): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3456fba970>]}
2021-05-14 01:54:40.415257 (Thread-218): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.158
2021-05-14 01:54:41.006817 (Thread-212): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-14 01:54:41.006981 (Thread-212): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-14 01:54:41.007044 (Thread-212): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-14 01:54:41.007099 (Thread-212): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-14 01:54:41.007151 (Thread-212): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-14 01:54:41.007972 (Thread-212): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-14 01:54:41.008322 (Thread-212): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-14 01:54:41.008694 (Thread-212): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-14 01:54:41.009001 (Thread-212): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-14 01:54:41.009289 (Thread-212): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-14 01:54:41.009552 (Thread-212): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-14 01:54:41.009813 (Thread-212): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-14 01:54:41.010081 (Thread-212): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-14 01:54:41.349847 (Thread-212): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.Views
- models.DBTTest.Targets
- models.DBTTest.Stage_Layer
- models.DBTTest.utils
- seeds.DBTTest

2021-05-14 01:54:41.627759 (Thread-219): handling status request
2021-05-14 01:54:41.628213 (Thread-219): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566b3bb0>]}
2021-05-14 01:54:41.630274 (Thread-219): sending response (<Response 6258 bytes [200 OK]>) to 10.0.4.158
2021-05-14 01:54:41.841738 (Thread-220): handling status request
2021-05-14 01:54:41.842183 (Thread-220): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566b3430>]}
2021-05-14 01:54:41.844137 (Thread-220): sending response (<Response 6258 bytes [200 OK]>) to 10.0.29.105
2021-05-14 01:54:41.845766 (Thread-221): handling status request
2021-05-14 01:54:41.846070 (Thread-221): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566b3dc0>]}
2021-05-14 01:54:41.847856 (Thread-221): sending response (<Response 6258 bytes [200 OK]>) to 10.0.31.167
2021-05-14 03:01:31.684445 (Thread-222): handling status request
2021-05-14 03:01:31.686471 (Thread-222): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566b35b0>]}
2021-05-14 03:01:31.688406 (Thread-222): sending response (<Response 6258 bytes [200 OK]>) to 10.0.36.181
2021-05-14 03:01:32.213674 (Thread-223): handling run_sql request
2021-05-14 03:01:32.214114 (Thread-223): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566b45e0>]}
2021-05-14 03:01:32.215304 (Thread-223): Connection 'model.DBTTest.SF_HF_segmented' was properly closed.
2021-05-14 03:01:33.339361 (Thread-223): sending response (<Response 137 bytes [200 OK]>) to 10.0.7.15
2021-05-14 03:01:33.367197 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 03:01:33.395798 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 03:01:33.396426 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 03:01:33.396553 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 03:01:33.415454 (Thread-1): finished collecting timing info
2021-05-14 03:01:33.421055 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 03:01:33.421208 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    --- SF -fact  oppor_won-1
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,timeframe  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 03:01:33.421307 (Thread-1): Opening a new connection, currently in state init
2021-05-14 03:01:33.964859 (Thread-224): handling poll request
2021-05-14 03:01:33.965352 (Thread-224): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566e5e20>]}
2021-05-14 03:01:33.967564 (Thread-224): sending response (<Response 6776 bytes [200 OK]>) to 10.0.31.167
2021-05-14 03:01:35.525152 (Thread-225): handling poll request
2021-05-14 03:01:35.525780 (Thread-225): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34566e5760>]}
2021-05-14 03:01:35.527142 (Thread-225): sending response (<Response 399 bytes [200 OK]>) to 10.0.17.254
2021-05-14 03:01:35.717592 (Thread-1): SQL status: SUCCESS 6 in 2.30 seconds
2021-05-14 03:01:35.719627 (Thread-1): finished collecting timing info
2021-05-14 03:01:35.720021 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 03:01:37.073693 (Thread-226): handling poll request
2021-05-14 03:01:37.074146 (Thread-226): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '315c2085-1982-4a06-98db-29be900387c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3456694d90>]}
2021-05-14 03:01:37.079120 (Thread-226): sending response (<Response 23713 bytes [200 OK]>) to 10.0.23.5
2021-05-14 11:02:20.014490 (MainThread): Running with dbt=0.18.1
2021-05-14 11:02:20.396201 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-14 11:02:20.417110 (MainThread): Tracking: tracking
2021-05-14 11:02:20.417448 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f268ac83eb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2687d739a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680676550>]}
2021-05-14 11:02:20.417992 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-14 11:02:20.418539 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-14 11:02:20.427213 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-14 11:02:20.773874 (Thread-2): handling status request
2021-05-14 11:02:20.778433 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26806af7c0>]}
2021-05-14 11:02:20.781191 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.6.48
2021-05-14 11:02:21.328087 (Thread-1): Parsing macros/metrics.sql
2021-05-14 11:02:21.356095 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-14 11:02:21.361906 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-14 11:02:21.369102 (Thread-1): Parsing macros/adapters.sql
2021-05-14 11:02:21.421093 (Thread-1): Parsing macros/catalog.sql
2021-05-14 11:02:21.424691 (Thread-1): Parsing macros/materializations/table.sql
2021-05-14 11:02:21.432296 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-14 11:02:21.437915 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-14 11:02:21.454089 (Thread-1): Parsing macros/materializations/view.sql
2021-05-14 11:02:21.457967 (Thread-1): Parsing macros/core.sql
2021-05-14 11:02:21.464016 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-14 11:02:21.473520 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-14 11:02:21.492108 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-14 11:02:21.494110 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-14 11:02:21.512345 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-14 11:02:21.543040 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-14 11:02:21.548480 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-14 11:02:21.554906 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-14 11:02:21.576918 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-14 11:02:21.583762 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-14 11:02:21.585772 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-14 11:02:21.592125 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-14 11:02:21.593871 (Thread-1): Parsing macros/etc/query.sql
2021-05-14 11:02:21.594954 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-14 11:02:21.603881 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-14 11:02:21.604872 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-14 11:02:21.606548 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-14 11:02:21.608574 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-14 11:02:21.610083 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-14 11:02:21.612748 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-14 11:02:21.614647 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-14 11:02:21.616572 (Thread-1): Parsing macros/adapters/common.sql
2021-05-14 11:02:21.669744 (Thread-1): Parsing macros/staging_columns.sql
2021-05-14 11:02:21.694469 (Thread-1): Parsing macros/staging_columns.sql
2021-05-14 11:02:21.770672 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-14 11:02:21.776346 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-14 11:02:21.781205 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-14 11:02:21.786172 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-14 11:02:21.794219 (Thread-1): Parsing macros/sql/star.sql
2021-05-14 11:02:21.802915 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-14 11:02:21.810083 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-14 11:02:21.817133 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-14 11:02:21.825345 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-14 11:02:21.829899 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-14 11:02:21.843744 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-14 11:02:21.850932 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-14 11:02:21.857762 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-14 11:02:21.864839 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-14 11:02:21.872365 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-14 11:02:21.877013 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-14 11:02:21.888508 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-14 11:02:21.898396 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-14 11:02:21.903626 (Thread-1): Parsing macros/sql/union.sql
2021-05-14 11:02:21.917566 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-14 11:02:21.964128 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-14 11:02:21.969724 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-14 11:02:21.977670 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-14 11:02:21.987175 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-14 11:02:22.006110 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-14 11:02:22.012832 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-14 11:02:22.018595 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-14 11:02:22.024710 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-14 11:02:22.034904 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-14 11:02:22.041411 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-14 11:02:22.048764 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-14 11:02:22.055760 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-14 11:02:22.069919 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-14 11:02:22.077291 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-14 11:02:22.085447 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-14 11:02:22.091037 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-14 11:02:22.097032 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-14 11:02:22.101949 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-14 11:02:22.108716 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-14 11:02:22.114866 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-14 11:02:22.124137 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-14 11:02:22.128988 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-14 11:02:22.136600 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-14 11:02:22.142234 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-14 11:02:22.147920 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-14 11:02:22.154258 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-14 11:02:22.159386 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-14 11:02:22.164920 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-14 11:02:22.186304 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-14 11:02:22.195185 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-14 11:02:22.210637 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-14 11:02:22.217535 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-14 11:02:22.222764 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-14 11:02:22.230018 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-14 11:02:22.243432 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-14 11:02:22.252149 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-14 11:02:22.257524 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-14 11:02:22.264959 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-14 11:02:22.272595 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-14 11:02:22.281719 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-14 11:02:22.289982 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-14 11:02:22.304823 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-14 11:02:22.329165 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-14 11:02:22.356719 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-14 11:02:22.368518 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-14 11:02:22.379089 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-14 11:02:22.386424 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-14 11:02:22.402507 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-14 11:02:22.411857 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-14 11:02:22.423249 (Thread-3): handling status request
2021-05-14 11:02:22.423587 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-14 11:02:22.424113 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680550b50>]}
2021-05-14 11:02:22.433922 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.16.40
2021-05-14 11:02:22.438380 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-14 11:02:22.473429 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-14 11:02:22.504184 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-14 11:02:22.514844 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-14 11:02:22.531030 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-14 11:02:22.564673 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-14 11:02:22.587886 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-14 11:02:22.594254 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-14 11:02:22.598099 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-14 11:02:22.602712 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-14 11:02:22.605491 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-14 11:02:22.609372 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-14 11:02:22.614303 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-14 11:02:22.617156 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-14 11:02:22.621025 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-14 11:02:22.623911 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-14 11:02:22.626353 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-14 11:02:22.630380 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-14 11:02:22.633182 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-14 11:02:22.639738 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-14 11:02:22.642818 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-14 11:02:22.646004 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-14 11:02:22.648803 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-14 11:02:22.651604 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-14 11:02:22.654600 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-14 11:02:22.657578 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-14 11:02:22.660289 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-14 11:02:22.665170 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-14 11:02:22.676870 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-14 11:02:22.682523 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-14 11:02:22.691226 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-14 11:02:22.695894 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-14 11:02:22.700014 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-14 11:02:22.706182 (Thread-1): Parsing macros/first_value.sql
2021-05-14 11:02:22.712701 (Thread-1): Parsing macros/json_extract.sql
2021-05-14 11:02:22.719173 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-14 11:02:22.868584 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-14 11:02:22.887036 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-14 11:02:22.895863 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-14 11:02:22.903488 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-14 11:02:22.908159 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-14 11:02:22.919585 (Thread-1): Parsing macros/percentile.sql
2021-05-14 11:02:22.926285 (Thread-1): Parsing macros/ceiling.sql
2021-05-14 11:02:22.932768 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-14 11:02:22.944082 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-14 11:02:22.950263 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-14 11:02:22.958340 (Thread-1): Parsing macros/string_agg.sql
2021-05-14 11:02:22.964802 (Thread-1): Parsing macros/array_agg.sql
2021-05-14 11:02:22.971835 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-14 11:02:22.979073 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-14 11:02:22.987477 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-14 11:02:22.992403 (Thread-1): Parsing macros/union_relations.sql
2021-05-14 11:02:23.013149 (Thread-1): Parsing macros/max_bool.sql
2021-05-14 11:02:23.149278 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_opportunity".
2021-05-14 11:02:23.181760 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_opportunity model triggered this warning. 
2021-05-14 11:02:23.243954 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_account".
2021-05-14 11:02:23.253804 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_account model triggered this warning. 
2021-05-14 11:02:23.278058 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_product".
2021-05-14 11:02:23.284643 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_product model triggered this warning. 
2021-05-14 11:02:23.299033 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_contacts".
2021-05-14 11:02:23.307598 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_contacts model triggered this warning. 
2021-05-14 11:02:23.322607 (Thread-1): Acquiring new snowflake connection "model.DBTTest.test".
2021-05-14 11:02:23.344880 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_address".
2021-05-14 11:02:23.364201 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_lead".
2021-05-14 11:02:23.374361 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_lead model triggered this warning. 
2021-05-14 11:02:23.392241 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_campaign".
2021-05-14 11:02:23.400872 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_campaign model triggered this warning. 
2021-05-14 11:02:23.416106 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_employee".
2021-05-14 11:02:23.422644 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_employee model triggered this warning. 
2021-05-14 11:02:23.436190 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_OpportunityStages".
2021-05-14 11:02:23.443590 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_OpportunityStages model triggered this warning. 
2021-05-14 11:02:23.462296 (Thread-1): Acquiring new snowflake connection "model.DBTTest.lead".
2021-05-14 11:02:23.483369 (Thread-1): Acquiring new snowflake connection "model.DBTTest.opportunity_history".
2021-05-14 11:02:23.503427 (Thread-1): Acquiring new snowflake connection "model.DBTTest.contact".
2021-05-14 11:02:23.522272 (Thread-1): Acquiring new snowflake connection "model.DBTTest.CAMPAIGN".
2021-05-14 11:02:23.537863 (Thread-1): Acquiring new snowflake connection "model.DBTTest.OPPORTUNITY_STAGE".
2021-05-14 11:02:23.556824 (Thread-1): Acquiring new snowflake connection "model.DBTTest.user_role".
2021-05-14 11:02:23.575756 (Thread-1): Acquiring new snowflake connection "model.DBTTest.period".
2021-05-14 11:02:23.593679 (Thread-1): Acquiring new snowflake connection "model.DBTTest.user".
2021-05-14 11:02:23.616227 (Thread-1): Acquiring new snowflake connection "model.DBTTest.account".
2021-05-14 11:02:23.641810 (Thread-1): Acquiring new snowflake connection "model.DBTTest.opportunity".
2021-05-14 11:02:23.665932 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-14 11:02:23.690883 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-14 11:02:23.717519 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-14 11:02:23.741001 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-14 11:02:23.766797 (Thread-1): Acquiring new snowflake connection "model.DBTTest.opportunity_dim".
2021-05-14 11:02:23.797996 (Thread-1): Acquiring new snowflake connection "model.DBTTest.dim_oppo_stage_calc".
2021-05-14 11:02:23.808197 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.dim_oppo_stage_calc model triggered this warning. 
2021-05-14 11:02:23.828282 (Thread-1): Acquiring new snowflake connection "model.DBTTest.lead_dim".
2021-05-14 11:02:23.851854 (Thread-1): Acquiring new snowflake connection "model.DBTTest.employee_dim".
2021-05-14 11:02:23.877685 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF".
2021-05-14 11:02:23.894309 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Dim_timeframe".
2021-05-14 11:02:23.913298 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-14 11:02:23.942779 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-14 11:02:24.007527 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-14 11:02:24.026449 (Thread-4): handling status request
2021-05-14 11:02:24.027027 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f268022bac0>]}
2021-05-14 11:02:24.027757 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.40
2021-05-14 11:02:24.664447 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-14 11:02:24.726024 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-14 11:02:24.830281 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-14 11:02:24.867474 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-14 11:02:24.885498 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-14 11:02:24.902414 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-14 11:02:25.303427 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-14 11:02:25.327623 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-14 11:02:25.356488 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-14 11:02:25.480877 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-14 11:02:25.497773 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-14 11:02:25.651771 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-14 11:02:25.673036 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-14 11:02:25.694951 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-14 11:02:25.721257 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-14 11:02:25.744889 (Thread-5): handling status request
2021-05-14 11:02:25.746925 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-14 11:02:25.747576 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680104760>]}
2021-05-14 11:02:25.759068 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.7.15
2021-05-14 11:02:25.770705 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-14 11:02:25.790206 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-14 11:02:25.812329 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-14 11:02:25.830891 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-14 11:02:25.853874 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-14 11:02:25.873768 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-14 11:02:25.907337 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-14 11:02:25.935108 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-14 11:02:25.960881 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-14 11:02:25.985337 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-14 11:02:26.011208 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-14 11:02:26.040483 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-14 11:02:26.312856 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-14 11:02:26.349303 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-14 11:02:26.394190 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-14 11:02:26.445619 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-14 11:02:26.480707 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-14 11:02:26.523644 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-14 11:02:26.568090 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-14 11:02:26.591077 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-14 11:02:26.618032 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-14 11:02:26.655766 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-14 11:02:26.679169 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-14 11:02:26.711014 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-14 11:02:27.221158 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-14 11:02:27.253939 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-14 11:02:27.298769 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-14 11:02:27.427603 (Thread-6): handling status request
2021-05-14 11:02:27.457151 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26800b82b0>]}
2021-05-14 11:02:27.463345 (Thread-6): sending response (<Response 184 bytes [200 OK]>) to 10.0.1.54
2021-05-14 11:02:27.974590 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-14 11:02:28.002995 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-14 11:02:28.026800 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-14 11:02:28.058824 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-14 11:02:28.375860 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-14 11:02:28.434952 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-14 11:02:28.475711 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-14 11:02:28.521881 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-14 11:02:28.607815 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-14 11:02:28.706102 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-14 11:02:28.723402 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-14 11:02:28.742595 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-14 11:02:28.768158 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-14 11:02:28.793098 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-14 11:02:29.746949 (Thread-7): handling status request
2021-05-14 11:02:29.747499 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680473310>]}
2021-05-14 11:02:29.748413 (Thread-7): sending response (<Response 184 bytes [200 OK]>) to 10.0.43.109
2021-05-14 11:02:29.758485 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-14 11:02:29.785647 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-14 11:02:29.811478 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-14 11:02:29.837531 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-14 11:02:29.906437 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-14 11:02:29.934442 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-14 11:02:29.961511 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-14 11:02:30.082843 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-14 11:02:30.106115 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-14 11:02:30.138474 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-14 11:02:30.165665 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-14 11:02:30.193207 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-14 11:02:30.211402 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-14 11:02:30.572585 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-14 11:02:30.598135 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-14 11:02:30.643794 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-14 11:02:30.693114 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-14 11:02:30.722208 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-14 11:02:30.748993 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-14 11:02:30.776917 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-14 11:02:30.804488 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-14 11:02:31.273182 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-14 11:02:31.462500 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-14 11:02:31.480160 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-14 11:02:31.520330 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-14 11:02:31.544972 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-14 11:02:31.701953 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-14 11:02:31.728175 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-14 11:02:31.763377 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-14 11:02:31.826666 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-14 11:02:31.880616 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-14 11:02:31.931990 (Thread-8): handling status request
2021-05-14 11:02:31.932388 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7e0850>]}
2021-05-14 11:02:31.933114 (Thread-8): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.254
2021-05-14 11:02:31.938248 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-14 11:02:31.978161 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-14 11:02:32.007019 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-14 11:02:32.028326 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-14 11:02:32.049080 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-14 11:02:32.075049 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-14 11:02:32.102429 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-14 11:02:32.413335 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-14 11:02:32.439833 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-14 11:02:32.464358 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-14 11:02:32.492721 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-14 11:02:32.513598 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-14 11:02:33.146703 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-14 11:02:33.171556 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-14 11:02:33.208557 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-14 11:02:33.232723 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-14 11:02:33.390291 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-14 11:02:33.440994 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-14 11:02:33.469075 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-14 11:02:33.530644 (Thread-9): handling status request
2021-05-14 11:02:33.546706 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b4603a0>]}
2021-05-14 11:02:33.563328 (Thread-9): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.159
2021-05-14 11:02:33.855088 (Thread-1): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-14 11:02:33.855301 (Thread-1): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-14 11:02:33.855409 (Thread-1): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-14 11:02:33.855495 (Thread-1): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-14 11:02:33.855576 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-14 11:02:33.857022 (Thread-1): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-14 11:02:33.857519 (Thread-1): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-14 11:02:33.857966 (Thread-1): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-14 11:02:33.858371 (Thread-1): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-14 11:02:33.858769 (Thread-1): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-14 11:02:33.859165 (Thread-1): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-14 11:02:33.859545 (Thread-1): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-14 11:02:33.859932 (Thread-1): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-14 11:02:34.258357 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.Stage_Layer
- models.DBTTest.Views
- models.DBTTest.utils
- models.DBTTest.Targets
- seeds.DBTTest

2021-05-14 11:02:35.176367 (Thread-10): handling status request
2021-05-14 11:02:35.178626 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b6210a0>]}
2021-05-14 11:02:35.203320 (Thread-10): sending response (<Response 97516 bytes [200 OK]>) to 10.0.40.40
2021-05-14 11:04:06.050348 (Thread-11): handling status request
2021-05-14 11:04:06.052521 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b621070>]}
2021-05-14 11:04:06.077165 (Thread-11): sending response (<Response 97516 bytes [200 OK]>) to 10.0.36.181
2021-05-14 11:04:07.005323 (Thread-12): handling run_sql request
2021-05-14 11:04:07.005909 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b621280>]}
2021-05-14 11:04:07.009652 (Thread-12): Connection 'model.dbt_date.dates' was properly closed.
2021-05-14 11:04:08.200459 (Thread-12): sending response (<Response 137 bytes [200 OK]>) to 10.0.23.5
2021-05-14 11:04:08.226929 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 11:04:08.254176 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 11:04:08.254695 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 11:04:08.254812 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 11:04:08.269293 (Thread-1): finished collecting timing info
2021-05-14 11:04:08.278926 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 11:04:08.279066 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Q' and f_metric_id='1'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 11:04:08.279130 (Thread-1): Opening a new connection, currently in state init
2021-05-14 11:04:08.730530 (Thread-13): handling poll request
2021-05-14 11:04:08.731125 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b648f40>]}
2021-05-14 11:04:08.735501 (Thread-13): sending response (<Response 15769 bytes [200 OK]>) to 10.0.36.181
2021-05-14 11:04:10.246955 (Thread-14): handling poll request
2021-05-14 11:04:10.247565 (Thread-14): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b648640>]}
2021-05-14 11:04:10.248606 (Thread-14): sending response (<Response 388 bytes [200 OK]>) to 10.0.43.109
2021-05-14 11:04:11.688389 (Thread-15): handling poll request
2021-05-14 11:04:11.688993 (Thread-15): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804d6d00>]}
2021-05-14 11:04:11.690085 (Thread-15): sending response (<Response 388 bytes [200 OK]>) to 10.0.31.167
2021-05-14 11:04:13.634251 (Thread-16): handling poll request
2021-05-14 11:04:13.634692 (Thread-16): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804b3700>]}
2021-05-14 11:04:13.635630 (Thread-16): sending response (<Response 388 bytes [200 OK]>) to 10.0.6.48
2021-05-14 11:04:15.088247 (Thread-17): handling poll request
2021-05-14 11:04:15.088776 (Thread-17): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804b3e50>]}
2021-05-14 11:04:15.089880 (Thread-17): sending response (<Response 388 bytes [200 OK]>) to 10.0.6.48
2021-05-14 11:04:15.988304 (Thread-1): SQL status: SUCCESS 13 in 7.71 seconds
2021-05-14 11:04:15.991917 (Thread-1): finished collecting timing info
2021-05-14 11:04:15.992442 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 11:04:16.511871 (Thread-18): handling poll request
2021-05-14 11:04:16.512303 (Thread-18): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804c6280>]}
2021-05-14 11:04:16.517046 (Thread-18): sending response (<Response 69694 bytes [200 OK]>) to 10.0.29.105
2021-05-14 11:05:37.591727 (Thread-19): handling status request
2021-05-14 11:05:37.594027 (Thread-19): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804b3be0>]}
2021-05-14 11:05:37.620355 (Thread-19): sending response (<Response 97516 bytes [200 OK]>) to 10.0.34.159
2021-05-14 11:05:38.414426 (Thread-20): handling run_sql request
2021-05-14 11:05:38.414864 (Thread-20): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804c6190>]}
2021-05-14 11:05:39.543224 (Thread-20): sending response (<Response 137 bytes [200 OK]>) to 10.0.1.71
2021-05-14 11:05:39.567545 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 11:05:39.593515 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 11:05:39.594039 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 11:05:39.594153 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 11:05:39.608462 (Thread-1): finished collecting timing info
2021-05-14 11:05:39.618097 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 11:05:39.618219 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Q' and f_metric_id='3'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 11:05:39.618282 (Thread-1): Opening a new connection, currently in state init
2021-05-14 11:05:40.048623 (Thread-21): handling poll request
2021-05-14 11:05:40.049265 (Thread-21): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b389dc0>]}
2021-05-14 11:05:40.051696 (Thread-21): sending response (<Response 15769 bytes [200 OK]>) to 10.0.43.109
2021-05-14 11:05:41.565256 (Thread-22): handling poll request
2021-05-14 11:05:41.565697 (Thread-22): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b389b20>]}
2021-05-14 11:05:41.566574 (Thread-22): sending response (<Response 388 bytes [200 OK]>) to 10.0.17.254
2021-05-14 11:05:43.682453 (Thread-23): handling poll request
2021-05-14 11:05:43.682903 (Thread-23): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b389250>]}
2021-05-14 11:05:43.683838 (Thread-23): sending response (<Response 388 bytes [200 OK]>) to 10.0.23.5
2021-05-14 11:05:45.137915 (Thread-24): handling poll request
2021-05-14 11:05:45.138377 (Thread-24): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b3895e0>]}
2021-05-14 11:05:45.139321 (Thread-24): sending response (<Response 388 bytes [200 OK]>) to 10.0.18.219
2021-05-14 11:05:46.758234 (Thread-25): handling poll request
2021-05-14 11:05:46.758829 (Thread-25): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b390160>]}
2021-05-14 11:05:46.759888 (Thread-25): sending response (<Response 388 bytes [200 OK]>) to 10.0.34.159
2021-05-14 11:05:47.869535 (Thread-1): SQL status: SUCCESS 12 in 8.25 seconds
2021-05-14 11:05:47.872225 (Thread-1): finished collecting timing info
2021-05-14 11:05:47.872725 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 11:05:48.347969 (Thread-26): handling poll request
2021-05-14 11:05:48.348399 (Thread-26): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b396e80>]}
2021-05-14 11:05:48.352955 (Thread-26): sending response (<Response 69426 bytes [200 OK]>) to 10.0.40.40
2021-05-14 11:16:12.154746 (Thread-27): handling status request
2021-05-14 11:16:12.156850 (Thread-27): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680291c10>]}
2021-05-14 11:16:12.182009 (Thread-27): sending response (<Response 97516 bytes [200 OK]>) to 10.0.23.5
2021-05-14 11:16:12.999555 (Thread-28): handling run_sql request
2021-05-14 11:16:13.000001 (Thread-28): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b3968e0>]}
2021-05-14 11:16:14.079603 (Thread-28): sending response (<Response 137 bytes [200 OK]>) to 10.0.43.109
2021-05-14 11:16:14.102054 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 11:16:14.128730 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 11:16:14.129262 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 11:16:14.129375 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 11:16:14.143268 (Thread-1): finished collecting timing info
2021-05-14 11:16:14.153304 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 11:16:14.153402 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='M' and f_metric_id='3'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 11:16:14.153464 (Thread-1): Opening a new connection, currently in state init
2021-05-14 11:16:14.618038 (Thread-29): handling poll request
2021-05-14 11:16:14.618515 (Thread-29): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804d4550>]}
2021-05-14 11:16:14.620754 (Thread-29): sending response (<Response 15769 bytes [200 OK]>) to 10.0.4.158
2021-05-14 11:16:16.157172 (Thread-30): handling poll request
2021-05-14 11:16:16.157637 (Thread-30): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680343d30>]}
2021-05-14 11:16:16.513027 (Thread-30): sending response (<Response 388 bytes [200 OK]>) to 10.0.43.109
2021-05-14 11:16:17.983368 (Thread-31): handling poll request
2021-05-14 11:16:17.983826 (Thread-31): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c19a0>]}
2021-05-14 11:16:17.984777 (Thread-31): sending response (<Response 388 bytes [200 OK]>) to 10.0.7.15
2021-05-14 11:16:19.527711 (Thread-32): handling poll request
2021-05-14 11:16:19.528135 (Thread-32): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c1100>]}
2021-05-14 11:16:19.528992 (Thread-32): sending response (<Response 388 bytes [200 OK]>) to 10.0.29.105
2021-05-14 11:16:21.062702 (Thread-33): handling poll request
2021-05-14 11:16:21.063159 (Thread-33): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c16d0>]}
2021-05-14 11:16:21.064013 (Thread-33): sending response (<Response 388 bytes [200 OK]>) to 10.0.18.219
2021-05-14 11:16:23.021973 (Thread-1): SQL status: SUCCESS 36 in 8.87 seconds
2021-05-14 11:16:23.025251 (Thread-1): finished collecting timing info
2021-05-14 11:16:23.025647 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 11:16:23.351093 (Thread-34): handling poll request
2021-05-14 11:16:23.351599 (Thread-34): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7a8820>]}
2021-05-14 11:16:23.352779 (Thread-34): sending response (<Response 1328 bytes [200 OK]>) to 10.0.1.54
2021-05-14 11:16:24.874349 (Thread-35): handling poll request
2021-05-14 11:16:24.874825 (Thread-35): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c15e0>]}
2021-05-14 11:16:24.879084 (Thread-35): sending response (<Response 71880 bytes [200 OK]>) to 10.0.32.149
2021-05-14 11:17:26.112308 (Thread-36): handling status request
2021-05-14 11:17:26.112746 (Thread-36): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7bd970>]}
2021-05-14 11:17:26.136890 (Thread-36): sending response (<Response 97516 bytes [200 OK]>) to 10.0.36.181
2021-05-14 11:17:26.926692 (Thread-37): handling run_sql request
2021-05-14 11:17:26.927154 (Thread-37): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7bda60>]}
2021-05-14 11:17:27.977522 (Thread-37): sending response (<Response 137 bytes [200 OK]>) to 10.0.23.5
2021-05-14 11:17:27.999820 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 11:17:28.025487 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 11:17:28.025965 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 11:17:28.026060 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 11:17:28.039769 (Thread-1): finished collecting timing info
2021-05-14 11:17:28.049323 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 11:17:28.049410 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='3'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 11:17:28.049472 (Thread-1): Opening a new connection, currently in state init
2021-05-14 11:17:28.519732 (Thread-38): handling poll request
2021-05-14 11:17:28.520213 (Thread-38): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c7250>]}
2021-05-14 11:17:28.522354 (Thread-38): sending response (<Response 15769 bytes [200 OK]>) to 10.0.34.159
2021-05-14 11:17:30.006649 (Thread-39): handling poll request
2021-05-14 11:17:30.007128 (Thread-39): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c7e80>]}
2021-05-14 11:17:30.008017 (Thread-39): sending response (<Response 388 bytes [200 OK]>) to 10.0.17.254
2021-05-14 11:17:31.489224 (Thread-40): handling poll request
2021-05-14 11:17:31.489704 (Thread-40): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c7ca0>]}
2021-05-14 11:17:31.490613 (Thread-40): sending response (<Response 388 bytes [200 OK]>) to 10.0.0.70
2021-05-14 11:17:33.441237 (Thread-1): SQL status: SUCCESS 3 in 5.39 seconds
2021-05-14 11:17:33.443103 (Thread-1): finished collecting timing info
2021-05-14 11:17:33.443500 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 11:17:33.705858 (Thread-41): handling poll request
2021-05-14 11:17:33.706305 (Thread-41): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5ed370>]}
2021-05-14 11:17:33.707485 (Thread-41): sending response (<Response 1326 bytes [200 OK]>) to 10.0.43.109
2021-05-14 11:17:35.209030 (Thread-42): handling poll request
2021-05-14 11:17:35.209472 (Thread-42): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5edfd0>]}
2021-05-14 11:17:35.213633 (Thread-42): sending response (<Response 67300 bytes [200 OK]>) to 10.0.4.158
2021-05-14 12:04:24.907755 (Thread-43): handling status request
2021-05-14 12:04:24.909972 (Thread-43): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5edfd0>]}
2021-05-14 12:04:24.947604 (Thread-43): sending response (<Response 97516 bytes [200 OK]>) to 10.0.4.158
2021-05-14 12:04:25.800617 (Thread-44): handling run_sql request
2021-05-14 12:04:25.801164 (Thread-44): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5eda90>]}
2021-05-14 12:04:27.251267 (Thread-44): sending response (<Response 137 bytes [200 OK]>) to 10.0.16.40
2021-05-14 12:04:27.280108 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 12:04:27.318905 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 12:04:27.319641 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 12:04:27.319805 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 12:04:27.343538 (Thread-1): finished collecting timing info
2021-05-14 12:04:27.361644 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 12:04:27.361818 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='4'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 12:04:27.361924 (Thread-1): Opening a new connection, currently in state init
2021-05-14 12:04:27.923130 (Thread-45): handling poll request
2021-05-14 12:04:27.923629 (Thread-45): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804c6130>]}
2021-05-14 12:04:27.925838 (Thread-45): sending response (<Response 15803 bytes [200 OK]>) to 10.0.23.5
2021-05-14 12:04:29.467366 (Thread-46): handling poll request
2021-05-14 12:04:29.467802 (Thread-46): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b686a90>]}
2021-05-14 12:04:29.468679 (Thread-46): sending response (<Response 388 bytes [200 OK]>) to 10.0.7.15
2021-05-14 12:04:30.914288 (Thread-47): handling poll request
2021-05-14 12:04:30.914713 (Thread-47): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b686280>]}
2021-05-14 12:04:30.915628 (Thread-47): sending response (<Response 388 bytes [200 OK]>) to 10.0.31.167
2021-05-14 12:04:32.448925 (Thread-48): handling poll request
2021-05-14 12:04:32.449532 (Thread-48): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b6863d0>]}
2021-05-14 12:04:32.450799 (Thread-48): sending response (<Response 388 bytes [200 OK]>) to 10.0.43.109
2021-05-14 12:04:34.019671 (Thread-49): handling poll request
2021-05-14 12:04:34.020101 (Thread-49): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b6868b0>]}
2021-05-14 12:04:34.020987 (Thread-49): sending response (<Response 388 bytes [200 OK]>) to 10.0.18.219
2021-05-14 12:04:34.702108 (Thread-1): SQL status: SUCCESS 3 in 7.34 seconds
2021-05-14 12:04:34.703998 (Thread-1): finished collecting timing info
2021-05-14 12:04:34.704404 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 12:04:35.575263 (Thread-50): handling poll request
2021-05-14 12:04:35.575871 (Thread-50): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b676820>]}
2021-05-14 12:04:35.583469 (Thread-50): sending response (<Response 68405 bytes [200 OK]>) to 10.0.23.5
2021-05-14 13:23:12.381219 (Thread-51): handling status request
2021-05-14 13:23:12.383133 (Thread-51): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b686be0>]}
2021-05-14 13:23:12.408191 (Thread-51): sending response (<Response 97516 bytes [200 OK]>) to 10.0.29.194
2021-05-14 13:23:13.127696 (Thread-52): handling run_sql request
2021-05-14 13:23:13.128147 (Thread-52): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b686c70>]}
2021-05-14 13:23:14.181145 (Thread-52): sending response (<Response 137 bytes [200 OK]>) to 10.0.13.215
2021-05-14 13:23:14.203339 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 13:23:14.228754 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 13:23:14.229327 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 13:23:14.229448 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 13:23:14.243869 (Thread-1): finished collecting timing info
2021-05-14 13:23:14.253598 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 13:23:14.253701 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='1'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 13:23:14.253764 (Thread-1): Opening a new connection, currently in state init
2021-05-14 13:23:14.783066 (Thread-53): handling poll request
2021-05-14 13:23:14.783537 (Thread-53): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b676c40>]}
2021-05-14 13:23:14.785674 (Thread-53): sending response (<Response 15803 bytes [200 OK]>) to 10.0.31.131
2021-05-14 13:23:16.250644 (Thread-54): handling poll request
2021-05-14 13:23:16.251134 (Thread-54): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b676340>]}
2021-05-14 13:23:16.252059 (Thread-54): sending response (<Response 388 bytes [200 OK]>) to 10.0.16.193
2021-05-14 13:23:17.728387 (Thread-55): handling poll request
2021-05-14 13:23:17.728821 (Thread-55): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680132640>]}
2021-05-14 13:23:17.729725 (Thread-55): sending response (<Response 388 bytes [200 OK]>) to 10.0.9.194
2021-05-14 13:23:19.244569 (Thread-56): handling poll request
2021-05-14 13:23:19.244998 (Thread-56): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680132160>]}
2021-05-14 13:23:19.245925 (Thread-56): sending response (<Response 388 bytes [200 OK]>) to 10.0.33.62
2021-05-14 13:23:20.737873 (Thread-57): handling poll request
2021-05-14 13:23:20.738315 (Thread-57): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26801329a0>]}
2021-05-14 13:23:20.739304 (Thread-57): sending response (<Response 388 bytes [200 OK]>) to 10.0.4.146
2021-05-14 13:23:20.867032 (Thread-1): SQL status: SUCCESS 4 in 6.61 seconds
2021-05-14 13:23:20.868885 (Thread-1): finished collecting timing info
2021-05-14 13:23:20.869633 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 13:23:22.239105 (Thread-58): handling poll request
2021-05-14 13:23:22.239587 (Thread-58): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26801321c0>]}
2021-05-14 13:23:22.244157 (Thread-58): sending response (<Response 68574 bytes [200 OK]>) to 10.0.4.146
2021-05-14 14:06:29.103672 (Thread-59): handling status request
2021-05-14 14:06:29.105503 (Thread-59): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680132430>]}
2021-05-14 14:06:29.131401 (Thread-59): sending response (<Response 97516 bytes [200 OK]>) to 10.0.13.240
2021-05-14 14:06:29.827029 (Thread-60): handling run_sql request
2021-05-14 14:06:29.827471 (Thread-60): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680132bb0>]}
2021-05-14 14:06:31.077330 (Thread-60): sending response (<Response 137 bytes [200 OK]>) to 10.0.21.136
2021-05-14 14:06:31.099392 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:06:31.125054 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 14:06:31.125651 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:06:31.125793 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 14:06:31.143414 (Thread-1): finished collecting timing info
2021-05-14 14:06:31.153407 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 14:06:31.153512 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result --where  f_timeframe_type='Y' and f_metric_id='1'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 14:06:31.153575 (Thread-1): Opening a new connection, currently in state init
2021-05-14 14:06:31.546669 (Thread-61): handling poll request
2021-05-14 14:06:31.547226 (Thread-61): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b358a60>]}
2021-05-14 14:06:31.549933 (Thread-61): sending response (<Response 15805 bytes [200 OK]>) to 10.0.34.59
2021-05-14 14:06:33.002690 (Thread-62): handling poll request
2021-05-14 14:06:33.003193 (Thread-62): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f268027db20>]}
2021-05-14 14:06:33.004137 (Thread-62): sending response (<Response 388 bytes [200 OK]>) to 10.0.13.240
2021-05-14 14:06:34.440935 (Thread-63): handling poll request
2021-05-14 14:06:34.441412 (Thread-63): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f268027d220>]}
2021-05-14 14:06:34.442440 (Thread-63): sending response (<Response 388 bytes [200 OK]>) to 10.0.16.193
2021-05-14 14:06:35.926495 (Thread-64): handling poll request
2021-05-14 14:06:35.926995 (Thread-64): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5dd0d0>]}
2021-05-14 14:06:35.928190 (Thread-64): sending response (<Response 388 bytes [200 OK]>) to 10.0.33.62
2021-05-14 14:06:37.434452 (Thread-65): handling poll request
2021-05-14 14:06:37.434872 (Thread-65): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5dd490>]}
2021-05-14 14:06:37.435809 (Thread-65): sending response (<Response 388 bytes [200 OK]>) to 10.0.46.159
2021-05-14 14:06:39.433434 (Thread-66): handling poll request
2021-05-14 14:06:39.433864 (Thread-66): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5dd670>]}
2021-05-14 14:06:39.434782 (Thread-66): sending response (<Response 388 bytes [200 OK]>) to 10.0.4.146
2021-05-14 14:06:40.054787 (Thread-1): SQL status: SUCCESS 363 in 8.90 seconds
2021-05-14 14:06:40.074736 (Thread-1): finished collecting timing info
2021-05-14 14:06:40.075216 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 14:06:40.879698 (Thread-67): handling poll request
2021-05-14 14:06:40.880197 (Thread-67): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804d6340>]}
2021-05-14 14:06:40.888430 (Thread-67): sending response (<Response 118977 bytes [200 OK]>) to 10.0.31.131
2021-05-14 14:48:37.250189 (Thread-68): handling status request
2021-05-14 14:48:37.252293 (Thread-68): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804d6e50>]}
2021-05-14 14:48:37.279259 (Thread-68): sending response (<Response 97516 bytes [200 OK]>) to 10.0.1.11
2021-05-14 14:48:38.087290 (Thread-69): handling run_sql request
2021-05-14 14:48:38.087723 (Thread-69): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680132520>]}
2021-05-14 14:48:39.142758 (Thread-69): sending response (<Response 137 bytes [200 OK]>) to 10.0.16.193
2021-05-14 14:48:39.165262 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:48:39.190664 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 14:48:39.191175 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:48:39.191290 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 14:48:39.205019 (Thread-1): finished collecting timing info
2021-05-14 14:48:39.214606 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 14:48:39.214696 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_HS_CREATEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result --where  f_timeframe_type='Y' and f_metric_id='1'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 14:48:39.214759 (Thread-1): Opening a new connection, currently in state init
2021-05-14 14:48:39.765678 (Thread-70): handling poll request
2021-05-14 14:48:39.766192 (Thread-70): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804d9e20>]}
2021-05-14 14:48:39.768390 (Thread-70): sending response (<Response 15857 bytes [200 OK]>) to 10.0.16.193
2021-05-14 14:48:40.094571 (Thread-1): Snowflake query id: 019c3e18-0000-294c-0000-b1490020b1de
2021-05-14 14:48:40.094710 (Thread-1): Snowflake error: 000904 (42000): SQL compilation error: error line 139 at position 95
invalid identifier 'CLDR_DATE'
2021-05-14 14:48:40.094836 (Thread-1): finished collecting timing info
2021-05-14 14:48:40.095249 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 14:48:40.160257 (Thread-1): Got an exception: Database Error
  000904 (42000): SQL compilation error: error line 139 at position 95
  invalid identifier 'CLDR_DATE'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 000904 (42000): SQL compilation error: error line 139 at position 95
invalid identifier 'CLDR_DATE'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  000904 (42000): SQL compilation error: error line 139 at position 95
  invalid identifier 'CLDR_DATE'
2021-05-14 14:48:40.161808 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 139 at position 95\n  invalid identifier 'CLDR_DATE'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_HS_CREATEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result --where  f_timeframe_type=\'Y\' and f_metric_id=\'1\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_HS_CREATEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result --where  f_timeframe_type=\'Y\' and f_metric_id=\'1\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 139 at position 95\n  invalid identifier 'CLDR_DATE'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_HS_CREATEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result --where  f_timeframe_type=\'Y\' and f_metric_id=\'1\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_HS_CREATEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result --where  f_timeframe_type=\'Y\' and f_metric_id=\'1\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-14 14:48:41.343735 (Thread-71): handling poll request
2021-05-14 14:48:41.344207 (Thread-71): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804d9640>]}
2021-05-14 14:48:41.345584 (Thread-71): sending response (<Response 102202 bytes [200 OK]>) to 10.0.18.164
2021-05-14 14:49:52.729297 (Thread-72): handling status request
2021-05-14 14:49:52.731426 (Thread-72): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804d9f40>]}
2021-05-14 14:49:52.756685 (Thread-72): sending response (<Response 97516 bytes [200 OK]>) to 10.0.8.122
2021-05-14 14:49:53.963297 (Thread-73): handling run_sql request
2021-05-14 14:49:53.963729 (Thread-73): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804d9a00>]}
2021-05-14 14:49:55.047878 (Thread-73): sending response (<Response 137 bytes [200 OK]>) to 10.0.29.194
2021-05-14 14:49:55.071048 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:49:55.096808 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 14:49:55.097394 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:49:55.097509 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 14:49:55.111416 (Thread-1): finished collecting timing info
2021-05-14 14:49:55.121097 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 14:49:55.121204 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_HS_CREATEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='1'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 14:49:55.121268 (Thread-1): Opening a new connection, currently in state init
2021-05-14 14:49:55.499502 (Thread-74): handling poll request
2021-05-14 14:49:55.499989 (Thread-74): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b646940>]}
2021-05-14 14:49:55.502223 (Thread-74): sending response (<Response 15897 bytes [200 OK]>) to 10.0.46.159
2021-05-14 14:49:56.940645 (Thread-75): handling poll request
2021-05-14 14:49:56.941088 (Thread-75): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b646430>]}
2021-05-14 14:49:56.942069 (Thread-75): sending response (<Response 388 bytes [200 OK]>) to 10.0.29.194
2021-05-14 14:49:58.413459 (Thread-76): handling poll request
2021-05-14 14:49:58.413895 (Thread-76): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804c8d60>]}
2021-05-14 14:49:58.414836 (Thread-76): sending response (<Response 388 bytes [200 OK]>) to 10.0.8.122
2021-05-14 14:49:59.876146 (Thread-77): handling poll request
2021-05-14 14:49:59.876582 (Thread-77): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804c8f10>]}
2021-05-14 14:49:59.877465 (Thread-77): sending response (<Response 388 bytes [200 OK]>) to 10.0.46.159
2021-05-14 14:50:01.297168 (Thread-78): handling poll request
2021-05-14 14:50:01.297614 (Thread-78): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804c88e0>]}
2021-05-14 14:50:01.298492 (Thread-78): sending response (<Response 388 bytes [200 OK]>) to 10.0.9.194
2021-05-14 14:50:02.400558 (Thread-1): SQL status: SUCCESS 4 in 7.28 seconds
2021-05-14 14:50:02.402869 (Thread-1): finished collecting timing info
2021-05-14 14:50:02.403327 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 14:50:02.907319 (Thread-79): handling poll request
2021-05-14 14:50:02.907756 (Thread-79): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804c8730>]}
2021-05-14 14:50:02.914068 (Thread-79): sending response (<Response 69043 bytes [200 OK]>) to 10.0.21.136
2021-05-14 14:57:17.518125 (Thread-80): handling status request
2021-05-14 14:57:17.520464 (Thread-80): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7b7760>]}
2021-05-14 14:57:17.546179 (Thread-80): sending response (<Response 97516 bytes [200 OK]>) to 10.0.29.194
2021-05-14 14:57:18.040197 (Thread-81): handling run_sql request
2021-05-14 14:57:18.040627 (Thread-81): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804c8e80>]}
2021-05-14 14:57:19.097471 (Thread-81): sending response (<Response 137 bytes [200 OK]>) to 10.0.31.131
2021-05-14 14:57:19.120017 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:57:19.145453 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 14:57:19.145961 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:57:19.146070 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 14:57:19.159893 (Thread-1): finished collecting timing info
2021-05-14 14:57:19.162990 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 14:57:19.163077 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on OPPORTUNITY.CREATED_DATE= timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 14:57:19.163137 (Thread-1): Opening a new connection, currently in state init
2021-05-14 14:57:19.622402 (Thread-82): handling poll request
2021-05-14 14:57:19.622875 (Thread-82): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7b7a90>]}
2021-05-14 14:57:19.625070 (Thread-82): sending response (<Response 6859 bytes [200 OK]>) to 10.0.1.11
2021-05-14 14:57:21.125788 (Thread-83): handling poll request
2021-05-14 14:57:21.126252 (Thread-83): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7b7880>]}
2021-05-14 14:57:21.127198 (Thread-83): sending response (<Response 396 bytes [200 OK]>) to 10.0.19.63
2021-05-14 14:57:21.649839 (Thread-1): SQL status: SUCCESS 0 in 2.49 seconds
2021-05-14 14:57:21.650273 (Thread-1): finished collecting timing info
2021-05-14 14:57:21.650652 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 14:57:22.574678 (Thread-84): handling poll request
2021-05-14 14:57:22.575168 (Thread-84): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b3455e0>]}
2021-05-14 14:57:22.579224 (Thread-84): sending response (<Response 23251 bytes [200 OK]>) to 10.0.33.62
2021-05-14 14:58:43.481645 (Thread-85): handling status request
2021-05-14 14:58:43.483615 (Thread-85): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b345f10>]}
2021-05-14 14:58:43.509056 (Thread-85): sending response (<Response 97516 bytes [200 OK]>) to 10.0.31.131
2021-05-14 14:58:44.036173 (Thread-86): handling run_sql request
2021-05-14 14:58:44.036602 (Thread-86): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7b7b50>]}
2021-05-14 14:58:45.096530 (Thread-86): sending response (<Response 137 bytes [200 OK]>) to 10.0.34.59
2021-05-14 14:58:45.119058 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:58:45.143483 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 14:58:45.143968 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:58:45.144091 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 14:58:45.157851 (Thread-1): finished collecting timing info
2021-05-14 14:58:45.160864 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 14:58:45.160944 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on OPPORTUNITY.CREATED_DATE= timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         --and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 14:58:45.161003 (Thread-1): Opening a new connection, currently in state init
2021-05-14 14:58:45.543944 (Thread-87): handling poll request
2021-05-14 14:58:45.544415 (Thread-87): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b6145e0>]}
2021-05-14 14:58:45.546542 (Thread-87): sending response (<Response 6861 bytes [200 OK]>) to 10.0.21.136
2021-05-14 14:58:46.984386 (Thread-88): handling poll request
2021-05-14 14:58:46.984833 (Thread-88): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b614670>]}
2021-05-14 14:58:46.985724 (Thread-88): sending response (<Response 396 bytes [200 OK]>) to 10.0.21.136
2021-05-14 14:58:47.709095 (Thread-1): SQL status: SUCCESS 0 in 2.55 seconds
2021-05-14 14:58:47.709526 (Thread-1): finished collecting timing info
2021-05-14 14:58:47.709916 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 14:58:48.458730 (Thread-89): handling poll request
2021-05-14 14:58:48.459202 (Thread-89): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b614280>]}
2021-05-14 14:58:48.463092 (Thread-89): sending response (<Response 23260 bytes [200 OK]>) to 10.0.19.63
2021-05-14 14:59:23.061124 (Thread-90): handling status request
2021-05-14 14:59:23.061573 (Thread-90): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b79f820>]}
2021-05-14 14:59:23.202905 (Thread-90): sending response (<Response 97516 bytes [200 OK]>) to 10.0.13.215
2021-05-14 14:59:23.742306 (Thread-91): handling run_sql request
2021-05-14 14:59:23.742736 (Thread-91): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b79f7f0>]}
2021-05-14 14:59:24.905709 (Thread-91): sending response (<Response 137 bytes [200 OK]>) to 10.0.19.63
2021-05-14 14:59:24.929728 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:59:24.959323 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 14:59:24.959880 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 14:59:24.959994 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 14:59:24.973740 (Thread-1): finished collecting timing info
2021-05-14 14:59:24.976763 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 14:59:24.976852 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on OPPORTUNITY.CREATED_DATE= timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         --and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from r_metric -- where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 14:59:24.976913 (Thread-1): Opening a new connection, currently in state init
2021-05-14 14:59:25.502837 (Thread-92): handling poll request
2021-05-14 14:59:25.503352 (Thread-92): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b358a30>]}
2021-05-14 14:59:25.505446 (Thread-92): sending response (<Response 6858 bytes [200 OK]>) to 10.0.40.208
2021-05-14 14:59:26.270701 (Thread-1): SQL status: SUCCESS 0 in 1.29 seconds
2021-05-14 14:59:26.271196 (Thread-1): finished collecting timing info
2021-05-14 14:59:26.271582 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 14:59:26.955054 (Thread-93): handling poll request
2021-05-14 14:59:26.955492 (Thread-93): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5ed190>]}
2021-05-14 14:59:26.959466 (Thread-93): sending response (<Response 23167 bytes [200 OK]>) to 10.0.29.13
2021-05-14 15:01:01.236261 (Thread-94): handling status request
2021-05-14 15:01:01.238398 (Thread-94): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5eda60>]}
2021-05-14 15:01:01.272737 (Thread-94): sending response (<Response 97516 bytes [200 OK]>) to 10.0.13.240
2021-05-14 15:01:01.761263 (Thread-95): handling run_sql request
2021-05-14 15:01:01.761870 (Thread-95): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5ed340>]}
2021-05-14 15:01:03.263622 (Thread-95): sending response (<Response 137 bytes [200 OK]>) to 10.0.16.193
2021-05-14 15:01:03.290106 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:01:03.320119 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:01:03.320791 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:01:03.320910 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:01:03.337195 (Thread-1): finished collecting timing info
2021-05-14 15:01:03.342428 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:01:03.342586 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         --and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from r_metric -- where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:01:03.342687 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:01:03.765178 (Thread-96): handling poll request
2021-05-14 15:01:03.765798 (Thread-96): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b3592b0>]}
2021-05-14 15:01:03.768483 (Thread-96): sending response (<Response 6868 bytes [200 OK]>) to 10.0.19.63
2021-05-14 15:01:05.514745 (Thread-1): SQL status: SUCCESS 288 in 2.17 seconds
2021-05-14 15:01:05.530506 (Thread-1): finished collecting timing info
2021-05-14 15:01:05.531124 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:01:06.030233 (Thread-97): handling poll request
2021-05-14 15:01:06.030890 (Thread-97): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b359dc0>]}
2021-05-14 15:01:06.041275 (Thread-97): sending response (<Response 49195 bytes [200 OK]>) to 10.0.18.164
2021-05-14 15:02:17.546067 (Thread-98): handling status request
2021-05-14 15:02:17.548519 (Thread-98): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b610460>]}
2021-05-14 15:02:17.593448 (Thread-98): sending response (<Response 97516 bytes [200 OK]>) to 10.0.7.5
2021-05-14 15:02:18.139252 (Thread-99): handling run_sql request
2021-05-14 15:02:18.139975 (Thread-99): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b610fd0>]}
2021-05-14 15:02:19.652108 (Thread-99): sending response (<Response 137 bytes [200 OK]>) to 10.0.13.240
2021-05-14 15:02:19.691293 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:02:19.734429 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:02:19.735609 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:02:19.735778 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:02:19.760776 (Thread-1): finished collecting timing info
2021-05-14 15:02:19.766098 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:02:19.766262 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         --and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from r_metric where R_TYPE='Year' --and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:02:19.766365 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:02:20.412243 (Thread-100): handling poll request
2021-05-14 15:02:20.412991 (Thread-100): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5db2b0>]}
2021-05-14 15:02:20.416691 (Thread-100): sending response (<Response 6860 bytes [200 OK]>) to 10.0.18.164
2021-05-14 15:02:21.956061 (Thread-101): handling poll request
2021-05-14 15:02:21.956797 (Thread-101): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5db250>]}
2021-05-14 15:02:21.958185 (Thread-101): sending response (<Response 396 bytes [200 OK]>) to 10.0.9.194
2021-05-14 15:02:23.412007 (Thread-102): handling poll request
2021-05-14 15:02:23.412613 (Thread-102): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b31a640>]}
2021-05-14 15:02:23.413938 (Thread-102): sending response (<Response 396 bytes [200 OK]>) to 10.0.31.131
2021-05-14 15:02:24.165535 (Thread-1): SQL status: SUCCESS 9 in 4.40 seconds
2021-05-14 15:02:24.168634 (Thread-1): finished collecting timing info
2021-05-14 15:02:24.169203 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:02:25.664514 (Thread-103): handling poll request
2021-05-14 15:02:25.665143 (Thread-103): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b31afd0>]}
2021-05-14 15:02:25.672444 (Thread-103): sending response (<Response 24000 bytes [200 OK]>) to 10.0.1.11
2021-05-14 15:03:28.476488 (Thread-104): handling status request
2021-05-14 15:03:28.476932 (Thread-104): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b31ac10>]}
2021-05-14 15:03:28.503094 (Thread-104): sending response (<Response 97516 bytes [200 OK]>) to 10.0.4.146
2021-05-14 15:03:29.034741 (Thread-105): handling run_sql request
2021-05-14 15:03:29.036865 (Thread-105): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b31ae80>]}
2021-05-14 15:03:30.161231 (Thread-105): sending response (<Response 137 bytes [200 OK]>) to 10.0.33.62
2021-05-14 15:03:30.183493 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:03:30.208660 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:03:30.209153 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:03:30.209266 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:03:30.223237 (Thread-1): finished collecting timing info
2021-05-14 15:03:30.226263 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:03:30.226341 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         --and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from r_metric where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:03:30.226397 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:03:30.850417 (Thread-106): handling poll request
2021-05-14 15:03:30.850900 (Thread-106): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c7a60>]}
2021-05-14 15:03:30.853162 (Thread-106): sending response (<Response 6865 bytes [200 OK]>) to 10.0.13.240
2021-05-14 15:03:32.384054 (Thread-107): handling poll request
2021-05-14 15:03:32.384502 (Thread-107): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c7100>]}
2021-05-14 15:03:32.385470 (Thread-107): sending response (<Response 396 bytes [200 OK]>) to 10.0.34.59
2021-05-14 15:03:33.926895 (Thread-108): handling poll request
2021-05-14 15:03:33.927389 (Thread-108): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c7940>]}
2021-05-14 15:03:33.928313 (Thread-108): sending response (<Response 396 bytes [200 OK]>) to 10.0.7.5
2021-05-14 15:03:35.453902 (Thread-109): handling poll request
2021-05-14 15:03:35.454366 (Thread-109): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5c7af0>]}
2021-05-14 15:03:35.455314 (Thread-109): sending response (<Response 396 bytes [200 OK]>) to 10.0.46.159
2021-05-14 15:03:35.867473 (Thread-1): Snowflake query id: 019c3e27-0000-2999-0000-b1490020c00e
2021-05-14 15:03:35.867611 (Thread-1): Snowflake error: 000904 (42000): SQL compilation error: error line 82 at position 29
invalid identifier 'F_TIMEFRAME_TYPE'
2021-05-14 15:03:35.867741 (Thread-1): finished collecting timing info
2021-05-14 15:03:35.868105 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:03:36.449397 (Thread-1): Got an exception: Database Error
  000904 (42000): SQL compilation error: error line 82 at position 29
  invalid identifier 'F_TIMEFRAME_TYPE'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 000904 (42000): SQL compilation error: error line 82 at position 29
invalid identifier 'F_TIMEFRAME_TYPE'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  000904 (42000): SQL compilation error: error line 82 at position 29
  invalid identifier 'F_TIMEFRAME_TYPE'
2021-05-14 15:03:36.451105 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 82 at position 29\n  invalid identifier 'F_TIMEFRAME_TYPE'", 'raw_sql': "With timeframe AS (\n  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'\n  \n  ),r_metric AS (\n    select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            OPPORTUNITY.Source_type as r_Source_type, \n            timeframe.type as r_type,\n            timeframe_type as r_timeframe_type,\n            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID\n        where OPPORTUNITY.IS_WON='true'\n         and OPPORTUNITY.IS_CLOSED='true'\n         and timeframe_type is not null\n         --and to_date(close_date) between timeframe.start_date and timeframe.end_date\n         --and to_date(close_date) between '2017-01-01' and '2021-03-31'\n        group by 4,5,6,7,8,9,10\n ),fs AS(\n    select sum(count) as f_count,\n            sum(AMOUNT) AS f_amount,\n            metric_id AS f_metric_id,\n            ENTITY_ID as f_entity_id, \n            TIMEFRAME_TYPE as f_timeframe_type,\n            cast(tmf.year as varchar(1000)) as f_types_timeframe,\n            tmf.year as f_year\n          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  \n    where \n        TIMEFRAME_TYPE='Y'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag='TRUE'\n    group by 3,4,5,6,7\n\n ), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN 'YES'\n            WHEN r_amount <> f_amount THEN 'YES'\n            WHEN r_metric_id <> f_metric_id THEN 'YES'\n            WHEN r_Source_type <> f_entity_id THEN 'YES'\n            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'\n            WHEN r_year <> f_year THEN 'YES'\n            ELSE 'NO'\n            END as value_mismatch\n\n    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id\n    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'\n    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from r_metric where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'\nlimit 500\n/* limit added automatically by dbt cloud */", 'compiled_sql': "With timeframe AS (\n  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'\n  \n  ),r_metric AS (\n    select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            OPPORTUNITY.Source_type as r_Source_type, \n            timeframe.type as r_type,\n            timeframe_type as r_timeframe_type,\n            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID\n        where OPPORTUNITY.IS_WON='true'\n         and OPPORTUNITY.IS_CLOSED='true'\n         and timeframe_type is not null\n         --and to_date(close_date) between timeframe.start_date and timeframe.end_date\n         --and to_date(close_date) between '2017-01-01' and '2021-03-31'\n        group by 4,5,6,7,8,9,10\n ),fs AS(\n    select sum(count) as f_count,\n            sum(AMOUNT) AS f_amount,\n            metric_id AS f_metric_id,\n            ENTITY_ID as f_entity_id, \n            TIMEFRAME_TYPE as f_timeframe_type,\n            cast(tmf.year as varchar(1000)) as f_types_timeframe,\n            tmf.year as f_year\n          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  \n    where \n        TIMEFRAME_TYPE='Y'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag='TRUE'\n    group by 3,4,5,6,7\n\n ), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN 'YES'\n            WHEN r_amount <> f_amount THEN 'YES'\n            WHEN r_metric_id <> f_metric_id THEN 'YES'\n            WHEN r_Source_type <> f_entity_id THEN 'YES'\n            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'\n            WHEN r_year <> f_year THEN 'YES'\n            ELSE 'NO'\n            END as value_mismatch\n\n    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id\n    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'\n    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from r_metric where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'\nlimit 500\n/* limit added automatically by dbt cloud */", 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 82 at position 29\n  invalid identifier 'F_TIMEFRAME_TYPE'", 'raw_sql': "With timeframe AS (\n  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'\n  \n  ),r_metric AS (\n    select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            OPPORTUNITY.Source_type as r_Source_type, \n            timeframe.type as r_type,\n            timeframe_type as r_timeframe_type,\n            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID\n        where OPPORTUNITY.IS_WON='true'\n         and OPPORTUNITY.IS_CLOSED='true'\n         and timeframe_type is not null\n         --and to_date(close_date) between timeframe.start_date and timeframe.end_date\n         --and to_date(close_date) between '2017-01-01' and '2021-03-31'\n        group by 4,5,6,7,8,9,10\n ),fs AS(\n    select sum(count) as f_count,\n            sum(AMOUNT) AS f_amount,\n            metric_id AS f_metric_id,\n            ENTITY_ID as f_entity_id, \n            TIMEFRAME_TYPE as f_timeframe_type,\n            cast(tmf.year as varchar(1000)) as f_types_timeframe,\n            tmf.year as f_year\n          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  \n    where \n        TIMEFRAME_TYPE='Y'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag='TRUE'\n    group by 3,4,5,6,7\n\n ), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN 'YES'\n            WHEN r_amount <> f_amount THEN 'YES'\n            WHEN r_metric_id <> f_metric_id THEN 'YES'\n            WHEN r_Source_type <> f_entity_id THEN 'YES'\n            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'\n            WHEN r_year <> f_year THEN 'YES'\n            ELSE 'NO'\n            END as value_mismatch\n\n    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id\n    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'\n    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from r_metric where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'\nlimit 500\n/* limit added automatically by dbt cloud */", 'compiled_sql': "With timeframe AS (\n  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'\n  \n  ),r_metric AS (\n    select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            OPPORTUNITY.Source_type as r_Source_type, \n            timeframe.type as r_type,\n            timeframe_type as r_timeframe_type,\n            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID\n        where OPPORTUNITY.IS_WON='true'\n         and OPPORTUNITY.IS_CLOSED='true'\n         and timeframe_type is not null\n         --and to_date(close_date) between timeframe.start_date and timeframe.end_date\n         --and to_date(close_date) between '2017-01-01' and '2021-03-31'\n        group by 4,5,6,7,8,9,10\n ),fs AS(\n    select sum(count) as f_count,\n            sum(AMOUNT) AS f_amount,\n            metric_id AS f_metric_id,\n            ENTITY_ID as f_entity_id, \n            TIMEFRAME_TYPE as f_timeframe_type,\n            cast(tmf.year as varchar(1000)) as f_types_timeframe,\n            tmf.year as f_year\n          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  \n    where \n        TIMEFRAME_TYPE='Y'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag='TRUE'\n    group by 3,4,5,6,7\n\n ), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN 'YES'\n            WHEN r_amount <> f_amount THEN 'YES'\n            WHEN r_metric_id <> f_metric_id THEN 'YES'\n            WHEN r_Source_type <> f_entity_id THEN 'YES'\n            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'\n            WHEN r_year <> f_year THEN 'YES'\n            ELSE 'NO'\n            END as value_mismatch\n\n    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id\n    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'\n    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from r_metric where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'\nlimit 500\n/* limit added automatically by dbt cloud */", 'tags': None}, None)
2021-05-14 15:03:36.932746 (Thread-110): handling poll request
2021-05-14 15:03:36.933268 (Thread-110): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b338850>]}
2021-05-14 15:03:36.934588 (Thread-110): sending response (<Response 37220 bytes [200 OK]>) to 10.0.29.13
2021-05-14 15:03:51.077235 (Thread-111): handling status request
2021-05-14 15:03:51.077685 (Thread-111): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b3389d0>]}
2021-05-14 15:03:51.104706 (Thread-111): sending response (<Response 97516 bytes [200 OK]>) to 10.0.1.11
2021-05-14 15:03:51.639529 (Thread-112): handling run_sql request
2021-05-14 15:03:51.640079 (Thread-112): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b338790>]}
2021-05-14 15:03:52.790130 (Thread-112): sending response (<Response 137 bytes [200 OK]>) to 10.0.46.159
2021-05-14 15:03:52.817471 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:03:52.844883 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:03:52.845519 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:03:52.845680 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:03:52.860708 (Thread-1): finished collecting timing info
2021-05-14 15:03:52.863806 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:03:52.863925 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         --and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:03:52.864000 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:03:53.368962 (Thread-113): handling poll request
2021-05-14 15:03:53.369580 (Thread-113): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26801491f0>]}
2021-05-14 15:03:53.372002 (Thread-113): sending response (<Response 6871 bytes [200 OK]>) to 10.0.1.11
2021-05-14 15:03:55.114028 (Thread-1): SQL status: SUCCESS 5 in 2.25 seconds
2021-05-14 15:03:55.116075 (Thread-1): finished collecting timing info
2021-05-14 15:03:55.116457 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:03:55.601384 (Thread-114): handling poll request
2021-05-14 15:03:55.601809 (Thread-114): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680149a90>]}
2021-05-14 15:03:55.605915 (Thread-114): sending response (<Response 24026 bytes [200 OK]>) to 10.0.33.62
2021-05-14 15:05:04.535398 (Thread-115): handling status request
2021-05-14 15:05:04.537332 (Thread-115): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680149280>]}
2021-05-14 15:05:04.563084 (Thread-115): sending response (<Response 97516 bytes [200 OK]>) to 10.0.18.164
2021-05-14 15:05:05.085441 (Thread-116): handling run_sql request
2021-05-14 15:05:05.085875 (Thread-116): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680149670>]}
2021-05-14 15:05:06.310677 (Thread-116): sending response (<Response 137 bytes [200 OK]>) to 10.0.8.122
2021-05-14 15:05:06.333563 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:05:06.381297 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:05:06.381931 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:05:06.382101 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:05:06.397962 (Thread-1): finished collecting timing info
2021-05-14 15:05:06.403012 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:05:06.403116 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:05:06.403179 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:05:06.921902 (Thread-117): handling poll request
2021-05-14 15:05:06.922525 (Thread-117): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26800d8880>]}
2021-05-14 15:05:06.924927 (Thread-117): sending response (<Response 6869 bytes [200 OK]>) to 10.0.4.146
2021-05-14 15:05:08.428665 (Thread-118): handling poll request
2021-05-14 15:05:08.429126 (Thread-118): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b321a90>]}
2021-05-14 15:05:08.430081 (Thread-118): sending response (<Response 396 bytes [200 OK]>) to 10.0.9.194
2021-05-14 15:05:09.642913 (Thread-1): SQL status: SUCCESS 4 in 3.24 seconds
2021-05-14 15:05:09.644877 (Thread-1): finished collecting timing info
2021-05-14 15:05:09.645263 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:05:09.891099 (Thread-119): handling poll request
2021-05-14 15:05:09.891555 (Thread-119): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b321400>]}
2021-05-14 15:05:09.892733 (Thread-119): sending response (<Response 1334 bytes [200 OK]>) to 10.0.29.13
2021-05-14 15:05:11.408552 (Thread-120): handling poll request
2021-05-14 15:05:11.408984 (Thread-120): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b321190>]}
2021-05-14 15:05:11.552120 (Thread-120): sending response (<Response 22929 bytes [200 OK]>) to 10.0.8.122
2021-05-14 15:05:56.408910 (Thread-121): handling status request
2021-05-14 15:05:56.409356 (Thread-121): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b77e7c0>]}
2021-05-14 15:05:56.436158 (Thread-121): sending response (<Response 97516 bytes [200 OK]>) to 10.0.31.131
2021-05-14 15:05:57.023945 (Thread-122): handling run_sql request
2021-05-14 15:05:57.024412 (Thread-122): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b77e850>]}
2021-05-14 15:05:58.101951 (Thread-122): sending response (<Response 137 bytes [200 OK]>) to 10.0.13.240
2021-05-14 15:05:58.126523 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:05:58.165103 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:05:58.165715 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:05:58.165829 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:05:58.180070 (Thread-1): finished collecting timing info
2021-05-14 15:05:58.183000 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:05:58.183083 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY --inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:05:58.183143 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:05:58.620466 (Thread-123): handling poll request
2021-05-14 15:05:58.620952 (Thread-123): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804c82b0>]}
2021-05-14 15:05:58.623054 (Thread-123): sending response (<Response 6871 bytes [200 OK]>) to 10.0.33.62
2021-05-14 15:06:00.136362 (Thread-124): handling poll request
2021-05-14 15:06:00.136952 (Thread-124): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804c8700>]}
2021-05-14 15:06:00.138207 (Thread-124): sending response (<Response 396 bytes [200 OK]>) to 10.0.18.164
2021-05-14 15:06:00.156916 (Thread-1): Snowflake query id: 019c3e29-0000-2999-0000-b1490020c012
2021-05-14 15:06:00.157102 (Thread-1): Snowflake error: 000904 (42000): SQL compilation error: error line 16 at position 12
invalid identifier 'TIMEFRAME.TYPE'
2021-05-14 15:06:00.157289 (Thread-1): finished collecting timing info
2021-05-14 15:06:00.157815 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:06:00.529198 (Thread-1): Got an exception: Database Error
  000904 (42000): SQL compilation error: error line 16 at position 12
  invalid identifier 'TIMEFRAME.TYPE'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 000904 (42000): SQL compilation error: error line 16 at position 12
invalid identifier 'TIMEFRAME.TYPE'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  000904 (42000): SQL compilation error: error line 16 at position 12
  invalid identifier 'TIMEFRAME.TYPE'
2021-05-14 15:06:00.530840 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 16 at position 12\n  invalid identifier 'TIMEFRAME.TYPE'", 'raw_sql': "With timeframe AS (\n  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'\n  \n  ),r_metric AS (\n    select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            OPPORTUNITY.Source_type as r_Source_type, \n            timeframe.type as r_type,\n            timeframe_type as r_timeframe_type,\n            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY --inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID\n        where OPPORTUNITY.IS_WON='true'\n         and OPPORTUNITY.IS_CLOSED='true'\n         and timeframe_type is not null\n         and to_date(close_date) between timeframe.start_date and timeframe.end_date\n         --and to_date(close_date) between '2017-01-01' and '2021-03-31'\n        group by 4,5,6,7,8,9,10\n ),fs AS(\n    select sum(count) as f_count,\n            sum(AMOUNT) AS f_amount,\n            metric_id AS f_metric_id,\n            ENTITY_ID as f_entity_id, \n            TIMEFRAME_TYPE as f_timeframe_type,\n            cast(tmf.year as varchar(1000)) as f_types_timeframe,\n            tmf.year as f_year\n          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  \n    where \n        TIMEFRAME_TYPE='Y'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag='TRUE'\n    group by 3,4,5,6,7\n\n ), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN 'YES'\n            WHEN r_amount <> f_amount THEN 'YES'\n            WHEN r_metric_id <> f_metric_id THEN 'YES'\n            WHEN r_Source_type <> f_entity_id THEN 'YES'\n            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'\n            WHEN r_year <> f_year THEN 'YES'\n            ELSE 'NO'\n            END as value_mismatch\n\n    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id\n    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'\n    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'\nlimit 500\n/* limit added automatically by dbt cloud */", 'compiled_sql': "With timeframe AS (\n  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'\n  \n  ),r_metric AS (\n    select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            OPPORTUNITY.Source_type as r_Source_type, \n            timeframe.type as r_type,\n            timeframe_type as r_timeframe_type,\n            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY --inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID\n        where OPPORTUNITY.IS_WON='true'\n         and OPPORTUNITY.IS_CLOSED='true'\n         and timeframe_type is not null\n         and to_date(close_date) between timeframe.start_date and timeframe.end_date\n         --and to_date(close_date) between '2017-01-01' and '2021-03-31'\n        group by 4,5,6,7,8,9,10\n ),fs AS(\n    select sum(count) as f_count,\n            sum(AMOUNT) AS f_amount,\n            metric_id AS f_metric_id,\n            ENTITY_ID as f_entity_id, \n            TIMEFRAME_TYPE as f_timeframe_type,\n            cast(tmf.year as varchar(1000)) as f_types_timeframe,\n            tmf.year as f_year\n          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  \n    where \n        TIMEFRAME_TYPE='Y'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag='TRUE'\n    group by 3,4,5,6,7\n\n ), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN 'YES'\n            WHEN r_amount <> f_amount THEN 'YES'\n            WHEN r_metric_id <> f_metric_id THEN 'YES'\n            WHEN r_Source_type <> f_entity_id THEN 'YES'\n            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'\n            WHEN r_year <> f_year THEN 'YES'\n            ELSE 'NO'\n            END as value_mismatch\n\n    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id\n    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'\n    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'\nlimit 500\n/* limit added automatically by dbt cloud */", 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 16 at position 12\n  invalid identifier 'TIMEFRAME.TYPE'", 'raw_sql': "With timeframe AS (\n  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'\n  \n  ),r_metric AS (\n    select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            OPPORTUNITY.Source_type as r_Source_type, \n            timeframe.type as r_type,\n            timeframe_type as r_timeframe_type,\n            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY --inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID\n        where OPPORTUNITY.IS_WON='true'\n         and OPPORTUNITY.IS_CLOSED='true'\n         and timeframe_type is not null\n         and to_date(close_date) between timeframe.start_date and timeframe.end_date\n         --and to_date(close_date) between '2017-01-01' and '2021-03-31'\n        group by 4,5,6,7,8,9,10\n ),fs AS(\n    select sum(count) as f_count,\n            sum(AMOUNT) AS f_amount,\n            metric_id AS f_metric_id,\n            ENTITY_ID as f_entity_id, \n            TIMEFRAME_TYPE as f_timeframe_type,\n            cast(tmf.year as varchar(1000)) as f_types_timeframe,\n            tmf.year as f_year\n          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  \n    where \n        TIMEFRAME_TYPE='Y'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag='TRUE'\n    group by 3,4,5,6,7\n\n ), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN 'YES'\n            WHEN r_amount <> f_amount THEN 'YES'\n            WHEN r_metric_id <> f_metric_id THEN 'YES'\n            WHEN r_Source_type <> f_entity_id THEN 'YES'\n            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'\n            WHEN r_year <> f_year THEN 'YES'\n            ELSE 'NO'\n            END as value_mismatch\n\n    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id\n    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'\n    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'\nlimit 500\n/* limit added automatically by dbt cloud */", 'compiled_sql': "With timeframe AS (\n  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'\n  union \n  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'\n  \n  ),r_metric AS (\n    select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            OPPORTUNITY.Source_type as r_Source_type, \n            timeframe.type as r_type,\n            timeframe_type as r_timeframe_type,\n            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY --inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID\n        where OPPORTUNITY.IS_WON='true'\n         and OPPORTUNITY.IS_CLOSED='true'\n         and timeframe_type is not null\n         and to_date(close_date) between timeframe.start_date and timeframe.end_date\n         --and to_date(close_date) between '2017-01-01' and '2021-03-31'\n        group by 4,5,6,7,8,9,10\n ),fs AS(\n    select sum(count) as f_count,\n            sum(AMOUNT) AS f_amount,\n            metric_id AS f_metric_id,\n            ENTITY_ID as f_entity_id, \n            TIMEFRAME_TYPE as f_timeframe_type,\n            cast(tmf.year as varchar(1000)) as f_types_timeframe,\n            tmf.year as f_year\n          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  \n    where \n        TIMEFRAME_TYPE='Y'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag='TRUE'\n    group by 3,4,5,6,7\n\n ), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN 'YES'\n            WHEN r_amount <> f_amount THEN 'YES'\n            WHEN r_metric_id <> f_metric_id THEN 'YES'\n            WHEN r_Source_type <> f_entity_id THEN 'YES'\n            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'\n            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'\n            WHEN r_year <> f_year THEN 'YES'\n            ELSE 'NO'\n            END as value_mismatch\n\n    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id\n    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'\n    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'\nlimit 500\n/* limit added automatically by dbt cloud */", 'tags': None}, None)
2021-05-14 15:06:01.672141 (Thread-125): handling poll request
2021-05-14 15:06:01.672584 (Thread-125): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5fdc70>]}
2021-05-14 15:06:01.673685 (Thread-125): sending response (<Response 37248 bytes [200 OK]>) to 10.0.21.136
2021-05-14 15:06:27.157114 (Thread-126): handling status request
2021-05-14 15:06:27.157573 (Thread-126): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5fd160>]}
2021-05-14 15:06:27.183603 (Thread-126): sending response (<Response 97516 bytes [200 OK]>) to 10.0.31.131
2021-05-14 15:06:27.675684 (Thread-127): handling run_sql request
2021-05-14 15:06:27.676124 (Thread-127): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5fd880>]}
2021-05-14 15:06:28.748540 (Thread-127): sending response (<Response 137 bytes [200 OK]>) to 10.0.7.5
2021-05-14 15:06:28.770198 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:06:28.796199 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:06:28.796733 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:06:28.796846 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:06:28.810499 (Thread-1): finished collecting timing info
2021-05-14 15:06:28.813606 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:06:28.813699 (Thread-1): On rpc.DBTTest.request: With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,timeframe --inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:06:28.813758 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:06:29.428219 (Thread-128): handling poll request
2021-05-14 15:06:29.428746 (Thread-128): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680369220>]}
2021-05-14 15:06:29.431105 (Thread-128): sending response (<Response 6881 bytes [200 OK]>) to 10.0.1.11
2021-05-14 15:06:30.925502 (Thread-129): handling poll request
2021-05-14 15:06:30.925959 (Thread-129): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680369520>]}
2021-05-14 15:06:30.926865 (Thread-129): sending response (<Response 395 bytes [200 OK]>) to 10.0.13.240
2021-05-14 15:06:31.824938 (Thread-1): SQL status: SUCCESS 6 in 3.01 seconds
2021-05-14 15:06:31.826883 (Thread-1): finished collecting timing info
2021-05-14 15:06:31.827289 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:06:32.367147 (Thread-130): handling poll request
2021-05-14 15:06:32.367588 (Thread-130): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680369250>]}
2021-05-14 15:06:32.368754 (Thread-130): sending response (<Response 1334 bytes [200 OK]>) to 10.0.31.131
2021-05-14 15:06:33.832345 (Thread-131): handling poll request
2021-05-14 15:06:33.832795 (Thread-131): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26802a3bb0>]}
2021-05-14 15:06:33.836618 (Thread-131): sending response (<Response 23312 bytes [200 OK]>) to 10.0.9.194
2021-05-14 15:08:39.435944 (Thread-132): handling status request
2021-05-14 15:08:39.439440 (Thread-132): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26802a3430>]}
2021-05-14 15:08:39.465363 (Thread-132): sending response (<Response 97516 bytes [200 OK]>) to 10.0.7.5
2021-05-14 15:08:40.297036 (Thread-133): handling run_sql request
2021-05-14 15:08:40.297479 (Thread-133): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26802a31c0>]}
2021-05-14 15:08:41.450868 (Thread-133): sending response (<Response 137 bytes [200 OK]>) to 10.0.29.194
2021-05-14 15:08:41.473527 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:08:41.500765 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:08:41.501320 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:08:41.501437 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:08:41.515860 (Thread-1): finished collecting timing info
2021-05-14 15:08:41.525820 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:08:41.525929 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='1'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:08:41.525994 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:08:41.899565 (Thread-134): handling poll request
2021-05-14 15:08:41.900263 (Thread-134): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7d7ee0>]}
2021-05-14 15:08:41.902662 (Thread-134): sending response (<Response 15917 bytes [200 OK]>) to 10.0.7.5
2021-05-14 15:08:43.468392 (Thread-135): handling poll request
2021-05-14 15:08:43.468864 (Thread-135): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7d74c0>]}
2021-05-14 15:08:43.469846 (Thread-135): sending response (<Response 388 bytes [200 OK]>) to 10.0.9.194
2021-05-14 15:08:45.529263 (Thread-136): handling poll request
2021-05-14 15:08:45.529710 (Thread-136): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7d7370>]}
2021-05-14 15:08:45.530587 (Thread-136): sending response (<Response 388 bytes [200 OK]>) to 10.0.46.159
2021-05-14 15:08:47.041261 (Thread-137): handling poll request
2021-05-14 15:08:47.041720 (Thread-137): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7d75b0>]}
2021-05-14 15:08:47.042741 (Thread-137): sending response (<Response 388 bytes [200 OK]>) to 10.0.40.208
2021-05-14 15:08:48.553775 (Thread-138): handling poll request
2021-05-14 15:08:48.554218 (Thread-138): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7d7820>]}
2021-05-14 15:08:48.555140 (Thread-138): sending response (<Response 388 bytes [200 OK]>) to 10.0.29.13
2021-05-14 15:08:49.233565 (Thread-1): SQL status: SUCCESS 4 in 7.71 seconds
2021-05-14 15:08:49.235472 (Thread-1): finished collecting timing info
2021-05-14 15:08:49.235861 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:08:50.060455 (Thread-139): handling poll request
2021-05-14 15:08:50.060929 (Thread-139): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b36a1f0>]}
2021-05-14 15:08:50.065439 (Thread-139): sending response (<Response 69142 bytes [200 OK]>) to 10.0.8.122
2021-05-14 15:14:46.511488 (Thread-140): handling status request
2021-05-14 15:14:46.513282 (Thread-140): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b36aca0>]}
2021-05-14 15:14:46.538894 (Thread-140): sending response (<Response 97516 bytes [200 OK]>) to 10.0.4.146
2021-05-14 15:14:47.291609 (Thread-141): handling run_sql request
2021-05-14 15:14:47.292031 (Thread-141): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7d7940>]}
2021-05-14 15:14:48.342262 (Thread-141): sending response (<Response 137 bytes [200 OK]>) to 10.0.4.146
2021-05-14 15:14:48.364653 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:14:48.390116 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:14:48.390636 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:14:48.390751 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:14:48.404882 (Thread-1): finished collecting timing info
2021-05-14 15:14:48.414869 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:14:48.414958 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='10'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:14:48.415047 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:14:48.883751 (Thread-142): handling poll request
2021-05-14 15:14:48.884247 (Thread-142): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b36a220>]}
2021-05-14 15:14:48.886534 (Thread-142): sending response (<Response 15918 bytes [200 OK]>) to 10.0.33.62
2021-05-14 15:14:50.429772 (Thread-143): handling poll request
2021-05-14 15:14:50.430209 (Thread-143): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b36a9a0>]}
2021-05-14 15:14:50.431207 (Thread-143): sending response (<Response 388 bytes [200 OK]>) to 10.0.18.164
2021-05-14 15:14:51.984686 (Thread-144): handling poll request
2021-05-14 15:14:51.985240 (Thread-144): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b36adc0>]}
2021-05-14 15:14:51.986199 (Thread-144): sending response (<Response 388 bytes [200 OK]>) to 10.0.13.215
2021-05-14 15:14:53.516992 (Thread-145): handling poll request
2021-05-14 15:14:53.517430 (Thread-145): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b321fa0>]}
2021-05-14 15:14:53.518357 (Thread-145): sending response (<Response 388 bytes [200 OK]>) to 10.0.18.164
2021-05-14 15:14:55.487793 (Thread-1): SQL status: SUCCESS 3 in 7.07 seconds
2021-05-14 15:14:55.489606 (Thread-1): finished collecting timing info
2021-05-14 15:14:55.489982 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:14:55.617833 (Thread-146): handling poll request
2021-05-14 15:14:55.618287 (Thread-146): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b321340>]}
2021-05-14 15:14:55.619518 (Thread-146): sending response (<Response 1326 bytes [200 OK]>) to 10.0.19.63
2021-05-14 15:14:57.071873 (Thread-147): handling poll request
2021-05-14 15:14:57.072308 (Thread-147): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b3215e0>]}
2021-05-14 15:14:57.077159 (Thread-147): sending response (<Response 68092 bytes [200 OK]>) to 10.0.16.193
2021-05-14 15:17:19.357586 (Thread-148): handling status request
2021-05-14 15:17:19.360091 (Thread-148): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26800d82e0>]}
2021-05-14 15:17:19.388757 (Thread-148): sending response (<Response 97516 bytes [200 OK]>) to 10.0.19.63
2021-05-14 15:17:20.153181 (Thread-149): handling run_sql request
2021-05-14 15:17:20.153624 (Thread-149): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b321cd0>]}
2021-05-14 15:17:21.217848 (Thread-149): sending response (<Response 137 bytes [200 OK]>) to 10.0.19.63
2021-05-14 15:17:21.238640 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:17:21.264107 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:17:21.264641 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:17:21.264756 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:17:21.279062 (Thread-1): finished collecting timing info
2021-05-14 15:17:21.291137 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:17:21.291255 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='10'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:17:21.291319 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:17:21.721080 (Thread-150): handling poll request
2021-05-14 15:17:21.721540 (Thread-150): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b61cdf0>]}
2021-05-14 15:17:21.844212 (Thread-150): sending response (<Response 15967 bytes [200 OK]>) to 10.0.31.131
2021-05-14 15:17:23.349491 (Thread-151): handling poll request
2021-05-14 15:17:23.349939 (Thread-151): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5ed9d0>]}
2021-05-14 15:17:23.350867 (Thread-151): sending response (<Response 388 bytes [200 OK]>) to 10.0.18.164
2021-05-14 15:17:25.651990 (Thread-152): handling poll request
2021-05-14 15:17:25.652439 (Thread-152): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b61c220>]}
2021-05-14 15:17:25.653366 (Thread-152): sending response (<Response 388 bytes [200 OK]>) to 10.0.8.122
2021-05-14 15:17:27.373183 (Thread-153): handling poll request
2021-05-14 15:17:27.373763 (Thread-153): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b61c730>]}
2021-05-14 15:17:27.375011 (Thread-153): sending response (<Response 388 bytes [200 OK]>) to 10.0.33.62
2021-05-14 15:17:27.937329 (Thread-1): SQL status: SUCCESS 3 in 6.65 seconds
2021-05-14 15:17:27.939391 (Thread-1): finished collecting timing info
2021-05-14 15:17:27.939777 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:17:28.900945 (Thread-154): handling poll request
2021-05-14 15:17:28.901406 (Thread-154): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26801c3dc0>]}
2021-05-14 15:17:28.905725 (Thread-154): sending response (<Response 69275 bytes [200 OK]>) to 10.0.33.62
2021-05-14 15:27:14.815149 (Thread-155): handling status request
2021-05-14 15:27:14.817576 (Thread-155): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26801c3e80>]}
2021-05-14 15:27:14.843148 (Thread-155): sending response (<Response 97516 bytes [200 OK]>) to 10.0.7.5
2021-05-14 15:27:15.648507 (Thread-156): handling run_sql request
2021-05-14 15:27:15.648943 (Thread-156): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b5ed1f0>]}
2021-05-14 15:27:16.747354 (Thread-156): sending response (<Response 137 bytes [200 OK]>) to 10.0.13.215
2021-05-14 15:27:16.769754 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:27:16.795584 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-14 15:27:16.796134 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-14 15:27:16.796246 (Thread-1): Compiling rpc.DBTTest.request
2021-05-14 15:27:16.810046 (Thread-1): finished collecting timing info
2021-05-14 15:27:16.819752 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-14 15:27:16.819843 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='3'
limit 500
/* limit added automatically by dbt cloud */
2021-05-14 15:27:16.819902 (Thread-1): Opening a new connection, currently in state init
2021-05-14 15:27:17.195936 (Thread-157): handling poll request
2021-05-14 15:27:17.196414 (Thread-157): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26801c3ac0>]}
2021-05-14 15:27:17.198641 (Thread-157): sending response (<Response 15966 bytes [200 OK]>) to 10.0.16.193
2021-05-14 15:27:18.770125 (Thread-158): handling poll request
2021-05-14 15:27:18.770578 (Thread-158): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26801c3d30>]}
2021-05-14 15:27:18.771542 (Thread-158): sending response (<Response 387 bytes [200 OK]>) to 10.0.13.215
2021-05-14 15:27:20.380850 (Thread-159): handling poll request
2021-05-14 15:27:20.381295 (Thread-159): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26800dc0a0>]}
2021-05-14 15:27:20.382201 (Thread-159): sending response (<Response 388 bytes [200 OK]>) to 10.0.33.62
2021-05-14 15:27:21.885375 (Thread-160): handling poll request
2021-05-14 15:27:21.885813 (Thread-160): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26800dc670>]}
2021-05-14 15:27:21.886695 (Thread-160): sending response (<Response 388 bytes [200 OK]>) to 10.0.33.62
2021-05-14 15:27:23.387113 (Thread-161): handling poll request
2021-05-14 15:27:23.387555 (Thread-161): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26800dcac0>]}
2021-05-14 15:27:23.388679 (Thread-161): sending response (<Response 388 bytes [200 OK]>) to 10.0.16.193
2021-05-14 15:27:24.717666 (Thread-1): SQL status: SUCCESS 3 in 7.90 seconds
2021-05-14 15:27:24.719500 (Thread-1): finished collecting timing info
2021-05-14 15:27:24.719887 (Thread-1): On rpc.DBTTest.request: Close
2021-05-14 15:27:25.597412 (Thread-162): handling poll request
2021-05-14 15:27:25.597858 (Thread-162): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26800dcb50>]}
2021-05-14 15:27:25.602168 (Thread-162): sending response (<Response 69223 bytes [200 OK]>) to 10.0.13.240
2021-05-14 15:48:52.967341 (Thread-163): Got an acceptable cached parse result
2021-05-14 15:48:53.068416 (Thread-163): Acquiring new snowflake connection "model.DBTTest.HS_SF".
2021-05-14 15:48:53.081505 (Thread-164): handling status request
2021-05-14 15:48:53.081974 (Thread-164): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267a99a2b0>]}
2021-05-14 15:48:53.082776 (Thread-164): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.146
2021-05-14 15:48:53.086306 (Thread-165): handling status request
2021-05-14 15:48:53.086612 (Thread-165): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267a97b550>]}
2021-05-14 15:48:53.087226 (Thread-165): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.208
2021-05-14 15:48:53.278465 (Thread-166): handling status request
2021-05-14 15:48:53.298025 (Thread-166): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267b7a2580>]}
2021-05-14 15:48:53.299134 (Thread-166): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.146
2021-05-14 15:48:54.604567 (Thread-167): handling status request
2021-05-14 15:48:54.605108 (Thread-167): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267a9ba6d0>]}
2021-05-14 15:48:54.605886 (Thread-167): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.59
2021-05-14 15:48:54.655870 (Thread-168): handling status request
2021-05-14 15:48:54.656539 (Thread-168): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267a9bdee0>]}
2021-05-14 15:48:54.657232 (Thread-168): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.131
2021-05-14 15:48:54.882738 (Thread-169): handling status request
2021-05-14 15:48:54.885272 (Thread-169): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f267a72bfa0>]}
2021-05-14 15:48:54.886160 (Thread-169): sending response (<Response 184 bytes [200 OK]>) to 10.0.13.215
2021-05-14 15:48:55.053412 (Thread-163): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-14 15:48:55.053574 (Thread-163): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-14 15:48:55.053664 (Thread-163): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-14 15:48:55.053727 (Thread-163): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-14 15:48:55.053784 (Thread-163): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-14 15:48:55.054618 (Thread-163): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-14 15:48:55.055042 (Thread-163): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-14 15:48:55.055344 (Thread-163): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-14 15:48:55.055591 (Thread-163): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-14 15:48:55.055827 (Thread-163): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-14 15:48:55.056059 (Thread-163): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-14 15:48:55.056327 (Thread-163): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-14 15:48:55.056573 (Thread-163): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-14 15:48:55.390069 (Thread-163): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.Stage_Layer
- models.DBTTest.Views
- models.DBTTest.utils
- models.DBTTest.Targets
- seeds.DBTTest

2021-05-14 15:48:56.150389 (Thread-170): handling status request
2021-05-14 15:48:56.150865 (Thread-170): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2680077910>]}
2021-05-14 15:48:56.152871 (Thread-170): sending response (<Response 6248 bytes [200 OK]>) to 10.0.34.59
2021-05-14 15:48:56.164719 (Thread-171): handling status request
2021-05-14 15:48:56.165138 (Thread-171): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26801cd5b0>]}
2021-05-14 15:48:56.167235 (Thread-171): sending response (<Response 6248 bytes [200 OK]>) to 10.0.46.159
2021-05-14 15:48:56.332126 (Thread-172): handling status request
2021-05-14 15:48:56.332570 (Thread-172): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '8aa1402a-89c0-4141-9e42-9d5e1ed75fe1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26804280a0>]}
2021-05-14 15:48:56.334515 (Thread-172): sending response (<Response 6248 bytes [200 OK]>) to 10.0.7.5
2021-05-15 04:49:12.872052 (MainThread): Running with dbt=0.18.1
2021-05-15 04:49:13.162666 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-15 04:49:13.168717 (MainThread): Tracking: tracking
2021-05-15 04:49:13.168962 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb740e8fd60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73dfbd8e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73792d5b0>]}
2021-05-15 04:49:13.169342 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-15 04:49:13.169771 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-15 04:49:13.170069 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-15 04:49:13.818559 (Thread-1): Parsing macros/metrics.sql
2021-05-15 04:49:13.834142 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-15 04:49:13.839227 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-15 04:49:13.843224 (Thread-1): Parsing macros/adapters.sql
2021-05-15 04:49:13.871896 (Thread-1): Parsing macros/catalog.sql
2021-05-15 04:49:13.873844 (Thread-1): Parsing macros/materializations/table.sql
2021-05-15 04:49:13.877643 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-15 04:49:13.879633 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-15 04:49:13.888592 (Thread-1): Parsing macros/materializations/view.sql
2021-05-15 04:49:13.890801 (Thread-1): Parsing macros/core.sql
2021-05-15 04:49:13.894395 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-15 04:49:13.903043 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-15 04:49:13.916853 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-15 04:49:13.918645 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-15 04:49:13.935036 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-15 04:49:13.962402 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-15 04:49:13.967243 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-15 04:49:13.973347 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-15 04:49:13.993828 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-15 04:49:14.000305 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-15 04:49:14.002121 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-15 04:49:14.007997 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-15 04:49:14.009573 (Thread-1): Parsing macros/etc/query.sql
2021-05-15 04:49:14.010638 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-15 04:49:14.019277 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-15 04:49:14.020222 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-15 04:49:14.021871 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-15 04:49:14.023836 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-15 04:49:14.025368 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-15 04:49:14.028094 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-15 04:49:14.029968 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-15 04:49:14.031767 (Thread-1): Parsing macros/adapters/common.sql
2021-05-15 04:49:14.084520 (Thread-1): Parsing macros/staging_columns.sql
2021-05-15 04:49:14.109133 (Thread-1): Parsing macros/staging_columns.sql
2021-05-15 04:49:14.157371 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-15 04:49:14.161797 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-15 04:49:14.166507 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-15 04:49:14.173573 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-15 04:49:14.180441 (Thread-1): Parsing macros/sql/star.sql
2021-05-15 04:49:14.186934 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-15 04:49:14.193682 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-15 04:49:14.201546 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-15 04:49:14.209199 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-15 04:49:14.213721 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-15 04:49:14.224974 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-15 04:49:14.231176 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-15 04:49:14.236051 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-15 04:49:14.242839 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-15 04:49:14.249519 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-15 04:49:14.254463 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-15 04:49:14.266210 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-15 04:49:14.273856 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-15 04:49:14.281121 (Thread-1): Parsing macros/sql/union.sql
2021-05-15 04:49:14.296393 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-15 04:49:14.317843 (Thread-2): handling status request
2021-05-15 04:49:14.320494 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7368c3a30>]}
2021-05-15 04:49:14.322217 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.122
2021-05-15 04:49:14.325111 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-15 04:49:14.332735 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-15 04:49:14.339093 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-15 04:49:14.347425 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-15 04:49:14.354329 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-15 04:49:14.360295 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-15 04:49:14.365096 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-15 04:49:14.370975 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-15 04:49:14.381401 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-15 04:49:14.386707 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-15 04:49:14.393865 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-15 04:49:14.400547 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-15 04:49:14.409795 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-15 04:49:14.415422 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-15 04:49:14.423505 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-15 04:49:14.428272 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-15 04:49:14.433230 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-15 04:49:14.438006 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-15 04:49:14.446550 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-15 04:49:14.451468 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-15 04:49:14.459694 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-15 04:49:14.465371 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-15 04:49:14.473448 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-15 04:49:14.481328 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-15 04:49:14.488896 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-15 04:49:14.497051 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-15 04:49:14.502004 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-15 04:49:14.507406 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-15 04:49:14.522814 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-15 04:49:14.529115 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-15 04:49:14.539872 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-15 04:49:14.546627 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-15 04:49:14.553706 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-15 04:49:14.562042 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-15 04:49:14.571113 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-15 04:49:14.577381 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-15 04:49:14.582473 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-15 04:49:14.589854 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-15 04:49:14.596901 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-15 04:49:14.608471 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-15 04:49:14.618948 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-15 04:49:14.633853 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-15 04:49:14.650992 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-15 04:49:14.673707 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-15 04:49:14.683753 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-15 04:49:14.696554 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-15 04:49:14.702266 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-15 04:49:14.719181 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-15 04:49:14.727354 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-15 04:49:14.738587 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-15 04:49:14.750640 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-15 04:49:14.775111 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-15 04:49:14.793019 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-15 04:49:14.800553 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-15 04:49:14.812692 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-15 04:49:14.842998 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-15 04:49:14.857448 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-15 04:49:14.866735 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-15 04:49:14.874795 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-15 04:49:14.880064 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-15 04:49:14.885086 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-15 04:49:14.890928 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-15 04:49:14.896489 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-15 04:49:14.901014 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-15 04:49:14.906675 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-15 04:49:14.914293 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-15 04:49:14.920559 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-15 04:49:14.926333 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-15 04:49:14.934487 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-15 04:49:14.941761 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-15 04:49:14.946334 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-15 04:49:14.951832 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-15 04:49:14.956419 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-15 04:49:14.960717 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-15 04:49:14.965782 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-15 04:49:14.971075 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-15 04:49:14.976051 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-15 04:49:14.981716 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-15 04:49:14.997180 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-15 04:49:15.002225 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-15 04:49:15.010382 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-15 04:49:15.016012 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-15 04:49:15.020463 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-15 04:49:15.029845 (Thread-1): Parsing macros/first_value.sql
2021-05-15 04:49:15.036436 (Thread-1): Parsing macros/json_extract.sql
2021-05-15 04:49:15.045491 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-15 04:49:15.055097 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-15 04:49:15.074221 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-15 04:49:15.081776 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-15 04:49:15.087914 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-15 04:49:15.095459 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-15 04:49:15.208457 (Thread-1): Parsing macros/percentile.sql
2021-05-15 04:49:15.215803 (Thread-1): Parsing macros/ceiling.sql
2021-05-15 04:49:15.220831 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-15 04:49:15.228568 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-15 04:49:15.236588 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-15 04:49:15.241405 (Thread-1): Parsing macros/string_agg.sql
2021-05-15 04:49:15.248089 (Thread-1): Parsing macros/array_agg.sql
2021-05-15 04:49:15.254148 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-15 04:49:15.262287 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-15 04:49:15.267642 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-15 04:49:15.272811 (Thread-1): Parsing macros/union_relations.sql
2021-05-15 04:49:15.285729 (Thread-1): Parsing macros/max_bool.sql
2021-05-15 04:49:15.403170 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_opportunity".
2021-05-15 04:49:15.420935 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_opportunity model triggered this warning. 
2021-05-15 04:49:15.458151 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_account".
2021-05-15 04:49:15.464695 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_account model triggered this warning. 
2021-05-15 04:49:15.477752 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_product".
2021-05-15 04:49:15.483393 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_product model triggered this warning. 
2021-05-15 04:49:15.497072 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_contacts".
2021-05-15 04:49:15.503766 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_contacts model triggered this warning. 
2021-05-15 04:49:15.516675 (Thread-1): Acquiring new snowflake connection "model.DBTTest.test".
2021-05-15 04:49:15.537023 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_address".
2021-05-15 04:49:15.553839 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_lead".
2021-05-15 04:49:15.560264 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_lead model triggered this warning. 
2021-05-15 04:49:15.573809 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_campaign".
2021-05-15 04:49:15.578765 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_campaign model triggered this warning. 
2021-05-15 04:49:15.591416 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_employee".
2021-05-15 04:49:15.596984 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_employee model triggered this warning. 
2021-05-15 04:49:15.612420 (Thread-1): Acquiring new snowflake connection "model.DBTTest.stg_sf_OpportunityStages".
2021-05-15 04:49:15.617981 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.stg_sf_OpportunityStages model triggered this warning. 
2021-05-15 04:49:15.631443 (Thread-1): Acquiring new snowflake connection "model.DBTTest.lead".
2021-05-15 04:49:15.646079 (Thread-1): Acquiring new snowflake connection "model.DBTTest.opportunity_history".
2021-05-15 04:49:15.662802 (Thread-1): Acquiring new snowflake connection "model.DBTTest.contact".
2021-05-15 04:49:15.678416 (Thread-1): Acquiring new snowflake connection "model.DBTTest.CAMPAIGN".
2021-05-15 04:49:15.695104 (Thread-1): Acquiring new snowflake connection "model.DBTTest.OPPORTUNITY_STAGE".
2021-05-15 04:49:15.709688 (Thread-1): Acquiring new snowflake connection "model.DBTTest.user_role".
2021-05-15 04:49:15.727180 (Thread-1): Acquiring new snowflake connection "model.DBTTest.period".
2021-05-15 04:49:15.744781 (Thread-1): Acquiring new snowflake connection "model.DBTTest.user".
2021-05-15 04:49:15.759398 (Thread-1): Acquiring new snowflake connection "model.DBTTest.account".
2021-05-15 04:49:15.775303 (Thread-1): Acquiring new snowflake connection "model.DBTTest.opportunity".
2021-05-15 04:49:15.791067 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-15 04:49:15.807106 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-15 04:49:15.823153 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-15 04:49:15.838760 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-15 04:49:15.854952 (Thread-1): Acquiring new snowflake connection "model.DBTTest.opportunity_dim".
2021-05-15 04:49:15.871350 (Thread-1): Acquiring new snowflake connection "model.DBTTest.dim_oppo_stage_calc".
2021-05-15 04:49:15.876999 (Thread-1): 
Warning: the `surrogate_key` macro now takes a single list argument instead of multiple string arguments. Support for multiple string arguments will be deprecated in a future release of dbt-utils. The DBTTest.dim_oppo_stage_calc model triggered this warning. 
2021-05-15 04:49:15.883880 (Thread-3): handling status request
2021-05-15 04:49:15.884174 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c9e3a0>]}
2021-05-15 04:49:15.884794 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.45.155
2021-05-15 04:49:15.891107 (Thread-1): Acquiring new snowflake connection "model.DBTTest.lead_dim".
2021-05-15 04:49:15.906648 (Thread-1): Acquiring new snowflake connection "model.DBTTest.employee_dim".
2021-05-15 04:49:15.928659 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF".
2021-05-15 04:49:15.940904 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Dim_timeframe".
2021-05-15 04:49:15.957925 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 04:49:15.977189 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-15 04:49:16.029738 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-15 04:49:16.530580 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-15 04:49:16.582707 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-15 04:49:16.643845 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-15 04:49:16.673554 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-15 04:49:16.699945 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-15 04:49:16.716571 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-15 04:49:17.009713 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-15 04:49:17.026894 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-15 04:49:17.047774 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-15 04:49:17.150916 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 04:49:17.168774 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 04:49:17.294716 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 04:49:17.311403 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 04:49:17.328219 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 04:49:17.342768 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 04:49:17.360530 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 04:49:17.380108 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 04:49:17.390792 (Thread-4): handling status request
2021-05-15 04:49:17.391177 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735967b50>]}
2021-05-15 04:49:17.391785 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.3.247
2021-05-15 04:49:17.400155 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 04:49:17.414633 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 04:49:17.429124 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 04:49:17.444616 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 04:49:17.459273 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-15 04:49:17.491542 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 04:49:17.507977 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 04:49:17.523370 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 04:49:17.538887 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 04:49:17.555651 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 04:49:17.579611 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 04:49:17.740689 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-15 04:49:17.762089 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-15 04:49:17.792569 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-15 04:49:17.822522 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-15 04:49:17.847361 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-15 04:49:17.874433 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-15 04:49:17.899815 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-15 04:49:17.914281 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-15 04:49:17.930317 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-15 04:49:17.948030 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-15 04:49:17.964089 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-15 04:49:17.983004 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-15 04:49:18.314022 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-15 04:49:18.338448 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-15 04:49:18.366333 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-15 04:49:18.730415 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-15 04:49:18.745007 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-15 04:49:18.759101 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-15 04:49:18.773033 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-15 04:49:18.854966 (Thread-5): handling status request
2021-05-15 04:49:18.875703 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ece430>]}
2021-05-15 04:49:18.886593 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.199
2021-05-15 04:49:18.961404 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-15 04:49:18.993660 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-15 04:49:19.016600 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-15 04:49:19.042807 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-15 04:49:19.104524 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-15 04:49:19.162787 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-15 04:49:19.177587 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-15 04:49:19.191858 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-15 04:49:19.209239 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-15 04:49:19.223387 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-15 04:49:19.795496 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-15 04:49:19.811898 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-15 04:49:19.827763 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-15 04:49:19.843776 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-15 04:49:19.882520 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-15 04:49:19.898789 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-15 04:49:19.914498 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-15 04:49:20.007764 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-15 04:49:20.021922 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-15 04:49:20.041875 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-15 04:49:20.056590 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-15 04:49:20.072041 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-15 04:49:20.087256 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-15 04:49:20.318656 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-15 04:49:20.342292 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-15 04:49:20.378217 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-15 04:49:20.421099 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-15 04:49:20.442746 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-15 04:49:20.452367 (Thread-6): handling status request
2021-05-15 04:49:20.452869 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d9a3d0>]}
2021-05-15 04:49:20.453498 (Thread-6): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.138
2021-05-15 04:49:20.458733 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-15 04:49:20.474038 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-15 04:49:20.489337 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-15 04:49:20.892922 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-15 04:49:20.907863 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-15 04:49:20.924927 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-15 04:49:20.972949 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-15 04:49:20.995392 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-15 04:49:21.143647 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-15 04:49:21.168693 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-15 04:49:21.203484 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-15 04:49:21.253670 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-15 04:49:21.300250 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-15 04:49:21.352053 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-15 04:49:21.379071 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-15 04:49:21.394742 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-15 04:49:21.410269 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-15 04:49:21.425672 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-15 04:49:21.441296 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-15 04:49:21.457549 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-15 04:49:21.728453 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-15 04:49:21.744708 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-15 04:49:21.760717 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-15 04:49:21.782441 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-15 04:49:21.798997 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-15 04:49:22.012368 (Thread-7): handling status request
2021-05-15 04:49:22.031349 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359aa730>]}
2021-05-15 04:49:22.037212 (Thread-7): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.10
2021-05-15 04:49:22.193799 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-15 04:49:22.208257 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-15 04:49:22.230427 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-15 04:49:22.244952 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-15 04:49:22.366982 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-15 04:49:22.397175 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-15 04:49:22.413557 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-15 04:49:22.666924 (Thread-1): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 04:49:22.667081 (Thread-1): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 04:49:22.667145 (Thread-1): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 04:49:22.667200 (Thread-1): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 04:49:22.667252 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 04:49:22.668042 (Thread-1): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 04:49:22.668380 (Thread-1): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 04:49:22.668686 (Thread-1): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 04:49:22.668955 (Thread-1): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 04:49:22.669221 (Thread-1): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 04:49:22.669484 (Thread-1): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 04:49:22.669747 (Thread-1): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 04:49:22.670008 (Thread-1): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 04:49:22.990613 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 04:49:24.081981 (Thread-8): handling status request
2021-05-15 04:49:24.082433 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7358e7f40>]}
2021-05-15 04:49:24.106151 (Thread-8): sending response (<Response 97516 bytes [200 OK]>) to 10.0.40.42
2021-05-15 05:04:25.904265 (Thread-9): handling status request
2021-05-15 05:04:25.906147 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355fde50>]}
2021-05-15 05:04:25.929743 (Thread-9): sending response (<Response 97516 bytes [200 OK]>) to 10.0.22.198
2021-05-15 05:04:26.738636 (Thread-10): handling run_sql request
2021-05-15 05:04:26.739087 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ddbc70>]}
2021-05-15 05:04:26.741873 (Thread-10): Connection 'model.dbt_date.dates' was properly closed.
2021-05-15 05:04:27.858735 (Thread-10): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.49
2021-05-15 05:04:27.885731 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 05:04:27.910461 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 05:04:27.910929 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 05:04:27.911048 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 05:04:27.929902 (Thread-1): finished collecting timing info
2021-05-15 05:04:27.940221 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 05:04:27.940314 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Month' and f_metric_id='1'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 05:04:27.940374 (Thread-1): Opening a new connection, currently in state init
2021-05-15 05:04:28.400061 (Thread-11): handling poll request
2021-05-15 05:04:28.400570 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744996a60>]}
2021-05-15 05:04:28.405778 (Thread-11): sending response (<Response 15970 bytes [200 OK]>) to 10.0.45.155
2021-05-15 05:04:30.139648 (Thread-12): handling poll request
2021-05-15 05:04:30.140104 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744996cd0>]}
2021-05-15 05:04:30.141043 (Thread-12): sending response (<Response 388 bytes [200 OK]>) to 10.0.1.135
2021-05-15 05:04:30.752707 (Thread-1): SQL status: SUCCESS 0 in 2.81 seconds
2021-05-15 05:04:30.753228 (Thread-1): finished collecting timing info
2021-05-15 05:04:30.753759 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 05:04:31.753141 (Thread-13): handling poll request
2021-05-15 05:04:31.753660 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a9b940>]}
2021-05-15 05:04:31.758239 (Thread-13): sending response (<Response 68837 bytes [200 OK]>) to 10.0.40.42
2021-05-15 05:04:45.949581 (Thread-14): handling status request
2021-05-15 05:04:45.950000 (Thread-14): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f162e0>]}
2021-05-15 05:04:45.977250 (Thread-14): sending response (<Response 97516 bytes [200 OK]>) to 10.0.40.42
2021-05-15 05:04:46.866980 (Thread-15): handling run_sql request
2021-05-15 05:04:46.867417 (Thread-15): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f16df0>]}
2021-05-15 05:04:48.068478 (Thread-15): sending response (<Response 137 bytes [200 OK]>) to 10.0.1.135
2021-05-15 05:04:48.069304 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 05:04:48.099562 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 05:04:48.100071 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 05:04:48.100184 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 05:04:48.116360 (Thread-1): finished collecting timing info
2021-05-15 05:04:48.127434 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 05:04:48.127531 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='M' and f_metric_id='1'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 05:04:48.127593 (Thread-1): Opening a new connection, currently in state init
2021-05-15 05:04:48.562438 (Thread-16): handling poll request
2021-05-15 05:04:48.562901 (Thread-16): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359db190>]}
2021-05-15 05:04:48.564964 (Thread-16): sending response (<Response 15966 bytes [200 OK]>) to 10.0.20.29
2021-05-15 05:04:50.025577 (Thread-17): handling poll request
2021-05-15 05:04:50.026024 (Thread-17): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735636fd0>]}
2021-05-15 05:04:50.026936 (Thread-17): sending response (<Response 388 bytes [200 OK]>) to 10.0.20.29
2021-05-15 05:04:51.492095 (Thread-18): handling poll request
2021-05-15 05:04:51.492525 (Thread-18): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735636e80>]}
2021-05-15 05:04:51.493432 (Thread-18): sending response (<Response 388 bytes [200 OK]>) to 10.0.18.95
2021-05-15 05:04:53.062351 (Thread-19): handling poll request
2021-05-15 05:04:53.062788 (Thread-19): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359c5b50>]}
2021-05-15 05:04:53.063754 (Thread-19): sending response (<Response 388 bytes [200 OK]>) to 10.0.17.122
2021-05-15 05:04:54.578478 (Thread-20): handling poll request
2021-05-15 05:04:54.578931 (Thread-20): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359c51f0>]}
2021-05-15 05:04:54.579815 (Thread-20): sending response (<Response 388 bytes [200 OK]>) to 10.0.40.42
2021-05-15 05:04:55.145781 (Thread-1): SQL status: SUCCESS 37 in 7.02 seconds
2021-05-15 05:04:55.152490 (Thread-1): finished collecting timing info
2021-05-15 05:04:55.152937 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 05:04:56.212207 (Thread-21): handling poll request
2021-05-15 05:04:56.212641 (Thread-21): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355c3280>]}
2021-05-15 05:04:56.217479 (Thread-21): sending response (<Response 74288 bytes [200 OK]>) to 10.0.3.247
2021-05-15 05:07:50.743172 (Thread-22): handling status request
2021-05-15 05:07:50.745487 (Thread-22): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744a06f70>]}
2021-05-15 05:07:50.770029 (Thread-22): sending response (<Response 97516 bytes [200 OK]>) to 10.0.31.167
2021-05-15 05:07:51.605272 (Thread-23): handling run_sql request
2021-05-15 05:07:51.605698 (Thread-23): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f11f10>]}
2021-05-15 05:07:52.644710 (Thread-23): sending response (<Response 137 bytes [200 OK]>) to 10.0.19.219
2021-05-15 05:07:52.666146 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 05:07:52.691356 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 05:07:52.691793 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 05:07:52.691900 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 05:07:52.705368 (Thread-1): finished collecting timing info
2021-05-15 05:07:52.714803 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 05:07:52.714878 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Q' and f_metric_id='1'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 05:07:52.714936 (Thread-1): Opening a new connection, currently in state init
2021-05-15 05:07:53.129239 (Thread-24): handling poll request
2021-05-15 05:07:53.129714 (Thread-24): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f370a0>]}
2021-05-15 05:07:53.131981 (Thread-24): sending response (<Response 15966 bytes [200 OK]>) to 10.0.1.135
2021-05-15 05:07:54.741988 (Thread-25): handling poll request
2021-05-15 05:07:54.742459 (Thread-25): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359db190>]}
2021-05-15 05:07:54.743321 (Thread-25): sending response (<Response 388 bytes [200 OK]>) to 10.0.4.10
2021-05-15 05:07:56.238800 (Thread-26): handling poll request
2021-05-15 05:07:56.239402 (Thread-26): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f37c40>]}
2021-05-15 05:07:56.240310 (Thread-26): sending response (<Response 387 bytes [200 OK]>) to 10.0.46.218
2021-05-15 05:07:57.756005 (Thread-27): handling poll request
2021-05-15 05:07:57.756438 (Thread-27): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356be490>]}
2021-05-15 05:07:57.757361 (Thread-27): sending response (<Response 388 bytes [200 OK]>) to 10.0.3.247
2021-05-15 05:07:58.680772 (Thread-1): SQL status: SUCCESS 13 in 5.97 seconds
2021-05-15 05:07:58.682965 (Thread-1): finished collecting timing info
2021-05-15 05:07:58.683356 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 05:07:59.256913 (Thread-28): handling poll request
2021-05-15 05:07:59.257349 (Thread-28): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356bec10>]}
2021-05-15 05:07:59.261664 (Thread-28): sending response (<Response 70678 bytes [200 OK]>) to 10.0.15.49
2021-05-15 05:09:47.644520 (Thread-29): handling status request
2021-05-15 05:09:47.646501 (Thread-29): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735809130>]}
2021-05-15 05:09:47.671259 (Thread-29): sending response (<Response 97516 bytes [200 OK]>) to 10.0.45.155
2021-05-15 05:09:48.474780 (Thread-30): handling run_sql request
2021-05-15 05:09:48.475317 (Thread-30): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735809670>]}
2021-05-15 05:09:49.657039 (Thread-30): sending response (<Response 137 bytes [200 OK]>) to 10.0.20.29
2021-05-15 05:09:49.678681 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 05:09:49.703531 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 05:09:49.703965 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 05:09:49.704073 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 05:09:49.717521 (Thread-1): finished collecting timing info
2021-05-15 05:09:49.726892 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 05:09:49.726967 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='3'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 05:09:49.727026 (Thread-1): Opening a new connection, currently in state init
2021-05-15 05:09:50.260099 (Thread-31): handling poll request
2021-05-15 05:09:50.260579 (Thread-31): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f107c0>]}
2021-05-15 05:09:50.262745 (Thread-31): sending response (<Response 15966 bytes [200 OK]>) to 10.0.40.42
2021-05-15 05:09:51.769130 (Thread-32): handling poll request
2021-05-15 05:09:51.769553 (Thread-32): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f106d0>]}
2021-05-15 05:09:51.770461 (Thread-32): sending response (<Response 388 bytes [200 OK]>) to 10.0.40.42
2021-05-15 05:09:51.910217 (Thread-1): SQL status: SUCCESS 3 in 2.18 seconds
2021-05-15 05:09:51.912017 (Thread-1): finished collecting timing info
2021-05-15 05:09:51.912401 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 05:09:53.303713 (Thread-33): handling poll request
2021-05-15 05:09:53.304162 (Thread-33): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744904460>]}
2021-05-15 05:09:53.308700 (Thread-33): sending response (<Response 69223 bytes [200 OK]>) to 10.0.40.42
2021-05-15 05:11:04.956367 (Thread-34): handling status request
2021-05-15 05:11:04.958728 (Thread-34): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744904070>]}
2021-05-15 05:11:04.983185 (Thread-34): sending response (<Response 97516 bytes [200 OK]>) to 10.0.46.218
2021-05-15 05:11:05.746768 (Thread-35): handling run_sql request
2021-05-15 05:11:05.747187 (Thread-35): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744904af0>]}
2021-05-15 05:11:06.787500 (Thread-35): sending response (<Response 137 bytes [200 OK]>) to 10.0.34.201
2021-05-15 05:11:06.808778 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 05:11:06.833563 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 05:11:06.834009 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 05:11:06.834115 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 05:11:06.847524 (Thread-1): finished collecting timing info
2021-05-15 05:11:06.857131 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 05:11:06.857204 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='M' and f_metric_id='3'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 05:11:06.857260 (Thread-1): Opening a new connection, currently in state init
2021-05-15 05:11:07.339013 (Thread-36): handling poll request
2021-05-15 05:11:07.339465 (Thread-36): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448cf6a0>]}
2021-05-15 05:11:07.341608 (Thread-36): sending response (<Response 15966 bytes [200 OK]>) to 10.0.15.199
2021-05-15 05:11:08.845924 (Thread-37): handling poll request
2021-05-15 05:11:08.846381 (Thread-37): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448cfa60>]}
2021-05-15 05:11:08.847252 (Thread-37): sending response (<Response 388 bytes [200 OK]>) to 10.0.45.155
2021-05-15 05:11:10.319814 (Thread-38): handling poll request
2021-05-15 05:11:10.320248 (Thread-38): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448cfca0>]}
2021-05-15 05:11:10.321136 (Thread-38): sending response (<Response 388 bytes [200 OK]>) to 10.0.18.95
2021-05-15 05:11:11.806333 (Thread-39): handling poll request
2021-05-15 05:11:11.806767 (Thread-39): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448cfee0>]}
2021-05-15 05:11:11.807641 (Thread-39): sending response (<Response 388 bytes [200 OK]>) to 10.0.45.155
2021-05-15 05:11:13.260774 (Thread-40): handling poll request
2021-05-15 05:11:13.261494 (Thread-40): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448cffd0>]}
2021-05-15 05:11:13.262687 (Thread-40): sending response (<Response 388 bytes [200 OK]>) to 10.0.22.198
2021-05-15 05:11:14.739319 (Thread-1): SQL status: SUCCESS 36 in 7.88 seconds
2021-05-15 05:11:14.742723 (Thread-1): finished collecting timing info
2021-05-15 05:11:14.743128 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 05:11:14.786594 (Thread-41): handling poll request
2021-05-15 05:11:14.787046 (Thread-41): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448cfaf0>]}
2021-05-15 05:11:14.788167 (Thread-41): sending response (<Response 1327 bytes [200 OK]>) to 10.0.6.126
2021-05-15 05:11:16.261716 (Thread-42): handling poll request
2021-05-15 05:11:16.262156 (Thread-42): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448dc6d0>]}
2021-05-15 05:11:16.268161 (Thread-42): sending response (<Response 72865 bytes [200 OK]>) to 10.0.22.198
2021-05-15 06:00:35.873934 (Thread-43): handling status request
2021-05-15 06:00:35.875998 (Thread-43): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448cf760>]}
2021-05-15 06:00:35.900506 (Thread-43): sending response (<Response 97516 bytes [200 OK]>) to 10.0.20.29
2021-05-15 06:00:36.743740 (Thread-44): handling run_sql request
2021-05-15 06:00:36.744158 (Thread-44): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448cf370>]}
2021-05-15 06:00:37.750819 (Thread-44): sending response (<Response 137 bytes [200 OK]>) to 10.0.45.155
2021-05-15 06:00:37.771868 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:00:37.796262 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 06:00:37.796688 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:00:37.796795 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 06:00:37.810229 (Thread-1): finished collecting timing info
2021-05-15 06:00:37.819537 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 06:00:37.819610 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='3'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 06:00:37.819669 (Thread-1): Opening a new connection, currently in state init
2021-05-15 06:00:38.260358 (Thread-45): handling poll request
2021-05-15 06:00:38.260868 (Thread-45): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448dc370>]}
2021-05-15 06:00:38.263015 (Thread-45): sending response (<Response 15966 bytes [200 OK]>) to 10.0.3.247
2021-05-15 06:00:39.805450 (Thread-46): handling poll request
2021-05-15 06:00:39.805907 (Thread-46): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448dc970>]}
2021-05-15 06:00:39.806851 (Thread-46): sending response (<Response 388 bytes [200 OK]>) to 10.0.36.138
2021-05-15 06:00:40.915505 (Thread-1): SQL status: SUCCESS 3 in 3.10 seconds
2021-05-15 06:00:40.917286 (Thread-1): finished collecting timing info
2021-05-15 06:00:40.917661 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 06:00:41.815015 (Thread-47): handling poll request
2021-05-15 06:00:41.815454 (Thread-47): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448dcd00>]}
2021-05-15 06:00:41.819645 (Thread-47): sending response (<Response 69223 bytes [200 OK]>) to 10.0.31.167
2021-05-15 06:05:50.035554 (Thread-48): handling status request
2021-05-15 06:05:50.037672 (Thread-48): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448dc100>]}
2021-05-15 06:05:50.062287 (Thread-48): sending response (<Response 97516 bytes [200 OK]>) to 10.0.41.124
2021-05-15 06:05:50.844628 (Thread-49): handling run_sql request
2021-05-15 06:05:50.845055 (Thread-49): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448dcdf0>]}
2021-05-15 06:05:52.073702 (Thread-49): sending response (<Response 137 bytes [200 OK]>) to 10.0.22.198
2021-05-15 06:05:52.099639 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:05:52.125886 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 06:05:52.126467 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:05:52.126591 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 06:05:52.142549 (Thread-1): finished collecting timing info
2021-05-15 06:05:52.154777 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 06:05:52.154884 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='4'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 06:05:52.154948 (Thread-1): Opening a new connection, currently in state init
2021-05-15 06:05:52.519751 (Thread-50): handling poll request
2021-05-15 06:05:52.520265 (Thread-50): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448d9970>]}
2021-05-15 06:05:52.522430 (Thread-50): sending response (<Response 15966 bytes [200 OK]>) to 10.0.18.95
2021-05-15 06:05:54.354613 (Thread-51): handling poll request
2021-05-15 06:05:54.355113 (Thread-51): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448d9d00>]}
2021-05-15 06:05:54.356029 (Thread-51): sending response (<Response 388 bytes [200 OK]>) to 10.0.45.155
2021-05-15 06:05:55.783863 (Thread-52): handling poll request
2021-05-15 06:05:55.784293 (Thread-52): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448d9fa0>]}
2021-05-15 06:05:55.785174 (Thread-52): sending response (<Response 388 bytes [200 OK]>) to 10.0.22.198
2021-05-15 06:05:57.274891 (Thread-53): handling poll request
2021-05-15 06:05:57.275319 (Thread-53): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448d9bb0>]}
2021-05-15 06:05:57.276281 (Thread-53): sending response (<Response 388 bytes [200 OK]>) to 10.0.41.124
2021-05-15 06:05:58.804301 (Thread-54): handling poll request
2021-05-15 06:05:58.804721 (Thread-54): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744876400>]}
2021-05-15 06:05:58.805580 (Thread-54): sending response (<Response 388 bytes [200 OK]>) to 10.0.46.218
2021-05-15 06:05:59.844573 (Thread-1): SQL status: SUCCESS 3 in 7.69 seconds
2021-05-15 06:05:59.847440 (Thread-1): finished collecting timing info
2021-05-15 06:05:59.847950 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 06:06:00.309789 (Thread-55): handling poll request
2021-05-15 06:06:00.310245 (Thread-55): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744876640>]}
2021-05-15 06:06:00.316159 (Thread-55): sending response (<Response 69220 bytes [200 OK]>) to 10.0.45.155
2021-05-15 06:24:26.273331 (Thread-56): handling status request
2021-05-15 06:24:26.275664 (Thread-56): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744876c10>]}
2021-05-15 06:24:26.300169 (Thread-56): sending response (<Response 97516 bytes [200 OK]>) to 10.0.45.155
2021-05-15 06:24:27.172257 (Thread-57): handling run_sql request
2021-05-15 06:24:27.172696 (Thread-57): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744876d30>]}
2021-05-15 06:24:28.230110 (Thread-57): sending response (<Response 137 bytes [200 OK]>) to 10.0.17.122
2021-05-15 06:24:28.251881 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:24:28.276466 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 06:24:28.276896 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:24:28.277004 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 06:24:28.290446 (Thread-1): finished collecting timing info
2021-05-15 06:24:28.298820 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 06:24:28.298897 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Y' and f_metric_id= 7
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 06:24:28.298965 (Thread-1): Opening a new connection, currently in state init
2021-05-15 06:24:28.720094 (Thread-58): handling poll request
2021-05-15 06:24:28.720558 (Thread-58): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448d9580>]}
2021-05-15 06:24:28.722688 (Thread-58): sending response (<Response 14178 bytes [200 OK]>) to 10.0.15.49
2021-05-15 06:24:30.229247 (Thread-59): handling poll request
2021-05-15 06:24:30.229695 (Thread-59): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448842b0>]}
2021-05-15 06:24:30.230627 (Thread-59): sending response (<Response 398 bytes [200 OK]>) to 10.0.3.247
2021-05-15 06:24:31.668552 (Thread-60): handling poll request
2021-05-15 06:24:31.668992 (Thread-60): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448844f0>]}
2021-05-15 06:24:31.789915 (Thread-60): sending response (<Response 397 bytes [200 OK]>) to 10.0.19.219
2021-05-15 06:24:33.308888 (Thread-61): handling poll request
2021-05-15 06:24:33.309331 (Thread-61): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744884ac0>]}
2021-05-15 06:24:33.310238 (Thread-61): sending response (<Response 398 bytes [200 OK]>) to 10.0.45.155
2021-05-15 06:24:34.905734 (Thread-62): handling poll request
2021-05-15 06:24:34.906156 (Thread-62): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744884be0>]}
2021-05-15 06:24:34.907031 (Thread-62): sending response (<Response 398 bytes [200 OK]>) to 10.0.3.247
2021-05-15 06:24:35.604052 (Thread-1): SQL status: SUCCESS 500 in 7.31 seconds
2021-05-15 06:24:35.631951 (Thread-1): finished collecting timing info
2021-05-15 06:24:35.632381 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 06:24:36.972706 (Thread-63): handling poll request
2021-05-15 06:24:36.973198 (Thread-63): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448d5160>]}
2021-05-15 06:24:36.983424 (Thread-63): sending response (<Response 151175 bytes [200 OK]>) to 10.0.22.198
2021-05-15 06:40:38.150821 (Thread-64): handling status request
2021-05-15 06:40:38.152902 (Thread-64): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744987490>]}
2021-05-15 06:40:38.177158 (Thread-64): sending response (<Response 97516 bytes [200 OK]>) to 10.0.1.135
2021-05-15 06:40:38.954765 (Thread-65): handling run_sql request
2021-05-15 06:40:38.955188 (Thread-65): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448d5040>]}
2021-05-15 06:40:39.968457 (Thread-65): sending response (<Response 137 bytes [200 OK]>) to 10.0.31.167
2021-05-15 06:40:39.990082 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:40:40.014890 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 06:40:40.015363 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:40:40.015473 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 06:40:40.029042 (Thread-1): finished collecting timing info
2021-05-15 06:40:40.038585 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 06:40:40.038671 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='10'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 06:40:40.038731 (Thread-1): Opening a new connection, currently in state init
2021-05-15 06:40:40.437507 (Thread-66): handling poll request
2021-05-15 06:40:40.437977 (Thread-66): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7449067f0>]}
2021-05-15 06:40:40.440107 (Thread-66): sending response (<Response 15967 bytes [200 OK]>) to 10.0.4.10
2021-05-15 06:40:41.179019 (Thread-1): SQL status: SUCCESS 3 in 1.14 seconds
2021-05-15 06:40:41.180821 (Thread-1): finished collecting timing info
2021-05-15 06:40:41.181205 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 06:40:42.232055 (Thread-67): handling poll request
2021-05-15 06:40:42.232473 (Thread-67): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744906d30>]}
2021-05-15 06:40:42.236865 (Thread-67): sending response (<Response 69275 bytes [200 OK]>) to 10.0.40.42
2021-05-15 06:43:38.510380 (Thread-68): handling status request
2021-05-15 06:43:38.512445 (Thread-68): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7449061f0>]}
2021-05-15 06:43:38.537016 (Thread-68): sending response (<Response 97516 bytes [200 OK]>) to 10.0.19.219
2021-05-15 06:43:39.363161 (Thread-69): handling run_sql request
2021-05-15 06:43:39.363595 (Thread-69): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7449068b0>]}
2021-05-15 06:43:40.388430 (Thread-69): sending response (<Response 137 bytes [200 OK]>) to 10.0.31.167
2021-05-15 06:43:40.410074 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:43:40.435124 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 06:43:40.435609 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:43:40.435717 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 06:43:40.449389 (Thread-1): finished collecting timing info
2021-05-15 06:43:40.457918 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 06:43:40.458005 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='M' and f_metric_id= 7
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 06:43:40.458065 (Thread-1): Opening a new connection, currently in state init
2021-05-15 06:43:40.887784 (Thread-70): handling poll request
2021-05-15 06:43:40.888247 (Thread-70): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448a5550>]}
2021-05-15 06:43:40.890406 (Thread-70): sending response (<Response 14178 bytes [200 OK]>) to 10.0.34.201
2021-05-15 06:43:42.469490 (Thread-71): handling poll request
2021-05-15 06:43:42.469905 (Thread-71): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448a59a0>]}
2021-05-15 06:43:42.470802 (Thread-71): sending response (<Response 398 bytes [200 OK]>) to 10.0.17.122
2021-05-15 06:43:44.034863 (Thread-72): handling poll request
2021-05-15 06:43:44.035295 (Thread-72): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448a5850>]}
2021-05-15 06:43:44.036164 (Thread-72): sending response (<Response 398 bytes [200 OK]>) to 10.0.45.155
2021-05-15 06:43:45.660065 (Thread-73): handling poll request
2021-05-15 06:43:45.660483 (Thread-73): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448a5af0>]}
2021-05-15 06:43:45.661335 (Thread-73): sending response (<Response 398 bytes [200 OK]>) to 10.0.40.42
2021-05-15 06:43:47.185325 (Thread-74): handling poll request
2021-05-15 06:43:47.185754 (Thread-74): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb74490c520>]}
2021-05-15 06:43:47.186692 (Thread-74): sending response (<Response 398 bytes [200 OK]>) to 10.0.36.138
2021-05-15 06:43:47.524231 (Thread-1): SQL status: SUCCESS 500 in 7.07 seconds
2021-05-15 06:43:47.548877 (Thread-1): finished collecting timing info
2021-05-15 06:43:47.549277 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 06:43:48.674133 (Thread-75): handling poll request
2021-05-15 06:43:48.674592 (Thread-75): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb74490c430>]}
2021-05-15 06:43:48.683443 (Thread-75): sending response (<Response 150604 bytes [200 OK]>) to 10.0.19.219
2021-05-15 06:44:06.282290 (Thread-76): handling status request
2021-05-15 06:44:06.282719 (Thread-76): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355bb9d0>]}
2021-05-15 06:44:06.306012 (Thread-76): sending response (<Response 97516 bytes [200 OK]>) to 10.0.19.219
2021-05-15 06:44:07.094120 (Thread-77): handling run_sql request
2021-05-15 06:44:07.094571 (Thread-77): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355bbf40>]}
2021-05-15 06:44:08.110908 (Thread-77): sending response (<Response 137 bytes [200 OK]>) to 10.0.31.167
2021-05-15 06:44:08.132292 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:44:08.155485 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 06:44:08.155920 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:44:08.156029 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 06:44:08.169542 (Thread-1): finished collecting timing info
2021-05-15 06:44:08.177936 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 06:44:08.178022 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Q' and f_metric_id= 7
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 06:44:08.178080 (Thread-1): Opening a new connection, currently in state init
2021-05-15 06:44:08.671446 (Thread-78): handling poll request
2021-05-15 06:44:08.671940 (Thread-78): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735eb5220>]}
2021-05-15 06:44:08.674083 (Thread-78): sending response (<Response 14178 bytes [200 OK]>) to 10.0.31.167
2021-05-15 06:44:10.154208 (Thread-79): handling poll request
2021-05-15 06:44:10.154645 (Thread-79): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735eb5400>]}
2021-05-15 06:44:10.155524 (Thread-79): sending response (<Response 398 bytes [200 OK]>) to 10.0.18.95
2021-05-15 06:44:12.140449 (Thread-80): handling poll request
2021-05-15 06:44:12.140877 (Thread-80): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735eb5070>]}
2021-05-15 06:44:12.141777 (Thread-80): sending response (<Response 398 bytes [200 OK]>) to 10.0.1.135
2021-05-15 06:44:13.611234 (Thread-81): handling poll request
2021-05-15 06:44:13.611642 (Thread-81): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735eb5bb0>]}
2021-05-15 06:44:13.612475 (Thread-81): sending response (<Response 397 bytes [200 OK]>) to 10.0.36.138
2021-05-15 06:44:14.150734 (Thread-1): SQL status: SUCCESS 500 in 5.97 seconds
2021-05-15 06:44:14.173384 (Thread-1): finished collecting timing info
2021-05-15 06:44:14.173793 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 06:44:15.177269 (Thread-82): handling poll request
2021-05-15 06:44:15.177700 (Thread-82): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb74490c400>]}
2021-05-15 06:44:15.187173 (Thread-82): sending response (<Response 149456 bytes [200 OK]>) to 10.0.45.155
2021-05-15 06:44:42.860766 (Thread-83): handling status request
2021-05-15 06:44:42.861188 (Thread-83): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb74490c1c0>]}
2021-05-15 06:44:42.885934 (Thread-83): sending response (<Response 97516 bytes [200 OK]>) to 10.0.3.247
2021-05-15 06:44:43.751907 (Thread-84): handling run_sql request
2021-05-15 06:44:43.752341 (Thread-84): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb74490c2e0>]}
2021-05-15 06:44:44.788630 (Thread-84): sending response (<Response 137 bytes [200 OK]>) to 10.0.36.138
2021-05-15 06:44:44.810783 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:44:44.839661 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 06:44:44.840457 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:44:44.840592 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 06:44:44.855324 (Thread-1): finished collecting timing info
2021-05-15 06:44:44.864074 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 06:44:44.864177 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Y' and f_metric_id= 18
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 06:44:44.864238 (Thread-1): Opening a new connection, currently in state init
2021-05-15 06:44:45.307499 (Thread-85): handling poll request
2021-05-15 06:44:45.307959 (Thread-85): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448d56d0>]}
2021-05-15 06:44:45.310065 (Thread-85): sending response (<Response 14179 bytes [200 OK]>) to 10.0.19.219
2021-05-15 06:44:46.887358 (Thread-86): handling poll request
2021-05-15 06:44:46.887775 (Thread-86): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7449049a0>]}
2021-05-15 06:44:46.888633 (Thread-86): sending response (<Response 398 bytes [200 OK]>) to 10.0.41.124
2021-05-15 06:44:48.407199 (Thread-87): handling poll request
2021-05-15 06:44:48.407636 (Thread-87): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744904100>]}
2021-05-15 06:44:48.408495 (Thread-87): sending response (<Response 397 bytes [200 OK]>) to 10.0.31.167
2021-05-15 06:44:49.905789 (Thread-88): handling poll request
2021-05-15 06:44:49.906214 (Thread-88): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744904940>]}
2021-05-15 06:44:49.907086 (Thread-88): sending response (<Response 398 bytes [200 OK]>) to 10.0.18.95
2021-05-15 06:44:51.266369 (Thread-1): SQL status: SUCCESS 135 in 6.40 seconds
2021-05-15 06:44:51.275381 (Thread-1): finished collecting timing info
2021-05-15 06:44:51.275777 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 06:44:51.921693 (Thread-89): handling poll request
2021-05-15 06:44:51.922162 (Thread-89): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744904490>]}
2021-05-15 06:44:51.928878 (Thread-89): sending response (<Response 82439 bytes [200 OK]>) to 10.0.45.155
2021-05-15 06:56:05.007465 (Thread-90): handling status request
2021-05-15 06:56:05.009832 (Thread-90): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744904130>]}
2021-05-15 06:56:05.154125 (Thread-90): sending response (<Response 97516 bytes [200 OK]>) to 10.0.6.126
2021-05-15 06:56:05.967173 (Thread-91): handling run_sql request
2021-05-15 06:56:05.967603 (Thread-91): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744906670>]}
2021-05-15 06:56:06.997464 (Thread-91): sending response (<Response 137 bytes [200 OK]>) to 10.0.41.124
2021-05-15 06:56:07.018750 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:56:07.043429 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 06:56:07.043892 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 06:56:07.044004 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 06:56:07.057448 (Thread-1): finished collecting timing info
2021-05-15 06:56:07.065820 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 06:56:07.065897 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Y' and f_metric_id= 19
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 06:56:07.065965 (Thread-1): Opening a new connection, currently in state init
2021-05-15 06:56:07.542882 (Thread-92): handling poll request
2021-05-15 06:56:07.543377 (Thread-92): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73574e0d0>]}
2021-05-15 06:56:07.545526 (Thread-92): sending response (<Response 14219 bytes [200 OK]>) to 10.0.15.49
2021-05-15 06:56:09.065879 (Thread-93): handling poll request
2021-05-15 06:56:09.066327 (Thread-93): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73574e580>]}
2021-05-15 06:56:09.067204 (Thread-93): sending response (<Response 398 bytes [200 OK]>) to 10.0.45.155
2021-05-15 06:56:10.705361 (Thread-94): handling poll request
2021-05-15 06:56:10.705808 (Thread-94): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73574e8b0>]}
2021-05-15 06:56:10.706734 (Thread-94): sending response (<Response 398 bytes [200 OK]>) to 10.0.15.199
2021-05-15 06:56:12.173250 (Thread-95): handling poll request
2021-05-15 06:56:12.173695 (Thread-95): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a4f3a0>]}
2021-05-15 06:56:12.174588 (Thread-95): sending response (<Response 398 bytes [200 OK]>) to 10.0.15.49
2021-05-15 06:56:13.850400 (Thread-96): handling poll request
2021-05-15 06:56:13.850854 (Thread-96): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a4f5b0>]}
2021-05-15 06:56:13.851740 (Thread-96): sending response (<Response 398 bytes [200 OK]>) to 10.0.40.42
2021-05-15 06:56:15.340694 (Thread-97): handling poll request
2021-05-15 06:56:15.341135 (Thread-97): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a4f940>]}
2021-05-15 06:56:15.342032 (Thread-97): sending response (<Response 398 bytes [200 OK]>) to 10.0.36.138
2021-05-15 06:56:15.985696 (Thread-1): SQL status: SUCCESS 16 in 8.92 seconds
2021-05-15 06:56:15.988280 (Thread-1): finished collecting timing info
2021-05-15 06:56:15.988667 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 06:56:17.352251 (Thread-98): handling poll request
2021-05-15 06:56:17.352719 (Thread-98): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a4f130>]}
2021-05-15 06:56:17.357284 (Thread-98): sending response (<Response 62630 bytes [200 OK]>) to 10.0.4.10
2021-05-15 07:01:34.866253 (Thread-99): handling status request
2021-05-15 07:01:34.868283 (Thread-99): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a4f8b0>]}
2021-05-15 07:01:34.896697 (Thread-99): sending response (<Response 97516 bytes [200 OK]>) to 10.0.17.122
2021-05-15 07:01:35.649321 (Thread-100): handling run_sql request
2021-05-15 07:01:35.649838 (Thread-100): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73574e2b0>]}
2021-05-15 07:01:36.713712 (Thread-100): sending response (<Response 137 bytes [200 OK]>) to 10.0.22.198
2021-05-15 07:01:36.735545 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:01:36.760372 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 07:01:36.760822 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:01:36.760928 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 07:01:36.775031 (Thread-1): finished collecting timing info
2021-05-15 07:01:36.784352 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 07:01:36.784437 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='27'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 07:01:36.784496 (Thread-1): Opening a new connection, currently in state init
2021-05-15 07:01:37.163534 (Thread-101): handling poll request
2021-05-15 07:01:37.164006 (Thread-101): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735cfa6a0>]}
2021-05-15 07:01:37.166288 (Thread-101): sending response (<Response 15967 bytes [200 OK]>) to 10.0.22.198
2021-05-15 07:01:38.709516 (Thread-102): handling poll request
2021-05-15 07:01:38.709944 (Thread-102): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735cfa310>]}
2021-05-15 07:01:38.710867 (Thread-102): sending response (<Response 388 bytes [200 OK]>) to 10.0.15.199
2021-05-15 07:01:40.234466 (Thread-103): handling poll request
2021-05-15 07:01:40.234911 (Thread-103): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735cfa8b0>]}
2021-05-15 07:01:40.235853 (Thread-103): sending response (<Response 388 bytes [200 OK]>) to 10.0.18.95
2021-05-15 07:01:42.388136 (Thread-104): handling poll request
2021-05-15 07:01:42.388637 (Thread-104): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7358d8ac0>]}
2021-05-15 07:01:42.389511 (Thread-104): sending response (<Response 388 bytes [200 OK]>) to 10.0.41.124
2021-05-15 07:01:43.905589 (Thread-105): handling poll request
2021-05-15 07:01:43.906009 (Thread-105): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7358d8400>]}
2021-05-15 07:01:43.906935 (Thread-105): sending response (<Response 388 bytes [200 OK]>) to 10.0.34.201
2021-05-15 07:01:44.584850 (Thread-1): SQL status: SUCCESS 3 in 7.80 seconds
2021-05-15 07:01:44.586937 (Thread-1): finished collecting timing info
2021-05-15 07:01:44.587341 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 07:01:45.458353 (Thread-106): handling poll request
2021-05-15 07:01:45.458797 (Thread-106): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356cff10>]}
2021-05-15 07:01:45.463122 (Thread-106): sending response (<Response 69225 bytes [200 OK]>) to 10.0.46.218
2021-05-15 07:02:07.860144 (Thread-107): handling status request
2021-05-15 07:02:07.860587 (Thread-107): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356ecca0>]}
2021-05-15 07:02:07.885931 (Thread-107): sending response (<Response 97516 bytes [200 OK]>) to 10.0.45.155
2021-05-15 07:02:08.724382 (Thread-108): handling run_sql request
2021-05-15 07:02:08.724797 (Thread-108): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7358d8520>]}
2021-05-15 07:02:09.867214 (Thread-108): sending response (<Response 137 bytes [200 OK]>) to 10.0.40.42
2021-05-15 07:02:09.857170 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:02:09.890794 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 07:02:09.891339 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:02:09.891458 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 07:02:09.906067 (Thread-1): finished collecting timing info
2021-05-15 07:02:09.916422 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 07:02:09.916525 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='M' and f_metric_id='27'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 07:02:09.916595 (Thread-1): Opening a new connection, currently in state init
2021-05-15 07:02:10.408778 (Thread-109): handling poll request
2021-05-15 07:02:10.409285 (Thread-109): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356ec3d0>]}
2021-05-15 07:02:10.411512 (Thread-109): sending response (<Response 15967 bytes [200 OK]>) to 10.0.15.199
2021-05-15 07:02:12.484066 (Thread-110): handling poll request
2021-05-15 07:02:12.484543 (Thread-110): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356ecf40>]}
2021-05-15 07:02:12.485426 (Thread-110): sending response (<Response 388 bytes [200 OK]>) to 10.0.17.122
2021-05-15 07:02:14.000043 (Thread-111): handling poll request
2021-05-15 07:02:14.000528 (Thread-111): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356ecb80>]}
2021-05-15 07:02:14.001396 (Thread-111): sending response (<Response 388 bytes [200 OK]>) to 10.0.20.29
2021-05-15 07:02:15.485352 (Thread-112): handling poll request
2021-05-15 07:02:15.485771 (Thread-112): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356ec790>]}
2021-05-15 07:02:15.486678 (Thread-112): sending response (<Response 388 bytes [200 OK]>) to 10.0.1.135
2021-05-15 07:02:16.043474 (Thread-1): SQL status: SUCCESS 36 in 6.13 seconds
2021-05-15 07:02:16.049011 (Thread-1): finished collecting timing info
2021-05-15 07:02:16.049542 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 07:02:17.540960 (Thread-113): handling poll request
2021-05-15 07:02:17.541406 (Thread-113): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f5d8e0>]}
2021-05-15 07:02:17.545943 (Thread-113): sending response (<Response 73818 bytes [200 OK]>) to 10.0.1.135
2021-05-15 07:02:43.948746 (Thread-114): handling status request
2021-05-15 07:02:43.949179 (Thread-114): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f5ddc0>]}
2021-05-15 07:02:43.974401 (Thread-114): sending response (<Response 97516 bytes [200 OK]>) to 10.0.40.42
2021-05-15 07:02:44.874563 (Thread-115): handling run_sql request
2021-05-15 07:02:44.874993 (Thread-115): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f5dac0>]}
2021-05-15 07:02:45.958559 (Thread-115): sending response (<Response 137 bytes [200 OK]>) to 10.0.41.124
2021-05-15 07:02:45.980730 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:02:46.006311 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 07:02:46.006762 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:02:46.006871 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 07:02:46.020589 (Thread-1): finished collecting timing info
2021-05-15 07:02:46.030626 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 07:02:46.030727 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Q' and f_metric_id='27'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 07:02:46.030788 (Thread-1): Opening a new connection, currently in state init
2021-05-15 07:02:46.473417 (Thread-116): handling poll request
2021-05-15 07:02:46.473881 (Thread-116): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359e7b80>]}
2021-05-15 07:02:46.476100 (Thread-116): sending response (<Response 15967 bytes [200 OK]>) to 10.0.34.201
2021-05-15 07:02:48.053614 (Thread-117): handling poll request
2021-05-15 07:02:48.054288 (Thread-117): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359e7bb0>]}
2021-05-15 07:02:48.055620 (Thread-117): sending response (<Response 388 bytes [200 OK]>) to 10.0.19.219
2021-05-15 07:02:49.593242 (Thread-118): handling poll request
2021-05-15 07:02:49.593658 (Thread-118): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359e7df0>]}
2021-05-15 07:02:49.594578 (Thread-118): sending response (<Response 388 bytes [200 OK]>) to 10.0.6.126
2021-05-15 07:02:51.887068 (Thread-119): handling poll request
2021-05-15 07:02:51.887644 (Thread-119): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359e7a00>]}
2021-05-15 07:02:51.888849 (Thread-119): sending response (<Response 388 bytes [200 OK]>) to 10.0.41.124
2021-05-15 07:02:52.068710 (Thread-1): SQL status: SUCCESS 12 in 6.04 seconds
2021-05-15 07:02:52.072301 (Thread-1): finished collecting timing info
2021-05-15 07:02:52.072828 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 07:02:53.400053 (Thread-120): handling poll request
2021-05-15 07:02:53.400492 (Thread-120): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359e72e0>]}
2021-05-15 07:02:53.532671 (Thread-120): sending response (<Response 70432 bytes [200 OK]>) to 10.0.45.155
2021-05-15 07:04:08.644381 (Thread-121): handling status request
2021-05-15 07:04:08.644820 (Thread-121): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d70400>]}
2021-05-15 07:04:08.670084 (Thread-121): sending response (<Response 97516 bytes [200 OK]>) to 10.0.45.155
2021-05-15 07:04:09.475379 (Thread-122): handling run_sql request
2021-05-15 07:04:09.475792 (Thread-122): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d70640>]}
2021-05-15 07:04:10.556974 (Thread-122): sending response (<Response 137 bytes [200 OK]>) to 10.0.40.42
2021-05-15 07:04:10.577407 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:04:10.601997 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 07:04:10.602472 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:04:10.602580 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 07:04:10.616311 (Thread-1): finished collecting timing info
2021-05-15 07:04:10.624847 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 07:04:10.624923 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Y' and f_metric_id= 28
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 07:04:10.624980 (Thread-1): Opening a new connection, currently in state init
2021-05-15 07:04:11.046791 (Thread-123): handling poll request
2021-05-15 07:04:11.047288 (Thread-123): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7449046d0>]}
2021-05-15 07:04:11.049412 (Thread-123): sending response (<Response 14220 bytes [200 OK]>) to 10.0.17.122
2021-05-15 07:04:12.529386 (Thread-124): handling poll request
2021-05-15 07:04:12.529875 (Thread-124): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735cfa070>]}
2021-05-15 07:04:12.530820 (Thread-124): sending response (<Response 398 bytes [200 OK]>) to 10.0.31.167
2021-05-15 07:04:14.055412 (Thread-125): handling poll request
2021-05-15 07:04:14.055833 (Thread-125): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356bbc70>]}
2021-05-15 07:04:14.056703 (Thread-125): sending response (<Response 398 bytes [200 OK]>) to 10.0.41.124
2021-05-15 07:04:15.564849 (Thread-126): handling poll request
2021-05-15 07:04:15.565250 (Thread-126): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73591cb20>]}
2021-05-15 07:04:15.566116 (Thread-126): sending response (<Response 398 bytes [200 OK]>) to 10.0.17.122
2021-05-15 07:04:17.058359 (Thread-127): handling poll request
2021-05-15 07:04:17.058800 (Thread-127): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73591ca60>]}
2021-05-15 07:04:17.059682 (Thread-127): sending response (<Response 397 bytes [200 OK]>) to 10.0.19.219
2021-05-15 07:04:18.623466 (Thread-128): handling poll request
2021-05-15 07:04:18.623895 (Thread-128): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73591c0a0>]}
2021-05-15 07:04:18.624775 (Thread-128): sending response (<Response 398 bytes [200 OK]>) to 10.0.36.138
2021-05-15 07:04:19.084442 (Thread-1): SQL status: SUCCESS 0 in 8.46 seconds
2021-05-15 07:04:19.084853 (Thread-1): finished collecting timing info
2021-05-15 07:04:19.085223 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 07:04:20.129448 (Thread-129): handling poll request
2021-05-15 07:04:20.129879 (Thread-129): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73591ccd0>]}
2021-05-15 07:04:20.134447 (Thread-129): sending response (<Response 60084 bytes [200 OK]>) to 10.0.18.95
2021-05-15 07:24:44.459177 (Thread-130): handling status request
2021-05-15 07:24:44.461112 (Thread-130): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73591caf0>]}
2021-05-15 07:24:44.486287 (Thread-130): sending response (<Response 97516 bytes [200 OK]>) to 10.0.45.155
2021-05-15 07:24:45.318516 (Thread-131): handling run_sql request
2021-05-15 07:24:45.318932 (Thread-131): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73591c370>]}
2021-05-15 07:24:46.325491 (Thread-131): sending response (<Response 137 bytes [200 OK]>) to 10.0.20.29
2021-05-15 07:24:46.346962 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:24:46.372321 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 07:24:46.372788 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:24:46.372896 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 07:24:46.386521 (Thread-1): finished collecting timing info
2021-05-15 07:24:46.395910 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 07:24:46.395998 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Y' and f_metric_id='29'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 07:24:46.396058 (Thread-1): Opening a new connection, currently in state init
2021-05-15 07:24:46.900374 (Thread-132): handling poll request
2021-05-15 07:24:46.900817 (Thread-132): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad1760>]}
2021-05-15 07:24:46.902971 (Thread-132): sending response (<Response 15967 bytes [200 OK]>) to 10.0.34.201
2021-05-15 07:24:48.440285 (Thread-133): handling poll request
2021-05-15 07:24:48.440709 (Thread-133): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad1bb0>]}
2021-05-15 07:24:48.441620 (Thread-133): sending response (<Response 388 bytes [200 OK]>) to 10.0.15.199
2021-05-15 07:24:49.981633 (Thread-134): handling poll request
2021-05-15 07:24:49.982054 (Thread-134): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad19a0>]}
2021-05-15 07:24:49.982930 (Thread-134): sending response (<Response 388 bytes [200 OK]>) to 10.0.18.95
2021-05-15 07:24:51.983547 (Thread-135): handling poll request
2021-05-15 07:24:51.984047 (Thread-135): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744904310>]}
2021-05-15 07:24:51.984979 (Thread-135): sending response (<Response 388 bytes [200 OK]>) to 10.0.20.29
2021-05-15 07:24:53.472958 (Thread-136): handling poll request
2021-05-15 07:24:53.473493 (Thread-136): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7449048b0>]}
2021-05-15 07:24:53.474426 (Thread-136): sending response (<Response 388 bytes [200 OK]>) to 10.0.34.201
2021-05-15 07:24:53.941912 (Thread-1): SQL status: SUCCESS 3 in 7.55 seconds
2021-05-15 07:24:53.943747 (Thread-1): finished collecting timing info
2021-05-15 07:24:53.944135 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 07:24:55.003012 (Thread-137): handling poll request
2021-05-15 07:24:55.003441 (Thread-137): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad1580>]}
2021-05-15 07:24:55.007645 (Thread-137): sending response (<Response 69237 bytes [200 OK]>) to 10.0.4.10
2021-05-15 07:29:53.093412 (Thread-138): handling status request
2021-05-15 07:29:53.095732 (Thread-138): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d54310>]}
2021-05-15 07:29:53.120540 (Thread-138): sending response (<Response 97516 bytes [200 OK]>) to 10.0.15.49
2021-05-15 07:29:54.042042 (Thread-139): handling run_sql request
2021-05-15 07:29:54.042498 (Thread-139): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad1400>]}
2021-05-15 07:29:55.059810 (Thread-139): sending response (<Response 137 bytes [200 OK]>) to 10.0.3.247
2021-05-15 07:29:55.081630 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:29:55.108116 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 07:29:55.108615 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:29:55.108729 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 07:29:55.122475 (Thread-1): finished collecting timing info
2021-05-15 07:29:55.131973 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 07:29:55.132051 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='M' and f_metric_id='29'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 07:29:55.132110 (Thread-1): Opening a new connection, currently in state init
2021-05-15 07:29:55.554568 (Thread-140): handling poll request
2021-05-15 07:29:55.555030 (Thread-140): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d545b0>]}
2021-05-15 07:29:55.557186 (Thread-140): sending response (<Response 15967 bytes [200 OK]>) to 10.0.4.10
2021-05-15 07:29:57.611574 (Thread-141): handling poll request
2021-05-15 07:29:57.611998 (Thread-141): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d54cd0>]}
2021-05-15 07:29:57.612917 (Thread-141): sending response (<Response 388 bytes [200 OK]>) to 10.0.40.42
2021-05-15 07:29:59.145990 (Thread-142): handling poll request
2021-05-15 07:29:59.146462 (Thread-142): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d542b0>]}
2021-05-15 07:29:59.147361 (Thread-142): sending response (<Response 388 bytes [200 OK]>) to 10.0.20.29
2021-05-15 07:30:00.738829 (Thread-143): handling poll request
2021-05-15 07:30:00.739254 (Thread-143): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d54640>]}
2021-05-15 07:30:00.740141 (Thread-143): sending response (<Response 388 bytes [200 OK]>) to 10.0.15.49
2021-05-15 07:30:02.231074 (Thread-144): handling poll request
2021-05-15 07:30:02.231522 (Thread-144): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d549a0>]}
2021-05-15 07:30:02.232417 (Thread-144): sending response (<Response 388 bytes [200 OK]>) to 10.0.17.122
2021-05-15 07:30:03.103841 (Thread-1): SQL status: SUCCESS 36 in 7.97 seconds
2021-05-15 07:30:03.107208 (Thread-1): finished collecting timing info
2021-05-15 07:30:03.107598 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 07:30:03.727987 (Thread-145): handling poll request
2021-05-15 07:30:03.728416 (Thread-145): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d4fe80>]}
2021-05-15 07:30:03.729559 (Thread-145): sending response (<Response 1327 bytes [200 OK]>) to 10.0.3.247
2021-05-15 07:30:05.393054 (Thread-146): handling poll request
2021-05-15 07:30:05.393506 (Thread-146): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7358d9f40>]}
2021-05-15 07:30:05.397985 (Thread-146): sending response (<Response 72978 bytes [200 OK]>) to 10.0.18.95
2021-05-15 07:50:19.570061 (Thread-147): handling status request
2021-05-15 07:50:19.572074 (Thread-147): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7358d9190>]}
2021-05-15 07:50:19.596767 (Thread-147): sending response (<Response 97516 bytes [200 OK]>) to 10.0.19.219
2021-05-15 07:50:20.474548 (Thread-148): handling run_sql request
2021-05-15 07:50:20.474961 (Thread-148): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7358d93d0>]}
2021-05-15 07:50:21.510578 (Thread-148): sending response (<Response 137 bytes [200 OK]>) to 10.0.41.124
2021-05-15 07:50:21.532740 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:50:21.558067 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 07:50:21.558586 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:50:21.558699 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 07:50:21.572788 (Thread-1): finished collecting timing info
2021-05-15 07:50:21.582944 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 07:50:21.583035 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='Q' and f_metric_id='29'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 07:50:21.583094 (Thread-1): Opening a new connection, currently in state init
2021-05-15 07:50:22.118339 (Thread-149): handling poll request
2021-05-15 07:50:22.118850 (Thread-149): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad1490>]}
2021-05-15 07:50:22.121628 (Thread-149): sending response (<Response 15967 bytes [200 OK]>) to 10.0.36.138
2021-05-15 07:50:23.675052 (Thread-150): handling poll request
2021-05-15 07:50:23.675468 (Thread-150): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359e7910>]}
2021-05-15 07:50:23.796106 (Thread-150): sending response (<Response 388 bytes [200 OK]>) to 10.0.46.218
2021-05-15 07:50:25.358906 (Thread-151): handling poll request
2021-05-15 07:50:25.359329 (Thread-151): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7448a5e20>]}
2021-05-15 07:50:25.360204 (Thread-151): sending response (<Response 388 bytes [200 OK]>) to 10.0.15.49
2021-05-15 07:50:27.513408 (Thread-152): handling poll request
2021-05-15 07:50:27.513830 (Thread-152): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359e7cd0>]}
2021-05-15 07:50:27.514734 (Thread-152): sending response (<Response 388 bytes [200 OK]>) to 10.0.6.126
2021-05-15 07:50:28.587710 (Thread-1): SQL status: SUCCESS 12 in 7.00 seconds
2021-05-15 07:50:28.589808 (Thread-1): finished collecting timing info
2021-05-15 07:50:28.590213 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 07:50:29.014513 (Thread-153): handling poll request
2021-05-15 07:50:29.014933 (Thread-153): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359e7670>]}
2021-05-15 07:50:29.019438 (Thread-153): sending response (<Response 70459 bytes [200 OK]>) to 10.0.15.199
2021-05-15 07:57:14.419476 (Thread-154): handling status request
2021-05-15 07:57:14.421699 (Thread-154): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7358d94f0>]}
2021-05-15 07:57:14.446440 (Thread-154): sending response (<Response 97516 bytes [200 OK]>) to 10.0.31.167
2021-05-15 07:57:15.265109 (Thread-155): handling run_sql request
2021-05-15 07:57:15.265536 (Thread-155): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359e77f0>]}
2021-05-15 07:57:16.276622 (Thread-155): sending response (<Response 137 bytes [200 OK]>) to 10.0.4.10
2021-05-15 07:57:16.298275 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:57:16.323272 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 07:57:16.323706 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:57:16.323812 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 07:57:16.337060 (Thread-1): finished collecting timing info
2021-05-15 07:57:16.345406 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 07:57:16.345482 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Y' and f_metric_id= 30
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 07:57:16.345540 (Thread-1): Opening a new connection, currently in state init
2021-05-15 07:57:16.763768 (Thread-156): handling poll request
2021-05-15 07:57:16.764221 (Thread-156): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f1d850>]}
2021-05-15 07:57:16.766398 (Thread-156): sending response (<Response 14220 bytes [200 OK]>) to 10.0.15.49
2021-05-15 07:57:18.267421 (Thread-157): handling poll request
2021-05-15 07:57:18.267859 (Thread-157): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f1dfa0>]}
2021-05-15 07:57:18.268728 (Thread-157): sending response (<Response 398 bytes [200 OK]>) to 10.0.20.29
2021-05-15 07:57:19.801943 (Thread-158): handling poll request
2021-05-15 07:57:19.802399 (Thread-158): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f1d280>]}
2021-05-15 07:57:19.803277 (Thread-158): sending response (<Response 398 bytes [200 OK]>) to 10.0.18.95
2021-05-15 07:57:21.330424 (Thread-159): handling poll request
2021-05-15 07:57:21.330844 (Thread-159): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f1da90>]}
2021-05-15 07:57:21.331720 (Thread-159): sending response (<Response 398 bytes [200 OK]>) to 10.0.20.29
2021-05-15 07:57:22.860237 (Thread-160): handling poll request
2021-05-15 07:57:22.860676 (Thread-160): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b27100>]}
2021-05-15 07:57:22.861555 (Thread-160): sending response (<Response 398 bytes [200 OK]>) to 10.0.22.198
2021-05-15 07:57:23.605443 (Thread-1): SQL status: SUCCESS 500 in 7.26 seconds
2021-05-15 07:57:23.634301 (Thread-1): finished collecting timing info
2021-05-15 07:57:23.634710 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 07:57:24.324038 (Thread-161): handling poll request
2021-05-15 07:57:24.324489 (Thread-161): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f0d400>]}
2021-05-15 07:57:24.334412 (Thread-161): sending response (<Response 147366 bytes [200 OK]>) to 10.0.17.122
2021-05-15 07:57:58.959893 (Thread-162): handling status request
2021-05-15 07:57:58.960321 (Thread-162): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735615bb0>]}
2021-05-15 07:57:58.985389 (Thread-162): sending response (<Response 97516 bytes [200 OK]>) to 10.0.22.198
2021-05-15 07:57:59.734370 (Thread-163): handling run_sql request
2021-05-15 07:57:59.734803 (Thread-163): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d4fee0>]}
2021-05-15 07:58:00.760977 (Thread-163): sending response (<Response 137 bytes [200 OK]>) to 10.0.22.198
2021-05-15 07:58:00.782105 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:58:00.803582 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 07:58:00.804010 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:58:00.804119 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 07:58:00.817382 (Thread-1): finished collecting timing info
2021-05-15 07:58:00.825736 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 07:58:00.825811 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='M' and f_metric_id= 30
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 07:58:00.825868 (Thread-1): Opening a new connection, currently in state init
2021-05-15 07:58:01.220369 (Thread-164): handling poll request
2021-05-15 07:58:01.220844 (Thread-164): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356157f0>]}
2021-05-15 07:58:01.222994 (Thread-164): sending response (<Response 14220 bytes [200 OK]>) to 10.0.17.122
2021-05-15 07:58:02.722677 (Thread-165): handling poll request
2021-05-15 07:58:02.723120 (Thread-165): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735962a30>]}
2021-05-15 07:58:02.723995 (Thread-165): sending response (<Response 398 bytes [200 OK]>) to 10.0.1.135
2021-05-15 07:58:04.280196 (Thread-166): handling poll request
2021-05-15 07:58:04.280625 (Thread-166): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735962af0>]}
2021-05-15 07:58:04.281502 (Thread-166): sending response (<Response 398 bytes [200 OK]>) to 10.0.46.218
2021-05-15 07:58:05.731417 (Thread-167): handling poll request
2021-05-15 07:58:05.731859 (Thread-167): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735962dc0>]}
2021-05-15 07:58:05.732758 (Thread-167): sending response (<Response 398 bytes [200 OK]>) to 10.0.15.49
2021-05-15 07:58:07.521872 (Thread-1): SQL status: SUCCESS 500 in 6.70 seconds
2021-05-15 07:58:07.546044 (Thread-1): finished collecting timing info
2021-05-15 07:58:07.546469 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 07:58:07.768556 (Thread-168): handling poll request
2021-05-15 07:58:07.768986 (Thread-168): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a97af0>]}
2021-05-15 07:58:07.770117 (Thread-168): sending response (<Response 1338 bytes [200 OK]>) to 10.0.34.201
2021-05-15 07:58:09.287111 (Thread-169): handling poll request
2021-05-15 07:58:09.287537 (Thread-169): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f0df10>]}
2021-05-15 07:58:09.296505 (Thread-169): sending response (<Response 148684 bytes [200 OK]>) to 10.0.34.201
2021-05-15 07:59:23.252216 (Thread-170): handling status request
2021-05-15 07:59:23.254542 (Thread-170): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f0d9a0>]}
2021-05-15 07:59:23.279431 (Thread-170): sending response (<Response 97516 bytes [200 OK]>) to 10.0.45.155
2021-05-15 07:59:24.116543 (Thread-171): handling run_sql request
2021-05-15 07:59:24.116963 (Thread-171): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f0dca0>]}
2021-05-15 07:59:25.126262 (Thread-171): sending response (<Response 137 bytes [200 OK]>) to 10.0.3.247
2021-05-15 07:59:25.147566 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:59:25.172576 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 07:59:25.173053 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 07:59:25.173163 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 07:59:25.186709 (Thread-1): finished collecting timing info
2021-05-15 07:59:25.195222 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 07:59:25.195302 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Q' and f_metric_id= 30
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 07:59:25.195361 (Thread-1): Opening a new connection, currently in state init
2021-05-15 07:59:25.672064 (Thread-172): handling poll request
2021-05-15 07:59:25.672545 (Thread-172): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ae3430>]}
2021-05-15 07:59:25.674736 (Thread-172): sending response (<Response 14219 bytes [200 OK]>) to 10.0.15.49
2021-05-15 07:59:27.755674 (Thread-173): handling poll request
2021-05-15 07:59:27.756100 (Thread-173): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ae3760>]}
2021-05-15 07:59:27.756957 (Thread-173): sending response (<Response 397 bytes [200 OK]>) to 10.0.15.199
2021-05-15 07:59:29.281833 (Thread-174): handling poll request
2021-05-15 07:59:29.282315 (Thread-174): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c36df0>]}
2021-05-15 07:59:29.283200 (Thread-174): sending response (<Response 398 bytes [200 OK]>) to 10.0.20.29
2021-05-15 07:59:30.708754 (Thread-175): handling poll request
2021-05-15 07:59:30.709195 (Thread-175): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c36610>]}
2021-05-15 07:59:30.710103 (Thread-175): sending response (<Response 398 bytes [200 OK]>) to 10.0.18.95
2021-05-15 07:59:32.767536 (Thread-176): handling poll request
2021-05-15 07:59:32.767981 (Thread-176): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c36550>]}
2021-05-15 07:59:32.768895 (Thread-176): sending response (<Response 398 bytes [200 OK]>) to 10.0.45.155
2021-05-15 07:59:32.830460 (Thread-1): SQL status: SUCCESS 500 in 7.64 seconds
2021-05-15 07:59:32.853021 (Thread-1): finished collecting timing info
2021-05-15 07:59:32.853427 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 07:59:34.260820 (Thread-177): handling poll request
2021-05-15 07:59:34.261250 (Thread-177): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a97160>]}
2021-05-15 07:59:34.270609 (Thread-177): sending response (<Response 146667 bytes [200 OK]>) to 10.0.15.199
2021-05-15 08:00:37.628670 (Thread-178): handling status request
2021-05-15 08:00:37.638719 (Thread-178): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a97d90>]}
2021-05-15 08:00:37.677627 (Thread-178): sending response (<Response 97516 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:00:38.501698 (Thread-179): handling run_sql request
2021-05-15 08:00:38.502121 (Thread-179): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a97d30>]}
2021-05-15 08:00:39.517641 (Thread-179): sending response (<Response 137 bytes [200 OK]>) to 10.0.4.10
2021-05-15 08:00:39.538757 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:00:39.562989 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:00:39.563463 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:00:39.563573 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:00:39.577066 (Thread-1): finished collecting timing info
2021-05-15 08:00:39.585407 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:00:39.585483 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Q' and f_metric_id= 31
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:00:39.585540 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:00:40.081398 (Thread-180): handling poll request
2021-05-15 08:00:40.081868 (Thread-180): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355c3760>]}
2021-05-15 08:00:40.202893 (Thread-180): sending response (<Response 14220 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:00:42.288118 (Thread-181): handling poll request
2021-05-15 08:00:42.288550 (Thread-181): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7358d9670>]}
2021-05-15 08:00:42.289438 (Thread-181): sending response (<Response 398 bytes [200 OK]>) to 10.0.15.199
2021-05-15 08:00:43.850339 (Thread-182): handling poll request
2021-05-15 08:00:43.850887 (Thread-182): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355c3d60>]}
2021-05-15 08:00:43.851772 (Thread-182): sending response (<Response 398 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:00:45.400790 (Thread-183): handling poll request
2021-05-15 08:00:45.401222 (Thread-183): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355c3c10>]}
2021-05-15 08:00:45.402109 (Thread-183): sending response (<Response 398 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:00:46.382767 (Thread-1): SQL status: SUCCESS 500 in 6.80 seconds
2021-05-15 08:00:46.794478 (Thread-1): finished collecting timing info
2021-05-15 08:00:46.795057 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:00:47.539929 (Thread-184): handling poll request
2021-05-15 08:00:47.540357 (Thread-184): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c36a00>]}
2021-05-15 08:00:47.554297 (Thread-184): sending response (<Response 182901 bytes [200 OK]>) to 10.0.15.199
2021-05-15 08:02:10.888261 (Thread-185): handling status request
2021-05-15 08:02:10.890677 (Thread-185): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ae3250>]}
2021-05-15 08:02:10.916687 (Thread-185): sending response (<Response 97516 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:02:12.012427 (Thread-186): handling run_sql request
2021-05-15 08:02:12.012929 (Thread-186): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ae3730>]}
2021-05-15 08:02:13.104797 (Thread-186): sending response (<Response 137 bytes [200 OK]>) to 10.0.45.155
2021-05-15 08:02:13.128072 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:02:13.153759 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:02:13.154395 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:02:13.154509 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:02:13.168589 (Thread-1): finished collecting timing info
2021-05-15 08:02:13.177564 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:02:13.177664 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='M' and f_metric_id= 31
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:02:13.177726 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:02:13.676450 (Thread-187): handling poll request
2021-05-15 08:02:13.676982 (Thread-187): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735650190>]}
2021-05-15 08:02:13.679197 (Thread-187): sending response (<Response 14220 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:02:15.287782 (Thread-188): handling poll request
2021-05-15 08:02:15.288223 (Thread-188): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735659b20>]}
2021-05-15 08:02:15.289132 (Thread-188): sending response (<Response 397 bytes [200 OK]>) to 10.0.17.122
2021-05-15 08:02:17.459329 (Thread-189): handling poll request
2021-05-15 08:02:17.459800 (Thread-189): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735650cd0>]}
2021-05-15 08:02:17.460682 (Thread-189): sending response (<Response 398 bytes [200 OK]>) to 10.0.18.95
2021-05-15 08:02:18.958037 (Thread-190): handling poll request
2021-05-15 08:02:18.958506 (Thread-190): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735659910>]}
2021-05-15 08:02:18.959422 (Thread-190): sending response (<Response 398 bytes [200 OK]>) to 10.0.45.155
2021-05-15 08:02:20.506063 (Thread-191): handling poll request
2021-05-15 08:02:20.506584 (Thread-191): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735650190>]}
2021-05-15 08:02:20.507477 (Thread-191): sending response (<Response 398 bytes [200 OK]>) to 10.0.22.198
2021-05-15 08:02:21.537772 (Thread-1): SQL status: SUCCESS 500 in 8.36 seconds
2021-05-15 08:02:21.865572 (Thread-1): finished collecting timing info
2021-05-15 08:02:21.866144 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:02:22.634626 (Thread-192): handling poll request
2021-05-15 08:02:22.635045 (Thread-192): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ac2850>]}
2021-05-15 08:02:22.644604 (Thread-192): sending response (<Response 186729 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:02:55.260170 (Thread-193): handling status request
2021-05-15 08:02:55.260584 (Thread-193): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ac2190>]}
2021-05-15 08:02:55.286243 (Thread-193): sending response (<Response 97516 bytes [200 OK]>) to 10.0.34.201
2021-05-15 08:02:56.088300 (Thread-194): handling run_sql request
2021-05-15 08:02:56.088718 (Thread-194): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ac2130>]}
2021-05-15 08:02:57.286425 (Thread-194): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.49
2021-05-15 08:02:57.309208 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:02:57.331394 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:02:57.331930 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:02:57.332042 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:02:57.345875 (Thread-1): finished collecting timing info
2021-05-15 08:02:57.355012 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:02:57.355095 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Y' and f_metric_id= 31
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:02:57.355154 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:02:57.837596 (Thread-195): handling poll request
2021-05-15 08:02:57.838082 (Thread-195): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b450d0>]}
2021-05-15 08:02:57.840239 (Thread-195): sending response (<Response 14220 bytes [200 OK]>) to 10.0.19.219
2021-05-15 08:02:59.486324 (Thread-196): handling poll request
2021-05-15 08:02:59.486756 (Thread-196): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b454f0>]}
2021-05-15 08:02:59.487629 (Thread-196): sending response (<Response 398 bytes [200 OK]>) to 10.0.3.247
2021-05-15 08:03:01.108296 (Thread-197): handling poll request
2021-05-15 08:03:01.108738 (Thread-197): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735809640>]}
2021-05-15 08:03:01.109767 (Thread-197): sending response (<Response 398 bytes [200 OK]>) to 10.0.3.247
2021-05-15 08:03:02.654078 (Thread-198): handling poll request
2021-05-15 08:03:02.654828 (Thread-198): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7358097c0>]}
2021-05-15 08:03:02.655743 (Thread-198): sending response (<Response 398 bytes [200 OK]>) to 10.0.15.49
2021-05-15 08:03:04.222163 (Thread-199): handling poll request
2021-05-15 08:03:04.222827 (Thread-199): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735809520>]}
2021-05-15 08:03:04.224163 (Thread-199): sending response (<Response 398 bytes [200 OK]>) to 10.0.17.122
2021-05-15 08:03:04.242567 (Thread-1): SQL status: SUCCESS 500 in 6.89 seconds
2021-05-15 08:03:04.503134 (Thread-1): finished collecting timing info
2021-05-15 08:03:04.503599 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:03:05.779562 (Thread-200): handling poll request
2021-05-15 08:03:05.780046 (Thread-200): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356599d0>]}
2021-05-15 08:03:05.790408 (Thread-200): sending response (<Response 182818 bytes [200 OK]>) to 10.0.19.219
2021-05-15 08:05:37.865588 (Thread-201): handling status request
2021-05-15 08:05:37.867506 (Thread-201): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735650160>]}
2021-05-15 08:05:37.891730 (Thread-201): sending response (<Response 97516 bytes [200 OK]>) to 10.0.4.10
2021-05-15 08:05:38.686282 (Thread-202): handling run_sql request
2021-05-15 08:05:38.686698 (Thread-202): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735650820>]}
2021-05-15 08:05:39.741093 (Thread-202): sending response (<Response 137 bytes [200 OK]>) to 10.0.17.122
2021-05-15 08:05:39.763008 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:05:39.788146 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:05:39.788609 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:05:39.788721 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:05:39.802979 (Thread-1): finished collecting timing info
2021-05-15 08:05:39.811568 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:05:39.811649 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Y' and f_metric_id= 32
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:05:39.811708 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:05:40.307648 (Thread-203): handling poll request
2021-05-15 08:05:40.308103 (Thread-203): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ed40d0>]}
2021-05-15 08:05:40.310311 (Thread-203): sending response (<Response 14220 bytes [200 OK]>) to 10.0.41.124
2021-05-15 08:05:42.392844 (Thread-204): handling poll request
2021-05-15 08:05:42.393263 (Thread-204): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ed4220>]}
2021-05-15 08:05:42.394130 (Thread-204): sending response (<Response 398 bytes [200 OK]>) to 10.0.45.155
2021-05-15 08:05:44.021314 (Thread-205): handling poll request
2021-05-15 08:05:44.021761 (Thread-205): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ed4ee0>]}
2021-05-15 08:05:44.022672 (Thread-205): sending response (<Response 398 bytes [200 OK]>) to 10.0.34.201
2021-05-15 08:05:45.521531 (Thread-206): handling poll request
2021-05-15 08:05:45.522092 (Thread-206): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ed4eb0>]}
2021-05-15 08:05:45.523064 (Thread-206): sending response (<Response 398 bytes [200 OK]>) to 10.0.34.201
2021-05-15 08:05:47.455122 (Thread-1): SQL status: SUCCESS 65 in 7.64 seconds
2021-05-15 08:05:47.460107 (Thread-1): finished collecting timing info
2021-05-15 08:05:47.460691 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:05:47.534977 (Thread-207): handling poll request
2021-05-15 08:05:47.535567 (Thread-207): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ed4880>]}
2021-05-15 08:05:47.537232 (Thread-207): sending response (<Response 1337 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:05:49.067223 (Thread-208): handling poll request
2021-05-15 08:05:49.067659 (Thread-208): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c3da30>]}
2021-05-15 08:05:49.072593 (Thread-208): sending response (<Response 71029 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:08:34.124111 (Thread-209): Got an acceptable cached parse result
2021-05-15 08:08:34.247542 (Thread-209): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 08:08:34.527921 (Thread-210): handling status request
2021-05-15 08:08:34.528318 (Thread-210): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341f1970>]}
2021-05-15 08:08:34.529025 (Thread-210): sending response (<Response 184 bytes [200 OK]>) to 10.0.45.155
2021-05-15 08:08:34.592435 (Thread-211): handling status request
2021-05-15 08:08:34.593385 (Thread-212): handling status request
2021-05-15 08:08:34.593610 (Thread-211): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73426eeb0>]}
2021-05-15 08:08:34.594030 (Thread-212): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73407e8e0>]}
2021-05-15 08:08:34.882502 (Thread-211): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 08:08:34.883188 (Thread-212): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:08:36.150158 (Thread-213): handling status request
2021-05-15 08:08:36.150598 (Thread-213): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d30a90>]}
2021-05-15 08:08:36.151273 (Thread-213): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.49
2021-05-15 08:08:36.296939 (Thread-209): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 08:08:36.297079 (Thread-209): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 08:08:36.297141 (Thread-209): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 08:08:36.297195 (Thread-209): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 08:08:36.297246 (Thread-209): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 08:08:36.297998 (Thread-209): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 08:08:36.298343 (Thread-209): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 08:08:36.298622 (Thread-209): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 08:08:36.298865 (Thread-209): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 08:08:36.299112 (Thread-209): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 08:08:36.299348 (Thread-209): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 08:08:36.299580 (Thread-209): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 08:08:36.299812 (Thread-209): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 08:08:36.435351 (Thread-214): handling status request
2021-05-15 08:08:36.450974 (Thread-214): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7344d17f0>]}
2021-05-15 08:08:36.456914 (Thread-214): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:08:36.493856 (Thread-215): handling status request
2021-05-15 08:08:36.499277 (Thread-215): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73459ea60>]}
2021-05-15 08:08:36.499931 (Thread-215): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.122
2021-05-15 08:08:36.629333 (Thread-209): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 08:08:37.676936 (Thread-216): handling status request
2021-05-15 08:08:37.677361 (Thread-216): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d9f880>]}
2021-05-15 08:08:37.679359 (Thread-216): sending response (<Response 6258 bytes [200 OK]>) to 10.0.20.29
2021-05-15 08:08:37.903076 (Thread-217): handling status request
2021-05-15 08:08:37.903499 (Thread-217): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735becf70>]}
2021-05-15 08:08:37.905408 (Thread-217): sending response (<Response 6258 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:08:38.010575 (Thread-218): handling status request
2021-05-15 08:08:38.011023 (Thread-218): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744a51190>]}
2021-05-15 08:08:38.012960 (Thread-218): sending response (<Response 6258 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:08:41.608347 (Thread-219): handling status request
2021-05-15 08:08:41.608762 (Thread-219): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7345c9cd0>]}
2021-05-15 08:08:41.610686 (Thread-219): sending response (<Response 6258 bytes [200 OK]>) to 10.0.3.247
2021-05-15 08:08:42.403608 (Thread-220): handling run_sql request
2021-05-15 08:08:42.404021 (Thread-220): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ec0970>]}
2021-05-15 08:08:42.405187 (Thread-220): Connection 'model.DBTTest.SF_HF_segmented' was properly closed.
2021-05-15 08:08:43.448452 (Thread-220): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.199
2021-05-15 08:08:43.470972 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:08:43.492756 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:08:43.493222 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:08:43.493331 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:08:43.507674 (Thread-1): finished collecting timing info
2021-05-15 08:08:43.516249 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:08:43.516340 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Y' and f_metric_id= 32
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:08:43.516400 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:08:43.929856 (Thread-221): handling poll request
2021-05-15 08:08:43.930374 (Thread-221): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7342479a0>]}
2021-05-15 08:08:43.932561 (Thread-221): sending response (<Response 14242 bytes [200 OK]>) to 10.0.45.155
2021-05-15 08:08:44.382770 (Thread-1): Snowflake query id: 019c4228-0000-29ce-0000-b1490023c00a
2021-05-15 08:08:44.382907 (Thread-1): Snowflake error: 000904 (42000): SQL compilation error: error line 134 at position 16
invalid identifier 'OPPORTUNITY.AMOUNT'
2021-05-15 08:08:44.383038 (Thread-1): finished collecting timing info
2021-05-15 08:08:44.383409 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:08:44.440083 (Thread-1): Got an exception: Database Error
  000904 (42000): SQL compilation error: error line 134 at position 16
  invalid identifier 'OPPORTUNITY.AMOUNT'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 000904 (42000): SQL compilation error: error line 134 at position 16
invalid identifier 'OPPORTUNITY.AMOUNT'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  000904 (42000): SQL compilation error: error line 134 at position 16
  invalid identifier 'OPPORTUNITY.AMOUNT'
2021-05-15 08:08:44.441576 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 134 at position 16\n  invalid identifier 'OPPORTUNITY.AMOUNT'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            0 AS r_amount,\n            52 AS r_metric_id,\n            Source as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from compare_result where F_TIMEFRAME_TYPE=\'Y\' and f_metric_id= 32\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            0 AS r_amount,\n            52 AS r_metric_id,\n            Source as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from compare_result where F_TIMEFRAME_TYPE=\'Y\' and f_metric_id= 32\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 134 at position 16\n  invalid identifier 'OPPORTUNITY.AMOUNT'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            0 AS r_amount,\n            52 AS r_metric_id,\n            Source as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from compare_result where F_TIMEFRAME_TYPE=\'Y\' and f_metric_id= 32\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            0 AS r_amount,\n            52 AS r_metric_id,\n            Source as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from compare_result where F_TIMEFRAME_TYPE=\'Y\' and f_metric_id= 32\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-15 08:08:45.515002 (Thread-222): handling poll request
2021-05-15 08:08:45.515416 (Thread-222): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bd17f0>]}
2021-05-15 08:08:45.516708 (Thread-222): sending response (<Response 90440 bytes [200 OK]>) to 10.0.18.95
2021-05-15 08:09:03.890392 (Thread-223): Got an acceptable cached parse result
2021-05-15 08:09:04.054142 (Thread-224): handling status request
2021-05-15 08:09:04.055306 (Thread-225): handling status request
2021-05-15 08:09:04.055476 (Thread-224): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c48b0>]}
2021-05-15 08:09:04.064254 (Thread-226): handling status request
2021-05-15 08:09:04.085231 (Thread-224): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:09:04.093967 (Thread-225): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735db93d0>]}
2021-05-15 08:09:04.094164 (Thread-226): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7344976a0>]}
2021-05-15 08:09:04.095052 (Thread-225): sending response (<Response 184 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:09:04.096122 (Thread-226): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:09:04.175828 (Thread-223): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 08:09:05.599451 (Thread-227): handling status request
2021-05-15 08:09:05.609103 (Thread-227): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c5580>]}
2021-05-15 08:09:05.609795 (Thread-227): sending response (<Response 184 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:09:05.647506 (Thread-228): handling status request
2021-05-15 08:09:05.659814 (Thread-228): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726c4a430>]}
2021-05-15 08:09:05.660256 (Thread-229): handling status request
2021-05-15 08:09:05.660920 (Thread-228): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:09:05.661545 (Thread-229): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341c47f0>]}
2021-05-15 08:09:05.662416 (Thread-229): sending response (<Response 184 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:09:06.009374 (Thread-223): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 08:09:06.009523 (Thread-223): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 08:09:06.009596 (Thread-223): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 08:09:06.009651 (Thread-223): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 08:09:06.009702 (Thread-223): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 08:09:06.010477 (Thread-223): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 08:09:06.010925 (Thread-223): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 08:09:06.011361 (Thread-223): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 08:09:06.011757 (Thread-223): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 08:09:06.012113 (Thread-223): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 08:09:06.012526 (Thread-223): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 08:09:06.012901 (Thread-223): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 08:09:06.013256 (Thread-223): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 08:09:06.337597 (Thread-223): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 08:09:07.112493 (Thread-230): handling status request
2021-05-15 08:09:07.112979 (Thread-230): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73414cd60>]}
2021-05-15 08:09:07.115113 (Thread-230): sending response (<Response 6258 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:09:07.137387 (Thread-231): handling status request
2021-05-15 08:09:07.137668 (Thread-231): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734157dc0>]}
2021-05-15 08:09:07.139466 (Thread-231): sending response (<Response 6258 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:09:07.228251 (Thread-232): handling status request
2021-05-15 08:09:07.228608 (Thread-232): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7340c81f0>]}
2021-05-15 08:09:07.230511 (Thread-232): sending response (<Response 6258 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:09:18.851749 (Thread-233): handling status request
2021-05-15 08:09:18.852195 (Thread-233): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735db9340>]}
2021-05-15 08:09:18.854122 (Thread-233): sending response (<Response 6258 bytes [200 OK]>) to 10.0.15.49
2021-05-15 08:09:19.733967 (Thread-234): handling run_sql request
2021-05-15 08:09:19.734407 (Thread-234): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735db9af0>]}
2021-05-15 08:09:19.735617 (Thread-234): Connection 'model.DBTTest.SF_HF_segmented' was properly closed.
2021-05-15 08:09:20.749492 (Thread-234): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.49
2021-05-15 08:09:20.771618 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:09:20.793249 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:09:20.793695 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:09:20.793804 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:09:20.807294 (Thread-1): finished collecting timing info
2021-05-15 08:09:20.815683 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:09:20.815756 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Y' and f_metric_id= 32
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:09:20.815815 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:09:21.336351 (Thread-235): handling poll request
2021-05-15 08:09:21.336801 (Thread-235): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73430f100>]}
2021-05-15 08:09:21.339052 (Thread-235): sending response (<Response 14235 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:09:22.821242 (Thread-236): handling poll request
2021-05-15 08:09:22.821696 (Thread-236): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73430f370>]}
2021-05-15 08:09:22.822661 (Thread-236): sending response (<Response 398 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:09:24.382356 (Thread-237): handling poll request
2021-05-15 08:09:24.382796 (Thread-237): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73430faf0>]}
2021-05-15 08:09:24.383692 (Thread-237): sending response (<Response 398 bytes [200 OK]>) to 10.0.17.122
2021-05-15 08:09:25.951579 (Thread-238): handling poll request
2021-05-15 08:09:25.951998 (Thread-238): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73430fe20>]}
2021-05-15 08:09:25.952859 (Thread-238): sending response (<Response 398 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:09:27.941330 (Thread-239): handling poll request
2021-05-15 08:09:27.941750 (Thread-239): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73430f730>]}
2021-05-15 08:09:27.942662 (Thread-239): sending response (<Response 397 bytes [200 OK]>) to 10.0.19.219
2021-05-15 08:09:29.402409 (Thread-240): handling poll request
2021-05-15 08:09:29.402838 (Thread-240): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73430f9a0>]}
2021-05-15 08:09:29.403709 (Thread-240): sending response (<Response 398 bytes [200 OK]>) to 10.0.41.124
2021-05-15 08:09:30.041480 (Thread-1): SQL status: SUCCESS 65 in 9.23 seconds
2021-05-15 08:09:30.046931 (Thread-1): finished collecting timing info
2021-05-15 08:09:30.047337 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:09:30.967404 (Thread-241): handling poll request
2021-05-15 08:09:30.967886 (Thread-241): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73430f6a0>]}
2021-05-15 08:09:30.973591 (Thread-241): sending response (<Response 72166 bytes [200 OK]>) to 10.0.34.201
2021-05-15 08:10:19.212588 (Thread-242): handling status request
2021-05-15 08:10:19.213033 (Thread-242): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73430f4f0>]}
2021-05-15 08:10:19.331310 (Thread-242): sending response (<Response 6258 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:10:20.091781 (Thread-243): handling run_sql request
2021-05-15 08:10:20.092218 (Thread-243): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73430f370>]}
2021-05-15 08:10:21.098858 (Thread-243): sending response (<Response 137 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:10:21.120841 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:10:21.145918 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:10:21.146346 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:10:21.146450 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:10:21.159996 (Thread-1): finished collecting timing info
2021-05-15 08:10:21.168272 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:10:21.168357 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='M' and f_metric_id= 32
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:10:21.168414 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:10:21.639846 (Thread-244): handling poll request
2021-05-15 08:10:21.640299 (Thread-244): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343378e0>]}
2021-05-15 08:10:21.642536 (Thread-244): sending response (<Response 14234 bytes [200 OK]>) to 10.0.22.198
2021-05-15 08:10:23.159858 (Thread-245): handling poll request
2021-05-15 08:10:23.160280 (Thread-245): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343375b0>]}
2021-05-15 08:10:23.161142 (Thread-245): sending response (<Response 398 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:10:24.680655 (Thread-246): handling poll request
2021-05-15 08:10:24.681089 (Thread-246): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734337df0>]}
2021-05-15 08:10:24.681957 (Thread-246): sending response (<Response 398 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:10:26.281796 (Thread-247): handling poll request
2021-05-15 08:10:26.282251 (Thread-247): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734337640>]}
2021-05-15 08:10:26.283151 (Thread-247): sending response (<Response 398 bytes [200 OK]>) to 10.0.41.124
2021-05-15 08:10:27.685223 (Thread-1): SQL status: SUCCESS 500 in 6.52 seconds
2021-05-15 08:10:27.709588 (Thread-248): handling poll request
2021-05-15 08:10:27.710002 (Thread-248): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734337b80>]}
2021-05-15 08:10:27.711015 (Thread-248): sending response (<Response 666 bytes [200 OK]>) to 10.0.15.49
2021-05-15 08:10:27.718053 (Thread-1): finished collecting timing info
2021-05-15 08:10:27.718631 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:10:29.134208 (Thread-249): handling poll request
2021-05-15 08:10:29.134641 (Thread-249): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735953580>]}
2021-05-15 08:10:29.144068 (Thread-249): sending response (<Response 154096 bytes [200 OK]>) to 10.0.18.95
2021-05-15 08:23:21.714508 (Thread-250): handling status request
2021-05-15 08:23:21.716722 (Thread-250): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735953f10>]}
2021-05-15 08:23:21.718852 (Thread-250): sending response (<Response 6258 bytes [200 OK]>) to 10.0.18.95
2021-05-15 08:23:22.581404 (Thread-251): handling run_sql request
2021-05-15 08:23:22.581829 (Thread-251): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735953220>]}
2021-05-15 08:23:23.611770 (Thread-251): sending response (<Response 137 bytes [200 OK]>) to 10.0.22.198
2021-05-15 08:23:23.637902 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:23:23.675542 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:23:23.676097 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:23:23.676244 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:23:23.690511 (Thread-1): finished collecting timing info
2021-05-15 08:23:23.700852 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:23:23.700932 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='W' and f_metric_id='1'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:23:23.700994 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:23:24.147101 (Thread-252): handling poll request
2021-05-15 08:23:24.147573 (Thread-252): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73574c8b0>]}
2021-05-15 08:23:24.149798 (Thread-252): sending response (<Response 15966 bytes [200 OK]>) to 10.0.15.49
2021-05-15 08:23:25.708499 (Thread-253): handling poll request
2021-05-15 08:23:25.708933 (Thread-253): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7276fe250>]}
2021-05-15 08:23:25.709819 (Thread-253): sending response (<Response 388 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:23:27.846566 (Thread-254): handling poll request
2021-05-15 08:23:27.847007 (Thread-254): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c26be0>]}
2021-05-15 08:23:27.847917 (Thread-254): sending response (<Response 388 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:23:29.230756 (Thread-1): SQL status: SUCCESS 0 in 5.53 seconds
2021-05-15 08:23:29.231171 (Thread-1): finished collecting timing info
2021-05-15 08:23:29.231542 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:23:29.417888 (Thread-255): handling poll request
2021-05-15 08:23:29.418381 (Thread-255): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734187580>]}
2021-05-15 08:23:29.419569 (Thread-255): sending response (<Response 1326 bytes [200 OK]>) to 10.0.15.199
2021-05-15 08:23:30.976847 (Thread-256): handling poll request
2021-05-15 08:23:30.977277 (Thread-256): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f1dd60>]}
2021-05-15 08:23:30.981563 (Thread-256): sending response (<Response 67879 bytes [200 OK]>) to 10.0.3.247
2021-05-15 08:23:44.858486 (Thread-257): handling status request
2021-05-15 08:23:44.858912 (Thread-257): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f1db50>]}
2021-05-15 08:23:44.860954 (Thread-257): sending response (<Response 6258 bytes [200 OK]>) to 10.0.20.29
2021-05-15 08:23:45.675815 (Thread-258): handling run_sql request
2021-05-15 08:23:45.676233 (Thread-258): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f1dc70>]}
2021-05-15 08:23:46.684624 (Thread-258): sending response (<Response 137 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:23:46.706832 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:23:46.728482 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:23:46.728935 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:23:46.729053 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:23:46.743000 (Thread-1): finished collecting timing info
2021-05-15 08:23:46.752342 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:23:46.752426 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where  f_timeframe_type='W' and f_metric_id=1
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:23:46.752484 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:23:47.186955 (Thread-259): handling poll request
2021-05-15 08:23:47.187426 (Thread-259): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b07100>]}
2021-05-15 08:23:47.189638 (Thread-259): sending response (<Response 15964 bytes [200 OK]>) to 10.0.4.10
2021-05-15 08:23:48.659151 (Thread-260): handling poll request
2021-05-15 08:23:48.659567 (Thread-260): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b07220>]}
2021-05-15 08:23:48.660427 (Thread-260): sending response (<Response 387 bytes [200 OK]>) to 10.0.19.219
2021-05-15 08:23:50.122972 (Thread-261): handling poll request
2021-05-15 08:23:50.123400 (Thread-261): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b07c40>]}
2021-05-15 08:23:50.124251 (Thread-261): sending response (<Response 388 bytes [200 OK]>) to 10.0.17.122
2021-05-15 08:23:51.636899 (Thread-262): handling poll request
2021-05-15 08:23:51.637338 (Thread-262): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b07ca0>]}
2021-05-15 08:23:51.638262 (Thread-262): sending response (<Response 388 bytes [200 OK]>) to 10.0.45.155
2021-05-15 08:23:53.143298 (Thread-263): handling poll request
2021-05-15 08:23:53.143736 (Thread-263): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b07550>]}
2021-05-15 08:23:53.144592 (Thread-263): sending response (<Response 388 bytes [200 OK]>) to 10.0.19.219
2021-05-15 08:23:53.685623 (Thread-1): SQL status: SUCCESS 0 in 6.93 seconds
2021-05-15 08:23:53.686044 (Thread-1): finished collecting timing info
2021-05-15 08:23:53.686442 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:23:54.631604 (Thread-264): handling poll request
2021-05-15 08:23:54.632028 (Thread-264): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e8b940>]}
2021-05-15 08:23:54.636458 (Thread-264): sending response (<Response 68808 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:25:35.660297 (Thread-265): handling status request
2021-05-15 08:25:35.662571 (Thread-265): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e8b5b0>]}
2021-05-15 08:25:35.664607 (Thread-265): sending response (<Response 6258 bytes [200 OK]>) to 10.0.41.124
2021-05-15 08:25:36.396246 (Thread-266): handling run_sql request
2021-05-15 08:25:36.396663 (Thread-266): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e8b370>]}
2021-05-15 08:25:37.423165 (Thread-266): sending response (<Response 137 bytes [200 OK]>) to 10.0.46.218
2021-05-15 08:25:37.445571 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:25:37.470595 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:25:37.471016 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:25:37.471121 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:25:37.484546 (Thread-1): finished collecting timing info
2021-05-15 08:25:37.493966 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:25:37.494050 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from r_metric where  r_type ='Week' --f_timeframe_type='W' and f_metric_id=1
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:25:37.494107 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:25:37.912393 (Thread-267): handling poll request
2021-05-15 08:25:37.912872 (Thread-267): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f1d4f0>]}
2021-05-15 08:25:37.915111 (Thread-267): sending response (<Response 15975 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:25:39.385454 (Thread-268): handling poll request
2021-05-15 08:25:39.385874 (Thread-268): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e22130>]}
2021-05-15 08:25:39.386764 (Thread-268): sending response (<Response 388 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:25:40.901622 (Thread-269): handling poll request
2021-05-15 08:25:40.902049 (Thread-269): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e22790>]}
2021-05-15 08:25:40.902978 (Thread-269): sending response (<Response 387 bytes [200 OK]>) to 10.0.46.218
2021-05-15 08:25:41.240123 (Thread-1): SQL status: SUCCESS 50 in 3.75 seconds
2021-05-15 08:25:41.242939 (Thread-1): finished collecting timing info
2021-05-15 08:25:41.243312 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:25:42.931876 (Thread-270): handling poll request
2021-05-15 08:25:42.932300 (Thread-270): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e228b0>]}
2021-05-15 08:25:42.937988 (Thread-270): sending response (<Response 71881 bytes [200 OK]>) to 10.0.18.95
2021-05-15 08:27:20.556315 (Thread-271): handling status request
2021-05-15 08:27:20.558630 (Thread-271): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e8ba90>]}
2021-05-15 08:27:20.560648 (Thread-271): sending response (<Response 6258 bytes [200 OK]>) to 10.0.46.218
2021-05-15 08:27:21.311896 (Thread-272): handling run_sql request
2021-05-15 08:27:21.312315 (Thread-272): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735db9d90>]}
2021-05-15 08:27:22.461436 (Thread-272): sending response (<Response 137 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:27:22.484542 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:27:22.508958 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:27:22.509415 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:27:22.509526 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:27:22.523163 (Thread-1): finished collecting timing info
2021-05-15 08:27:22.532422 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:27:22.532508 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='W' and f_metric_id=1
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:27:22.532568 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:27:23.055367 (Thread-273): handling poll request
2021-05-15 08:27:23.056125 (Thread-273): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735cc6970>]}
2021-05-15 08:27:23.059683 (Thread-273): sending response (<Response 16067 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:27:24.669662 (Thread-274): handling poll request
2021-05-15 08:27:24.670135 (Thread-274): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734157d30>]}
2021-05-15 08:27:24.671033 (Thread-274): sending response (<Response 388 bytes [200 OK]>) to 10.0.46.218
2021-05-15 08:27:26.135778 (Thread-275): handling poll request
2021-05-15 08:27:26.136261 (Thread-275): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e223a0>]}
2021-05-15 08:27:26.137137 (Thread-275): sending response (<Response 388 bytes [200 OK]>) to 10.0.22.198
2021-05-15 08:27:28.185302 (Thread-1): SQL status: SUCCESS 0 in 5.65 seconds
2021-05-15 08:27:28.185727 (Thread-1): finished collecting timing info
2021-05-15 08:27:28.186108 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:27:28.297939 (Thread-276): handling poll request
2021-05-15 08:27:28.298397 (Thread-276): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b13640>]}
2021-05-15 08:27:28.299571 (Thread-276): sending response (<Response 1329 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:27:29.839810 (Thread-277): handling poll request
2021-05-15 08:27:29.840349 (Thread-277): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b13700>]}
2021-05-15 08:27:29.844425 (Thread-277): sending response (<Response 68345 bytes [200 OK]>) to 10.0.3.247
2021-05-15 08:29:16.609394 (Thread-278): Got an acceptable cached parse result
2021-05-15 08:29:16.724635 (Thread-278): Acquiring new snowflake connection "model.DBTTest.HS_SF".
2021-05-15 08:29:16.941288 (Thread-279): handling status request
2021-05-15 08:29:16.941975 (Thread-279): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72698f100>]}
2021-05-15 08:29:16.942414 (Thread-280): handling status request
2021-05-15 08:29:16.943256 (Thread-279): sending response (<Response 184 bytes [200 OK]>) to 10.0.3.247
2021-05-15 08:29:16.956825 (Thread-280): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb727639310>]}
2021-05-15 08:29:16.976310 (Thread-280): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 08:29:17.046895 (Thread-281): handling status request
2021-05-15 08:29:17.047305 (Thread-281): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734275a00>]}
2021-05-15 08:29:17.048031 (Thread-281): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:29:18.546687 (Thread-282): handling status request
2021-05-15 08:29:18.547093 (Thread-282): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d3f5e0>]}
2021-05-15 08:29:18.547743 (Thread-282): sending response (<Response 184 bytes [200 OK]>) to 10.0.19.219
2021-05-15 08:29:18.571201 (Thread-283): handling status request
2021-05-15 08:29:18.571511 (Thread-283): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735606760>]}
2021-05-15 08:29:18.572103 (Thread-283): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.201
2021-05-15 08:29:18.582417 (Thread-284): handling status request
2021-05-15 08:29:18.582714 (Thread-284): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356069a0>]}
2021-05-15 08:29:18.583246 (Thread-284): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.49
2021-05-15 08:29:18.721725 (Thread-278): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 08:29:18.721867 (Thread-278): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 08:29:18.721929 (Thread-278): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 08:29:18.721984 (Thread-278): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 08:29:18.722036 (Thread-278): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 08:29:18.722820 (Thread-278): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 08:29:18.723135 (Thread-278): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 08:29:18.723401 (Thread-278): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 08:29:18.723642 (Thread-278): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 08:29:18.723879 (Thread-278): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 08:29:18.724114 (Thread-278): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 08:29:18.724348 (Thread-278): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 08:29:18.724582 (Thread-278): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 08:29:19.067450 (Thread-278): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 08:29:20.014061 (Thread-285): handling status request
2021-05-15 08:29:20.014528 (Thread-285): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a8ae20>]}
2021-05-15 08:29:20.017566 (Thread-285): sending response (<Response 6248 bytes [200 OK]>) to 10.0.18.95
2021-05-15 08:29:20.100972 (Thread-286): handling status request
2021-05-15 08:29:20.101400 (Thread-286): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a0cc70>]}
2021-05-15 08:29:20.103748 (Thread-286): sending response (<Response 6248 bytes [200 OK]>) to 10.0.17.122
2021-05-15 08:29:20.106114 (Thread-287): handling status request
2021-05-15 08:29:20.106483 (Thread-287): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735676fd0>]}
2021-05-15 08:29:20.108265 (Thread-287): sending response (<Response 6248 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:29:26.356702 (Thread-288): handling status request
2021-05-15 08:29:26.357115 (Thread-288): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7379047f0>]}
2021-05-15 08:29:26.359055 (Thread-288): sending response (<Response 6248 bytes [200 OK]>) to 10.0.34.201
2021-05-15 08:29:27.245391 (Thread-289): handling run_sql request
2021-05-15 08:29:27.245807 (Thread-289): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f092e0>]}
2021-05-15 08:29:27.247024 (Thread-289): Connection 'model.DBTTest.HS_SF' was properly closed.
2021-05-15 08:29:28.265756 (Thread-289): sending response (<Response 137 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:29:28.287874 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:29:28.309841 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:29:28.310285 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:29:28.310392 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:29:28.323887 (Thread-1): finished collecting timing info
2021-05-15 08:29:28.333554 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:29:28.333640 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END_DATE
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='W' and f_metric_id=1
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:29:28.333699 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:29:28.829856 (Thread-290): handling poll request
2021-05-15 08:29:28.830385 (Thread-290): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359d3610>]}
2021-05-15 08:29:28.832699 (Thread-290): sending response (<Response 16543 bytes [200 OK]>) to 10.0.46.218
2021-05-15 08:29:29.345750 (Thread-1): Snowflake query id: 019c423d-0000-29a2-0000-b149002397c6
2021-05-15 08:29:29.345881 (Thread-1): Snowflake error: 000904 (42000): SQL compilation error: error line 286 at position 24
invalid identifier 'TMF.WEEK_END_DATE'
2021-05-15 08:29:29.346010 (Thread-1): finished collecting timing info
2021-05-15 08:29:29.346417 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:29:29.410148 (Thread-1): Got an exception: Database Error
  000904 (42000): SQL compilation error: error line 286 at position 24
  invalid identifier 'TMF.WEEK_END_DATE'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 000904 (42000): SQL compilation error: error line 286 at position 24
invalid identifier 'TMF.WEEK_END_DATE'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  000904 (42000): SQL compilation error: error line 286 at position 24
  invalid identifier 'TMF.WEEK_END_DATE'
2021-05-15 08:29:29.411690 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 286 at position 24\n  invalid identifier 'TMF.WEEK_END_DATE'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END_DATE\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result where f_timeframe_type=\'W\' and f_metric_id=1\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END_DATE\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result where f_timeframe_type=\'W\' and f_metric_id=1\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 286 at position 24\n  invalid identifier 'TMF.WEEK_END_DATE'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END_DATE\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result where f_timeframe_type=\'W\' and f_metric_id=1\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END_DATE\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result where f_timeframe_type=\'W\' and f_metric_id=1\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-15 08:29:30.508509 (Thread-291): handling poll request
2021-05-15 08:29:30.508976 (Thread-291): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7340c8040>]}
2021-05-15 08:29:30.510387 (Thread-291): sending response (<Response 107126 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:32:07.896280 (Thread-292): handling status request
2021-05-15 08:32:07.898273 (Thread-292): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7368229d0>]}
2021-05-15 08:32:07.900786 (Thread-292): sending response (<Response 6248 bytes [200 OK]>) to 10.0.15.49
2021-05-15 08:32:08.649319 (Thread-293): handling run_sql request
2021-05-15 08:32:08.649746 (Thread-293): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7368226a0>]}
2021-05-15 08:32:09.680296 (Thread-293): sending response (<Response 137 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:32:09.702765 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:32:09.727818 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:32:09.728278 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:32:09.728386 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:32:09.741820 (Thread-1): finished collecting timing info
2021-05-15 08:32:09.751610 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:32:09.751685 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='W' and f_metric_id=1
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:32:09.751743 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:32:10.150485 (Thread-294): handling poll request
2021-05-15 08:32:10.150968 (Thread-294): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735abcac0>]}
2021-05-15 08:32:10.153080 (Thread-294): sending response (<Response 16538 bytes [200 OK]>) to 10.0.3.247
2021-05-15 08:32:11.674909 (Thread-295): handling poll request
2021-05-15 08:32:11.675335 (Thread-295): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735abc7f0>]}
2021-05-15 08:32:11.676186 (Thread-295): sending response (<Response 388 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:32:13.165438 (Thread-296): handling poll request
2021-05-15 08:32:13.165853 (Thread-296): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735abcd30>]}
2021-05-15 08:32:13.166738 (Thread-296): sending response (<Response 388 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:32:14.677690 (Thread-297): handling poll request
2021-05-15 08:32:14.678144 (Thread-297): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735abca30>]}
2021-05-15 08:32:14.679087 (Thread-297): sending response (<Response 388 bytes [200 OK]>) to 10.0.45.155
2021-05-15 08:32:16.215246 (Thread-298): handling poll request
2021-05-15 08:32:16.215670 (Thread-298): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735abc400>]}
2021-05-15 08:32:16.216542 (Thread-298): sending response (<Response 388 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:32:17.080289 (Thread-1): SQL status: SUCCESS 0 in 7.33 seconds
2021-05-15 08:32:17.080715 (Thread-1): finished collecting timing info
2021-05-15 08:32:17.081092 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:32:18.286110 (Thread-299): handling poll request
2021-05-15 08:32:18.286577 (Thread-299): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356430d0>]}
2021-05-15 08:32:18.290967 (Thread-299): sending response (<Response 71641 bytes [200 OK]>) to 10.0.19.219
2021-05-15 08:32:56.223314 (Thread-300): handling status request
2021-05-15 08:32:56.223799 (Thread-300): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735643c70>]}
2021-05-15 08:32:56.225838 (Thread-300): sending response (<Response 6248 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:32:56.988464 (Thread-301): handling run_sql request
2021-05-15 08:32:56.988914 (Thread-301): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7356432e0>]}
2021-05-15 08:32:58.059768 (Thread-301): sending response (<Response 137 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:32:58.059729 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:32:58.081970 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:32:58.082494 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:32:58.082605 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:32:58.098868 (Thread-1): finished collecting timing info
2021-05-15 08:32:58.109815 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:32:58.109917 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from fs where f_timeframe_type='W' and f_metric_id=1
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:32:58.109979 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:32:58.576392 (Thread-302): handling poll request
2021-05-15 08:32:58.576843 (Thread-302): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a28e80>]}
2021-05-15 08:32:58.579093 (Thread-302): sending response (<Response 16526 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:33:00.106459 (Thread-303): handling poll request
2021-05-15 08:33:00.106897 (Thread-303): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735abce50>]}
2021-05-15 08:33:00.233937 (Thread-303): sending response (<Response 387 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:33:02.080749 (Thread-1): SQL status: SUCCESS 26 in 3.97 seconds
2021-05-15 08:33:02.082802 (Thread-1): finished collecting timing info
2021-05-15 08:33:02.083176 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:33:02.588802 (Thread-304): handling poll request
2021-05-15 08:33:02.589288 (Thread-304): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735abc9d0>]}
2021-05-15 08:33:02.593570 (Thread-304): sending response (<Response 73096 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:34:16.540572 (Thread-305): Got an acceptable cached parse result
2021-05-15 08:34:16.570888 (Thread-306): handling status request
2021-05-15 08:34:16.578909 (Thread-306): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73426e640>]}
2021-05-15 08:34:16.579662 (Thread-306): sending response (<Response 184 bytes [200 OK]>) to 10.0.20.29
2021-05-15 08:34:16.645808 (Thread-307): handling status request
2021-05-15 08:34:16.646238 (Thread-307): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726c41d00>]}
2021-05-15 08:34:16.646851 (Thread-307): sending response (<Response 184 bytes [200 OK]>) to 10.0.18.95
2021-05-15 08:34:16.652273 (Thread-305): Acquiring new snowflake connection "model.DBTTest.HS_SF".
2021-05-15 08:34:16.664664 (Thread-308): handling status request
2021-05-15 08:34:16.665005 (Thread-308): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726c22ca0>]}
2021-05-15 08:34:16.665538 (Thread-308): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:34:18.157041 (Thread-309): handling status request
2021-05-15 08:34:18.157520 (Thread-309): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726b2a0a0>]}
2021-05-15 08:34:18.158241 (Thread-309): sending response (<Response 184 bytes [200 OK]>) to 10.0.3.247
2021-05-15 08:34:18.194976 (Thread-310): handling status request
2021-05-15 08:34:18.195354 (Thread-310): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726447880>]}
2021-05-15 08:34:18.196000 (Thread-310): sending response (<Response 184 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:34:18.251321 (Thread-311): handling status request
2021-05-15 08:34:18.251764 (Thread-311): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7262589a0>]}
2021-05-15 08:34:18.252879 (Thread-311): sending response (<Response 184 bytes [200 OK]>) to 10.0.18.95
2021-05-15 08:34:18.389266 (Thread-305): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 08:34:18.389417 (Thread-305): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 08:34:18.389479 (Thread-305): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 08:34:18.389533 (Thread-305): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 08:34:18.389584 (Thread-305): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 08:34:18.390395 (Thread-305): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 08:34:18.390729 (Thread-305): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 08:34:18.391012 (Thread-305): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 08:34:18.391261 (Thread-305): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 08:34:18.391502 (Thread-305): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 08:34:18.391736 (Thread-305): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 08:34:18.391970 (Thread-305): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 08:34:18.392205 (Thread-305): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 08:34:18.874638 (Thread-305): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 08:34:19.618061 (Thread-312): handling status request
2021-05-15 08:34:19.618519 (Thread-312): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73688d3a0>]}
2021-05-15 08:34:19.620673 (Thread-312): sending response (<Response 6248 bytes [200 OK]>) to 10.0.15.199
2021-05-15 08:34:19.644991 (Thread-313): handling status request
2021-05-15 08:34:19.645304 (Thread-313): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73688dc10>]}
2021-05-15 08:34:19.647157 (Thread-313): sending response (<Response 6248 bytes [200 OK]>) to 10.0.15.49
2021-05-15 08:34:19.725153 (Thread-314): handling status request
2021-05-15 08:34:19.725503 (Thread-314): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73564b250>]}
2021-05-15 08:34:19.727379 (Thread-314): sending response (<Response 6248 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:34:46.825733 (Thread-315): handling status request
2021-05-15 08:34:46.826150 (Thread-315): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73797aeb0>]}
2021-05-15 08:34:46.828054 (Thread-315): sending response (<Response 6248 bytes [200 OK]>) to 10.0.22.198
2021-05-15 08:34:48.653293 (Thread-316): handling run_sql request
2021-05-15 08:34:48.653734 (Thread-316): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726a990a0>]}
2021-05-15 08:34:48.654962 (Thread-316): Connection 'model.DBTTest.HS_SF' was properly closed.
2021-05-15 08:34:49.660590 (Thread-316): sending response (<Response 137 bytes [200 OK]>) to 10.0.46.218
2021-05-15 08:34:49.683125 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:34:49.704651 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:34:49.705100 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:34:49.705208 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:34:49.719360 (Thread-1): finished collecting timing info
2021-05-15 08:34:49.729051 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:34:49.729133 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from fs where f_timeframe_type='W' and f_metric_id=1
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:34:49.729190 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:34:50.214873 (Thread-317): handling poll request
2021-05-15 08:34:50.215346 (Thread-317): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7268d9460>]}
2021-05-15 08:34:50.217541 (Thread-317): sending response (<Response 16523 bytes [200 OK]>) to 10.0.45.155
2021-05-15 08:34:51.723633 (Thread-318): handling poll request
2021-05-15 08:34:51.724066 (Thread-318): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7268d9e20>]}
2021-05-15 08:34:51.724952 (Thread-318): sending response (<Response 388 bytes [200 OK]>) to 10.0.3.247
2021-05-15 08:34:53.703886 (Thread-319): handling poll request
2021-05-15 08:34:53.704324 (Thread-319): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734400e20>]}
2021-05-15 08:34:53.705194 (Thread-319): sending response (<Response 388 bytes [200 OK]>) to 10.0.15.199
2021-05-15 08:34:53.716588 (Thread-1): SQL status: SUCCESS 330 in 3.99 seconds
2021-05-15 08:34:53.724920 (Thread-1): finished collecting timing info
2021-05-15 08:34:53.725319 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:34:55.169696 (Thread-320): handling poll request
2021-05-15 08:34:55.170141 (Thread-320): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735734b20>]}
2021-05-15 08:34:55.176554 (Thread-320): sending response (<Response 91855 bytes [200 OK]>) to 10.0.34.201
2021-05-15 08:35:33.449135 (Thread-321): handling status request
2021-05-15 08:35:33.449581 (Thread-321): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb750d05c70>]}
2021-05-15 08:35:33.451643 (Thread-321): sending response (<Response 6248 bytes [200 OK]>) to 10.0.3.247
2021-05-15 08:35:34.403382 (Thread-322): handling run_sql request
2021-05-15 08:35:34.403811 (Thread-322): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73688d9d0>]}
2021-05-15 08:35:35.418142 (Thread-322): sending response (<Response 137 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:35:35.440719 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:35:35.465866 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:35:35.466307 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:35:35.466412 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:35:35.479909 (Thread-1): finished collecting timing info
2021-05-15 08:35:35.489578 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:35:35.489650 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='W' and f_metric_id=1
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:35:35.489707 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:35:35.962362 (Thread-323): handling poll request
2021-05-15 08:35:35.962835 (Thread-323): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72779ce20>]}
2021-05-15 08:35:35.965036 (Thread-323): sending response (<Response 16533 bytes [200 OK]>) to 10.0.40.42
2021-05-15 08:35:38.106972 (Thread-324): handling poll request
2021-05-15 08:35:38.107405 (Thread-324): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72779cf70>]}
2021-05-15 08:35:38.108291 (Thread-324): sending response (<Response 387 bytes [200 OK]>) to 10.0.17.122
2021-05-15 08:35:39.642344 (Thread-325): handling poll request
2021-05-15 08:35:39.642783 (Thread-325): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355fda90>]}
2021-05-15 08:35:39.643677 (Thread-325): sending response (<Response 388 bytes [200 OK]>) to 10.0.4.10
2021-05-15 08:35:41.231592 (Thread-326): handling poll request
2021-05-15 08:35:41.232023 (Thread-326): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355fd6d0>]}
2021-05-15 08:35:41.232900 (Thread-326): sending response (<Response 388 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:35:42.080621 (Thread-1): SQL status: SUCCESS 0 in 6.59 seconds
2021-05-15 08:35:42.081044 (Thread-1): finished collecting timing info
2021-05-15 08:35:42.081403 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:35:43.312425 (Thread-327): handling poll request
2021-05-15 08:35:43.313236 (Thread-327): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735da2430>]}
2021-05-15 08:35:43.317393 (Thread-327): sending response (<Response 71626 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:37:49.338999 (Thread-328): handling status request
2021-05-15 08:37:49.340940 (Thread-328): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73564b040>]}
2021-05-15 08:37:49.343024 (Thread-328): sending response (<Response 6248 bytes [200 OK]>) to 10.0.17.122
2021-05-15 08:37:50.089816 (Thread-329): handling run_sql request
2021-05-15 08:37:50.090272 (Thread-329): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355fd970>]}
2021-05-15 08:37:51.114728 (Thread-329): sending response (<Response 137 bytes [200 OK]>) to 10.0.19.219
2021-05-15 08:37:51.137356 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:37:51.161825 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:37:51.162284 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:37:51.162389 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:37:51.175841 (Thread-1): finished collecting timing info
2021-05-15 08:37:51.185547 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:37:51.185620 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from r_metric  where 1=1
--r_timeframe_type='W'
 and f_metric_id=1
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:37:51.185679 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:37:51.638543 (Thread-330): handling poll request
2021-05-15 08:37:51.639034 (Thread-330): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72657e760>]}
2021-05-15 08:37:51.641239 (Thread-330): sending response (<Response 16539 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:37:52.086302 (Thread-1): Snowflake query id: 019c4245-0000-29ce-0000-b1490023c6a2
2021-05-15 08:37:52.086437 (Thread-1): Snowflake error: 000904 (42000): SQL compilation error: error line 333 at position 5
invalid identifier 'F_METRIC_ID'
2021-05-15 08:37:52.086572 (Thread-1): finished collecting timing info
2021-05-15 08:37:52.086941 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:37:52.151126 (Thread-1): Got an exception: Database Error
  000904 (42000): SQL compilation error: error line 333 at position 5
  invalid identifier 'F_METRIC_ID'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 000904 (42000): SQL compilation error: error line 333 at position 5
invalid identifier 'F_METRIC_ID'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  000904 (42000): SQL compilation error: error line 333 at position 5
  invalid identifier 'F_METRIC_ID'
2021-05-15 08:37:52.152862 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 333 at position 5\n  invalid identifier 'F_METRIC_ID'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from r_metric  where 1=1\n--r_timeframe_type=\'W\'\n and f_metric_id=1\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from r_metric  where 1=1\n--r_timeframe_type=\'W\'\n and f_metric_id=1\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 333 at position 5\n  invalid identifier 'F_METRIC_ID'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from r_metric  where 1=1\n--r_timeframe_type=\'W\'\n and f_metric_id=1\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from r_metric  where 1=1\n--r_timeframe_type=\'W\'\n and f_metric_id=1\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-15 08:37:53.227141 (Thread-331): handling poll request
2021-05-15 08:37:53.227567 (Thread-331): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72643c1f0>]}
2021-05-15 08:37:53.229030 (Thread-331): sending response (<Response 107057 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:38:07.115647 (Thread-332): handling status request
2021-05-15 08:38:07.116090 (Thread-332): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72643c3d0>]}
2021-05-15 08:38:07.118147 (Thread-332): sending response (<Response 6248 bytes [200 OK]>) to 10.0.34.201
2021-05-15 08:38:07.883355 (Thread-333): handling run_sql request
2021-05-15 08:38:07.883798 (Thread-333): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72643c2e0>]}
2021-05-15 08:38:08.911111 (Thread-333): sending response (<Response 137 bytes [200 OK]>) to 10.0.36.138
2021-05-15 08:38:08.934506 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:38:08.956350 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:38:08.956784 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:38:08.956892 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:38:08.970506 (Thread-1): finished collecting timing info
2021-05-15 08:38:08.980487 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:38:08.980562 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from r_metric  where 1=1
--r_timeframe_type='W'
 and r_metric_id=1
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:38:08.980620 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:38:09.352294 (Thread-334): handling poll request
2021-05-15 08:38:09.354910 (Thread-334): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e225b0>]}
2021-05-15 08:38:09.474932 (Thread-334): sending response (<Response 16539 bytes [200 OK]>) to 10.0.31.167
2021-05-15 08:38:11.095372 (Thread-1): SQL status: SUCCESS 232 in 2.11 seconds
2021-05-15 08:38:11.102043 (Thread-1): finished collecting timing info
2021-05-15 08:38:11.102457 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:38:11.667218 (Thread-335): handling poll request
2021-05-15 08:38:11.667648 (Thread-335): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726580220>]}
2021-05-15 08:38:11.673286 (Thread-335): sending response (<Response 88311 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:38:54.237898 (Thread-336): handling status request
2021-05-15 08:38:54.238377 (Thread-336): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72779ca60>]}
2021-05-15 08:38:54.240577 (Thread-336): sending response (<Response 6248 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:38:55.020001 (Thread-337): handling run_sql request
2021-05-15 08:38:55.020459 (Thread-337): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359d9880>]}
2021-05-15 08:38:56.039048 (Thread-337): sending response (<Response 137 bytes [200 OK]>) to 10.0.1.135
2021-05-15 08:38:56.061656 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:38:56.086972 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 08:38:56.087412 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 08:38:56.087518 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 08:38:56.100949 (Thread-1): finished collecting timing info
2021-05-15 08:38:56.110693 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 08:38:56.110767 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(CLDR_WEEK_NUM as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from r_metric  where 1=1
--r_timeframe_type='W'
 and r_metric_id=1
 and r_type='Week'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 08:38:56.110823 (Thread-1): Opening a new connection, currently in state init
2021-05-15 08:38:56.669646 (Thread-338): handling poll request
2021-05-15 08:38:56.670368 (Thread-338): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735932d00>]}
2021-05-15 08:38:56.673774 (Thread-338): sending response (<Response 16559 bytes [200 OK]>) to 10.0.6.126
2021-05-15 08:38:57.589564 (Thread-1): SQL status: SUCCESS 1 in 1.48 seconds
2021-05-15 08:38:57.591126 (Thread-1): finished collecting timing info
2021-05-15 08:38:57.591505 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 08:38:58.183312 (Thread-339): handling poll request
2021-05-15 08:38:58.183748 (Thread-339): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359d9610>]}
2021-05-15 08:38:58.187965 (Thread-339): sending response (<Response 71683 bytes [200 OK]>) to 10.0.4.10
2021-05-15 09:10:22.890570 (Thread-340): Got an acceptable cached parse result
2021-05-15 09:10:23.008314 (Thread-340): Acquiring new snowflake connection "model.DBTTest.HS_SF".
2021-05-15 09:10:23.296273 (Thread-341): handling status request
2021-05-15 09:10:23.307251 (Thread-341): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726a1d280>]}
2021-05-15 09:10:23.309666 (Thread-342): handling status request
2021-05-15 09:10:23.310494 (Thread-341): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.167
2021-05-15 09:10:23.311645 (Thread-343): handling status request
2021-05-15 09:10:23.312126 (Thread-342): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb737967e80>]}
2021-05-15 09:10:23.313059 (Thread-342): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:10:23.313669 (Thread-343): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355f4d60>]}
2021-05-15 09:10:23.314881 (Thread-343): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:10:24.899238 (Thread-344): handling status request
2021-05-15 09:10:24.900048 (Thread-344): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7267bbdc0>]}
2021-05-15 09:10:24.900490 (Thread-345): handling status request
2021-05-15 09:10:24.901245 (Thread-344): sending response (<Response 184 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:10:24.902108 (Thread-346): handling status request
2021-05-15 09:10:24.902325 (Thread-345): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726375040>]}
2021-05-15 09:10:24.903086 (Thread-346): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7267bb6a0>]}
2021-05-15 09:10:24.903790 (Thread-345): sending response (<Response 184 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:10:24.904639 (Thread-346): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:10:25.073774 (Thread-340): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 09:10:25.073938 (Thread-340): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 09:10:25.074003 (Thread-340): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 09:10:25.074072 (Thread-340): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 09:10:25.074127 (Thread-340): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 09:10:25.074956 (Thread-340): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 09:10:25.075309 (Thread-340): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 09:10:25.075604 (Thread-340): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 09:10:25.075861 (Thread-340): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 09:10:25.076099 (Thread-340): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 09:10:25.076340 (Thread-340): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 09:10:25.076577 (Thread-340): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 09:10:25.076811 (Thread-340): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 09:10:25.416602 (Thread-340): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 09:10:26.460383 (Thread-347): handling status request
2021-05-15 09:10:26.460821 (Thread-347): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734400520>]}
2021-05-15 09:10:26.463213 (Thread-347): sending response (<Response 6248 bytes [200 OK]>) to 10.0.41.124
2021-05-15 09:10:26.471805 (Thread-348): handling status request
2021-05-15 09:10:26.472509 (Thread-349): handling status request
2021-05-15 09:10:26.472870 (Thread-348): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73407ed90>]}
2021-05-15 09:10:26.473213 (Thread-349): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726375cd0>]}
2021-05-15 09:10:26.475117 (Thread-348): sending response (<Response 6248 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:10:26.477150 (Thread-349): sending response (<Response 6248 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:10:37.435401 (Thread-350): handling status request
2021-05-15 09:10:37.435832 (Thread-350): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73432ffd0>]}
2021-05-15 09:10:37.437762 (Thread-350): sending response (<Response 6248 bytes [200 OK]>) to 10.0.3.247
2021-05-15 09:10:38.214937 (Thread-351): handling run_sql request
2021-05-15 09:10:38.215368 (Thread-351): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73688d040>]}
2021-05-15 09:10:38.216568 (Thread-351): Connection 'model.DBTTest.HS_SF' was properly closed.
2021-05-15 09:10:39.229270 (Thread-351): sending response (<Response 137 bytes [200 OK]>) to 10.0.46.218
2021-05-15 09:10:39.251714 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:10:39.274143 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:10:39.274613 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:10:39.274722 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:10:39.288353 (Thread-1): finished collecting timing info
2021-05-15 09:10:39.297997 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:10:39.298086 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from r_metric  where 1=1
--r_timeframe_type='W'
 and r_metric_id=1
 and r_type='Week'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:10:39.298144 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:10:39.667696 (Thread-352): handling poll request
2021-05-15 09:10:39.668214 (Thread-352): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb736895460>]}
2021-05-15 09:10:39.670773 (Thread-352): sending response (<Response 16571 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:10:41.251784 (Thread-353): handling poll request
2021-05-15 09:10:41.252219 (Thread-353): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb736895f40>]}
2021-05-15 09:10:41.253092 (Thread-353): sending response (<Response 388 bytes [200 OK]>) to 10.0.41.124
2021-05-15 09:10:42.430802 (Thread-1): SQL status: SUCCESS 1 in 3.13 seconds
2021-05-15 09:10:42.432332 (Thread-1): finished collecting timing info
2021-05-15 09:10:42.432721 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:10:43.393062 (Thread-354): handling poll request
2021-05-15 09:10:43.393494 (Thread-354): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7368953a0>]}
2021-05-15 09:10:43.398302 (Thread-354): sending response (<Response 71742 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:11:23.469646 (Thread-355): handling status request
2021-05-15 09:11:23.470075 (Thread-355): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359d4dc0>]}
2021-05-15 09:11:23.472167 (Thread-355): sending response (<Response 6248 bytes [200 OK]>) to 10.0.45.155
2021-05-15 09:11:24.295532 (Thread-356): handling run_sql request
2021-05-15 09:11:24.295953 (Thread-356): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb736895f70>]}
2021-05-15 09:11:25.322061 (Thread-356): sending response (<Response 137 bytes [200 OK]>) to 10.0.3.247
2021-05-15 09:11:25.345721 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:11:25.371090 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:11:25.371519 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:11:25.371625 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:11:25.385091 (Thread-1): finished collecting timing info
2021-05-15 09:11:25.395016 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:11:25.395101 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=1
 and r_type='Week'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:11:25.395162 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:11:25.885141 (Thread-357): handling poll request
2021-05-15 09:11:25.885597 (Thread-357): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bdeee0>]}
2021-05-15 09:11:25.887896 (Thread-357): sending response (<Response 16577 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:11:27.897061 (Thread-358): handling poll request
2021-05-15 09:11:27.897493 (Thread-358): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bdea00>]}
2021-05-15 09:11:27.898383 (Thread-358): sending response (<Response 388 bytes [200 OK]>) to 10.0.34.201
2021-05-15 09:11:28.996272 (Thread-1): SQL status: SUCCESS 1 in 3.60 seconds
2021-05-15 09:11:28.998043 (Thread-1): finished collecting timing info
2021-05-15 09:11:28.998462 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:11:29.435842 (Thread-359): handling poll request
2021-05-15 09:11:29.436271 (Thread-359): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bdeac0>]}
2021-05-15 09:11:29.440511 (Thread-359): sending response (<Response 71960 bytes [200 OK]>) to 10.0.1.135
2021-05-15 09:18:09.421856 (Thread-360): Got an acceptable cached parse result
2021-05-15 09:18:09.459781 (Thread-361): handling status request
2021-05-15 09:18:09.460224 (Thread-361): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725f82a90>]}
2021-05-15 09:18:09.460979 (Thread-361): sending response (<Response 184 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:18:09.505663 (Thread-362): handling status request
2021-05-15 09:18:09.506024 (Thread-362): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725f82e50>]}
2021-05-15 09:18:09.506732 (Thread-362): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.167
2021-05-15 09:18:09.512742 (Thread-363): handling status request
2021-05-15 09:18:09.513075 (Thread-363): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725f82970>]}
2021-05-15 09:18:09.513679 (Thread-363): sending response (<Response 184 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:18:09.547247 (Thread-360): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 09:18:10.998310 (Thread-364): handling status request
2021-05-15 09:18:10.998737 (Thread-364): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d47f40>]}
2021-05-15 09:18:10.999463 (Thread-364): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.122
2021-05-15 09:18:11.044798 (Thread-365): handling status request
2021-05-15 09:18:11.045690 (Thread-366): handling status request
2021-05-15 09:18:11.045867 (Thread-365): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72604ce20>]}
2021-05-15 09:18:11.046365 (Thread-366): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72604cbe0>]}
2021-05-15 09:18:11.047239 (Thread-365): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.201
2021-05-15 09:18:11.169153 (Thread-366): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.138
2021-05-15 09:18:11.676686 (Thread-360): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 09:18:11.676841 (Thread-360): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 09:18:11.676903 (Thread-360): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 09:18:11.676975 (Thread-360): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 09:18:11.677034 (Thread-360): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 09:18:11.677866 (Thread-360): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 09:18:11.678248 (Thread-360): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 09:18:11.678540 (Thread-360): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 09:18:11.678787 (Thread-360): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 09:18:11.679066 (Thread-360): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 09:18:11.679309 (Thread-360): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 09:18:11.679543 (Thread-360): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 09:18:11.679773 (Thread-360): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 09:18:12.011669 (Thread-360): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 09:18:12.469952 (Thread-367): handling status request
2021-05-15 09:18:12.470432 (Thread-367): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726857d30>]}
2021-05-15 09:18:12.472406 (Thread-367): sending response (<Response 6258 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:18:12.520435 (Thread-368): handling status request
2021-05-15 09:18:12.520726 (Thread-368): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c3aeb0>]}
2021-05-15 09:18:12.522539 (Thread-368): sending response (<Response 6258 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:18:13.602199 (Thread-369): handling status request
2021-05-15 09:18:13.602635 (Thread-369): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734ca0940>]}
2021-05-15 09:18:13.604613 (Thread-369): sending response (<Response 6258 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:18:49.289091 (Thread-370): handling status request
2021-05-15 09:18:49.289508 (Thread-370): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734122c40>]}
2021-05-15 09:18:49.291430 (Thread-370): sending response (<Response 6258 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:18:50.044885 (Thread-371): handling run_sql request
2021-05-15 09:18:50.045296 (Thread-371): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734122b20>]}
2021-05-15 09:18:50.046503 (Thread-371): Connection 'model.DBTTest.SF_HF_segmented' was properly closed.
2021-05-15 09:18:51.063407 (Thread-371): sending response (<Response 137 bytes [200 OK]>) to 10.0.17.122
2021-05-15 09:18:51.086463 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:18:51.108316 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:18:51.108763 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:18:51.108873 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:18:51.122293 (Thread-1): finished collecting timing info
2021-05-15 09:18:51.131221 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:18:51.131298 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='W' and f_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:18:51.131358 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:18:51.606894 (Thread-372): handling poll request
2021-05-15 09:18:51.607348 (Thread-372): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d61070>]}
2021-05-15 09:18:51.609588 (Thread-372): sending response (<Response 14893 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:18:53.635651 (Thread-373): handling poll request
2021-05-15 09:18:53.636075 (Thread-373): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d610a0>]}
2021-05-15 09:18:53.636952 (Thread-373): sending response (<Response 398 bytes [200 OK]>) to 10.0.45.155
2021-05-15 09:18:55.100128 (Thread-374): handling poll request
2021-05-15 09:18:55.100558 (Thread-374): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d61070>]}
2021-05-15 09:18:55.101420 (Thread-374): sending response (<Response 397 bytes [200 OK]>) to 10.0.4.10
2021-05-15 09:18:56.590092 (Thread-375): handling poll request
2021-05-15 09:18:56.590552 (Thread-375): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341dff40>]}
2021-05-15 09:18:56.591423 (Thread-375): sending response (<Response 398 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:18:58.685248 (Thread-376): handling poll request
2021-05-15 09:18:58.685686 (Thread-376): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341df790>]}
2021-05-15 09:18:58.687070 (Thread-376): sending response (<Response 398 bytes [200 OK]>) to 10.0.46.218
2021-05-15 09:18:59.797345 (Thread-1): SQL status: SUCCESS 0 in 8.67 seconds
2021-05-15 09:18:59.797771 (Thread-1): finished collecting timing info
2021-05-15 09:18:59.798150 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:19:00.236909 (Thread-377): handling poll request
2021-05-15 09:19:00.237343 (Thread-377): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d61430>]}
2021-05-15 09:19:00.241531 (Thread-377): sending response (<Response 63413 bytes [200 OK]>) to 10.0.1.135
2021-05-15 09:19:24.817290 (Thread-378): handling status request
2021-05-15 09:19:24.817706 (Thread-378): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341227f0>]}
2021-05-15 09:19:24.819769 (Thread-378): sending response (<Response 6258 bytes [200 OK]>) to 10.0.36.138
2021-05-15 09:19:25.725478 (Thread-379): handling run_sql request
2021-05-15 09:19:25.725897 (Thread-379): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734122610>]}
2021-05-15 09:19:26.770939 (Thread-379): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.49
2021-05-15 09:19:26.794047 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:19:26.818595 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:19:26.819052 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:19:26.819159 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:19:26.832999 (Thread-1): finished collecting timing info
2021-05-15 09:19:26.841822 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:19:26.841909 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where F_TIMEFRAME_TYPE='Y' and f_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:19:26.841969 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:19:27.276116 (Thread-380): handling poll request
2021-05-15 09:19:27.276613 (Thread-380): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341df910>]}
2021-05-15 09:19:27.278876 (Thread-380): sending response (<Response 14893 bytes [200 OK]>) to 10.0.34.201
2021-05-15 09:19:28.784467 (Thread-381): handling poll request
2021-05-15 09:19:28.784897 (Thread-381): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341df460>]}
2021-05-15 09:19:28.785823 (Thread-381): sending response (<Response 398 bytes [200 OK]>) to 10.0.41.124
2021-05-15 09:19:30.317662 (Thread-382): handling poll request
2021-05-15 09:19:30.318093 (Thread-382): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341df0a0>]}
2021-05-15 09:19:30.319018 (Thread-382): sending response (<Response 398 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:19:33.269267 (Thread-383): handling poll request
2021-05-15 09:19:33.269699 (Thread-383): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7342475b0>]}
2021-05-15 09:19:33.270618 (Thread-383): sending response (<Response 398 bytes [200 OK]>) to 10.0.15.49
2021-05-15 09:19:34.442963 (Thread-1): SQL status: SUCCESS 1 in 7.60 seconds
2021-05-15 09:19:34.444758 (Thread-1): finished collecting timing info
2021-05-15 09:19:34.445133 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:19:34.829000 (Thread-384): handling poll request
2021-05-15 09:19:34.829490 (Thread-384): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7344e5790>]}
2021-05-15 09:19:34.833969 (Thread-384): sending response (<Response 63561 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:20:07.231943 (Thread-385): handling status request
2021-05-15 09:20:07.232361 (Thread-385): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7344e5a60>]}
2021-05-15 09:20:07.234398 (Thread-385): sending response (<Response 6258 bytes [200 OK]>) to 10.0.41.124
2021-05-15 09:20:07.928619 (Thread-386): handling run_sql request
2021-05-15 09:20:07.929052 (Thread-386): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7344e5730>]}
2021-05-15 09:20:08.983384 (Thread-386): sending response (<Response 137 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:20:09.005955 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:20:09.028083 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:20:09.028613 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:20:09.028723 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:20:09.044411 (Thread-1): finished collecting timing info
2021-05-15 09:20:09.054331 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:20:09.054425 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from seg_fs where F_TIMEFRAME_TYPE='Y' and f_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:20:09.054485 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:20:09.563736 (Thread-387): handling poll request
2021-05-15 09:20:09.564224 (Thread-387): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d610d0>]}
2021-05-15 09:20:09.566785 (Thread-387): sending response (<Response 14885 bytes [200 OK]>) to 10.0.46.218
2021-05-15 09:20:11.063679 (Thread-388): handling poll request
2021-05-15 09:20:11.064119 (Thread-388): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d613d0>]}
2021-05-15 09:20:11.065038 (Thread-388): sending response (<Response 398 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:20:13.140629 (Thread-389): handling poll request
2021-05-15 09:20:13.141093 (Thread-389): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734ca07f0>]}
2021-05-15 09:20:13.141973 (Thread-389): sending response (<Response 398 bytes [200 OK]>) to 10.0.19.219
2021-05-15 09:20:13.459982 (Thread-1): SQL status: SUCCESS 8 in 4.41 seconds
2021-05-15 09:20:13.461713 (Thread-1): finished collecting timing info
2021-05-15 09:20:13.462093 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:20:14.613573 (Thread-390): handling poll request
2021-05-15 09:20:14.613984 (Thread-390): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726c9d130>]}
2021-05-15 09:20:14.618373 (Thread-390): sending response (<Response 63789 bytes [200 OK]>) to 10.0.3.247
2021-05-15 09:20:19.736061 (Thread-391): handling status request
2021-05-15 09:20:19.736497 (Thread-391): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735601190>]}
2021-05-15 09:20:19.738610 (Thread-391): sending response (<Response 6258 bytes [200 OK]>) to 10.0.15.49
2021-05-15 09:20:20.493348 (Thread-392): handling run_sql request
2021-05-15 09:20:20.493769 (Thread-392): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735601370>]}
2021-05-15 09:20:21.512654 (Thread-392): sending response (<Response 137 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:20:21.534154 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:20:21.555734 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:20:21.556183 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:20:21.556294 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:20:21.570001 (Thread-1): finished collecting timing info
2021-05-15 09:20:21.578877 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:20:21.578971 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from seg_fs where F_TIMEFRAME_TYPE='W' and f_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:20:21.579034 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:20:22.079582 (Thread-393): handling poll request
2021-05-15 09:20:22.080029 (Thread-393): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735601100>]}
2021-05-15 09:20:22.082167 (Thread-393): sending response (<Response 14885 bytes [200 OK]>) to 10.0.34.201
2021-05-15 09:20:23.590038 (Thread-394): handling poll request
2021-05-15 09:20:23.590495 (Thread-394): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d61940>]}
2021-05-15 09:20:23.591373 (Thread-394): sending response (<Response 398 bytes [200 OK]>) to 10.0.46.218
2021-05-15 09:20:25.079027 (Thread-395): handling poll request
2021-05-15 09:20:25.079479 (Thread-395): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341df160>]}
2021-05-15 09:20:25.080377 (Thread-395): sending response (<Response 398 bytes [200 OK]>) to 10.0.41.124
2021-05-15 09:20:25.821412 (Thread-1): SQL status: SUCCESS 338 in 4.24 seconds
2021-05-15 09:20:25.830052 (Thread-1): finished collecting timing info
2021-05-15 09:20:25.830459 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:20:26.602788 (Thread-396): handling poll request
2021-05-15 09:20:26.603212 (Thread-396): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7275d65e0>]}
2021-05-15 09:20:26.725283 (Thread-396): sending response (<Response 85523 bytes [200 OK]>) to 10.0.45.155
2021-05-15 09:22:58.218861 (Thread-397): handling status request
2021-05-15 09:22:58.220692 (Thread-397): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735dba700>]}
2021-05-15 09:22:58.222725 (Thread-397): sending response (<Response 6258 bytes [200 OK]>) to 10.0.4.10
2021-05-15 09:22:58.979419 (Thread-398): handling run_sql request
2021-05-15 09:22:58.979843 (Thread-398): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725eccb80>]}
2021-05-15 09:23:00.036973 (Thread-398): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:23:00.059347 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:23:00.083817 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:23:00.084301 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:23:00.084420 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:23:00.099075 (Thread-1): finished collecting timing info
2021-05-15 09:23:00.110110 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:23:00.110225 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_TIMEFRAME_TYPE='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:23:00.110289 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:23:00.582623 (Thread-399): handling poll request
2021-05-15 09:23:00.583108 (Thread-399): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734358ca0>]}
2021-05-15 09:23:00.585334 (Thread-399): sending response (<Response 14893 bytes [200 OK]>) to 10.0.1.135
2021-05-15 09:23:01.672930 (Thread-1): SQL status: SUCCESS 0 in 1.56 seconds
2021-05-15 09:23:01.673325 (Thread-1): finished collecting timing info
2021-05-15 09:23:01.673697 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:23:02.085175 (Thread-400): handling poll request
2021-05-15 09:23:02.085608 (Thread-400): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7344e54c0>]}
2021-05-15 09:23:02.089788 (Thread-400): sending response (<Response 63271 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:23:46.236246 (Thread-401): handling status request
2021-05-15 09:23:46.236685 (Thread-401): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bd97c0>]}
2021-05-15 09:23:46.238850 (Thread-401): sending response (<Response 6258 bytes [200 OK]>) to 10.0.6.126
2021-05-15 09:23:47.052924 (Thread-402): handling run_sql request
2021-05-15 09:23:47.053345 (Thread-402): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bd9f40>]}
2021-05-15 09:23:48.084125 (Thread-402): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.49
2021-05-15 09:23:48.109721 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:23:48.131601 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:23:48.132060 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:23:48.132168 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:23:48.145818 (Thread-1): finished collecting timing info
2021-05-15 09:23:48.154616 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:23:48.154704 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from calendar --where r_TIMEFRAME_TYPE='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:23:48.154763 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:23:48.557906 (Thread-403): handling poll request
2021-05-15 09:23:48.558397 (Thread-403): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725f82070>]}
2021-05-15 09:23:48.561212 (Thread-403): sending response (<Response 14891 bytes [200 OK]>) to 10.0.4.10
2021-05-15 09:23:49.721482 (Thread-1): SQL status: SUCCESS 500 in 1.57 seconds
2021-05-15 09:23:49.739176 (Thread-1): finished collecting timing info
2021-05-15 09:23:49.739613 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:23:49.997658 (Thread-404): handling poll request
2021-05-15 09:23:49.998090 (Thread-404): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343587f0>]}
2021-05-15 09:23:49.999323 (Thread-404): sending response (<Response 1341 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:23:51.474884 (Thread-405): handling poll request
2021-05-15 09:23:51.475422 (Thread-405): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341227f0>]}
2021-05-15 09:23:51.482571 (Thread-405): sending response (<Response 100386 bytes [200 OK]>) to 10.0.3.247
2021-05-15 09:25:42.045842 (Thread-406): handling status request
2021-05-15 09:25:42.047855 (Thread-406): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d613d0>]}
2021-05-15 09:25:42.049883 (Thread-406): sending response (<Response 6258 bytes [200 OK]>) to 10.0.3.247
2021-05-15 09:25:42.805772 (Thread-407): handling run_sql request
2021-05-15 09:25:42.806264 (Thread-407): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343582b0>]}
2021-05-15 09:25:43.844451 (Thread-407): sending response (<Response 137 bytes [200 OK]>) to 10.0.17.122
2021-05-15 09:25:43.866545 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:25:43.890881 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:25:43.891339 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:25:43.891444 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:25:43.904785 (Thread-1): finished collecting timing info
2021-05-15 09:25:43.913598 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:25:43.913668 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select distinct timeframe_type from calendar --where r_TIMEFRAME_TYPE='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:25:43.913725 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:25:44.343404 (Thread-408): handling poll request
2021-05-15 09:25:44.343854 (Thread-408): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f209d0>]}
2021-05-15 09:25:44.345981 (Thread-408): sending response (<Response 14914 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:25:45.355108 (Thread-1): SQL status: SUCCESS 77 in 1.44 seconds
2021-05-15 09:25:45.356926 (Thread-1): finished collecting timing info
2021-05-15 09:25:45.357312 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:25:45.794643 (Thread-409): handling poll request
2021-05-15 09:25:45.795067 (Thread-409): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bdabb0>]}
2021-05-15 09:25:45.799344 (Thread-409): sending response (<Response 64007 bytes [200 OK]>) to 10.0.17.122
2021-05-15 09:26:56.777469 (Thread-410): handling status request
2021-05-15 09:26:56.779552 (Thread-410): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726adaac0>]}
2021-05-15 09:26:56.781607 (Thread-410): sending response (<Response 6258 bytes [200 OK]>) to 10.0.34.201
2021-05-15 09:26:57.461696 (Thread-411): handling run_sql request
2021-05-15 09:26:57.462296 (Thread-411): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f201f0>]}
2021-05-15 09:26:58.526504 (Thread-411): sending response (<Response 137 bytes [200 OK]>) to 10.0.4.10
2021-05-15 09:26:58.548388 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:26:58.572880 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:26:58.573306 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:26:58.573415 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:26:58.586887 (Thread-1): finished collecting timing info
2021-05-15 09:26:58.595644 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:26:58.595732 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_TIMEFRAME_TYPE='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:26:58.595791 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:26:59.055019 (Thread-412): handling poll request
2021-05-15 09:26:59.055471 (Thread-412): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f20130>]}
2021-05-15 09:26:59.057623 (Thread-412): sending response (<Response 14893 bytes [200 OK]>) to 10.0.17.122
2021-05-15 09:26:59.564653 (Thread-1): SQL status: SUCCESS 0 in 0.97 seconds
2021-05-15 09:26:59.565083 (Thread-1): finished collecting timing info
2021-05-15 09:26:59.565483 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:27:00.601744 (Thread-413): handling poll request
2021-05-15 09:27:00.602203 (Thread-413): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726a1d4c0>]}
2021-05-15 09:27:00.606418 (Thread-413): sending response (<Response 63272 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:27:10.759626 (Thread-414): handling status request
2021-05-15 09:27:10.760044 (Thread-414): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726a1d1f0>]}
2021-05-15 09:27:10.762062 (Thread-414): sending response (<Response 6258 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:27:11.609354 (Thread-415): handling run_sql request
2021-05-15 09:27:11.609773 (Thread-415): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726a1d970>]}
2021-05-15 09:27:12.713207 (Thread-415): sending response (<Response 137 bytes [200 OK]>) to 10.0.45.155
2021-05-15 09:27:12.735595 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:27:12.757524 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:27:12.757961 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:27:12.758069 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:27:12.771693 (Thread-1): finished collecting timing info
2021-05-15 09:27:12.780615 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:27:12.780695 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            0 AS r_amount,
            52 AS r_metric_id,
            Source as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal_Stage as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(DATE_ENTERED) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_type='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:27:12.780756 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:27:13.153014 (Thread-416): handling poll request
2021-05-15 09:27:13.153497 (Thread-416): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f2a8b0>]}
2021-05-15 09:27:13.155676 (Thread-416): sending response (<Response 14883 bytes [200 OK]>) to 10.0.17.122
2021-05-15 09:27:14.382189 (Thread-1): SQL status: SUCCESS 0 in 1.60 seconds
2021-05-15 09:27:14.382601 (Thread-1): finished collecting timing info
2021-05-15 09:27:14.382973 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:27:14.587839 (Thread-417): handling poll request
2021-05-15 09:27:14.588250 (Thread-417): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73438fa00>]}
2021-05-15 09:27:14.589410 (Thread-417): sending response (<Response 1339 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:27:16.087197 (Thread-418): handling poll request
2021-05-15 09:27:16.087620 (Thread-418): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73438fcd0>]}
2021-05-15 09:27:16.093607 (Thread-418): sending response (<Response 62281 bytes [200 OK]>) to 10.0.1.135
2021-05-15 09:36:26.395081 (Thread-419): handling status request
2021-05-15 09:36:26.397303 (Thread-419): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73438fc70>]}
2021-05-15 09:36:26.399398 (Thread-419): sending response (<Response 6258 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:36:27.280038 (Thread-420): handling run_sql request
2021-05-15 09:36:27.280463 (Thread-420): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73438f760>]}
2021-05-15 09:36:28.305004 (Thread-420): sending response (<Response 137 bytes [200 OK]>) to 10.0.36.138
2021-05-15 09:36:28.327013 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:36:28.351822 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:36:28.352257 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:36:28.352365 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:36:28.365705 (Thread-1): finished collecting timing info
2021-05-15 09:36:28.374704 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:36:28.374780 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            PROPERTY_AMOUNT AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal del left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = del.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = del.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_type='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:36:28.374838 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:36:28.903099 (Thread-421): handling poll request
2021-05-15 09:36:28.903588 (Thread-421): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744876730>]}
2021-05-15 09:36:28.905851 (Thread-421): sending response (<Response 15141 bytes [200 OK]>) to 10.0.45.155
2021-05-15 09:36:29.090879 (Thread-1): Snowflake query id: 019c4280-0000-299a-0000-b1490023e1fa
2021-05-15 09:36:29.091013 (Thread-1): Snowflake error: 000904 (42000): SQL compilation error: error line 158 at position 82
invalid identifier 'DEAL.PROPERTY_CREATEDATE'
2021-05-15 09:36:29.091144 (Thread-1): finished collecting timing info
2021-05-15 09:36:29.091520 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:36:29.162708 (Thread-1): Got an exception: Database Error
  000904 (42000): SQL compilation error: error line 158 at position 82
  invalid identifier 'DEAL.PROPERTY_CREATEDATE'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 000904 (42000): SQL compilation error: error line 158 at position 82
invalid identifier 'DEAL.PROPERTY_CREATEDATE'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  000904 (42000): SQL compilation error: error line 158 at position 82
  invalid identifier 'DEAL.PROPERTY_CREATEDATE'
2021-05-15 09:36:29.164254 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 158 at position 82\n  invalid identifier 'DEAL.PROPERTY_CREATEDATE'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal del left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = del.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = del.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal del left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = del.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = del.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 158 at position 82\n  invalid identifier 'DEAL.PROPERTY_CREATEDATE'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal del left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = del.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = del.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal del left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = del.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = del.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-15 09:36:30.458749 (Thread-422): handling poll request
2021-05-15 09:36:30.459180 (Thread-422): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7275d67c0>]}
2021-05-15 09:36:30.460529 (Thread-422): sending response (<Response 96881 bytes [200 OK]>) to 10.0.34.201
2021-05-15 09:37:11.950577 (Thread-423): handling status request
2021-05-15 09:37:11.951011 (Thread-423): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b4cb50>]}
2021-05-15 09:37:11.953045 (Thread-423): sending response (<Response 6258 bytes [200 OK]>) to 10.0.19.219
2021-05-15 09:37:12.810688 (Thread-424): handling run_sql request
2021-05-15 09:37:12.811108 (Thread-424): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73460e9d0>]}
2021-05-15 09:37:13.836828 (Thread-424): sending response (<Response 137 bytes [200 OK]>) to 10.0.34.201
2021-05-15 09:37:13.858914 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:37:13.880507 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:37:13.880920 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:37:13.881027 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:37:13.894445 (Thread-1): finished collecting timing info
2021-05-15 09:37:13.903411 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:37:13.903484 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            PROPERTY_AMOUNT AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = del.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_type='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:37:13.903543 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:37:14.365321 (Thread-425): handling poll request
2021-05-15 09:37:14.366258 (Thread-425): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73413a040>]}
2021-05-15 09:37:14.368380 (Thread-425): sending response (<Response 15148 bytes [200 OK]>) to 10.0.6.126
2021-05-15 09:37:14.757902 (Thread-1): Snowflake query id: 019c4281-0000-299a-0000-b1490023e4a2
2021-05-15 09:37:14.758035 (Thread-1): Snowflake error: 000904 (42000): SQL compilation error: error line 157 at position 141
invalid identifier 'DEL.SOURCE_DEAL_ID'
2021-05-15 09:37:14.758188 (Thread-1): finished collecting timing info
2021-05-15 09:37:14.758578 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:37:14.854807 (Thread-1): Got an exception: Database Error
  000904 (42000): SQL compilation error: error line 157 at position 141
  invalid identifier 'DEL.SOURCE_DEAL_ID'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 000904 (42000): SQL compilation error: error line 157 at position 141
invalid identifier 'DEL.SOURCE_DEAL_ID'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  000904 (42000): SQL compilation error: error line 157 at position 141
  invalid identifier 'DEL.SOURCE_DEAL_ID'
2021-05-15 09:37:14.856276 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 157 at position 141\n  invalid identifier 'DEL.SOURCE_DEAL_ID'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = del.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = del.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 157 at position 141\n  invalid identifier 'DEL.SOURCE_DEAL_ID'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = del.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = del.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-15 09:37:15.879382 (Thread-426): handling poll request
2021-05-15 09:37:15.879838 (Thread-426): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f20c10>]}
2021-05-15 09:37:16.005898 (Thread-426): sending response (<Response 96895 bytes [200 OK]>) to 10.0.41.124
2021-05-15 09:37:34.067054 (Thread-427): handling status request
2021-05-15 09:37:34.067483 (Thread-427): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726861070>]}
2021-05-15 09:37:34.069461 (Thread-427): sending response (<Response 6258 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:37:34.859350 (Thread-428): handling run_sql request
2021-05-15 09:37:34.859778 (Thread-428): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726533820>]}
2021-05-15 09:37:35.873492 (Thread-428): sending response (<Response 137 bytes [200 OK]>) to 10.0.6.126
2021-05-15 09:37:35.895331 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:37:35.919975 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:37:35.920392 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:37:35.920498 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:37:35.933865 (Thread-1): finished collecting timing info
2021-05-15 09:37:35.942874 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:37:35.942945 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            PROPERTY_AMOUNT AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_type='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:37:35.943001 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:37:36.531165 (Thread-429): handling poll request
2021-05-15 09:37:36.531617 (Thread-429): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735698070>]}
2021-05-15 09:37:36.533739 (Thread-429): sending response (<Response 15149 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:37:36.776153 (Thread-1): Snowflake query id: 019c4281-0000-299a-0000-b1490023e586
2021-05-15 09:37:36.776289 (Thread-1): Snowflake error: 000904 (42000): SQL compilation error: error line 158 at position 108
invalid identifier 'CLDR_DATE'
2021-05-15 09:37:36.776420 (Thread-1): finished collecting timing info
2021-05-15 09:37:36.776782 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:37:36.859506 (Thread-1): Got an exception: Database Error
  000904 (42000): SQL compilation error: error line 158 at position 108
  invalid identifier 'CLDR_DATE'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 000904 (42000): SQL compilation error: error line 158 at position 108
invalid identifier 'CLDR_DATE'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  000904 (42000): SQL compilation error: error line 158 at position 108
  invalid identifier 'CLDR_DATE'
2021-05-15 09:37:36.860988 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 158 at position 108\n  invalid identifier 'CLDR_DATE'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  000904 (42000): SQL compilation error: error line 158 at position 108\n  invalid identifier 'CLDR_DATE'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-15 09:37:38.713517 (Thread-430): handling poll request
2021-05-15 09:37:38.713940 (Thread-430): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e64dc0>]}
2021-05-15 09:37:38.715304 (Thread-430): sending response (<Response 96839 bytes [200 OK]>) to 10.0.15.49
2021-05-15 09:39:27.358896 (Thread-431): handling status request
2021-05-15 09:39:27.361422 (Thread-431): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d3f4c0>]}
2021-05-15 09:39:27.363474 (Thread-431): sending response (<Response 6258 bytes [200 OK]>) to 10.0.36.138
2021-05-15 09:39:28.069026 (Thread-432): handling run_sql request
2021-05-15 09:39:28.069451 (Thread-432): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d3f460>]}
2021-05-15 09:39:29.092074 (Thread-432): sending response (<Response 137 bytes [200 OK]>) to 10.0.4.10
2021-05-15 09:39:29.114247 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:39:29.139024 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:39:29.139461 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:39:29.139568 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:39:29.152943 (Thread-1): finished collecting timing info
2021-05-15 09:39:29.162074 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:39:29.162195 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(Source_deal_id) as r_count,
            PROPERTY_AMOUNT AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_type='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:39:29.162257 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:39:29.511890 (Thread-433): handling poll request
2021-05-15 09:39:29.512340 (Thread-433): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d3f580>]}
2021-05-15 09:39:29.514455 (Thread-433): sending response (<Response 15189 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:39:29.877525 (Thread-1): Snowflake query id: 019c4283-0000-299a-0000-b1490023e72e
2021-05-15 09:39:29.877656 (Thread-1): Snowflake error: 002028 (42601): SQL compilation error:
ambiguous column name 'SOURCE_DEAL_ID'
2021-05-15 09:39:29.877778 (Thread-1): finished collecting timing info
2021-05-15 09:39:29.878158 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:39:29.948760 (Thread-1): Got an exception: Database Error
  002028 (42601): SQL compilation error:
  ambiguous column name 'SOURCE_DEAL_ID'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 002028 (42601): SQL compilation error:
ambiguous column name 'SOURCE_DEAL_ID'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  002028 (42601): SQL compilation error:
  ambiguous column name 'SOURCE_DEAL_ID'
2021-05-15 09:39:29.950338 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  002028 (42601): SQL compilation error:\n  ambiguous column name 'SOURCE_DEAL_ID'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  002028 (42601): SQL compilation error:\n  ambiguous column name 'SOURCE_DEAL_ID'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-15 09:39:31.092780 (Thread-434): handling poll request
2021-05-15 09:39:31.093211 (Thread-434): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c36940>]}
2021-05-15 09:39:31.094606 (Thread-434): sending response (<Response 96958 bytes [200 OK]>) to 10.0.45.155
2021-05-15 09:40:04.214731 (Thread-435): handling status request
2021-05-15 09:40:04.215163 (Thread-435): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726861100>]}
2021-05-15 09:40:04.217174 (Thread-435): sending response (<Response 6258 bytes [200 OK]>) to 10.0.19.219
2021-05-15 09:40:05.044004 (Thread-436): handling run_sql request
2021-05-15 09:40:05.044431 (Thread-436): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72690b490>]}
2021-05-15 09:40:06.056800 (Thread-436): sending response (<Response 137 bytes [200 OK]>) to 10.0.3.247
2021-05-15 09:40:06.079110 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:40:06.101134 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:40:06.101588 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:40:06.101699 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:40:06.115682 (Thread-1): finished collecting timing info
2021-05-15 09:40:06.124944 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:40:06.125022 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            PROPERTY_AMOUNT AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_type='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:40:06.125085 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:40:06.497506 (Thread-437): handling poll request
2021-05-15 09:40:06.497946 (Thread-437): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7340c8640>]}
2021-05-15 09:40:06.500101 (Thread-437): sending response (<Response 15194 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:40:07.500102 (Thread-1): Snowflake query id: 019c4284-0000-299a-0000-b1490023e732
2021-05-15 09:40:07.500237 (Thread-1): Snowflake error: 002028 (42601): SQL compilation error:
ambiguous column name 'SOURCE_TYPE'
2021-05-15 09:40:07.500364 (Thread-1): finished collecting timing info
2021-05-15 09:40:07.500721 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:40:07.556908 (Thread-1): Got an exception: Database Error
  002028 (42601): SQL compilation error:
  ambiguous column name 'SOURCE_TYPE'
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 002028 (42601): SQL compilation error:
ambiguous column name 'SOURCE_TYPE'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  002028 (42601): SQL compilation error:
  ambiguous column name 'SOURCE_TYPE'
2021-05-15 09:40:07.558412 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  002028 (42601): SQL compilation error:\n  ambiguous column name 'SOURCE_TYPE'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(deal.Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(deal.Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  002028 (42601): SQL compilation error:\n  ambiguous column name 'SOURCE_TYPE'", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(deal.Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(deal.Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-15 09:40:08.518774 (Thread-438): handling poll request
2021-05-15 09:40:08.519189 (Thread-438): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7368fa7c0>]}
2021-05-15 09:40:08.520558 (Thread-438): sending response (<Response 96972 bytes [200 OK]>) to 10.0.31.167
2021-05-15 09:40:28.201041 (Thread-439): handling status request
2021-05-15 09:40:28.201481 (Thread-439): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7368fa910>]}
2021-05-15 09:40:28.203812 (Thread-439): sending response (<Response 6258 bytes [200 OK]>) to 10.0.31.167
2021-05-15 09:40:29.086999 (Thread-440): handling run_sql request
2021-05-15 09:40:29.087430 (Thread-440): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7368fab20>]}
2021-05-15 09:40:30.162551 (Thread-440): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:40:30.185433 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:40:30.210512 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:40:30.211012 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:40:30.211128 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:40:30.224937 (Thread-1): finished collecting timing info
2021-05-15 09:40:30.234307 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:40:30.234405 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            PROPERTY_AMOUNT AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_type='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:40:30.234468 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:40:30.639712 (Thread-441): handling poll request
2021-05-15 09:40:30.640199 (Thread-441): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726d00460>]}
2021-05-15 09:40:30.642878 (Thread-441): sending response (<Response 15199 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:40:31.225174 (Thread-1): Snowflake query id: 019c4284-0000-29a2-0000-b1490023dde6
2021-05-15 09:40:31.225314 (Thread-1): Snowflake error: 001104 (42601): SQL compilation error: error line 0 at position -1
'SYS_VW.PROPERTY_AMOUNT_0' in select clause is neither an aggregate nor in the group by clause.
2021-05-15 09:40:31.225456 (Thread-1): finished collecting timing info
2021-05-15 09:40:31.225822 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:40:31.306974 (Thread-1): Got an exception: Database Error
  001104 (42601): SQL compilation error: error line 0 at position -1
  'SYS_VW.PROPERTY_AMOUNT_0' in select clause is neither an aggregate nor in the group by clause.
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 001104 (42601): SQL compilation error: error line 0 at position -1
'SYS_VW.PROPERTY_AMOUNT_0' in select clause is neither an aggregate nor in the group by clause.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  001104 (42601): SQL compilation error: error line 0 at position -1
  'SYS_VW.PROPERTY_AMOUNT_0' in select clause is neither an aggregate nor in the group by clause.
2021-05-15 09:40:31.308688 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  001104 (42601): SQL compilation error: error line 0 at position -1\n  'SYS_VW.PROPERTY_AMOUNT_0' in select clause is neither an aggregate nor in the group by clause.", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(deal.Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            deal.Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(deal.Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            deal.Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  001104 (42601): SQL compilation error: error line 0 at position -1\n  'SYS_VW.PROPERTY_AMOUNT_0' in select clause is neither an aggregate nor in the group by clause.", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(deal.Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            deal.Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),segr_metric AS (\n    --- SF  New Leads by industry 7\n       select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            7 AS r_metric_id,\n            INDUSTRY as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8\n\n         -- New Leads by Lead Source 18\n     union\n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            18 AS r_metric_id,\n            LEAD_SOURCE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --New Leads by Lead Status 19      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            19 AS r_metric_id,\n            STATUS as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n\n      union    --Accounts by Type 28      \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            28 AS r_metric_id,\n            acc.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8 \n       \n      union    --Leads by emp_id= 30     \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            30 AS r_metric_id,\n            owner_id as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8  \n\n      union    --Leads by location= 31   \n     select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            31 AS r_metric_id,\n            concat(led.street,\' \',led.city,\' \',led.state,\' \',led.postal_code,\' \',led.country) as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n     \n      union    --Opportunities by type = 32  \n     select \n            count(source_id) as r_count,\n            sum(oppo.AMOUNT) AS r_amount,\n            32 AS r_metric_id,\n            oppo.TYPE as r_segment_name,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  \n        where \n         timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7,8   \n  -- HS\n       union    --Deals by Original Source Data= 52 \n      select \n            count(deal.Source_deal_id) as r_count,\n            PROPERTY_AMOUNT AS r_amount,\n            52 AS r_metric_id,\n            OPPORTUNITY_STG.Source as r_segment_name,\n            deal.Source_type as r_Source_type, \n            calendar.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID \n        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE\n        where \n         timeframe_type is not null\n         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date\n        group by 4,5,6,7,8   \n    \n    union   --Deals Created by Pipeline 62\n\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            62 AS r_metric_id,\n            DEAL_PIPELINE_STAGE_ID as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n    \n    union   --Revenue by Company 85\n\n        select\n           \n            count(Source_ID) as r_count,\n            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,\n            85 AS r_metric_id,\n            PROPERTY_NAME as r_segment_name,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Company,calendar\n         where \n         timeframe_type is not null\n         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7,8\n\n\n\n \n\n),seg_fs AS(\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7,8\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n    union\n    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,\n    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7,8\n\n),compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_segment_name,\n    f_segment_name,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id \n    and r_segment_name = f_segment_name\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\n\nselect * from segr_metric where r_type=\'Week\' and r_metric_id= 52\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-15 09:40:32.233855 (Thread-442): handling poll request
2021-05-15 09:40:32.234300 (Thread-442): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341f6550>]}
2021-05-15 09:40:32.235674 (Thread-442): sending response (<Response 97623 bytes [200 OK]>) to 10.0.45.155
2021-05-15 09:40:57.020854 (Thread-443): handling status request
2021-05-15 09:40:57.021541 (Thread-443): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735948400>]}
2021-05-15 09:40:57.023736 (Thread-443): sending response (<Response 6258 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:40:57.830832 (Thread-444): handling run_sql request
2021-05-15 09:40:57.831247 (Thread-444): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359489d0>]}
2021-05-15 09:40:58.903210 (Thread-444): sending response (<Response 137 bytes [200 OK]>) to 10.0.3.247
2021-05-15 09:40:58.928121 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:40:58.949984 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:40:58.950446 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:40:58.950556 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:40:58.964725 (Thread-1): finished collecting timing info
2021-05-15 09:40:58.973885 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:40:58.973978 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            sum(PROPERTY_AMOUNT) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_type='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:40:58.974038 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:40:59.370483 (Thread-445): handling poll request
2021-05-15 09:40:59.370926 (Thread-445): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c94940>]}
2021-05-15 09:40:59.373301 (Thread-445): sending response (<Response 15204 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:41:00.898942 (Thread-446): handling poll request
2021-05-15 09:41:00.899363 (Thread-446): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735948a60>]}
2021-05-15 09:41:00.900371 (Thread-446): sending response (<Response 396 bytes [200 OK]>) to 10.0.4.10
2021-05-15 09:41:01.409244 (Thread-1): SQL status: SUCCESS 8 in 2.44 seconds
2021-05-15 09:41:01.411018 (Thread-1): finished collecting timing info
2021-05-15 09:41:01.411401 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:41:02.337426 (Thread-447): handling poll request
2021-05-15 09:41:02.337865 (Thread-447): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726d00100>]}
2021-05-15 09:41:02.342188 (Thread-447): sending response (<Response 65424 bytes [200 OK]>) to 10.0.31.167
2021-05-15 09:41:23.602988 (Thread-448): handling status request
2021-05-15 09:41:23.603411 (Thread-448): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c94a00>]}
2021-05-15 09:41:23.605410 (Thread-448): sending response (<Response 6258 bytes [200 OK]>) to 10.0.15.49
2021-05-15 09:41:24.385594 (Thread-449): handling run_sql request
2021-05-15 09:41:24.386015 (Thread-449): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735c94ca0>]}
2021-05-15 09:41:25.409827 (Thread-449): sending response (<Response 137 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:41:25.431959 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:41:25.453644 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:41:25.454096 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:41:25.454223 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:41:25.467700 (Thread-1): finished collecting timing info
2021-05-15 09:41:25.476841 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:41:25.476919 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            sum(PROPERTY_AMOUNT) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where r_type='Week' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:41:25.476978 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:41:25.897808 (Thread-450): handling poll request
2021-05-15 09:41:25.898315 (Thread-450): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73573afa0>]}
2021-05-15 09:41:25.900435 (Thread-450): sending response (<Response 15207 bytes [200 OK]>) to 10.0.19.219
2021-05-15 09:41:27.438550 (Thread-451): handling poll request
2021-05-15 09:41:27.438976 (Thread-451): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73573ab80>]}
2021-05-15 09:41:27.439863 (Thread-451): sending response (<Response 398 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:41:28.908818 (Thread-452): handling poll request
2021-05-15 09:41:28.909241 (Thread-452): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73573a6a0>]}
2021-05-15 09:41:28.910115 (Thread-452): sending response (<Response 398 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:41:30.210940 (Thread-1): SQL status: SUCCESS 8 in 4.73 seconds
2021-05-15 09:41:30.213359 (Thread-1): finished collecting timing info
2021-05-15 09:41:30.213758 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:41:30.495076 (Thread-453): handling poll request
2021-05-15 09:41:30.495502 (Thread-453): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad93d0>]}
2021-05-15 09:41:30.500082 (Thread-453): sending response (<Response 66181 bytes [200 OK]>) to 10.0.36.138
2021-05-15 09:41:57.966518 (Thread-454): handling status request
2021-05-15 09:41:57.966996 (Thread-454): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7344c36d0>]}
2021-05-15 09:41:57.969025 (Thread-454): sending response (<Response 6258 bytes [200 OK]>) to 10.0.36.138
2021-05-15 09:41:58.748810 (Thread-455): handling run_sql request
2021-05-15 09:41:58.749243 (Thread-455): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73573a730>]}
2021-05-15 09:41:59.776424 (Thread-455): sending response (<Response 137 bytes [200 OK]>) to 10.0.46.218
2021-05-15 09:41:59.798561 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:41:59.825823 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:41:59.846528 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:41:59.846638 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:41:59.861017 (Thread-1): finished collecting timing info
2021-05-15 09:41:59.870166 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:41:59.870278 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            sum(PROPERTY_AMOUNT) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where r_type='Year' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:41:59.870339 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:42:00.307399 (Thread-456): handling poll request
2021-05-15 09:42:00.307869 (Thread-456): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad93a0>]}
2021-05-15 09:42:00.434664 (Thread-456): sending response (<Response 15207 bytes [200 OK]>) to 10.0.1.135
2021-05-15 09:42:01.912281 (Thread-457): handling poll request
2021-05-15 09:42:01.912708 (Thread-457): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73407ed60>]}
2021-05-15 09:42:01.913580 (Thread-457): sending response (<Response 398 bytes [200 OK]>) to 10.0.45.155
2021-05-15 09:42:04.071619 (Thread-458): handling poll request
2021-05-15 09:42:04.072065 (Thread-458): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73573a550>]}
2021-05-15 09:42:04.072947 (Thread-458): sending response (<Response 397 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:42:04.612218 (Thread-1): SQL status: SUCCESS 2 in 4.74 seconds
2021-05-15 09:42:04.614429 (Thread-1): finished collecting timing info
2021-05-15 09:42:04.614826 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:42:05.701446 (Thread-459): handling poll request
2021-05-15 09:42:05.701879 (Thread-459): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b35b20>]}
2021-05-15 09:42:05.706002 (Thread-459): sending response (<Response 65291 bytes [200 OK]>) to 10.0.34.201
2021-05-15 09:42:24.620303 (Thread-460): handling status request
2021-05-15 09:42:24.620762 (Thread-460): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355f4280>]}
2021-05-15 09:42:24.622807 (Thread-460): sending response (<Response 6258 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:42:25.572581 (Thread-461): handling run_sql request
2021-05-15 09:42:25.573008 (Thread-461): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355f4250>]}
2021-05-15 09:42:26.584685 (Thread-461): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:42:26.608648 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:42:26.630292 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:42:26.630719 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:42:26.630830 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:42:26.644248 (Thread-1): finished collecting timing info
2021-05-15 09:42:26.653211 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:42:26.653286 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            sum(PROPERTY_AMOUNT) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where r_type='Month' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:42:26.653344 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:42:27.149926 (Thread-462): handling poll request
2021-05-15 09:42:27.150390 (Thread-462): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7262769d0>]}
2021-05-15 09:42:27.152506 (Thread-462): sending response (<Response 15208 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:42:28.668938 (Thread-463): handling poll request
2021-05-15 09:42:28.669426 (Thread-463): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7262769a0>]}
2021-05-15 09:42:28.670365 (Thread-463): sending response (<Response 398 bytes [200 OK]>) to 10.0.36.138
2021-05-15 09:42:30.173327 (Thread-464): handling poll request
2021-05-15 09:42:30.173754 (Thread-464): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b60c40>]}
2021-05-15 09:42:30.174669 (Thread-464): sending response (<Response 398 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:42:30.475760 (Thread-1): SQL status: SUCCESS 6 in 3.82 seconds
2021-05-15 09:42:30.479770 (Thread-1): finished collecting timing info
2021-05-15 09:42:30.480181 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:42:31.790265 (Thread-465): handling poll request
2021-05-15 09:42:31.790712 (Thread-465): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b60580>]}
2021-05-15 09:42:31.795567 (Thread-465): sending response (<Response 65929 bytes [200 OK]>) to 10.0.41.124
2021-05-15 09:43:32.154652 (Thread-466): handling status request
2021-05-15 09:43:32.155078 (Thread-466): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b607c0>]}
2021-05-15 09:43:32.157073 (Thread-466): sending response (<Response 6258 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:43:32.913481 (Thread-467): handling run_sql request
2021-05-15 09:43:32.913899 (Thread-467): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726276340>]}
2021-05-15 09:43:33.939203 (Thread-467): sending response (<Response 137 bytes [200 OK]>) to 10.0.17.122
2021-05-15 09:43:33.961204 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:43:33.985896 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:43:33.986368 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:43:33.986477 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:43:33.999844 (Thread-1): finished collecting timing info
2021-05-15 09:43:34.009526 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:43:34.009601 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where r_type='Month' and r_metric_id= 52
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:43:34.009658 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:43:34.494674 (Thread-468): handling poll request
2021-05-15 09:43:34.495123 (Thread-468): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735822ac0>]}
2021-05-15 09:43:34.497263 (Thread-468): sending response (<Response 15220 bytes [200 OK]>) to 10.0.3.247
2021-05-15 09:43:35.964873 (Thread-469): handling poll request
2021-05-15 09:43:35.965323 (Thread-469): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7345c90d0>]}
2021-05-15 09:43:35.966244 (Thread-469): sending response (<Response 398 bytes [200 OK]>) to 10.0.31.167
2021-05-15 09:43:37.417027 (Thread-470): handling poll request
2021-05-15 09:43:37.417457 (Thread-470): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7345c9940>]}
2021-05-15 09:43:37.418363 (Thread-470): sending response (<Response 398 bytes [200 OK]>) to 10.0.1.135
2021-05-15 09:43:38.006196 (Thread-1): SQL status: SUCCESS 6 in 4.00 seconds
2021-05-15 09:43:38.010205 (Thread-1): finished collecting timing info
2021-05-15 09:43:38.010625 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:43:38.890824 (Thread-471): handling poll request
2021-05-15 09:43:38.891311 (Thread-471): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b60250>]}
2021-05-15 09:43:38.895551 (Thread-471): sending response (<Response 65985 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:45:27.046774 (Thread-472): handling status request
2021-05-15 09:45:27.048879 (Thread-472): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7345c99d0>]}
2021-05-15 09:45:27.050912 (Thread-472): sending response (<Response 6258 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:45:27.783994 (Thread-473): handling run_sql request
2021-05-15 09:45:27.784411 (Thread-473): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7345c9a00>]}
2021-05-15 09:45:28.823285 (Thread-473): sending response (<Response 137 bytes [200 OK]>) to 10.0.3.247
2021-05-15 09:45:28.845212 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:45:28.870594 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:45:28.894580 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:45:28.894729 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:45:28.909106 (Thread-1): finished collecting timing info
2021-05-15 09:45:28.918724 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:45:28.918815 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where r_type='Month' and r_metric_id= 62
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:45:28.918875 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:45:29.392379 (Thread-474): handling poll request
2021-05-15 09:45:29.392841 (Thread-474): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7345c90d0>]}
2021-05-15 09:45:29.395629 (Thread-474): sending response (<Response 15269 bytes [200 OK]>) to 10.0.18.95
2021-05-15 09:45:30.946983 (Thread-475): handling poll request
2021-05-15 09:45:30.947406 (Thread-475): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad9730>]}
2021-05-15 09:45:30.948313 (Thread-475): sending response (<Response 398 bytes [200 OK]>) to 10.0.36.138
2021-05-15 09:45:32.421197 (Thread-476): handling poll request
2021-05-15 09:45:32.421616 (Thread-476): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b60a30>]}
2021-05-15 09:45:32.422529 (Thread-476): sending response (<Response 398 bytes [200 OK]>) to 10.0.17.122
2021-05-15 09:45:32.575049 (Thread-1): SQL status: SUCCESS 10 in 3.66 seconds
2021-05-15 09:45:32.581558 (Thread-1): finished collecting timing info
2021-05-15 09:45:32.582066 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:45:33.908501 (Thread-477): handling poll request
2021-05-15 09:45:33.908941 (Thread-477): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725f962e0>]}
2021-05-15 09:45:33.913632 (Thread-477): sending response (<Response 67095 bytes [200 OK]>) to 10.0.46.218
2021-05-15 09:46:08.070854 (Thread-478): handling status request
2021-05-15 09:46:08.071361 (Thread-478): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726276f10>]}
2021-05-15 09:46:08.073379 (Thread-478): sending response (<Response 6258 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:46:08.933105 (Thread-479): handling run_sql request
2021-05-15 09:46:08.933528 (Thread-479): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725f96e20>]}
2021-05-15 09:46:09.950942 (Thread-479): sending response (<Response 137 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:46:09.973014 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:46:09.994710 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:46:09.995218 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:46:09.995336 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:46:10.008952 (Thread-1): finished collecting timing info
2021-05-15 09:46:10.018079 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:46:10.018194 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CREATEDATE=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where r_type='Year' and r_metric_id= 62
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:46:10.018266 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:46:10.406607 (Thread-480): handling poll request
2021-05-15 09:46:10.407050 (Thread-480): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734549f10>]}
2021-05-15 09:46:10.409150 (Thread-480): sending response (<Response 15268 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:46:11.896760 (Thread-481): handling poll request
2021-05-15 09:46:11.897180 (Thread-481): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734549340>]}
2021-05-15 09:46:11.898060 (Thread-481): sending response (<Response 398 bytes [200 OK]>) to 10.0.46.218
2021-05-15 09:46:13.203345 (Thread-1): SQL status: SUCCESS 6 in 3.19 seconds
2021-05-15 09:46:13.205405 (Thread-1): finished collecting timing info
2021-05-15 09:46:13.205786 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:46:13.889461 (Thread-482): handling poll request
2021-05-15 09:46:13.890271 (Thread-482): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7345497f0>]}
2021-05-15 09:46:13.894505 (Thread-482): sending response (<Response 66316 bytes [200 OK]>) to 10.0.19.219
2021-05-15 09:48:57.729063 (Thread-483): handling status request
2021-05-15 09:48:57.731502 (Thread-483): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725f969a0>]}
2021-05-15 09:48:57.734627 (Thread-483): sending response (<Response 6258 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:48:58.619070 (Thread-484): handling run_sql request
2021-05-15 09:48:58.619509 (Thread-484): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725f964c0>]}
2021-05-15 09:48:59.648707 (Thread-484): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.49
2021-05-15 09:48:59.670699 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:48:59.695173 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:48:59.695624 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:48:59.695733 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:48:59.709053 (Thread-1): finished collecting timing info
2021-05-15 09:48:59.718092 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:48:59.718195 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company,calendar
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where r_type='Year' and r_metric_id= 62
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:48:59.718258 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:49:00.137288 (Thread-485): handling poll request
2021-05-15 09:49:00.137749 (Thread-485): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725d51a90>]}
2021-05-15 09:49:00.139935 (Thread-485): sending response (<Response 15286 bytes [200 OK]>) to 10.0.6.126
2021-05-15 09:49:01.623377 (Thread-486): handling poll request
2021-05-15 09:49:01.623808 (Thread-486): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725d51400>]}
2021-05-15 09:49:01.748014 (Thread-486): sending response (<Response 398 bytes [200 OK]>) to 10.0.3.247
2021-05-15 09:49:03.813400 (Thread-487): handling poll request
2021-05-15 09:49:03.813824 (Thread-487): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725fa8f40>]}
2021-05-15 09:49:03.814727 (Thread-487): sending response (<Response 398 bytes [200 OK]>) to 10.0.45.155
2021-05-15 09:49:03.892872 (Thread-1): SQL status: SUCCESS 6 in 4.17 seconds
2021-05-15 09:49:03.894872 (Thread-1): finished collecting timing info
2021-05-15 09:49:03.895665 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:49:05.339689 (Thread-488): handling poll request
2021-05-15 09:49:05.340125 (Thread-488): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725fa8040>]}
2021-05-15 09:49:05.344383 (Thread-488): sending response (<Response 66406 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:56:30.607746 (Thread-489): handling status request
2021-05-15 09:56:30.609769 (Thread-489): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d6af10>]}
2021-05-15 09:56:30.611818 (Thread-489): sending response (<Response 6258 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:56:31.314490 (Thread-490): handling run_sql request
2021-05-15 09:56:31.314937 (Thread-490): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d6a0d0>]}
2021-05-15 09:56:32.321508 (Thread-490): sending response (<Response 137 bytes [200 OK]>) to 10.0.31.167
2021-05-15 09:56:32.343406 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:56:32.368601 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:56:32.369045 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:56:32.369155 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:56:32.382614 (Thread-1): finished collecting timing info
2021-05-15 09:56:32.391847 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:56:32.391929 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company inner join calendar on to_date(PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where r_type='Week' and r_metric_id= 62
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:56:32.391988 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:56:32.816553 (Thread-491): handling poll request
2021-05-15 09:56:32.817000 (Thread-491): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734306340>]}
2021-05-15 09:56:32.819166 (Thread-491): sending response (<Response 15339 bytes [200 OK]>) to 10.0.15.199
2021-05-15 09:56:34.299059 (Thread-492): handling poll request
2021-05-15 09:56:34.299486 (Thread-492): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734306730>]}
2021-05-15 09:56:34.300396 (Thread-492): sending response (<Response 398 bytes [200 OK]>) to 10.0.34.201
2021-05-15 09:56:35.749213 (Thread-493): handling poll request
2021-05-15 09:56:35.749643 (Thread-493): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343066d0>]}
2021-05-15 09:56:35.750577 (Thread-493): sending response (<Response 398 bytes [200 OK]>) to 10.0.20.29
2021-05-15 09:56:36.021338 (Thread-1): SQL status: SUCCESS 12 in 3.63 seconds
2021-05-15 09:56:36.023920 (Thread-1): finished collecting timing info
2021-05-15 09:56:36.024324 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:56:37.185333 (Thread-494): handling poll request
2021-05-15 09:56:37.185773 (Thread-494): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72635c4f0>]}
2021-05-15 09:56:37.191863 (Thread-494): sending response (<Response 67732 bytes [200 OK]>) to 10.0.17.122
2021-05-15 09:57:34.910993 (Thread-495): handling status request
2021-05-15 09:57:34.911425 (Thread-495): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343068b0>]}
2021-05-15 09:57:34.913479 (Thread-495): sending response (<Response 6258 bytes [200 OK]>) to 10.0.1.135
2021-05-15 09:57:35.714778 (Thread-496): handling run_sql request
2021-05-15 09:57:35.715230 (Thread-496): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343068e0>]}
2021-05-15 09:57:36.764411 (Thread-496): sending response (<Response 137 bytes [200 OK]>) to 10.0.36.138
2021-05-15 09:57:36.786602 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:57:36.811562 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:57:36.812029 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:57:36.812137 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:57:36.825945 (Thread-1): finished collecting timing info
2021-05-15 09:57:36.835543 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:57:36.835625 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company inner join calendar on to_date(PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where r_type='Week' and r_metric_id= 85
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:57:36.835684 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:57:37.343105 (Thread-497): handling poll request
2021-05-15 09:57:37.343616 (Thread-497): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735db5af0>]}
2021-05-15 09:57:37.345858 (Thread-497): sending response (<Response 15338 bytes [200 OK]>) to 10.0.40.42
2021-05-15 09:57:38.802115 (Thread-498): handling poll request
2021-05-15 09:57:38.802586 (Thread-498): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7368fa1f0>]}
2021-05-15 09:57:38.803477 (Thread-498): sending response (<Response 398 bytes [200 OK]>) to 10.0.4.10
2021-05-15 09:57:40.345229 (Thread-499): handling poll request
2021-05-15 09:57:40.345663 (Thread-499): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e641c0>]}
2021-05-15 09:57:40.346565 (Thread-499): sending response (<Response 398 bytes [200 OK]>) to 10.0.17.122
2021-05-15 09:57:41.823836 (Thread-500): handling poll request
2021-05-15 09:57:41.824275 (Thread-500): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726533e80>]}
2021-05-15 09:57:41.825152 (Thread-500): sending response (<Response 398 bytes [200 OK]>) to 10.0.6.126
2021-05-15 09:57:43.661716 (Thread-1): SQL status: SUCCESS 0 in 6.83 seconds
2021-05-15 09:57:43.662152 (Thread-1): finished collecting timing info
2021-05-15 09:57:43.662551 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:57:43.909620 (Thread-501): handling poll request
2021-05-15 09:57:43.910065 (Thread-501): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72635cc40>]}
2021-05-15 09:57:43.911293 (Thread-501): sending response (<Response 1339 bytes [200 OK]>) to 10.0.46.218
2021-05-15 09:57:45.442881 (Thread-502): handling poll request
2021-05-15 09:57:45.443324 (Thread-502): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72635c370>]}
2021-05-15 09:57:45.447479 (Thread-502): sending response (<Response 64701 bytes [200 OK]>) to 10.0.1.135
2021-05-15 09:59:56.122661 (Thread-503): handling status request
2021-05-15 09:59:56.124892 (Thread-503): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72635c8e0>]}
2021-05-15 09:59:56.126995 (Thread-503): sending response (<Response 6258 bytes [200 OK]>) to 10.0.6.126
2021-05-15 09:59:56.820731 (Thread-504): handling run_sql request
2021-05-15 09:59:56.821169 (Thread-504): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72635c610>]}
2021-05-15 09:59:57.830442 (Thread-504): sending response (<Response 137 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:59:57.852272 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:59:57.877183 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 09:59:57.877625 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 09:59:57.877732 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 09:59:57.891158 (Thread-1): finished collecting timing info
2021-05-15 09:59:57.900244 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 09:59:57.900315 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company inner join calendar on to_date(PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where f_timeframe_type='Y' and f_metric_id= 85
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 09:59:57.900372 (Thread-1): Opening a new connection, currently in state init
2021-05-15 09:59:58.280354 (Thread-505): handling poll request
2021-05-15 09:59:58.280824 (Thread-505): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734306f10>]}
2021-05-15 09:59:58.282999 (Thread-505): sending response (<Response 15346 bytes [200 OK]>) to 10.0.22.198
2021-05-15 09:59:59.317000 (Thread-1): SQL status: SUCCESS 0 in 1.42 seconds
2021-05-15 09:59:59.317438 (Thread-1): finished collecting timing info
2021-05-15 09:59:59.317820 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 09:59:59.850838 (Thread-506): handling poll request
2021-05-15 09:59:59.851344 (Thread-506): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734306e20>]}
2021-05-15 09:59:59.855497 (Thread-506): sending response (<Response 65677 bytes [200 OK]>) to 10.0.36.138
2021-05-15 10:00:12.991484 (Thread-507): handling status request
2021-05-15 10:00:12.991926 (Thread-507): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725d51f70>]}
2021-05-15 10:00:12.993971 (Thread-507): sending response (<Response 6258 bytes [200 OK]>) to 10.0.6.126
2021-05-15 10:00:13.993675 (Thread-508): handling run_sql request
2021-05-15 10:00:13.994090 (Thread-508): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725d51b20>]}
2021-05-15 10:00:14.997435 (Thread-508): sending response (<Response 137 bytes [200 OK]>) to 10.0.18.95
2021-05-15 10:00:15.019742 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:00:15.041585 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 10:00:15.042081 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:00:15.042214 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 10:00:15.055666 (Thread-1): finished collecting timing info
2021-05-15 10:00:15.064843 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 10:00:15.064920 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company inner join calendar on to_date(PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from seg_fs where f_timeframe_type='Y' and f_metric_id= 85
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 10:00:15.064978 (Thread-1): Opening a new connection, currently in state init
2021-05-15 10:00:15.436684 (Thread-509): handling poll request
2021-05-15 10:00:15.437155 (Thread-509): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72670e520>]}
2021-05-15 10:00:15.439662 (Thread-509): sending response (<Response 15338 bytes [200 OK]>) to 10.0.15.199
2021-05-15 10:00:16.981968 (Thread-510): handling poll request
2021-05-15 10:00:16.982423 (Thread-510): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725d516d0>]}
2021-05-15 10:00:16.983298 (Thread-510): sending response (<Response 398 bytes [200 OK]>) to 10.0.31.167
2021-05-15 10:00:19.145950 (Thread-511): handling poll request
2021-05-15 10:00:19.146409 (Thread-511): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725d51640>]}
2021-05-15 10:00:19.147280 (Thread-511): sending response (<Response 398 bytes [200 OK]>) to 10.0.34.201
2021-05-15 10:00:19.650954 (Thread-1): SQL status: SUCCESS 0 in 4.59 seconds
2021-05-15 10:00:19.651367 (Thread-1): finished collecting timing info
2021-05-15 10:00:19.651746 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 10:00:20.968643 (Thread-512): handling poll request
2021-05-15 10:00:20.969076 (Thread-512): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad97c0>]}
2021-05-15 10:00:20.973212 (Thread-512): sending response (<Response 65506 bytes [200 OK]>) to 10.0.22.198
2021-05-15 10:08:40.575598 (Thread-513): handling status request
2021-05-15 10:08:40.578034 (Thread-513): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725d51790>]}
2021-05-15 10:08:40.580120 (Thread-513): sending response (<Response 6258 bytes [200 OK]>) to 10.0.45.155
2021-05-15 10:08:41.316807 (Thread-514): handling run_sql request
2021-05-15 10:08:41.317228 (Thread-514): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73417a610>]}
2021-05-15 10:08:42.415734 (Thread-514): sending response (<Response 137 bytes [200 OK]>) to 10.0.31.167
2021-05-15 10:08:42.437747 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:08:42.462552 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 10:08:42.463066 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:08:42.463177 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 10:08:42.478687 (Thread-1): finished collecting timing info
2021-05-15 10:08:42.487870 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 10:08:42.487948 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company inner join calendar on to_date(PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_type='Year' and r_metric_id= 85
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 10:08:42.488008 (Thread-1): Opening a new connection, currently in state init
2021-05-15 10:08:42.944695 (Thread-515): handling poll request
2021-05-15 10:08:42.945146 (Thread-515): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735729e80>]}
2021-05-15 10:08:42.947292 (Thread-515): sending response (<Response 15336 bytes [200 OK]>) to 10.0.15.199
2021-05-15 10:08:44.219496 (Thread-1): SQL status: SUCCESS 500 in 1.73 seconds
2021-05-15 10:08:44.234868 (Thread-1): finished collecting timing info
2021-05-15 10:08:44.235297 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 10:08:44.541017 (Thread-516): handling poll request
2021-05-15 10:08:44.541475 (Thread-516): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73573ae50>]}
2021-05-15 10:08:44.667772 (Thread-516): sending response (<Response 107536 bytes [200 OK]>) to 10.0.34.201
2021-05-15 10:41:55.562330 (Thread-517): handling status request
2021-05-15 10:41:55.564470 (Thread-517): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735822280>]}
2021-05-15 10:41:55.566578 (Thread-517): sending response (<Response 6258 bytes [200 OK]>) to 10.0.22.198
2021-05-15 10:41:56.411315 (Thread-518): handling run_sql request
2021-05-15 10:41:56.411732 (Thread-518): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725f96d00>]}
2021-05-15 10:41:57.420473 (Thread-518): sending response (<Response 137 bytes [200 OK]>) to 10.0.17.122
2021-05-15 10:41:57.442541 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:41:57.467988 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 10:41:57.468423 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:41:57.468528 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 10:41:57.482162 (Thread-1): finished collecting timing info
2021-05-15 10:41:57.491940 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 10:41:57.492023 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng,calendar
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=39
 and r_type='Week'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 10:41:57.492080 (Thread-1): Opening a new connection, currently in state init
2021-05-15 10:41:57.946418 (Thread-519): handling poll request
2021-05-15 10:41:57.946943 (Thread-519): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735e38760>]}
2021-05-15 10:41:57.949476 (Thread-519): sending response (<Response 16754 bytes [200 OK]>) to 10.0.40.42
2021-05-15 10:41:59.493406 (Thread-520): handling poll request
2021-05-15 10:41:59.493826 (Thread-520): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726c41ca0>]}
2021-05-15 10:41:59.494727 (Thread-520): sending response (<Response 388 bytes [200 OK]>) to 10.0.17.122
2021-05-15 10:42:00.998956 (Thread-521): handling poll request
2021-05-15 10:42:00.999390 (Thread-521): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726c41b50>]}
2021-05-15 10:42:01.000275 (Thread-521): sending response (<Response 388 bytes [200 OK]>) to 10.0.31.167
2021-05-15 10:42:01.787192 (Thread-1): SQL status: SUCCESS 1 in 4.30 seconds
2021-05-15 10:42:01.789105 (Thread-1): finished collecting timing info
2021-05-15 10:42:01.789486 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 10:42:02.485589 (Thread-522): handling poll request
2021-05-15 10:42:02.486016 (Thread-522): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341207c0>]}
2021-05-15 10:42:02.490245 (Thread-522): sending response (<Response 72846 bytes [200 OK]>) to 10.0.34.201
2021-05-15 10:44:53.168473 (Thread-523): handling status request
2021-05-15 10:44:53.170726 (Thread-523): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734120040>]}
2021-05-15 10:44:53.172752 (Thread-523): sending response (<Response 6258 bytes [200 OK]>) to 10.0.1.135
2021-05-15 10:44:54.006615 (Thread-524): handling run_sql request
2021-05-15 10:44:54.007027 (Thread-524): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734120e80>]}
2021-05-15 10:44:55.036446 (Thread-524): sending response (<Response 137 bytes [200 OK]>) to 10.0.36.138
2021-05-15 10:44:55.060073 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:44:55.085570 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 10:44:55.086057 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:44:55.086188 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 10:44:55.100121 (Thread-1): finished collecting timing info
2021-05-15 10:44:55.110246 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 10:44:55.110336 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=39
 and r_type='Week'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 10:44:55.110395 (Thread-1): Opening a new connection, currently in state init
2021-05-15 10:44:55.629947 (Thread-525): handling poll request
2021-05-15 10:44:55.630419 (Thread-525): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734120430>]}
2021-05-15 10:44:55.632526 (Thread-525): sending response (<Response 16798 bytes [200 OK]>) to 10.0.1.135
2021-05-15 10:44:57.121490 (Thread-526): handling poll request
2021-05-15 10:44:57.121924 (Thread-526): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726c41b80>]}
2021-05-15 10:44:57.122858 (Thread-526): sending response (<Response 388 bytes [200 OK]>) to 10.0.34.201
2021-05-15 10:44:58.310670 (Thread-1): SQL status: SUCCESS 1 in 3.20 seconds
2021-05-15 10:44:58.312348 (Thread-1): finished collecting timing info
2021-05-15 10:44:58.312730 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 10:44:59.405751 (Thread-527): handling poll request
2021-05-15 10:44:59.406212 (Thread-527): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7261db400>]}
2021-05-15 10:44:59.410468 (Thread-527): sending response (<Response 73066 bytes [200 OK]>) to 10.0.3.247
2021-05-15 10:45:26.984646 (Thread-528): handling status request
2021-05-15 10:45:26.985108 (Thread-528): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735ad9b80>]}
2021-05-15 10:45:26.987218 (Thread-528): sending response (<Response 6258 bytes [200 OK]>) to 10.0.17.122
2021-05-15 10:45:27.783797 (Thread-529): handling run_sql request
2021-05-15 10:45:27.784215 (Thread-529): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bb36a0>]}
2021-05-15 10:45:28.815531 (Thread-529): sending response (<Response 137 bytes [200 OK]>) to 10.0.3.247
2021-05-15 10:45:28.838406 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:45:28.866071 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 10:45:28.866688 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:45:28.866803 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 10:45:28.880970 (Thread-1): finished collecting timing info
2021-05-15 10:45:28.891165 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 10:45:28.891247 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=39
 and r_type='Year'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 10:45:28.891307 (Thread-1): Opening a new connection, currently in state init
2021-05-15 10:45:29.329720 (Thread-530): handling poll request
2021-05-15 10:45:29.330216 (Thread-530): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726c3c2e0>]}
2021-05-15 10:45:29.332385 (Thread-530): sending response (<Response 16798 bytes [200 OK]>) to 10.0.15.49
2021-05-15 10:45:30.867037 (Thread-531): handling poll request
2021-05-15 10:45:30.867463 (Thread-531): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b4cd90>]}
2021-05-15 10:45:30.868359 (Thread-531): sending response (<Response 388 bytes [200 OK]>) to 10.0.17.122
2021-05-15 10:45:31.964548 (Thread-1): SQL status: SUCCESS 1 in 3.07 seconds
2021-05-15 10:45:31.966737 (Thread-1): finished collecting timing info
2021-05-15 10:45:31.967124 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 10:45:32.415872 (Thread-532): handling poll request
2021-05-15 10:45:32.416311 (Thread-532): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7261d7bb0>]}
2021-05-15 10:45:32.420827 (Thread-532): sending response (<Response 73068 bytes [200 OK]>) to 10.0.22.198
2021-05-15 10:46:21.843793 (Thread-533): handling status request
2021-05-15 10:46:21.844237 (Thread-533): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bb3af0>]}
2021-05-15 10:46:21.846334 (Thread-533): sending response (<Response 6258 bytes [200 OK]>) to 10.0.22.198
2021-05-15 10:46:22.739099 (Thread-534): handling run_sql request
2021-05-15 10:46:22.739525 (Thread-534): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726c3ca30>]}
2021-05-15 10:46:23.753244 (Thread-534): sending response (<Response 137 bytes [200 OK]>) to 10.0.1.135
2021-05-15 10:46:23.775381 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:46:23.800096 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 10:46:23.800532 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:46:23.800639 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 10:46:23.814350 (Thread-1): finished collecting timing info
2021-05-15 10:46:23.824246 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 10:46:23.824332 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=89
 and r_type='Year'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 10:46:23.824391 (Thread-1): Opening a new connection, currently in state init
2021-05-15 10:46:24.425542 (Thread-535): handling poll request
2021-05-15 10:46:24.426026 (Thread-535): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726909070>]}
2021-05-15 10:46:24.428266 (Thread-535): sending response (<Response 16797 bytes [200 OK]>) to 10.0.18.95
2021-05-15 10:46:26.046405 (Thread-536): handling poll request
2021-05-15 10:46:26.046833 (Thread-536): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7269090d0>]}
2021-05-15 10:46:26.047712 (Thread-536): sending response (<Response 388 bytes [200 OK]>) to 10.0.36.138
2021-05-15 10:46:27.565150 (Thread-537): handling poll request
2021-05-15 10:46:27.565596 (Thread-537): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7268451f0>]}
2021-05-15 10:46:27.566526 (Thread-537): sending response (<Response 388 bytes [200 OK]>) to 10.0.40.42
2021-05-15 10:46:28.873031 (Thread-1): SQL status: SUCCESS 2 in 5.05 seconds
2021-05-15 10:46:28.874867 (Thread-1): finished collecting timing info
2021-05-15 10:46:28.875258 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 10:46:29.103379 (Thread-538): handling poll request
2021-05-15 10:46:29.103818 (Thread-538): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7261dd460>]}
2021-05-15 10:46:29.104993 (Thread-538): sending response (<Response 1329 bytes [200 OK]>) to 10.0.40.42
2021-05-15 10:46:30.646114 (Thread-539): handling poll request
2021-05-15 10:46:30.646587 (Thread-539): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726861430>]}
2021-05-15 10:46:30.650828 (Thread-539): sending response (<Response 72263 bytes [200 OK]>) to 10.0.20.29
2021-05-15 10:58:29.674962 (Thread-540): handling status request
2021-05-15 10:58:29.677139 (Thread-540): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bc67f0>]}
2021-05-15 10:58:29.679284 (Thread-540): sending response (<Response 6258 bytes [200 OK]>) to 10.0.15.199
2021-05-15 10:58:30.910237 (Thread-541): handling run_sql request
2021-05-15 10:58:30.910673 (Thread-541): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7261dd1f0>]}
2021-05-15 10:58:31.928593 (Thread-541): sending response (<Response 137 bytes [200 OK]>) to 10.0.31.167
2021-05-15 10:58:31.951621 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:58:31.976395 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 10:58:31.976820 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:58:31.976929 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 10:58:31.990385 (Thread-1): finished collecting timing info
2021-05-15 10:58:32.000277 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 10:58:32.000349 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=89
 and r_type='Month'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 10:58:32.000408 (Thread-1): Opening a new connection, currently in state init
2021-05-15 10:58:32.402810 (Thread-542): handling poll request
2021-05-15 10:58:32.403261 (Thread-542): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c5af0>]}
2021-05-15 10:58:32.405373 (Thread-542): sending response (<Response 16799 bytes [200 OK]>) to 10.0.15.199
2021-05-15 10:58:34.423899 (Thread-543): handling poll request
2021-05-15 10:58:34.424325 (Thread-543): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c5520>]}
2021-05-15 10:58:34.425182 (Thread-543): sending response (<Response 388 bytes [200 OK]>) to 10.0.6.126
2021-05-15 10:58:35.916085 (Thread-544): handling poll request
2021-05-15 10:58:35.916528 (Thread-544): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c5880>]}
2021-05-15 10:58:35.917414 (Thread-544): sending response (<Response 388 bytes [200 OK]>) to 10.0.34.201
2021-05-15 10:58:36.609357 (Thread-1): SQL status: SUCCESS 8 in 4.61 seconds
2021-05-15 10:58:36.611344 (Thread-1): finished collecting timing info
2021-05-15 10:58:36.611733 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 10:58:37.405126 (Thread-545): handling poll request
2021-05-15 10:58:37.405579 (Thread-545): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c5c70>]}
2021-05-15 10:58:37.409912 (Thread-545): sending response (<Response 74003 bytes [200 OK]>) to 10.0.34.201
2021-05-15 10:59:16.468816 (Thread-546): handling status request
2021-05-15 10:59:16.469276 (Thread-546): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735a7a3a0>]}
2021-05-15 10:59:16.588604 (Thread-546): sending response (<Response 6258 bytes [200 OK]>) to 10.0.20.29
2021-05-15 10:59:17.293760 (Thread-547): handling run_sql request
2021-05-15 10:59:17.294232 (Thread-547): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7341f6eb0>]}
2021-05-15 10:59:18.312857 (Thread-547): sending response (<Response 137 bytes [200 OK]>) to 10.0.20.29
2021-05-15 10:59:18.334848 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:59:18.356223 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 10:59:18.356636 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:59:18.356742 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 10:59:18.370994 (Thread-1): finished collecting timing info
2021-05-15 10:59:18.380832 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 10:59:18.380922 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=89
 and r_type='Quarter'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 10:59:18.380982 (Thread-1): Opening a new connection, currently in state init
2021-05-15 10:59:18.784301 (Thread-548): handling poll request
2021-05-15 10:59:18.784775 (Thread-548): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7276c8070>]}
2021-05-15 10:59:18.787013 (Thread-548): sending response (<Response 16801 bytes [200 OK]>) to 10.0.6.126
2021-05-15 10:59:20.227123 (Thread-549): handling poll request
2021-05-15 10:59:20.227554 (Thread-549): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7276c8280>]}
2021-05-15 10:59:20.228443 (Thread-549): sending response (<Response 388 bytes [200 OK]>) to 10.0.4.10
2021-05-15 10:59:21.705801 (Thread-550): handling poll request
2021-05-15 10:59:21.706311 (Thread-550): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726266700>]}
2021-05-15 10:59:21.707292 (Thread-550): sending response (<Response 388 bytes [200 OK]>) to 10.0.15.49
2021-05-15 10:59:22.175029 (Thread-1): SQL status: SUCCESS 4 in 3.79 seconds
2021-05-15 10:59:22.176830 (Thread-1): finished collecting timing info
2021-05-15 10:59:22.177218 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 10:59:23.993381 (Thread-551): handling poll request
2021-05-15 10:59:23.993820 (Thread-551): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7262668e0>]}
2021-05-15 10:59:23.998110 (Thread-551): sending response (<Response 73473 bytes [200 OK]>) to 10.0.46.218
2021-05-15 10:59:40.806808 (Thread-552): handling status request
2021-05-15 10:59:40.807242 (Thread-552): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726266bb0>]}
2021-05-15 10:59:40.809273 (Thread-552): sending response (<Response 6258 bytes [200 OK]>) to 10.0.45.155
2021-05-15 10:59:41.583955 (Thread-553): handling run_sql request
2021-05-15 10:59:41.584406 (Thread-553): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7262663d0>]}
2021-05-15 10:59:42.589271 (Thread-553): sending response (<Response 137 bytes [200 OK]>) to 10.0.17.122
2021-05-15 10:59:42.611393 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:59:42.636061 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 10:59:42.636543 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 10:59:42.636657 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 10:59:42.650185 (Thread-1): finished collecting timing info
2021-05-15 10:59:42.660216 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 10:59:42.660291 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=89
 and r_type='Week'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 10:59:42.660349 (Thread-1): Opening a new connection, currently in state init
2021-05-15 10:59:43.197937 (Thread-554): handling poll request
2021-05-15 10:59:43.199022 (Thread-554): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726a39c10>]}
2021-05-15 10:59:43.201150 (Thread-554): sending response (<Response 16798 bytes [200 OK]>) to 10.0.40.42
2021-05-15 10:59:44.688671 (Thread-555): handling poll request
2021-05-15 10:59:44.689111 (Thread-555): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7262668b0>]}
2021-05-15 10:59:44.690017 (Thread-555): sending response (<Response 387 bytes [200 OK]>) to 10.0.41.124
2021-05-15 10:59:45.693748 (Thread-1): SQL status: SUCCESS 19 in 3.03 seconds
2021-05-15 10:59:45.696515 (Thread-1): finished collecting timing info
2021-05-15 10:59:45.696918 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 10:59:46.154761 (Thread-556): handling poll request
2021-05-15 10:59:46.155205 (Thread-556): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7276c8e80>]}
2021-05-15 10:59:46.159666 (Thread-556): sending response (<Response 75372 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:03:13.099386 (Thread-557): handling status request
2021-05-15 11:03:13.101830 (Thread-557): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b138e0>]}
2021-05-15 11:03:13.103903 (Thread-557): sending response (<Response 6258 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:03:13.917852 (Thread-558): handling run_sql request
2021-05-15 11:03:13.918306 (Thread-558): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726a39880>]}
2021-05-15 11:03:15.022465 (Thread-558): sending response (<Response 137 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:03:15.045113 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:03:15.071010 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:03:15.071528 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:03:15.071643 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 11:03:15.085960 (Thread-1): finished collecting timing info
2021-05-15 11:03:15.096289 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 11:03:15.096391 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=71
 and r_type='Week'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 11:03:15.096453 (Thread-1): Opening a new connection, currently in state init
2021-05-15 11:03:15.578822 (Thread-559): handling poll request
2021-05-15 11:03:15.579313 (Thread-559): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355e3250>]}
2021-05-15 11:03:15.581421 (Thread-559): sending response (<Response 16805 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:03:17.187206 (Thread-560): handling poll request
2021-05-15 11:03:17.187641 (Thread-560): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7267ea040>]}
2021-05-15 11:03:17.188559 (Thread-560): sending response (<Response 388 bytes [200 OK]>) to 10.0.20.29
2021-05-15 11:03:18.769172 (Thread-1): SQL status: SUCCESS 7 in 3.67 seconds
2021-05-15 11:03:18.772322 (Thread-1): finished collecting timing info
2021-05-15 11:03:18.772858 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 11:03:19.306816 (Thread-561): handling poll request
2021-05-15 11:03:19.307241 (Thread-561): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735cfc370>]}
2021-05-15 11:03:19.311896 (Thread-561): sending response (<Response 73868 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:03:41.331858 (Thread-562): handling status request
2021-05-15 11:03:41.332294 (Thread-562): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735cfc4f0>]}
2021-05-15 11:03:41.334383 (Thread-562): sending response (<Response 6258 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:03:42.295716 (Thread-563): handling run_sql request
2021-05-15 11:03:42.296140 (Thread-563): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735cfcca0>]}
2021-05-15 11:03:43.405819 (Thread-563): sending response (<Response 137 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:03:43.427115 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:03:43.449272 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:03:43.449751 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:03:43.449866 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 11:03:43.463657 (Thread-1): finished collecting timing info
2021-05-15 11:03:43.473896 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 11:03:43.473986 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=71
 and r_type='Year'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 11:03:43.474046 (Thread-1): Opening a new connection, currently in state init
2021-05-15 11:03:43.944391 (Thread-564): handling poll request
2021-05-15 11:03:43.944842 (Thread-564): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7262663a0>]}
2021-05-15 11:03:43.946991 (Thread-564): sending response (<Response 16806 bytes [200 OK]>) to 10.0.19.219
2021-05-15 11:03:45.524752 (Thread-565): handling poll request
2021-05-15 11:03:45.525163 (Thread-565): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726856c10>]}
2021-05-15 11:03:45.526011 (Thread-565): sending response (<Response 388 bytes [200 OK]>) to 10.0.40.42
2021-05-15 11:03:47.061774 (Thread-1): SQL status: SUCCESS 1 in 3.59 seconds
2021-05-15 11:03:47.063471 (Thread-1): finished collecting timing info
2021-05-15 11:03:47.063850 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 11:03:47.082485 (Thread-566): handling poll request
2021-05-15 11:03:47.082874 (Thread-566): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c50d0>]}
2021-05-15 11:03:47.083960 (Thread-566): sending response (<Response 1329 bytes [200 OK]>) to 10.0.31.167
2021-05-15 11:03:49.520669 (Thread-567): handling poll request
2021-05-15 11:03:49.521150 (Thread-567): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735939ee0>]}
2021-05-15 11:03:49.525195 (Thread-567): sending response (<Response 72166 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:04:10.260057 (Thread-568): handling status request
2021-05-15 11:04:10.260472 (Thread-568): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735939160>]}
2021-05-15 11:04:10.262680 (Thread-568): sending response (<Response 6258 bytes [200 OK]>) to 10.0.31.167
2021-05-15 11:04:11.073657 (Thread-569): handling run_sql request
2021-05-15 11:04:11.074083 (Thread-569): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735939640>]}
2021-05-15 11:04:12.201899 (Thread-569): sending response (<Response 137 bytes [200 OK]>) to 10.0.20.29
2021-05-15 11:04:12.225299 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:04:12.249020 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:04:12.249564 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:04:12.249676 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 11:04:12.263468 (Thread-1): finished collecting timing info
2021-05-15 11:04:12.273846 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 11:04:12.273929 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=71
 and r_type='Month'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 11:04:12.273989 (Thread-1): Opening a new connection, currently in state init
2021-05-15 11:04:12.758755 (Thread-570): handling poll request
2021-05-15 11:04:12.759221 (Thread-570): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735cfc850>]}
2021-05-15 11:04:12.761443 (Thread-570): sending response (<Response 16807 bytes [200 OK]>) to 10.0.1.135
2021-05-15 11:04:14.301551 (Thread-571): handling poll request
2021-05-15 11:04:14.301969 (Thread-571): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726a39700>]}
2021-05-15 11:04:14.302879 (Thread-571): sending response (<Response 388 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:04:14.728474 (Thread-1): SQL status: SUCCESS 7 in 2.45 seconds
2021-05-15 11:04:14.730802 (Thread-1): finished collecting timing info
2021-05-15 11:04:14.731199 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 11:04:15.903698 (Thread-572): handling poll request
2021-05-15 11:04:15.904169 (Thread-572): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c5eb0>]}
2021-05-15 11:04:15.909374 (Thread-572): sending response (<Response 73916 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:05:46.392312 (Thread-573): handling status request
2021-05-15 11:05:46.394376 (Thread-573): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726856430>]}
2021-05-15 11:05:46.396879 (Thread-573): sending response (<Response 6258 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:05:47.257017 (Thread-574): handling run_sql request
2021-05-15 11:05:47.257428 (Thread-574): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c5ac0>]}
2021-05-15 11:05:48.358712 (Thread-574): sending response (<Response 137 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:05:48.380276 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:05:48.405745 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:05:48.406317 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:05:48.406476 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 11:05:48.420464 (Thread-1): finished collecting timing info
2021-05-15 11:05:48.430629 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 11:05:48.430705 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=76
 and r_type='Month'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 11:05:48.430767 (Thread-1): Opening a new connection, currently in state init
2021-05-15 11:05:48.909276 (Thread-575): handling poll request
2021-05-15 11:05:48.909730 (Thread-575): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726a99c70>]}
2021-05-15 11:05:48.912134 (Thread-575): sending response (<Response 16807 bytes [200 OK]>) to 10.0.20.29
2021-05-15 11:05:50.513356 (Thread-576): handling poll request
2021-05-15 11:05:50.513831 (Thread-576): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726722730>]}
2021-05-15 11:05:50.634715 (Thread-576): sending response (<Response 388 bytes [200 OK]>) to 10.0.15.49
2021-05-15 11:05:51.748818 (Thread-1): SQL status: SUCCESS 7 in 3.32 seconds
2021-05-15 11:05:51.752470 (Thread-1): finished collecting timing info
2021-05-15 11:05:51.752870 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 11:05:52.110195 (Thread-577): handling poll request
2021-05-15 11:05:52.110736 (Thread-577): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f72700>]}
2021-05-15 11:05:52.117356 (Thread-577): sending response (<Response 73927 bytes [200 OK]>) to 10.0.17.122
2021-05-15 11:07:42.325620 (Thread-578): handling status request
2021-05-15 11:07:42.327525 (Thread-578): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c50a0>]}
2021-05-15 11:07:42.329543 (Thread-578): sending response (<Response 6258 bytes [200 OK]>) to 10.0.1.135
2021-05-15 11:07:43.151631 (Thread-579): handling run_sql request
2021-05-15 11:07:43.152092 (Thread-579): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7267229a0>]}
2021-05-15 11:07:44.179163 (Thread-579): sending response (<Response 137 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:07:44.201407 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:07:44.226329 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:07:44.226808 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:07:44.226919 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 11:07:44.240779 (Thread-1): finished collecting timing info
2021-05-15 11:07:44.250847 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 11:07:44.250941 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=76
 and r_type='Year'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 11:07:44.251003 (Thread-1): Opening a new connection, currently in state init
2021-05-15 11:07:44.656753 (Thread-580): handling poll request
2021-05-15 11:07:44.657216 (Thread-580): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72602b7c0>]}
2021-05-15 11:07:44.659379 (Thread-580): sending response (<Response 16806 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:07:46.207892 (Thread-581): handling poll request
2021-05-15 11:07:46.208317 (Thread-581): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72602ba30>]}
2021-05-15 11:07:46.209184 (Thread-581): sending response (<Response 388 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:07:47.723282 (Thread-582): handling poll request
2021-05-15 11:07:47.723723 (Thread-582): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72602bf10>]}
2021-05-15 11:07:47.724576 (Thread-582): sending response (<Response 388 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:07:47.758326 (Thread-1): SQL status: SUCCESS 2 in 3.51 seconds
2021-05-15 11:07:47.760123 (Thread-1): finished collecting timing info
2021-05-15 11:07:47.760503 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 11:07:49.318367 (Thread-583): handling poll request
2021-05-15 11:07:49.318804 (Thread-583): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725c72430>]}
2021-05-15 11:07:49.323472 (Thread-583): sending response (<Response 73240 bytes [200 OK]>) to 10.0.40.42
2021-05-15 11:09:49.414198 (Thread-584): handling status request
2021-05-15 11:09:49.416221 (Thread-584): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72602be50>]}
2021-05-15 11:09:49.418274 (Thread-584): sending response (<Response 6258 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:09:50.194269 (Thread-585): handling run_sql request
2021-05-15 11:09:50.194679 (Thread-585): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735f725e0>]}
2021-05-15 11:09:51.253164 (Thread-585): sending response (<Response 137 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:09:51.280879 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:09:51.309821 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:09:51.310371 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:09:51.310481 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 11:09:51.329467 (Thread-1): finished collecting timing info
2021-05-15 11:09:51.339707 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 11:09:51.339809 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=66
 and r_type='Year'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 11:09:51.339872 (Thread-1): Opening a new connection, currently in state init
2021-05-15 11:09:51.945838 (Thread-586): handling poll request
2021-05-15 11:09:51.946314 (Thread-586): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725c723d0>]}
2021-05-15 11:09:51.948507 (Thread-586): sending response (<Response 16806 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:09:54.323532 (Thread-587): handling poll request
2021-05-15 11:09:54.323951 (Thread-587): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725c72be0>]}
2021-05-15 11:09:54.324814 (Thread-587): sending response (<Response 388 bytes [200 OK]>) to 10.0.15.49
2021-05-15 11:09:54.450505 (Thread-1): SQL status: SUCCESS 2 in 3.11 seconds
2021-05-15 11:09:54.452218 (Thread-1): finished collecting timing info
2021-05-15 11:09:54.452590 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 11:09:55.801341 (Thread-588): handling poll request
2021-05-15 11:09:55.801769 (Thread-588): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355c9bb0>]}
2021-05-15 11:09:55.806094 (Thread-588): sending response (<Response 73245 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:10:55.839856 (Thread-589): handling status request
2021-05-15 11:10:55.840279 (Thread-589): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355c98b0>]}
2021-05-15 11:10:55.842323 (Thread-589): sending response (<Response 6258 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:10:56.756050 (Thread-590): handling run_sql request
2021-05-15 11:10:56.756475 (Thread-590): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355c9b20>]}
2021-05-15 11:10:57.772517 (Thread-590): sending response (<Response 137 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:10:57.794806 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:10:57.819547 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:10:57.819997 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:10:57.820104 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 11:10:57.834277 (Thread-1): finished collecting timing info
2021-05-15 11:10:57.844418 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 11:10:57.844491 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='EMAIL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=66
 and r_type='Year'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 11:10:57.844549 (Thread-1): Opening a new connection, currently in state init
2021-05-15 11:10:58.251701 (Thread-591): handling poll request
2021-05-15 11:10:58.252149 (Thread-591): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725c723d0>]}
2021-05-15 11:10:58.254272 (Thread-591): sending response (<Response 16806 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:10:59.775905 (Thread-592): handling poll request
2021-05-15 11:10:59.776322 (Thread-592): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7343c58b0>]}
2021-05-15 11:10:59.777190 (Thread-592): sending response (<Response 388 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:11:01.317478 (Thread-1): SQL status: SUCCESS 2 in 3.47 seconds
2021-05-15 11:11:01.319251 (Thread-1): finished collecting timing info
2021-05-15 11:11:01.319625 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 11:11:01.339512 (Thread-593): handling poll request
2021-05-15 11:11:01.339912 (Thread-593): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72602bbb0>]}
2021-05-15 11:11:01.341038 (Thread-593): sending response (<Response 1329 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:11:02.832272 (Thread-594): handling poll request
2021-05-15 11:11:02.832765 (Thread-594): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725e1c5b0>]}
2021-05-15 11:11:02.836891 (Thread-594): sending response (<Response 72311 bytes [200 OK]>) to 10.0.1.135
2021-05-15 11:11:23.986953 (Thread-595): handling status request
2021-05-15 11:11:23.987373 (Thread-595): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725e1c340>]}
2021-05-15 11:11:23.989405 (Thread-595): sending response (<Response 6258 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:11:24.822615 (Thread-596): handling run_sql request
2021-05-15 11:11:24.823041 (Thread-596): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725e1c670>]}
2021-05-15 11:11:25.874162 (Thread-596): sending response (<Response 137 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:11:25.896583 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:11:25.918116 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:11:25.918579 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:11:25.918686 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 11:11:25.932106 (Thread-1): finished collecting timing info
2021-05-15 11:11:25.942085 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 11:11:25.942196 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='EMAIL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
 and r_metric_id=66
 and r_type='Month'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 11:11:25.942259 (Thread-1): Opening a new connection, currently in state init
2021-05-15 11:11:26.352061 (Thread-597): handling poll request
2021-05-15 11:11:26.352513 (Thread-597): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7260234c0>]}
2021-05-15 11:11:26.354682 (Thread-597): sending response (<Response 16808 bytes [200 OK]>) to 10.0.40.42
2021-05-15 11:11:27.843362 (Thread-598): handling poll request
2021-05-15 11:11:27.843790 (Thread-598): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7260235b0>]}
2021-05-15 11:11:27.844654 (Thread-598): sending response (<Response 388 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:11:29.086558 (Thread-1): SQL status: SUCCESS 17 in 3.14 seconds
2021-05-15 11:11:29.090553 (Thread-1): finished collecting timing info
2021-05-15 11:11:29.090945 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 11:11:29.401491 (Thread-599): handling poll request
2021-05-15 11:11:29.402306 (Thread-599): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735daf880>]}
2021-05-15 11:11:29.406736 (Thread-599): sending response (<Response 75324 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:12:07.514508 (Thread-600): Got an acceptable cached parse result
2021-05-15 11:12:07.636890 (Thread-600): Acquiring new snowflake connection "model.DBTTest.HS_SF".
2021-05-15 11:12:07.919054 (Thread-601): handling status request
2021-05-15 11:12:07.919841 (Thread-602): handling status request
2021-05-15 11:12:07.929545 (Thread-601): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bc6a60>]}
2021-05-15 11:12:07.930084 (Thread-603): handling status request
2021-05-15 11:12:07.931727 (Thread-602): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7257a2c40>]}
2021-05-15 11:12:07.932465 (Thread-601): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.49
2021-05-15 11:12:07.932982 (Thread-603): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735bc6df0>]}
2021-05-15 11:12:07.933905 (Thread-602): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.49
2021-05-15 11:12:07.957983 (Thread-603): sending response (<Response 184 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:12:09.506956 (Thread-604): handling status request
2021-05-15 11:12:09.507346 (Thread-604): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7258dd910>]}
2021-05-15 11:12:09.508036 (Thread-604): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.167
2021-05-15 11:12:09.554928 (Thread-605): handling status request
2021-05-15 11:12:09.555249 (Thread-605): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7258dd7f0>]}
2021-05-15 11:12:09.555864 (Thread-605): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:12:09.578400 (Thread-606): handling status request
2021-05-15 11:12:09.578747 (Thread-606): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7258dd310>]}
2021-05-15 11:12:09.579340 (Thread-606): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:12:09.656127 (Thread-600): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 11:12:09.656265 (Thread-600): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 11:12:09.656326 (Thread-600): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 11:12:09.656381 (Thread-600): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 11:12:09.656432 (Thread-600): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:12:09.657210 (Thread-600): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:12:09.657537 (Thread-600): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:12:09.657807 (Thread-600): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:12:09.658049 (Thread-600): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:12:09.658309 (Thread-600): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:12:09.658557 (Thread-600): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:12:09.658793 (Thread-600): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:12:09.659028 (Thread-600): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:12:09.990247 (Thread-600): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 11:12:11.006655 (Thread-607): handling status request
2021-05-15 11:12:11.007064 (Thread-607): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7261976d0>]}
2021-05-15 11:12:11.014214 (Thread-608): handling status request
2021-05-15 11:12:11.014643 (Thread-608): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725d84340>]}
2021-05-15 11:12:11.080556 (Thread-609): handling status request
2021-05-15 11:12:11.091299 (Thread-609): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7264b1880>]}
2021-05-15 11:12:11.132308 (Thread-607): sending response (<Response 6248 bytes [200 OK]>) to 10.0.40.42
2021-05-15 11:12:11.134890 (Thread-608): sending response (<Response 6248 bytes [200 OK]>) to 10.0.17.122
2021-05-15 11:12:11.137149 (Thread-609): sending response (<Response 6248 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:13:02.630927 (MainThread): Connection 'model.DBTTest.HS_SF' was properly closed.
2021-05-15 11:13:03.532451 (Thread-611): handling status request
2021-05-15 11:13:03.532923 (Thread-611): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725653c70>]}
2021-05-15 11:13:03.533644 (Thread-611): sending response (<Response 184 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:13:03.630547 (Thread-612): handling status request
2021-05-15 11:13:03.630983 (Thread-612): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72565feb0>]}
2021-05-15 11:13:03.631712 (Thread-612): sending response (<Response 184 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:13:03.642562 (Thread-613): handling status request
2021-05-15 11:13:03.642884 (Thread-613): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb734497e50>]}
2021-05-15 11:13:03.643474 (Thread-613): sending response (<Response 184 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:13:03.685264 (Thread-610): Got an acceptable cached parse result
2021-05-15 11:13:03.796969 (Thread-610): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-15 11:13:05.049789 (Thread-614): handling status request
2021-05-15 11:13:05.050403 (Thread-614): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72574f7c0>]}
2021-05-15 11:13:05.051332 (Thread-614): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:13:05.108023 (Thread-615): handling status request
2021-05-15 11:13:05.108437 (Thread-615): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7257dea60>]}
2021-05-15 11:13:05.109141 (Thread-615): sending response (<Response 184 bytes [200 OK]>) to 10.0.1.135
2021-05-15 11:13:05.132247 (Thread-616): handling status request
2021-05-15 11:13:05.132795 (Thread-616): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7257deb50>]}
2021-05-15 11:13:05.133421 (Thread-616): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:13:05.717256 (Thread-610): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 11:13:05.717406 (Thread-610): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 11:13:05.717466 (Thread-610): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 11:13:05.717518 (Thread-610): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 11:13:05.717567 (Thread-610): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:13:05.718319 (Thread-610): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:13:05.718657 (Thread-610): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:13:05.718968 (Thread-610): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:13:05.719234 (Thread-610): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:13:05.719499 (Thread-610): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:13:05.719766 (Thread-610): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:13:05.720017 (Thread-610): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:13:05.720264 (Thread-610): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:13:06.042267 (Thread-610): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 11:13:06.559969 (Thread-617): handling status request
2021-05-15 11:13:06.560513 (Thread-617): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725a171f0>]}
2021-05-15 11:13:06.562532 (Thread-617): sending response (<Response 6253 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:13:06.592602 (Thread-618): handling status request
2021-05-15 11:13:06.592961 (Thread-618): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725e367c0>]}
2021-05-15 11:13:06.594994 (Thread-618): sending response (<Response 6253 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:13:06.599467 (Thread-619): handling status request
2021-05-15 11:13:06.599747 (Thread-619): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7256d9580>]}
2021-05-15 11:13:06.601470 (Thread-619): sending response (<Response 6253 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:13:44.132734 (Thread-620): handling status request
2021-05-15 11:13:44.133156 (Thread-620): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7256d9c10>]}
2021-05-15 11:13:44.135226 (Thread-620): sending response (<Response 6253 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:13:45.016925 (Thread-621): handling run_sql request
2021-05-15 11:13:45.017352 (Thread-621): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7256d9760>]}
2021-05-15 11:13:45.018627 (Thread-621): Connection 'model.DBTTest.HS_SF_FACT' was properly closed.
2021-05-15 11:13:46.034559 (Thread-621): sending response (<Response 137 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:13:46.058579 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:13:46.080383 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:13:46.080830 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:13:46.080938 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 11:13:46.097394 (Thread-1): finished collecting timing info
2021-05-15 11:13:46.110895 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 11:13:46.111018 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='EMAIL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  --where 1=1
--r_timeframe_type='W'
--  and r_metric_id=66
--  and r_type='Month'
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 11:13:46.111114 (Thread-1): Opening a new connection, currently in state init
2021-05-15 11:13:46.565368 (Thread-622): handling poll request
2021-05-15 11:13:46.565836 (Thread-622): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7251c1a30>]}
2021-05-15 11:13:46.568047 (Thread-622): sending response (<Response 16821 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:13:48.051118 (Thread-623): handling poll request
2021-05-15 11:13:48.051777 (Thread-623): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7251c1640>]}
2021-05-15 11:13:48.053204 (Thread-623): sending response (<Response 393 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:13:49.642906 (Thread-624): handling poll request
2021-05-15 11:13:49.643327 (Thread-624): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72591a7f0>]}
2021-05-15 11:13:49.644193 (Thread-624): sending response (<Response 393 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:13:51.149365 (Thread-625): handling poll request
2021-05-15 11:13:51.149836 (Thread-625): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72591a910>]}
2021-05-15 11:13:51.150748 (Thread-625): sending response (<Response 393 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:13:52.673416 (Thread-626): handling poll request
2021-05-15 11:13:52.673874 (Thread-626): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72591ab80>]}
2021-05-15 11:13:52.675331 (Thread-626): sending response (<Response 392 bytes [200 OK]>) to 10.0.1.135
2021-05-15 11:13:54.691909 (Thread-627): handling poll request
2021-05-15 11:13:54.692370 (Thread-627): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7251c1af0>]}
2021-05-15 11:13:54.693422 (Thread-627): sending response (<Response 393 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:13:56.207353 (Thread-628): handling poll request
2021-05-15 11:13:56.207827 (Thread-628): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726197910>]}
2021-05-15 11:13:56.208710 (Thread-628): sending response (<Response 394 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:13:56.276227 (Thread-1): SQL status: SUCCESS 469 in 10.17 seconds
2021-05-15 11:13:56.296763 (Thread-1): finished collecting timing info
2021-05-15 11:13:56.297175 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 11:13:57.725064 (Thread-629): handling poll request
2021-05-15 11:13:57.725498 (Thread-629): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725878040>]}
2021-05-15 11:13:57.735456 (Thread-629): sending response (<Response 137645 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:14:07.854815 (Thread-630): Got an acceptable cached parse result
2021-05-15 11:14:07.955918 (Thread-631): handling status request
2021-05-15 11:14:07.956414 (Thread-631): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725293610>]}
2021-05-15 11:14:07.957162 (Thread-631): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.167
2021-05-15 11:14:07.960717 (Thread-632): handling status request
2021-05-15 11:14:07.961005 (Thread-632): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7252a29a0>]}
2021-05-15 11:14:07.961561 (Thread-632): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:14:07.971150 (Thread-630): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-15 11:14:07.993054 (Thread-633): handling status request
2021-05-15 11:14:07.993402 (Thread-633): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72514c910>]}
2021-05-15 11:14:07.993939 (Thread-633): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.49
2021-05-15 11:14:09.627036 (Thread-634): handling status request
2021-05-15 11:14:09.632561 (Thread-634): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725867d90>]}
2021-05-15 11:14:09.633291 (Thread-634): sending response (<Response 184 bytes [200 OK]>) to 10.0.1.135
2021-05-15 11:14:09.655847 (Thread-635): handling status request
2021-05-15 11:14:09.656310 (Thread-636): handling status request
2021-05-15 11:14:09.656753 (Thread-635): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7251bc4c0>]}
2021-05-15 11:14:09.657286 (Thread-636): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725569f40>]}
2021-05-15 11:14:09.657909 (Thread-635): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.122
2021-05-15 11:14:09.658563 (Thread-636): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:14:10.000617 (Thread-630): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 11:14:10.000770 (Thread-630): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 11:14:10.000832 (Thread-630): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 11:14:10.000886 (Thread-630): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 11:14:10.000937 (Thread-630): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:14:10.001695 (Thread-630): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:14:10.002020 (Thread-630): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:14:10.002306 (Thread-630): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:14:10.002547 (Thread-630): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:14:10.002829 (Thread-630): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:14:10.003072 (Thread-630): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:14:10.003303 (Thread-630): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:14:10.003533 (Thread-630): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:14:10.331574 (Thread-630): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 11:14:11.268071 (Thread-637): handling status request
2021-05-15 11:14:11.268491 (Thread-637): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725536ac0>]}
2021-05-15 11:14:11.270437 (Thread-637): sending response (<Response 6253 bytes [200 OK]>) to 10.0.1.135
2021-05-15 11:14:11.281665 (Thread-638): handling status request
2021-05-15 11:14:11.281938 (Thread-638): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725536e80>]}
2021-05-15 11:14:11.283689 (Thread-638): sending response (<Response 6253 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:14:11.290827 (Thread-639): handling status request
2021-05-15 11:14:11.291110 (Thread-639): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725536130>]}
2021-05-15 11:14:11.430362 (Thread-639): sending response (<Response 6253 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:14:20.251566 (Thread-640): handling status request
2021-05-15 11:14:20.252059 (Thread-640): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7255366d0>]}
2021-05-15 11:14:20.254056 (Thread-640): sending response (<Response 6253 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:14:21.018215 (Thread-641): handling run_sql request
2021-05-15 11:14:21.018639 (Thread-641): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7258ffa30>]}
2021-05-15 11:14:21.019814 (Thread-641): Connection 'model.DBTTest.HS_SF_FACT' was properly closed.
2021-05-15 11:14:22.046616 (Thread-641): sending response (<Response 137 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:14:22.069051 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:14:22.091472 (MainThread): Found 123 models, 72 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:14:22.091952 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 11:14:22.092062 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 11:14:22.107690 (Thread-1): finished collecting timing info
2021-05-15 11:14:22.117140 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 11:14:22.117216 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company inner join calendar on to_date(PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric --where r_type='Year' and r_metric_id= 85
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 11:14:22.117275 (Thread-1): Opening a new connection, currently in state init
2021-05-15 11:14:22.499785 (Thread-642): handling poll request
2021-05-15 11:14:22.500303 (Thread-642): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72590a250>]}
2021-05-15 11:14:22.502512 (Thread-642): sending response (<Response 15338 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:14:24.566587 (Thread-643): handling poll request
2021-05-15 11:14:24.567014 (Thread-643): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72590a670>]}
2021-05-15 11:14:24.567874 (Thread-643): sending response (<Response 398 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:14:26.080257 (Thread-644): handling poll request
2021-05-15 11:14:26.080677 (Thread-644): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72590a3a0>]}
2021-05-15 11:14:26.081549 (Thread-644): sending response (<Response 398 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:14:26.937778 (Thread-1): SQL status: SUCCESS 500 in 4.82 seconds
2021-05-15 11:14:26.951191 (Thread-1): finished collecting timing info
2021-05-15 11:14:26.951602 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 11:14:27.556906 (Thread-645): handling poll request
2021-05-15 11:14:27.557327 (Thread-645): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72590adf0>]}
2021-05-15 11:14:27.564479 (Thread-645): sending response (<Response 110175 bytes [200 OK]>) to 10.0.40.42
2021-05-15 11:14:43.820725 (Thread-647): handling status request
2021-05-15 11:14:43.835846 (Thread-648): handling status request
2021-05-15 11:14:43.840622 (Thread-647): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725956ee0>]}
2021-05-15 11:14:43.843225 (Thread-648): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7261138b0>]}
2021-05-15 11:14:43.843440 (Thread-646): Got an acceptable cached parse result
2021-05-15 11:14:43.843969 (Thread-649): handling status request
2021-05-15 11:14:43.844774 (Thread-647): sending response (<Response 184 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:14:43.845463 (Thread-648): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:14:43.861542 (Thread-649): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725b96e80>]}
2021-05-15 11:14:43.880216 (Thread-649): sending response (<Response 184 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:14:43.955594 (Thread-646): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-15 11:14:45.373325 (Thread-650): handling status request
2021-05-15 11:14:45.387279 (Thread-650): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72531bd00>]}
2021-05-15 11:14:45.388031 (Thread-650): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.49
2021-05-15 11:14:45.392995 (Thread-651): handling status request
2021-05-15 11:14:45.393400 (Thread-651): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726000880>]}
2021-05-15 11:14:45.393972 (Thread-651): sending response (<Response 184 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:14:45.403544 (Thread-652): handling status request
2021-05-15 11:14:45.403931 (Thread-652): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7264bc520>]}
2021-05-15 11:14:45.404516 (Thread-652): sending response (<Response 184 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:14:45.926153 (Thread-646): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 11:14:45.926320 (Thread-646): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 11:14:45.926383 (Thread-646): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 11:14:45.926438 (Thread-646): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 11:14:45.926489 (Thread-646): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:14:45.927276 (Thread-646): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:14:45.927619 (Thread-646): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:14:45.927890 (Thread-646): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:14:45.928134 (Thread-646): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:14:45.928371 (Thread-646): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:14:45.928603 (Thread-646): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:14:45.928848 (Thread-646): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:14:45.929079 (Thread-646): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:14:46.260141 (Thread-646): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 11:14:50.191556 (Thread-653): handling status request
2021-05-15 11:14:50.191984 (Thread-653): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72577d8e0>]}
2021-05-15 11:14:50.194286 (Thread-653): sending response (<Response 6257 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:14:50.213576 (Thread-654): handling status request
2021-05-15 11:14:50.213991 (Thread-654): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7253c7460>]}
2021-05-15 11:14:50.215834 (Thread-654): sending response (<Response 6257 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:14:50.223608 (Thread-655): handling status request
2021-05-15 11:14:50.223901 (Thread-655): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73575d8b0>]}
2021-05-15 11:14:50.225823 (Thread-655): sending response (<Response 6257 bytes [200 OK]>) to 10.0.19.219
2021-05-15 11:14:53.255944 (MainThread): Connection 'model.DBTTest.Test_timeframe' was properly closed.
2021-05-15 11:14:54.101079 (Thread-656): Got an acceptable cached parse result
2021-05-15 11:14:54.169857 (Thread-657): handling status request
2021-05-15 11:14:54.170556 (Thread-658): handling status request
2021-05-15 11:14:54.171041 (Thread-657): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725603430>]}
2021-05-15 11:14:54.171391 (Thread-658): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7359b5d60>]}
2021-05-15 11:14:54.172204 (Thread-657): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:14:54.172860 (Thread-658): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:14:54.195135 (Thread-659): handling status request
2021-05-15 11:14:54.195539 (Thread-659): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725603f70>]}
2021-05-15 11:14:54.196322 (Thread-659): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:14:54.214096 (Thread-656): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 11:14:55.697356 (Thread-660): handling status request
2021-05-15 11:14:55.697858 (Thread-660): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724c07f40>]}
2021-05-15 11:14:55.698571 (Thread-660): sending response (<Response 184 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:14:55.753663 (Thread-661): handling status request
2021-05-15 11:14:55.754374 (Thread-662): handling status request
2021-05-15 11:14:55.754780 (Thread-661): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724a86cd0>]}
2021-05-15 11:14:55.755237 (Thread-662): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724a86550>]}
2021-05-15 11:14:55.756076 (Thread-661): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:14:55.756775 (Thread-662): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.42
2021-05-15 11:14:56.227231 (Thread-656): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 11:14:56.227438 (Thread-656): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 11:14:56.227546 (Thread-656): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 11:14:56.227638 (Thread-656): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 11:14:56.227727 (Thread-656): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:14:56.228532 (Thread-656): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:14:56.228872 (Thread-656): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:14:56.229149 (Thread-656): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:14:56.229393 (Thread-656): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:14:56.229629 (Thread-656): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:14:56.229864 (Thread-656): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:14:56.230099 (Thread-656): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:14:56.230392 (Thread-656): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:14:56.562625 (Thread-656): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 11:14:57.147705 (Thread-663): handling status request
2021-05-15 11:14:57.148142 (Thread-663): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735be7cd0>]}
2021-05-15 11:14:57.150108 (Thread-663): sending response (<Response 6258 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:14:57.201105 (Thread-664): handling status request
2021-05-15 11:14:57.201419 (Thread-664): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735b18670>]}
2021-05-15 11:14:57.203254 (Thread-664): sending response (<Response 6258 bytes [200 OK]>) to 10.0.1.135
2021-05-15 11:14:57.269346 (Thread-665): handling status request
2021-05-15 11:14:57.269701 (Thread-665): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7251f6370>]}
2021-05-15 11:14:57.271544 (Thread-665): sending response (<Response 6258 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:15:15.226848 (MainThread): Connection 'model.DBTTest.SF_HF_segmented' was properly closed.
2021-05-15 11:15:16.078996 (Thread-666): Got an acceptable cached parse result
2021-05-15 11:15:16.193461 (Thread-666): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-15 11:15:16.260619 (Thread-667): handling status request
2021-05-15 11:15:16.273482 (Thread-667): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724a6a490>]}
2021-05-15 11:15:16.274300 (Thread-667): sending response (<Response 184 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:15:16.553715 (Thread-668): handling status request
2021-05-15 11:15:16.554433 (Thread-669): handling status request
2021-05-15 11:15:16.555022 (Thread-668): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724608eb0>]}
2021-05-15 11:15:16.555460 (Thread-669): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72475ca00>]}
2021-05-15 11:15:16.556216 (Thread-668): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.122
2021-05-15 11:15:16.556918 (Thread-669): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:15:18.076415 (Thread-670): handling status request
2021-05-15 11:15:18.078874 (Thread-670): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb744a1a2e0>]}
2021-05-15 11:15:18.079748 (Thread-670): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:15:18.152985 (Thread-671): handling status request
2021-05-15 11:15:18.153393 (Thread-671): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724c35430>]}
2021-05-15 11:15:18.154059 (Thread-671): sending response (<Response 184 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:15:18.195463 (Thread-672): handling status request
2021-05-15 11:15:18.218204 (Thread-672): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724a14940>]}
2021-05-15 11:15:18.219433 (Thread-666): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 11:15:18.220621 (Thread-666): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 11:15:18.220705 (Thread-666): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 11:15:18.220771 (Thread-666): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 11:15:18.220834 (Thread-666): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:15:18.221595 (Thread-666): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:15:18.221965 (Thread-666): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:15:18.222451 (Thread-666): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:15:18.222729 (Thread-666): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:15:18.222973 (Thread-666): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:15:18.223210 (Thread-666): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:15:18.223444 (Thread-666): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:15:18.223676 (Thread-666): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:15:18.669820 (Thread-666): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 5 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 11:15:18.709534 (Thread-672): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:15:19.698374 (Thread-673): handling status request
2021-05-15 11:15:19.698807 (Thread-673): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725c22340>]}
2021-05-15 11:15:19.700772 (Thread-673): sending response (<Response 6257 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:15:19.725832 (Thread-674): handling status request
2021-05-15 11:15:19.726129 (Thread-674): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725c22430>]}
2021-05-15 11:15:19.727928 (Thread-674): sending response (<Response 6257 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:15:23.598970 (Thread-675): handling status request
2021-05-15 11:15:23.599386 (Thread-675): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725c22eb0>]}
2021-05-15 11:15:23.601334 (Thread-675): sending response (<Response 6257 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:17:32.818844 (MainThread): Connection 'model.DBTTest.Test_timeframe' was properly closed.
2021-05-15 11:17:33.725516 (Thread-676): Got an acceptable cached parse result
2021-05-15 11:17:33.791913 (Thread-677): handling status request
2021-05-15 11:17:33.792372 (Thread-677): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724687340>]}
2021-05-15 11:17:33.793076 (Thread-677): sending response (<Response 184 bytes [200 OK]>) to 10.0.19.219
2021-05-15 11:17:33.880019 (Thread-678): handling status request
2021-05-15 11:17:33.880501 (Thread-679): handling status request
2021-05-15 11:17:33.881185 (Thread-678): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725603e50>]}
2021-05-15 11:17:33.881631 (Thread-679): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7355edbb0>]}
2021-05-15 11:17:33.882365 (Thread-678): sending response (<Response 184 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:17:33.883051 (Thread-679): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:17:35.342093 (Thread-680): handling status request
2021-05-15 11:17:35.342671 (Thread-680): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72478efa0>]}
2021-05-15 11:17:35.343328 (Thread-680): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:17:35.675521 (Thread-681): handling status request
2021-05-15 11:17:35.676823 (Thread-682): handling status request
2021-05-15 11:17:35.676995 (Thread-681): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72472ddf0>]}
2021-05-15 11:17:35.677394 (Thread-682): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724717520>]}
2021-05-15 11:17:35.678118 (Thread-681): sending response (<Response 184 bytes [200 OK]>) to 10.0.20.29
2021-05-15 11:17:35.678848 (Thread-682): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:17:35.818503 (Thread-676): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 11:17:35.818667 (Thread-676): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 11:17:35.818754 (Thread-676): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 11:17:35.818814 (Thread-676): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 11:17:35.818865 (Thread-676): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:17:35.819647 (Thread-676): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:17:35.819986 (Thread-676): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:17:35.820287 (Thread-676): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:17:35.820549 (Thread-676): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:17:35.820790 (Thread-676): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:17:35.821026 (Thread-676): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:17:35.821280 (Thread-676): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:17:35.821522 (Thread-676): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:17:36.144220 (Thread-676): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 6 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.livedata_rk
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 11:17:36.990440 (Thread-683): handling status request
2021-05-15 11:17:36.990865 (Thread-683): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73575d160>]}
2021-05-15 11:17:36.992716 (Thread-683): sending response (<Response 5987 bytes [200 OK]>) to 10.0.19.219
2021-05-15 11:17:37.176172 (Thread-684): handling status request
2021-05-15 11:17:37.176574 (Thread-684): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7248a4b80>]}
2021-05-15 11:17:37.178434 (Thread-684): sending response (<Response 5987 bytes [200 OK]>) to 10.0.19.219
2021-05-15 11:17:37.272055 (Thread-685): handling status request
2021-05-15 11:17:37.272352 (Thread-685): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7248a46a0>]}
2021-05-15 11:17:37.274071 (Thread-685): sending response (<Response 5987 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:18:19.154460 (Thread-686): Got an acceptable cached parse result
2021-05-15 11:18:19.243625 (Thread-687): handling status request
2021-05-15 11:18:19.244122 (Thread-687): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724fafac0>]}
2021-05-15 11:18:19.244833 (Thread-687): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.49
2021-05-15 11:18:19.318345 (Thread-688): handling status request
2021-05-15 11:18:19.330969 (Thread-688): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724943af0>]}
2021-05-15 11:18:19.331692 (Thread-688): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:18:19.368518 (Thread-689): handling status request
2021-05-15 11:18:19.369032 (Thread-689): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724675700>]}
2021-05-15 11:18:19.369681 (Thread-689): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:18:21.055608 (Thread-690): handling status request
2021-05-15 11:18:21.062372 (Thread-691): handling status request
2021-05-15 11:18:21.062568 (Thread-690): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724b5bb20>]}
2021-05-15 11:18:21.063421 (Thread-692): handling status request
2021-05-15 11:18:21.064187 (Thread-690): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.122
2021-05-15 11:18:21.064321 (Thread-691): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72678b550>]}
2021-05-15 11:18:21.064792 (Thread-692): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7259c1970>]}
2021-05-15 11:18:21.065811 (Thread-691): sending response (<Response 184 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:18:21.066588 (Thread-692): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:18:21.223781 (Thread-686): WARNING: Found documentation for resource "stg_sf_calendar" which was not found or is disabled
2021-05-15 11:18:21.223957 (Thread-686): WARNING: Found documentation for resource "stg_sf_contact" which was not found or is disabled
2021-05-15 11:18:21.224025 (Thread-686): WARNING: Found documentation for resource "stg_sf_user" which was not found or is disabled
2021-05-15 11:18:21.224080 (Thread-686): WARNING: Found documentation for resource "stg_sf_user_role" which was not found or is disabled
2021-05-15 11:18:21.224132 (Thread-686): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:18:21.224867 (Thread-686): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:18:21.225201 (Thread-686): [WARNING]: Test 'test.DBTTest.unique_stg_sf_calendar_cldr_date' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_calendar' which was not found
2021-05-15 11:18:21.225497 (Thread-686): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:18:21.225755 (Thread-686): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_user_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user' which was not found
2021-05-15 11:18:21.226011 (Thread-686): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:18:21.226291 (Thread-686): [WARNING]: Test 'test.DBTTest.unique_stg_sf_user_role_user_role_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_user_role' which was not found
2021-05-15 11:18:21.226546 (Thread-686): [WARNING]: Test 'test.DBTTest.not_null_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:18:21.226798 (Thread-686): [WARNING]: Test 'test.DBTTest.unique_stg_sf_contact_id' (models/sources/stg_salesforce/schema.yml) depends on a node named 'stg_sf_contact' which was not found
2021-05-15 11:18:21.534979 (Thread-686): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.marts
- models.DBTTest.livedata_rk
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 11:18:22.577305 (Thread-693): handling status request
2021-05-15 11:18:22.577764 (Thread-693): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72627d4c0>]}
2021-05-15 11:18:22.579666 (Thread-693): sending response (<Response 6011 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:18:22.597422 (Thread-694): handling status request
2021-05-15 11:18:22.597720 (Thread-694): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725e002b0>]}
2021-05-15 11:18:22.599472 (Thread-694): sending response (<Response 6011 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:18:22.611376 (Thread-695): handling status request
2021-05-15 11:18:22.611657 (Thread-695): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724feca90>]}
2021-05-15 11:18:22.613382 (Thread-695): sending response (<Response 6011 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:18:46.355809 (Thread-696): Got an acceptable cached parse result
2021-05-15 11:18:46.389568 (Thread-697): handling status request
2021-05-15 11:18:46.390274 (Thread-697): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724aa2700>]}
2021-05-15 11:18:46.390730 (Thread-698): handling status request
2021-05-15 11:18:46.391656 (Thread-697): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:18:46.393377 (Thread-698): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724aa2550>]}
2021-05-15 11:18:46.394043 (Thread-698): sending response (<Response 184 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:18:46.421815 (Thread-699): handling status request
2021-05-15 11:18:46.422346 (Thread-699): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724a55fd0>]}
2021-05-15 11:18:46.422976 (Thread-699): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.42
2021-05-15 11:18:48.183031 (Thread-700): handling status request
2021-05-15 11:18:48.183720 (Thread-701): handling status request
2021-05-15 11:18:48.184381 (Thread-700): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724c3f670>]}
2021-05-15 11:18:48.184803 (Thread-702): handling status request
2021-05-15 11:18:48.185828 (Thread-700): sending response (<Response 184 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:18:48.185958 (Thread-701): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7260879d0>]}
2021-05-15 11:18:48.186469 (Thread-702): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726087ee0>]}
2021-05-15 11:18:48.187497 (Thread-701): sending response (<Response 184 bytes [200 OK]>) to 10.0.19.219
2021-05-15 11:18:48.188307 (Thread-702): sending response (<Response 184 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:18:48.374433 (Thread-696): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:18:48.681333 (Thread-696): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 8 unused configuration paths:
- models.DBTTest.sources
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.marts
- models.DBTTest.livedata_rk
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 11:18:49.718018 (Thread-703): handling status request
2021-05-15 11:18:49.719078 (Thread-704): handling status request
2021-05-15 11:18:49.719261 (Thread-703): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735d11ee0>]}
2021-05-15 11:18:49.719620 (Thread-704): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb736845820>]}
2021-05-15 11:18:49.720643 (Thread-703): sending response (<Response 1381 bytes [200 OK]>) to 10.0.6.126
2021-05-15 11:18:49.721583 (Thread-704): sending response (<Response 1381 bytes [200 OK]>) to 10.0.19.219
2021-05-15 11:18:49.743391 (Thread-705): handling status request
2021-05-15 11:18:49.743682 (Thread-705): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7368e9820>]}
2021-05-15 11:18:49.860364 (Thread-705): sending response (<Response 1381 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:19:48.103042 (Thread-706): For key DBTTest, hash mismatch (FileHash(name='sha256', checksum='aaeb59bbd1d8e8e03e83f69353e452b117dc6682d414e8391034b4fcec51a9a9') -> FileHash(name='sha256', checksum='5742420359b7d3ccfca60917f0b0c72e665554ceea462cbe80f51737a8fb3603')), cache invalidated
2021-05-15 11:19:48.106834 (Thread-706): Parsing macros/metrics.sql
2021-05-15 11:19:48.117514 (Thread-706): Parsing macros/generate_custom_schema_name.sql
2021-05-15 11:19:48.120809 (Thread-706): Parsing macros/datatype_conversion.sql
2021-05-15 11:19:48.124675 (Thread-706): Parsing macros/adapters.sql
2021-05-15 11:19:48.152390 (Thread-706): Parsing macros/catalog.sql
2021-05-15 11:19:48.154372 (Thread-706): Parsing macros/materializations/table.sql
2021-05-15 11:19:48.158160 (Thread-706): Parsing macros/materializations/merge.sql
2021-05-15 11:19:48.160136 (Thread-706): Parsing macros/materializations/incremental.sql
2021-05-15 11:19:48.169130 (Thread-706): Parsing macros/materializations/view.sql
2021-05-15 11:19:48.171292 (Thread-706): Parsing macros/core.sql
2021-05-15 11:19:48.174831 (Thread-706): Parsing macros/materializations/helpers.sql
2021-05-15 11:19:48.183443 (Thread-706): Parsing macros/materializations/common/merge.sql
2021-05-15 11:19:48.198023 (Thread-706): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-15 11:19:48.200032 (Thread-706): Parsing macros/materializations/snapshot/strategies.sql
2021-05-15 11:19:48.216450 (Thread-706): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-15 11:19:48.245684 (Thread-706): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-15 11:19:48.250643 (Thread-706): Parsing macros/materializations/view/view.sql
2021-05-15 11:19:48.256844 (Thread-706): Parsing macros/materializations/seed/seed.sql
2021-05-15 11:19:48.277702 (Thread-706): Parsing macros/materializations/table/table.sql
2021-05-15 11:19:48.284650 (Thread-706): Parsing macros/materializations/incremental/helpers.sql
2021-05-15 11:19:48.286603 (Thread-706): Parsing macros/materializations/incremental/incremental.sql
2021-05-15 11:19:48.293623 (Thread-706): Parsing macros/etc/is_incremental.sql
2021-05-15 11:19:48.295789 (Thread-706): Parsing macros/etc/query.sql
2021-05-15 11:19:48.297199 (Thread-706): Parsing macros/etc/datetime.sql
2021-05-15 11:19:48.307173 (Thread-706): Parsing macros/etc/get_custom_alias.sql
2021-05-15 11:19:48.308184 (Thread-706): Parsing macros/etc/get_custom_database.sql
2021-05-15 11:19:48.309980 (Thread-706): Parsing macros/etc/get_custom_schema.sql
2021-05-15 11:19:48.311983 (Thread-706): Parsing macros/schema_tests/not_null.sql
2021-05-15 11:19:48.313552 (Thread-706): Parsing macros/schema_tests/accepted_values.sql
2021-05-15 11:19:48.316262 (Thread-706): Parsing macros/schema_tests/relationships.sql
2021-05-15 11:19:48.318165 (Thread-706): Parsing macros/schema_tests/unique.sql
2021-05-15 11:19:48.319950 (Thread-706): Parsing macros/adapters/common.sql
2021-05-15 11:19:48.369167 (Thread-706): Parsing macros/staging_columns.sql
2021-05-15 11:19:48.385772 (Thread-706): Parsing macros/staging_columns.sql
2021-05-15 11:19:48.437625 (Thread-706): Parsing macros/logger/pretty_time.sql
2021-05-15 11:19:48.441026 (Thread-706): Parsing macros/logger/log_info.sql
2021-05-15 11:19:48.443926 (Thread-706): Parsing macros/logger/pretty_log_format.sql
2021-05-15 11:19:48.446634 (Thread-706): Parsing macros/sql/pivot.sql
2021-05-15 11:19:48.451332 (Thread-706): Parsing macros/sql/star.sql
2021-05-15 11:19:48.455943 (Thread-706): Parsing macros/sql/surrogate_key.sql
2021-05-15 11:19:48.460786 (Thread-706): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-15 11:19:48.465110 (Thread-706): Parsing macros/sql/get_column_values.sql
2021-05-15 11:19:48.471853 (Thread-706): Parsing macros/sql/groupby.sql
2021-05-15 11:19:48.474891 (Thread-706): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-15 11:19:48.483307 (Thread-706): Parsing macros/sql/nullcheck_table.sql
2021-05-15 11:19:48.487092 (Thread-706): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-15 11:19:48.490512 (Thread-706): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-15 11:19:48.494941 (Thread-706): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-15 11:19:48.499286 (Thread-706): Parsing macros/sql/safe_add.sql
2021-05-15 11:19:48.502284 (Thread-706): Parsing macros/sql/unpivot.sql
2021-05-15 11:19:48.510243 (Thread-706): Parsing macros/sql/generate_series.sql
2021-05-15 11:19:48.515337 (Thread-706): Parsing macros/sql/nullcheck.sql
2021-05-15 11:19:48.518471 (Thread-706): Parsing macros/sql/union.sql
2021-05-15 11:19:48.528542 (Thread-706): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-15 11:19:48.553240 (Thread-706): Parsing macros/web/get_url_parameter.sql
2021-05-15 11:19:48.556283 (Thread-706): Parsing macros/web/get_url_path.sql
2021-05-15 11:19:48.560415 (Thread-707): handling status request
2021-05-15 11:19:48.560608 (Thread-706): Parsing macros/web/get_url_host.sql
2021-05-15 11:19:48.560997 (Thread-707): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7251ead00>]}
2021-05-15 11:19:48.563024 (Thread-707): sending response (<Response 184 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:19:48.564418 (Thread-706): Parsing macros/datetime/date_spine.sql
2021-05-15 11:19:48.569695 (Thread-706): Parsing macros/schema_tests/expression_is_true.sql
2021-05-15 11:19:48.572750 (Thread-706): Parsing macros/schema_tests/not_constant.sql
2021-05-15 11:19:48.575051 (Thread-708): handling status request
2021-05-15 11:19:48.575409 (Thread-708): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724bbf820>]}
2021-05-15 11:19:48.576002 (Thread-708): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:19:48.576184 (Thread-706): Parsing macros/schema_tests/at_least_one.sql
2021-05-15 11:19:48.579577 (Thread-706): Parsing macros/schema_tests/equality.sql
2021-05-15 11:19:48.585067 (Thread-706): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-15 11:19:48.594828 (Thread-706): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-15 11:19:48.598346 (Thread-706): Parsing macros/schema_tests/test_unique_where.sql
2021-05-15 11:19:48.601965 (Thread-706): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-15 11:19:48.609493 (Thread-706): Parsing macros/schema_tests/relationships_where.sql
2021-05-15 11:19:48.613555 (Thread-706): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-15 11:19:48.617919 (Thread-706): Parsing macros/schema_tests/recency.sql
2021-05-15 11:19:48.621153 (Thread-706): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-15 11:19:48.624893 (Thread-706): Parsing macros/geo/haversine_distance.sql
2021-05-15 11:19:48.627717 (Thread-706): Parsing macros/cross_db_utils/split_part.sql
2021-05-15 11:19:48.631621 (Thread-706): Parsing macros/cross_db_utils/length.sql
2021-05-15 11:19:48.635154 (Thread-706): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-15 11:19:48.639285 (Thread-709): handling status request
2021-05-15 11:19:48.639788 (Thread-709): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72575df40>]}
2021-05-15 11:19:48.640398 (Thread-709): sending response (<Response 184 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:19:48.641333 (Thread-706): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-15 11:19:48.644444 (Thread-706): Parsing macros/cross_db_utils/right.sql
2021-05-15 11:19:48.648825 (Thread-706): Parsing macros/cross_db_utils/hash.sql
2021-05-15 11:19:48.652421 (Thread-706): Parsing macros/cross_db_utils/replace.sql
2021-05-15 11:19:48.655701 (Thread-706): Parsing macros/cross_db_utils/concat.sql
2021-05-15 11:19:48.664417 (Thread-706): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-15 11:19:48.667574 (Thread-706): Parsing macros/cross_db_utils/identifier.sql
2021-05-15 11:19:48.677007 (Thread-706): Parsing macros/cross_db_utils/datediff.sql
2021-05-15 11:19:48.688482 (Thread-706): Parsing macros/cross_db_utils/dateadd.sql
2021-05-15 11:19:48.692887 (Thread-706): Parsing macros/cross_db_utils/datatypes.sql
2021-05-15 11:19:48.701066 (Thread-706): Parsing macros/cross_db_utils/position.sql
2021-05-15 11:19:48.704704 (Thread-706): Parsing macros/cross_db_utils/literal.sql
2021-05-15 11:19:48.707664 (Thread-706): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-15 11:19:48.711561 (Thread-706): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-15 11:19:48.718896 (Thread-706): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-15 11:19:48.722685 (Thread-706): Parsing macros/cross_db_utils/except.sql
2021-05-15 11:19:48.725766 (Thread-706): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-15 11:19:48.729796 (Thread-706): Parsing macros/cross_db_utils/last_day.sql
2021-05-15 11:19:48.734635 (Thread-706): Parsing macros/cross_db_utils/intersect.sql
2021-05-15 11:19:48.739596 (Thread-706): Parsing macros/get_campaign_group_history_columns.sql
2021-05-15 11:19:48.744330 (Thread-706): Parsing macros/get_campaign_history_columns.sql
2021-05-15 11:19:48.753687 (Thread-706): Parsing macros/get_creative_history_columns.sql
2021-05-15 11:19:48.766878 (Thread-706): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-15 11:19:48.786447 (Thread-706): Parsing macros/get_account_history_columns.sql
2021-05-15 11:19:48.794097 (Thread-706): Parsing macros/get_staging_files.sql
2021-05-15 11:19:48.808046 (Thread-706): Parsing macros/get_campaign_history_columns.sql
2021-05-15 11:19:48.812101 (Thread-706): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-15 11:19:48.826045 (Thread-706): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-15 11:19:48.835785 (Thread-706): Parsing macros/get_ad_group_history_columns.sql
2021-05-15 11:19:48.842388 (Thread-706): Parsing macros/get_campaign_history_columns.sql
2021-05-15 11:19:48.851301 (Thread-706): Parsing macros/get_ad_set_history_columns.sql
2021-05-15 11:19:48.871239 (Thread-706): Parsing macros/get_creative_history_columns.sql
2021-05-15 11:19:48.887566 (Thread-706): Parsing macros/get_basic_ad_columns.sql
2021-05-15 11:19:48.893423 (Thread-706): Parsing macros/get_ad_history_columns.sql
2021-05-15 11:19:48.901578 (Thread-706): Parsing macros/get_account_history_columns.sql
2021-05-15 11:19:48.922465 (Thread-706): Parsing macros/get_date_dimension.sql
2021-05-15 11:19:48.935764 (Thread-706): Parsing macros/get_base_dates.sql
2021-05-15 11:19:48.939769 (Thread-706): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-15 11:19:48.943048 (Thread-706): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-15 11:19:48.946673 (Thread-706): Parsing macros/calendar_date/yesterday.sql
2021-05-15 11:19:48.949588 (Thread-706): Parsing macros/calendar_date/month_name.sql
2021-05-15 11:19:48.953894 (Thread-706): Parsing macros/calendar_date/day_name.sql
2021-05-15 11:19:48.958032 (Thread-706): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-15 11:19:48.961019 (Thread-706): Parsing macros/calendar_date/date_part.sql
2021-05-15 11:19:48.965043 (Thread-706): Parsing macros/calendar_date/n_days_ago.sql
2021-05-15 11:19:48.968083 (Thread-706): Parsing macros/calendar_date/now.sql
2021-05-15 11:19:48.970941 (Thread-706): Parsing macros/calendar_date/n_months_ago.sql
2021-05-15 11:19:48.973832 (Thread-706): Parsing macros/calendar_date/this_week.sql
2021-05-15 11:19:48.976547 (Thread-706): Parsing macros/calendar_date/convert_timezone.sql
2021-05-15 11:19:48.981308 (Thread-706): Parsing macros/calendar_date/periods_since.sql
2021-05-15 11:19:48.984140 (Thread-706): Parsing macros/calendar_date/n_months_away.sql
2021-05-15 11:19:48.987122 (Thread-706): Parsing macros/calendar_date/n_days_away.sql
2021-05-15 11:19:48.990014 (Thread-706): Parsing macros/calendar_date/last_week.sql
2021-05-15 11:19:48.992865 (Thread-706): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-15 11:19:48.995964 (Thread-706): Parsing macros/calendar_date/tomorrow.sql
2021-05-15 11:19:48.998766 (Thread-706): Parsing macros/calendar_date/today.sql
2021-05-15 11:19:49.001542 (Thread-706): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-15 11:19:49.005519 (Thread-706): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-15 11:19:49.013285 (Thread-706): Parsing macros/enabled_vars_one_true.sql
2021-05-15 11:19:49.017159 (Thread-706): Parsing macros/dummy_coalesce_value.sql
2021-05-15 11:19:49.022837 (Thread-706): Parsing macros/enabled_vars.sql
2021-05-15 11:19:49.026070 (Thread-706): Parsing macros/_get_utils_namespaces.sql
2021-05-15 11:19:49.029366 (Thread-706): Parsing macros/remove_prefix_from_columns.sql
2021-05-15 11:19:49.033030 (Thread-706): Parsing macros/first_value.sql
2021-05-15 11:19:49.037568 (Thread-706): Parsing macros/json_extract.sql
2021-05-15 11:19:49.041876 (Thread-706): Parsing macros/generate_columns_macro.sql
2021-05-15 11:19:49.047514 (Thread-706): Parsing macros/timestamp_diff.sql
2021-05-15 11:19:49.059524 (Thread-706): Parsing macros/timestamp_add.sql
2021-05-15 11:19:49.064780 (Thread-706): Parsing macros/staging_models_automation.sql
2021-05-15 11:19:49.069276 (Thread-706): Parsing macros/snowflake_seed_data.sql
2021-05-15 11:19:49.072406 (Thread-706): Parsing macros/fill_staging_columns.sql
2021-05-15 11:19:49.081401 (Thread-706): Parsing macros/percentile.sql
2021-05-15 11:19:49.087284 (Thread-706): Parsing macros/ceiling.sql
2021-05-15 11:19:49.091529 (Thread-706): Parsing macros/get_columns_for_macro.sql
2021-05-15 11:19:49.097873 (Thread-706): Parsing macros/add_pass_through_columns.sql
2021-05-15 11:19:49.101399 (Thread-706): Parsing macros/pivot_json_extract.sql
2021-05-15 11:19:49.104622 (Thread-706): Parsing macros/string_agg.sql
2021-05-15 11:19:49.108681 (Thread-706): Parsing macros/array_agg.sql
2021-05-15 11:19:49.112686 (Thread-706): Parsing macros/fill_pass_through_columns.sql
2021-05-15 11:19:49.116421 (Thread-706): Parsing macros/empty_variable_warning.sql
2021-05-15 11:19:49.119654 (Thread-706): Parsing macros/seed_data_helper.sql
2021-05-15 11:19:49.123236 (Thread-706): Parsing macros/union_relations.sql
2021-05-15 11:19:49.134411 (Thread-706): Parsing macros/max_bool.sql
2021-05-15 11:19:49.191400 (Thread-706): For key DBTTest, hash mismatch (FileHash(name='sha256', checksum='aaeb59bbd1d8e8e03e83f69353e452b117dc6682d414e8391034b4fcec51a9a9') -> FileHash(name='sha256', checksum='5742420359b7d3ccfca60917f0b0c72e665554ceea462cbe80f51737a8fb3603')), cache invalidated
2021-05-15 11:19:49.234166 (Thread-706): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-15 11:19:49.247918 (Thread-706): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-15 11:19:49.260545 (Thread-706): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-15 11:19:49.272694 (Thread-706): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-15 11:19:49.285176 (Thread-706): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-15 11:19:49.297796 (Thread-706): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-15 11:19:49.310527 (Thread-706): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 11:19:49.322672 (Thread-706): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-15 11:19:49.340450 (Thread-706): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-15 11:19:49.714314 (Thread-706): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-15 11:19:49.732477 (Thread-706): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-15 11:19:49.758889 (Thread-706): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-15 11:19:49.778501 (Thread-706): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-15 11:19:49.795188 (Thread-706): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-15 11:19:49.812229 (Thread-706): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-15 11:19:50.081782 (Thread-706): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-15 11:19:50.096821 (Thread-706): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-15 11:19:50.112012 (Thread-706): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-15 11:19:50.112842 (Thread-710): handling status request
2021-05-15 11:19:50.124139 (Thread-710): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725a3cca0>]}
2021-05-15 11:19:50.124866 (Thread-710): sending response (<Response 184 bytes [200 OK]>) to 10.0.19.219
2021-05-15 11:19:50.156657 (Thread-711): handling status request
2021-05-15 11:19:50.167321 (Thread-711): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7258225e0>]}
2021-05-15 11:19:50.178494 (Thread-711): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.122
2021-05-15 11:19:50.195549 (Thread-712): handling status request
2021-05-15 11:19:50.206188 (Thread-712): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72529b490>]}
2021-05-15 11:19:50.211887 (Thread-712): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:19:50.220542 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 11:19:50.236406 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 11:19:50.251408 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 11:19:50.266342 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 11:19:50.282242 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 11:19:50.296666 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 11:19:50.312412 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 11:19:50.327861 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 11:19:50.342432 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 11:19:50.356883 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 11:19:50.371275 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 11:19:50.386800 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 11:19:50.401163 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-15 11:19:50.414018 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 11:19:50.430633 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 11:19:50.446234 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 11:19:50.462069 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 11:19:50.478467 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 11:19:50.493006 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 11:19:50.659090 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-15 11:19:50.675034 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-15 11:19:50.692477 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-15 11:19:50.710478 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-15 11:19:50.725597 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-15 11:19:50.746947 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-15 11:19:50.763406 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-15 11:19:50.777101 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-15 11:19:50.790378 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-15 11:19:50.803567 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-15 11:19:50.816938 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-15 11:19:50.830721 (Thread-706): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-15 11:19:51.122377 (Thread-706): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-15 11:19:51.138119 (Thread-706): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-15 11:19:51.163255 (Thread-706): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-15 11:19:51.656761 (Thread-713): handling status request
2021-05-15 11:19:51.657174 (Thread-713): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7265f8550>]}
2021-05-15 11:19:51.657897 (Thread-713): sending response (<Response 184 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:19:51.664565 (Thread-706): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-15 11:19:51.673918 (Thread-714): handling status request
2021-05-15 11:19:51.674241 (Thread-714): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7253ab5b0>]}
2021-05-15 11:19:51.674817 (Thread-714): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:19:51.679870 (Thread-706): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-15 11:19:51.695254 (Thread-706): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-15 11:19:51.708534 (Thread-715): handling status request
2021-05-15 11:19:51.708854 (Thread-715): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725a8d3d0>]}
2021-05-15 11:19:51.709437 (Thread-715): sending response (<Response 184 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:19:51.714251 (Thread-706): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-15 11:19:51.918639 (Thread-706): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-15 11:19:51.940285 (Thread-706): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-15 11:19:51.962596 (Thread-706): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-15 11:19:51.984662 (Thread-706): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-15 11:19:52.021067 (Thread-706): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-15 11:19:52.051380 (Thread-706): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-15 11:19:52.066682 (Thread-706): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-15 11:19:52.082820 (Thread-706): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-15 11:19:52.098536 (Thread-706): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-15 11:19:52.115724 (Thread-706): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-15 11:19:52.607670 (Thread-706): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-15 11:19:52.623828 (Thread-706): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-15 11:19:52.640208 (Thread-706): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-15 11:19:52.657331 (Thread-706): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-15 11:19:52.676502 (Thread-706): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-15 11:19:52.693064 (Thread-706): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-15 11:19:52.709535 (Thread-706): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-15 11:19:52.799339 (Thread-706): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-15 11:19:52.814596 (Thread-706): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-15 11:19:52.834742 (Thread-706): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-15 11:19:52.850041 (Thread-706): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-15 11:19:52.866444 (Thread-706): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-15 11:19:52.882020 (Thread-706): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-15 11:19:53.117703 (Thread-706): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-15 11:19:53.136311 (Thread-706): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-15 11:19:53.162087 (Thread-706): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-15 11:19:53.187411 (Thread-706): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-15 11:19:53.205182 (Thread-706): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-15 11:19:53.220872 (Thread-706): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-15 11:19:53.236483 (Thread-706): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-15 11:19:53.252643 (Thread-706): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-15 11:19:53.779910 (Thread-706): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-15 11:19:53.794154 (Thread-706): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-15 11:19:53.808559 (Thread-706): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-15 11:19:53.835161 (Thread-706): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-15 11:19:53.851563 (Thread-706): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-15 11:19:53.984196 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-15 11:19:54.002341 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-15 11:19:54.021775 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-15 11:19:54.048636 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-15 11:19:54.074076 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-15 11:19:54.101234 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-15 11:19:54.120538 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-15 11:19:54.136326 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-15 11:19:54.152132 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-15 11:19:54.167841 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-15 11:19:54.184837 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-15 11:19:54.200405 (Thread-706): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-15 11:19:54.451880 (Thread-706): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-15 11:19:54.467819 (Thread-706): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-15 11:19:54.483596 (Thread-706): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-15 11:19:54.508170 (Thread-706): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-15 11:19:54.523728 (Thread-706): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-15 11:19:54.771907 (Thread-716): handling status request
2021-05-15 11:19:54.790306 (Thread-716): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72524b160>]}
2021-05-15 11:19:54.791031 (Thread-716): sending response (<Response 184 bytes [200 OK]>) to 10.0.17.122
2021-05-15 11:19:54.797811 (Thread-706): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-15 11:19:54.806959 (Thread-717): handling status request
2021-05-15 11:19:54.807552 (Thread-717): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724deac10>]}
2021-05-15 11:19:54.807972 (Thread-718): handling status request
2021-05-15 11:19:54.808621 (Thread-717): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.42
2021-05-15 11:19:54.809271 (Thread-718): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724dea370>]}
2021-05-15 11:19:54.809896 (Thread-718): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:19:54.813914 (Thread-706): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-15 11:19:54.837671 (Thread-706): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-15 11:19:54.851679 (Thread-706): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-15 11:19:54.966957 (Thread-706): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-15 11:19:54.982521 (Thread-706): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-15 11:19:54.998836 (Thread-706): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-15 11:19:55.426065 (Thread-706): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:19:55.731313 (Thread-706): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.sources
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.marts
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-15 11:19:57.082246 (Thread-719): handling status request
2021-05-15 11:19:57.082681 (Thread-719): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724e171f0>]}
2021-05-15 11:19:57.103478 (Thread-719): sending response (<Response 82949 bytes [200 OK]>) to 10.0.1.135
2021-05-15 11:19:57.112826 (Thread-720): handling status request
2021-05-15 11:19:57.113103 (Thread-720): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72516e490>]}
2021-05-15 11:19:57.132963 (Thread-720): sending response (<Response 82949 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:19:57.133895 (Thread-721): handling status request
2021-05-15 11:19:57.134316 (Thread-721): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725007ac0>]}
2021-05-15 11:19:57.155384 (Thread-721): sending response (<Response 82949 bytes [200 OK]>) to 10.0.19.219
2021-05-15 11:20:43.746525 (Thread-722): handling status request
2021-05-15 11:20:43.746953 (Thread-722): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725007b80>]}
2021-05-15 11:20:43.769625 (Thread-722): sending response (<Response 82949 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:20:44.049155 (Thread-723): handling status request
2021-05-15 11:20:44.049568 (Thread-723): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72489c730>]}
2021-05-15 11:20:44.070304 (Thread-723): sending response (<Response 82949 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:20:44.235170 (Thread-724): handling cli_args request
2021-05-15 11:20:44.235551 (Thread-724): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb73560b4c0>]}
2021-05-15 11:20:44.248578 (Thread-724): sending response (<Response 304 bytes [200 OK]>) to 10.0.17.122
2021-05-15 11:20:48.470347 (Thread-725): handling status request
2021-05-15 11:20:48.471019 (Thread-725): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724f29820>]}
2021-05-15 11:20:48.481771 (Thread-726): handling status request
2021-05-15 11:20:48.493139 (Thread-725): sending response (<Response 82949 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:20:48.493295 (Thread-726): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724f31370>]}
2021-05-15 11:20:48.514535 (Thread-726): sending response (<Response 82949 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:20:48.525033 (Thread-727): handling status request
2021-05-15 11:20:48.529668 (Thread-727): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724b208b0>]}
2021-05-15 11:20:48.549707 (Thread-727): sending response (<Response 82949 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:21:39.292163 (Thread-728): handling status request
2021-05-15 11:21:39.292597 (Thread-728): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735dba6d0>]}
2021-05-15 11:21:39.313239 (Thread-728): sending response (<Response 82949 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:21:39.552999 (Thread-729): handling status request
2021-05-15 11:21:39.553394 (Thread-729): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724db27f0>]}
2021-05-15 11:21:39.574081 (Thread-729): sending response (<Response 82949 bytes [200 OK]>) to 10.0.31.167
2021-05-15 11:21:39.803155 (Thread-730): handling cli_args request
2021-05-15 11:21:39.803576 (Thread-730): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724807850>]}
2021-05-15 11:21:39.813550 (Thread-730): sending response (<Response 306 bytes [200 OK]>) to 10.0.46.218
2021-05-15 11:21:44.882386 (Thread-731): handling status request
2021-05-15 11:21:44.882817 (Thread-731): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724db27f0>]}
2021-05-15 11:21:44.910290 (Thread-731): sending response (<Response 82949 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:21:44.935286 (Thread-732): handling status request
2021-05-15 11:21:44.935769 (Thread-732): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72516fc70>]}
2021-05-15 11:21:44.936303 (Thread-733): handling status request
2021-05-15 11:21:44.957955 (Thread-732): sending response (<Response 82949 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:21:44.958099 (Thread-733): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7244d4dc0>]}
2021-05-15 11:21:44.981940 (Thread-733): sending response (<Response 82949 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:22:53.417835 (Thread-734): handling status request
2021-05-15 11:22:53.419879 (Thread-734): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724d9f160>]}
2021-05-15 11:22:53.440464 (Thread-734): sending response (<Response 82949 bytes [200 OK]>) to 10.0.31.167
2021-05-15 11:22:53.799109 (Thread-735): handling status request
2021-05-15 11:22:53.799601 (Thread-735): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb726105580>]}
2021-05-15 11:22:53.820119 (Thread-735): sending response (<Response 82949 bytes [200 OK]>) to 10.0.15.49
2021-05-15 11:22:53.989910 (Thread-736): handling cli_args request
2021-05-15 11:22:53.990349 (Thread-736): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72516f370>]}
2021-05-15 11:22:54.113836 (Thread-736): Connection 'model.dbt_date.dates' was properly closed.
2021-05-15 11:22:55.132000 (Thread-736): sending response (<Response 137 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:22:55.662976 (MainThread): Partial parsing not enabled
2021-05-15 11:22:55.667304 (MainThread): Parsing macros/metrics.sql
2021-05-15 11:22:55.678357 (MainThread): Parsing macros/generate_custom_schema_name.sql
2021-05-15 11:22:55.683047 (Thread-737): handling poll request
2021-05-15 11:22:55.683451 (Thread-737): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724b6fbb0>]}
2021-05-15 11:22:55.685088 (Thread-737): sending response (<Response 1107 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:22:55.681549 (MainThread): Parsing macros/datatype_conversion.sql
2021-05-15 11:22:55.685750 (MainThread): Parsing macros/adapters.sql
2021-05-15 11:22:55.713783 (MainThread): Parsing macros/catalog.sql
2021-05-15 11:22:55.715798 (MainThread): Parsing macros/materializations/table.sql
2021-05-15 11:22:55.719642 (MainThread): Parsing macros/materializations/merge.sql
2021-05-15 11:22:55.721636 (MainThread): Parsing macros/materializations/incremental.sql
2021-05-15 11:22:55.730607 (MainThread): Parsing macros/materializations/view.sql
2021-05-15 11:22:55.732785 (MainThread): Parsing macros/core.sql
2021-05-15 11:22:55.736373 (MainThread): Parsing macros/materializations/helpers.sql
2021-05-15 11:22:55.745061 (MainThread): Parsing macros/materializations/common/merge.sql
2021-05-15 11:22:55.759029 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-15 11:22:55.760796 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-05-15 11:22:55.776921 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-15 11:22:55.804337 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-15 11:22:55.809199 (MainThread): Parsing macros/materializations/view/view.sql
2021-05-15 11:22:55.815331 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-05-15 11:22:55.835402 (MainThread): Parsing macros/materializations/table/table.sql
2021-05-15 11:22:55.841839 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-05-15 11:22:55.843685 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-05-15 11:22:55.849558 (MainThread): Parsing macros/etc/is_incremental.sql
2021-05-15 11:22:55.851177 (MainThread): Parsing macros/etc/query.sql
2021-05-15 11:22:55.852262 (MainThread): Parsing macros/etc/datetime.sql
2021-05-15 11:22:55.860874 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-05-15 11:22:55.861852 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-05-15 11:22:55.863546 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-05-15 11:22:55.865503 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-05-15 11:22:55.867083 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-05-15 11:22:55.869753 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-05-15 11:22:55.871659 (MainThread): Parsing macros/schema_tests/unique.sql
2021-05-15 11:22:55.873424 (MainThread): Parsing macros/adapters/common.sql
2021-05-15 11:22:55.919768 (MainThread): Parsing macros/staging_columns.sql
2021-05-15 11:22:55.937596 (MainThread): Parsing macros/staging_columns.sql
2021-05-15 11:22:55.983263 (MainThread): Parsing macros/logger/pretty_time.sql
2021-05-15 11:22:55.986060 (MainThread): Parsing macros/logger/log_info.sql
2021-05-15 11:22:55.989098 (MainThread): Parsing macros/logger/pretty_log_format.sql
2021-05-15 11:22:55.992316 (MainThread): Parsing macros/sql/pivot.sql
2021-05-15 11:22:55.997618 (MainThread): Parsing macros/sql/star.sql
2021-05-15 11:22:56.002845 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-05-15 11:22:56.007935 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-15 11:22:56.012361 (MainThread): Parsing macros/sql/get_column_values.sql
2021-05-15 11:22:56.018303 (MainThread): Parsing macros/sql/groupby.sql
2021-05-15 11:22:56.021645 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-15 11:22:56.030280 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-05-15 11:22:56.033866 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-15 11:22:56.037004 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-15 11:22:56.041768 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-15 11:22:56.046450 (MainThread): Parsing macros/sql/safe_add.sql
2021-05-15 11:22:56.049723 (MainThread): Parsing macros/sql/unpivot.sql
2021-05-15 11:22:56.058250 (MainThread): Parsing macros/sql/generate_series.sql
2021-05-15 11:22:56.063848 (MainThread): Parsing macros/sql/nullcheck.sql
2021-05-15 11:22:56.066972 (MainThread): Parsing macros/sql/union.sql
2021-05-15 11:22:56.076837 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-15 11:22:56.101862 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-05-15 11:22:56.105061 (MainThread): Parsing macros/web/get_url_path.sql
2021-05-15 11:22:56.109640 (MainThread): Parsing macros/web/get_url_host.sql
2021-05-15 11:22:56.113508 (MainThread): Parsing macros/datetime/date_spine.sql
2021-05-15 11:22:56.118920 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-05-15 11:22:56.122213 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-05-15 11:22:56.125544 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-05-15 11:22:56.128852 (MainThread): Parsing macros/schema_tests/equality.sql
2021-05-15 11:22:56.134343 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-15 11:22:56.138495 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-15 11:22:56.142310 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-05-15 11:22:56.146206 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-15 11:22:56.153843 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-05-15 11:22:56.157803 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-15 11:22:56.163349 (MainThread): Parsing macros/schema_tests/recency.sql
2021-05-15 11:22:56.166928 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-15 11:22:56.170846 (MainThread): Parsing macros/geo/haversine_distance.sql
2021-05-15 11:22:56.174402 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-05-15 11:22:56.178315 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-05-15 11:22:56.181735 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-15 11:22:56.187293 (MainThread): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-15 11:22:56.190643 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-05-15 11:22:56.195058 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-05-15 11:22:56.198577 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-05-15 11:22:56.202200 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-05-15 11:22:56.206565 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-15 11:22:56.209658 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-05-15 11:22:56.213592 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-05-15 11:22:56.225846 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-05-15 11:22:56.231015 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-05-15 11:22:56.239929 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-05-15 11:22:56.243616 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-05-15 11:22:56.247095 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-15 11:22:56.251348 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-15 11:22:56.259137 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-15 11:22:56.263444 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-05-15 11:22:56.267422 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-15 11:22:56.271965 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-05-15 11:22:56.277383 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-05-15 11:22:56.283685 (MainThread): Parsing macros/get_campaign_group_history_columns.sql
2021-05-15 11:22:56.288909 (MainThread): Parsing macros/get_campaign_history_columns.sql
2021-05-15 11:22:56.298296 (MainThread): Parsing macros/get_creative_history_columns.sql
2021-05-15 11:22:56.312711 (MainThread): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-15 11:22:56.333658 (MainThread): Parsing macros/get_account_history_columns.sql
2021-05-15 11:22:56.342430 (MainThread): Parsing macros/get_staging_files.sql
2021-05-15 11:22:56.349743 (MainThread): Parsing macros/get_campaign_history_columns.sql
2021-05-15 11:22:56.354315 (MainThread): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-15 11:22:56.367635 (MainThread): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-15 11:22:56.374253 (MainThread): Parsing macros/get_ad_group_history_columns.sql
2021-05-15 11:22:56.380958 (MainThread): Parsing macros/get_campaign_history_columns.sql
2021-05-15 11:22:56.388005 (MainThread): Parsing macros/get_ad_set_history_columns.sql
2021-05-15 11:22:56.408195 (MainThread): Parsing macros/get_creative_history_columns.sql
2021-05-15 11:22:56.424682 (MainThread): Parsing macros/get_basic_ad_columns.sql
2021-05-15 11:22:56.430848 (MainThread): Parsing macros/get_ad_history_columns.sql
2021-05-15 11:22:56.439263 (MainThread): Parsing macros/get_account_history_columns.sql
2021-05-15 11:22:56.465048 (MainThread): Parsing macros/get_date_dimension.sql
2021-05-15 11:22:56.478147 (MainThread): Parsing macros/get_base_dates.sql
2021-05-15 11:22:56.482462 (MainThread): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-15 11:22:56.485831 (MainThread): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-15 11:22:56.489458 (MainThread): Parsing macros/calendar_date/yesterday.sql
2021-05-15 11:22:56.492266 (MainThread): Parsing macros/calendar_date/month_name.sql
2021-05-15 11:22:56.496318 (MainThread): Parsing macros/calendar_date/day_name.sql
2021-05-15 11:22:56.500845 (MainThread): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-15 11:22:56.503612 (MainThread): Parsing macros/calendar_date/date_part.sql
2021-05-15 11:22:56.507441 (MainThread): Parsing macros/calendar_date/n_days_ago.sql
2021-05-15 11:22:56.511056 (MainThread): Parsing macros/calendar_date/now.sql
2021-05-15 11:22:56.513735 (MainThread): Parsing macros/calendar_date/n_months_ago.sql
2021-05-15 11:22:56.517031 (MainThread): Parsing macros/calendar_date/this_week.sql
2021-05-15 11:22:56.519828 (MainThread): Parsing macros/calendar_date/convert_timezone.sql
2021-05-15 11:22:56.524641 (MainThread): Parsing macros/calendar_date/periods_since.sql
2021-05-15 11:22:56.527598 (MainThread): Parsing macros/calendar_date/n_months_away.sql
2021-05-15 11:22:56.530671 (MainThread): Parsing macros/calendar_date/n_days_away.sql
2021-05-15 11:22:56.533810 (MainThread): Parsing macros/calendar_date/last_week.sql
2021-05-15 11:22:56.537128 (MainThread): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-15 11:22:56.542300 (MainThread): Parsing macros/calendar_date/tomorrow.sql
2021-05-15 11:22:56.545832 (MainThread): Parsing macros/calendar_date/today.sql
2021-05-15 11:22:56.548948 (MainThread): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-15 11:22:56.553538 (MainThread): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-15 11:22:56.562114 (MainThread): Parsing macros/enabled_vars_one_true.sql
2021-05-15 11:22:56.565293 (MainThread): Parsing macros/dummy_coalesce_value.sql
2021-05-15 11:22:56.571281 (MainThread): Parsing macros/enabled_vars.sql
2021-05-15 11:22:56.574726 (MainThread): Parsing macros/_get_utils_namespaces.sql
2021-05-15 11:22:56.578334 (MainThread): Parsing macros/remove_prefix_from_columns.sql
2021-05-15 11:22:56.582362 (MainThread): Parsing macros/first_value.sql
2021-05-15 11:22:56.587051 (MainThread): Parsing macros/json_extract.sql
2021-05-15 11:22:56.591764 (MainThread): Parsing macros/generate_columns_macro.sql
2021-05-15 11:22:56.597870 (MainThread): Parsing macros/timestamp_diff.sql
2021-05-15 11:22:56.609837 (MainThread): Parsing macros/timestamp_add.sql
2021-05-15 11:22:56.615062 (MainThread): Parsing macros/staging_models_automation.sql
2021-05-15 11:22:56.619682 (MainThread): Parsing macros/snowflake_seed_data.sql
2021-05-15 11:22:56.623219 (MainThread): Parsing macros/fill_staging_columns.sql
2021-05-15 11:22:56.630026 (MainThread): Parsing macros/percentile.sql
2021-05-15 11:22:56.634342 (MainThread): Parsing macros/ceiling.sql
2021-05-15 11:22:56.637718 (MainThread): Parsing macros/get_columns_for_macro.sql
2021-05-15 11:22:56.643682 (MainThread): Parsing macros/add_pass_through_columns.sql
2021-05-15 11:22:56.647184 (MainThread): Parsing macros/pivot_json_extract.sql
2021-05-15 11:22:56.651004 (MainThread): Parsing macros/string_agg.sql
2021-05-15 11:22:56.655114 (MainThread): Parsing macros/array_agg.sql
2021-05-15 11:22:56.658608 (MainThread): Parsing macros/fill_pass_through_columns.sql
2021-05-15 11:22:56.663024 (MainThread): Parsing macros/empty_variable_warning.sql
2021-05-15 11:22:56.666717 (MainThread): Parsing macros/seed_data_helper.sql
2021-05-15 11:22:56.670454 (MainThread): Parsing macros/union_relations.sql
2021-05-15 11:22:56.682275 (MainThread): Parsing macros/max_bool.sql
2021-05-15 11:22:56.730413 (MainThread): Partial parsing not enabled
2021-05-15 11:22:56.831428 (MainThread): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-15 11:22:56.867791 (MainThread): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-15 11:22:56.881066 (MainThread): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-15 11:22:56.893908 (MainThread): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-15 11:22:56.906343 (MainThread): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-15 11:22:56.918954 (MainThread): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-15 11:22:56.931535 (MainThread): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 11:22:56.951364 (MainThread): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-15 11:22:56.986049 (MainThread): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-15 11:22:57.191251 (MainThread): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-15 11:22:57.231486 (MainThread): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-15 11:22:57.242798 (Thread-738): handling poll request
2021-05-15 11:22:57.243193 (Thread-738): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724a2c520>]}
2021-05-15 11:22:57.256675 (Thread-738): sending response (<Response 46771 bytes [200 OK]>) to 10.0.1.135
2021-05-15 11:22:57.300384 (MainThread): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-15 11:22:57.327379 (MainThread): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-15 11:22:57.342360 (MainThread): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-15 11:22:57.357181 (MainThread): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-15 11:22:57.632394 (MainThread): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-15 11:22:57.647487 (MainThread): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-15 11:22:57.663665 (MainThread): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-15 11:22:57.756485 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 11:22:57.771876 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 11:22:57.786255 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 11:22:57.801085 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 11:22:57.815447 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 11:22:57.829822 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 11:22:57.844036 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 11:22:57.914605 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 11:22:57.929235 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 11:22:57.943495 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 11:22:57.958721 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 11:22:57.973044 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 11:22:57.987447 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-15 11:22:58.006247 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 11:22:58.022529 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 11:22:58.039576 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 11:22:58.066768 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 11:22:58.083689 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 11:22:58.098944 (MainThread): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 11:22:58.248644 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-15 11:22:58.272075 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-15 11:22:58.298228 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-15 11:22:58.326844 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-15 11:22:58.346984 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-15 11:22:58.372720 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-15 11:22:58.394846 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-15 11:22:58.407750 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-15 11:22:58.420639 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-15 11:22:58.433487 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-15 11:22:58.447058 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-15 11:22:58.460055 (MainThread): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-15 11:22:58.767597 (MainThread): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-15 11:22:58.782943 (MainThread): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-15 11:22:58.806886 (MainThread): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-15 11:22:59.043232 (MainThread): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-15 11:22:59.057625 (MainThread): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-15 11:22:59.071164 (MainThread): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-15 11:22:59.085373 (MainThread): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-15 11:22:59.315019 (MainThread): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-15 11:22:59.339443 (Thread-739): handling poll request
2021-05-15 11:22:59.339855 (Thread-739): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72474cc40>]}
2021-05-15 11:22:59.344211 (Thread-739): sending response (<Response 15743 bytes [200 OK]>) to 10.0.36.138
2021-05-15 11:22:59.346984 (MainThread): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-15 11:22:59.369757 (MainThread): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-15 11:22:59.396061 (MainThread): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-15 11:22:59.442553 (MainThread): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-15 11:22:59.498443 (MainThread): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-15 11:22:59.512439 (MainThread): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-15 11:22:59.527205 (MainThread): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-15 11:22:59.541504 (MainThread): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-15 11:22:59.555967 (MainThread): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-15 11:22:59.977387 (MainThread): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-15 11:22:59.993411 (MainThread): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-15 11:23:00.009962 (MainThread): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-15 11:23:00.025351 (MainThread): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-15 11:23:00.062765 (MainThread): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-15 11:23:00.078294 (MainThread): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-15 11:23:00.093963 (MainThread): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-15 11:23:00.235954 (MainThread): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-15 11:23:00.252915 (MainThread): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-15 11:23:00.272719 (MainThread): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-15 11:23:00.286788 (MainThread): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-15 11:23:00.301914 (MainThread): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-15 11:23:00.316563 (MainThread): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-15 11:23:00.526681 (MainThread): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-15 11:23:00.549070 (MainThread): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-15 11:23:00.580994 (MainThread): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-15 11:23:00.623967 (MainThread): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-15 11:23:00.644849 (MainThread): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-15 11:23:00.660233 (MainThread): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-15 11:23:00.675273 (MainThread): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-15 11:23:00.690096 (MainThread): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-15 11:23:00.815174 (Thread-740): handling poll request
2021-05-15 11:23:00.815584 (Thread-740): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72561d3a0>]}
2021-05-15 11:23:00.818900 (Thread-740): sending response (<Response 10087 bytes [200 OK]>) to 10.0.31.167
2021-05-15 11:23:01.003379 (MainThread): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-15 11:23:01.017862 (MainThread): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-15 11:23:01.031649 (MainThread): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-15 11:23:01.057970 (MainThread): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-15 11:23:01.072174 (MainThread): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-15 11:23:01.191146 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-15 11:23:01.215938 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-15 11:23:01.245770 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-15 11:23:01.295933 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-15 11:23:01.341857 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-15 11:23:01.398895 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-15 11:23:01.431858 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-15 11:23:01.447054 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-15 11:23:01.462619 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-15 11:23:01.477676 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-15 11:23:01.492872 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-15 11:23:01.507538 (MainThread): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-15 11:23:01.802557 (MainThread): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-15 11:23:01.818217 (MainThread): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-15 11:23:01.833980 (MainThread): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-15 11:23:01.855213 (MainThread): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-15 11:23:01.869981 (MainThread): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-15 11:23:02.116196 (MainThread): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-15 11:23:02.130156 (MainThread): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-15 11:23:02.150502 (MainThread): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-15 11:23:02.164124 (MainThread): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-15 11:23:02.337670 (MainThread): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-15 11:23:02.347277 (Thread-741): handling poll request
2021-05-15 11:23:02.347675 (Thread-741): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724a02ca0>]}
2021-05-15 11:23:02.350592 (Thread-741): sending response (<Response 9190 bytes [200 OK]>) to 10.0.40.42
2021-05-15 11:23:02.367203 (MainThread): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-15 11:23:02.383429 (MainThread): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-15 11:23:02.625437 (MainThread): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 11:23:02.882525 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.sources
- models.DBTTest.Stage_Layer
- models.DBTTest.utils
- models.DBTTest.Views
- models.DBTTest.Targets
- models.DBTTest.marts
- seeds.DBTTest

2021-05-15 11:23:03.226540 (MainThread): Found 99 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 11:23:03.237449 (MainThread): 
2021-05-15 11:23:03.237756 (MainThread): Acquiring new snowflake connection "master".
2021-05-15 11:23:03.241401 (ThreadPoolExecutor-0_0): Acquiring new snowflake connection "list_DATAFLOTEST_DATABASE".
2021-05-15 11:23:03.250789 (ThreadPoolExecutor-0_0): Using snowflake connection "list_DATAFLOTEST_DATABASE".
2021-05-15 11:23:03.250863 (ThreadPoolExecutor-0_0): On list_DATAFLOTEST_DATABASE: /* {"app": "dbt", "dbt_version": "0.18.1", "profile_name": "user", "target_name": "default", "connection_name": "list_DATAFLOTEST_DATABASE"} */

    show terse schemas in database DATAFLOTEST_DATABASE
    limit 10000
2021-05-15 11:23:03.250921 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-05-15 11:23:03.911450 (ThreadPoolExecutor-0_0): SQL status: SUCCESS 17 in 0.66 seconds
2021-05-15 11:23:03.914555 (ThreadPoolExecutor-0_0): On list_DATAFLOTEST_DATABASE: Close
2021-05-15 11:23:04.154371 (ThreadPoolExecutor-0_0): Acquiring new snowflake connection "create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing".
2021-05-15 11:23:04.154740 (ThreadPoolExecutor-0_0): Acquiring new snowflake connection "create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing".
2021-05-15 11:23:04.155022 (ThreadPoolExecutor-0_0): Creating schema "DATAFLOTEST_DATABASE.dbt_test_UAT_Testing"
2021-05-15 11:23:04.161620 (ThreadPoolExecutor-0_0): Using snowflake connection "create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing".
2021-05-15 11:23:04.161707 (ThreadPoolExecutor-0_0): On create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing: BEGIN
2021-05-15 11:23:04.161769 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state closed
2021-05-15 11:23:04.438219 (Thread-742): handling poll request
2021-05-15 11:23:04.438632 (Thread-742): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724a2e820>]}
2021-05-15 11:23:04.440912 (Thread-742): sending response (<Response 6579 bytes [200 OK]>) to 10.0.4.10
2021-05-15 11:23:05.229442 (ThreadPoolExecutor-0_0): SQL status: SUCCESS 1 in 1.07 seconds
2021-05-15 11:23:05.229612 (ThreadPoolExecutor-0_0): Using snowflake connection "create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing".
2021-05-15 11:23:05.229677 (ThreadPoolExecutor-0_0): On create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing: /* {"app": "dbt", "dbt_version": "0.18.1", "profile_name": "user", "target_name": "default", "connection_name": "create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing"} */
create schema if not exists DATAFLOTEST_DATABASE.dbt_test_UAT_Testing
2021-05-15 11:23:05.399301 (ThreadPoolExecutor-0_0): SQL status: SUCCESS 1 in 0.17 seconds
2021-05-15 11:23:05.402200 (ThreadPoolExecutor-0_0): On create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing: COMMIT
2021-05-15 11:23:05.402337 (ThreadPoolExecutor-0_0): Using snowflake connection "create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing".
2021-05-15 11:23:05.402386 (ThreadPoolExecutor-0_0): On create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing: COMMIT
2021-05-15 11:23:05.469802 (ThreadPoolExecutor-0_0): SQL status: SUCCESS 1 in 0.07 seconds
2021-05-15 11:23:05.469949 (ThreadPoolExecutor-0_0): On create_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing: Close
2021-05-15 11:23:05.763162 (ThreadPoolExecutor-1_0): Acquiring new snowflake connection "list_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing".
2021-05-15 11:23:05.770437 (ThreadPoolExecutor-1_0): Using snowflake connection "list_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing".
2021-05-15 11:23:05.770527 (ThreadPoolExecutor-1_0): On list_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing: /* {"app": "dbt", "dbt_version": "0.18.1", "profile_name": "user", "target_name": "default", "connection_name": "list_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing"} */

    show terse objects in DATAFLOTEST_DATABASE.dbt_test_UAT_Testing
2021-05-15 11:23:05.770586 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-05-15 11:23:05.892855 (Thread-743): handling poll request
2021-05-15 11:23:05.893286 (Thread-743): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724f686a0>]}
2021-05-15 11:23:05.895168 (Thread-743): sending response (<Response 4796 bytes [200 OK]>) to 10.0.15.49
2021-05-15 11:23:06.136550 (ThreadPoolExecutor-1_0): SQL status: SUCCESS 0 in 0.37 seconds
2021-05-15 11:23:06.137000 (ThreadPoolExecutor-1_0): On list_DATAFLOTEST_DATABASE_dbt_test_UAT_Testing: Close
2021-05-15 11:23:06.511014 (ThreadPoolExecutor-1_0): Acquiring new snowflake connection "list_DATAFLOTEST_DATABASE_dbt_test".
2021-05-15 11:23:06.513763 (ThreadPoolExecutor-1_0): Using snowflake connection "list_DATAFLOTEST_DATABASE_dbt_test".
2021-05-15 11:23:06.513863 (ThreadPoolExecutor-1_0): On list_DATAFLOTEST_DATABASE_dbt_test: /* {"app": "dbt", "dbt_version": "0.18.1", "profile_name": "user", "target_name": "default", "connection_name": "list_DATAFLOTEST_DATABASE_dbt_test"} */

    show terse objects in DATAFLOTEST_DATABASE.dbt_test
2021-05-15 11:23:06.513922 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-05-15 11:23:07.119710 (ThreadPoolExecutor-1_0): Snowflake query id: 019c42eb-0000-299a-0000-b149002424d6
2021-05-15 11:23:07.119835 (ThreadPoolExecutor-1_0): Snowflake error: 002043 (02000): SQL compilation error:
Object does not exist, or operation cannot be performed.
2021-05-15 11:23:07.119957 (ThreadPoolExecutor-1_0): Error running SQL: macro list_relations_without_caching
2021-05-15 11:23:07.120001 (ThreadPoolExecutor-1_0): Rolling back transaction.
2021-05-15 11:23:07.120122 (ThreadPoolExecutor-1_0): On list_DATAFLOTEST_DATABASE_dbt_test: Close
2021-05-15 11:23:07.175323 (ThreadPoolExecutor-1_0): Acquiring new snowflake connection "list_DATAFLOTEST_DATABASE_snapshots".
2021-05-15 11:23:07.178043 (ThreadPoolExecutor-1_0): Using snowflake connection "list_DATAFLOTEST_DATABASE_snapshots".
2021-05-15 11:23:07.178142 (ThreadPoolExecutor-1_0): On list_DATAFLOTEST_DATABASE_snapshots: /* {"app": "dbt", "dbt_version": "0.18.1", "profile_name": "user", "target_name": "default", "connection_name": "list_DATAFLOTEST_DATABASE_snapshots"} */

    show terse objects in DATAFLOTEST_DATABASE.snapshots
2021-05-15 11:23:07.178224 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-05-15 11:23:07.362449 (Thread-744): handling poll request
2021-05-15 11:23:07.362861 (Thread-744): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7253cb430>]}
2021-05-15 11:23:07.364907 (Thread-744): sending response (<Response 5325 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:23:07.868155 (ThreadPoolExecutor-1_0): Snowflake query id: 019c42eb-0000-29a2-0000-b1490023fa86
2021-05-15 11:23:07.868289 (ThreadPoolExecutor-1_0): Snowflake error: 002043 (02000): SQL compilation error:
Object does not exist, or operation cannot be performed.
2021-05-15 11:23:07.868402 (ThreadPoolExecutor-1_0): Error running SQL: macro list_relations_without_caching
2021-05-15 11:23:07.868447 (ThreadPoolExecutor-1_0): Rolling back transaction.
2021-05-15 11:23:07.868565 (ThreadPoolExecutor-1_0): On list_DATAFLOTEST_DATABASE_snapshots: Close
2021-05-15 11:23:07.954147 (MainThread): Using snowflake connection "master".
2021-05-15 11:23:07.954274 (MainThread): On master: BEGIN
2021-05-15 11:23:07.954338 (MainThread): Opening a new connection, currently in state init
2021-05-15 11:23:08.479809 (MainThread): SQL status: SUCCESS 1 in 0.53 seconds
2021-05-15 11:23:08.479965 (MainThread): On master: COMMIT
2021-05-15 11:23:08.480061 (MainThread): Using snowflake connection "master".
2021-05-15 11:23:08.480108 (MainThread): On master: COMMIT
2021-05-15 11:23:08.663417 (MainThread): SQL status: SUCCESS 1 in 0.18 seconds
2021-05-15 11:23:08.663584 (MainThread): On master: Close
2021-05-15 11:23:08.757527 (MainThread): 11:23:08 | Concurrency: 1 threads (target='default')
2021-05-15 11:23:08.757660 (MainThread): 11:23:08 | 
2021-05-15 11:23:08.759287 (Thread-1): Began running node model.DBTTest.HS_SF_FACT
2021-05-15 11:23:08.760397 (Thread-1): 11:23:08 | 1 of 3 START table model dbt_test_UAT_Testing.HS_SF_FACT............. [RUN]
2021-05-15 11:23:08.760661 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-15 11:23:08.760759 (Thread-1): Compiling model.DBTTest.HS_SF_FACT
2021-05-15 11:23:08.771646 (Thread-1): Writing injected SQL for node "model.DBTTest.HS_SF_FACT"
2021-05-15 11:23:08.806316 (Thread-1): finished collecting timing info
2021-05-15 11:23:08.835257 (Thread-1): Writing runtime SQL for node "model.DBTTest.HS_SF_FACT"
2021-05-15 11:23:08.879416 (Thread-1): Using snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-15 11:23:08.879545 (Thread-1): On model.DBTTest.HS_SF_FACT: BEGIN
2021-05-15 11:23:08.879611 (Thread-1): Opening a new connection, currently in state closed
2021-05-15 11:23:09.279305 (Thread-1): SQL status: SUCCESS 1 in 0.40 seconds
2021-05-15 11:23:09.279457 (Thread-1): Using snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-15 11:23:09.279508 (Thread-1): On model.DBTTest.HS_SF_FACT: /* {"app": "dbt", "dbt_version": "0.18.1", "profile_name": "user", "target_name": "default", "node_id": "model.DBTTest.HS_SF_FACT"} */


      create or replace transient table DATAFLOTEST_DATABASE.dbt_test_UAT_Testing.HS_SF_FACT  as
      (WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='EMAIL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  --where 1=1
--r_timeframe_type='W'
--  and r_metric_id=66
--  and r_type='Month'
      );
2021-05-15 11:23:09.372943 (Thread-745): handling poll request
2021-05-15 11:23:09.373387 (Thread-745): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725e1c040>]}
2021-05-15 11:23:09.376564 (Thread-745): sending response (<Response 23667 bytes [200 OK]>) to 10.0.45.155
2021-05-15 11:23:10.834946 (Thread-746): handling poll request
2021-05-15 11:23:10.835370 (Thread-746): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724dbc2e0>]}
2021-05-15 11:23:10.836222 (Thread-746): sending response (<Response 309 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:23:12.306263 (Thread-747): handling poll request
2021-05-15 11:23:12.306689 (Thread-747): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724dbc940>]}
2021-05-15 11:23:12.307554 (Thread-747): sending response (<Response 309 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:23:14.320617 (Thread-748): handling poll request
2021-05-15 11:23:14.321237 (Thread-748): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724dbc760>]}
2021-05-15 11:23:14.322111 (Thread-748): sending response (<Response 309 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:23:15.771318 (Thread-749): handling poll request
2021-05-15 11:23:15.771740 (Thread-749): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724dbceb0>]}
2021-05-15 11:23:15.772601 (Thread-749): sending response (<Response 309 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:23:17.379747 (Thread-750): handling poll request
2021-05-15 11:23:17.380216 (Thread-750): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb725e1c160>]}
2021-05-15 11:23:17.381079 (Thread-750): sending response (<Response 308 bytes [200 OK]>) to 10.0.34.201
2021-05-15 11:23:19.359248 (Thread-751): handling poll request
2021-05-15 11:23:19.359666 (Thread-751): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb72578ff40>]}
2021-05-15 11:23:19.360513 (Thread-751): sending response (<Response 309 bytes [200 OK]>) to 10.0.31.167
2021-05-15 11:23:20.375035 (Thread-1): SQL status: SUCCESS 1 in 11.10 seconds
2021-05-15 11:23:20.377788 (Thread-1): On model.DBTTest.HS_SF_FACT: COMMIT
2021-05-15 11:23:20.377923 (Thread-1): Using snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-15 11:23:20.377971 (Thread-1): On model.DBTTest.HS_SF_FACT: COMMIT
2021-05-15 11:23:20.450697 (Thread-1): SQL status: SUCCESS 1 in 0.07 seconds
2021-05-15 11:23:20.461722 (Thread-1): finished collecting timing info
2021-05-15 11:23:20.461948 (Thread-1): On model.DBTTest.HS_SF_FACT: Close
2021-05-15 11:23:20.748874 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7a20166-e5bb-4dd0-9d85-8f351b3b407c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f0582545640>]}
2021-05-15 11:23:20.750316 (Thread-1): 11:23:20 | 1 of 3 OK created table model dbt_test_UAT_Testing.HS_SF_FACT........ [SUCCESS 1 in 11.99s]
2021-05-15 11:23:20.750418 (Thread-1): Finished running node model.DBTTest.HS_SF_FACT
2021-05-15 11:23:20.750528 (Thread-1): Began running node model.DBTTest.SF_HF_segmented
2021-05-15 11:23:20.751337 (Thread-1): 11:23:20 | 2 of 3 START table model dbt_test_UAT_Testing.SF_HF_segmented........ [RUN]
2021-05-15 11:23:20.751553 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 11:23:20.751628 (Thread-1): Compiling model.DBTTest.SF_HF_segmented
2021-05-15 11:23:20.758577 (Thread-1): Writing injected SQL for node "model.DBTTest.SF_HF_segmented"
2021-05-15 11:23:20.788481 (Thread-1): finished collecting timing info
2021-05-15 11:23:20.792706 (Thread-1): Writing runtime SQL for node "model.DBTTest.SF_HF_segmented"
2021-05-15 11:23:20.828924 (Thread-1): Using snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 11:23:20.829015 (Thread-1): On model.DBTTest.SF_HF_segmented: BEGIN
2021-05-15 11:23:20.829077 (Thread-1): Opening a new connection, currently in state closed
2021-05-15 11:23:20.974527 (Thread-752): handling poll request
2021-05-15 11:23:20.974979 (Thread-752): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724f68b20>]}
2021-05-15 11:23:20.977374 (Thread-752): sending response (<Response 7710 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:23:21.509205 (Thread-1): SQL status: SUCCESS 1 in 0.68 seconds
2021-05-15 11:23:21.509357 (Thread-1): Using snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 11:23:21.509410 (Thread-1): On model.DBTTest.SF_HF_segmented: /* {"app": "dbt", "dbt_version": "0.18.1", "profile_name": "user", "target_name": "default", "node_id": "model.DBTTest.SF_HF_segmented"} */


      create or replace transient table DATAFLOTEST_DATABASE.dbt_test_UAT_Testing.SF_HF_segmented  as
      (WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company inner join calendar on to_date(PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric --where r_type='Year' and r_metric_id= 85
      );
2021-05-15 11:23:22.445893 (Thread-753): handling poll request
2021-05-15 11:23:22.446349 (Thread-753): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735dd96a0>]}
2021-05-15 11:23:22.447545 (Thread-753): sending response (<Response 14024 bytes [200 OK]>) to 10.0.22.198
2021-05-15 11:23:24.641919 (Thread-754): handling poll request
2021-05-15 11:23:24.642425 (Thread-754): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724f68670>]}
2021-05-15 11:23:24.643305 (Thread-754): sending response (<Response 309 bytes [200 OK]>) to 10.0.15.199
2021-05-15 11:23:26.151328 (Thread-755): handling poll request
2021-05-15 11:23:26.151766 (Thread-755): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735dd9fd0>]}
2021-05-15 11:23:26.152625 (Thread-755): sending response (<Response 309 bytes [200 OK]>) to 10.0.18.95
2021-05-15 11:23:26.837884 (Thread-1): SQL status: SUCCESS 1 in 5.33 seconds
2021-05-15 11:23:26.840638 (Thread-1): On model.DBTTest.SF_HF_segmented: COMMIT
2021-05-15 11:23:26.840767 (Thread-1): Using snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 11:23:26.840816 (Thread-1): On model.DBTTest.SF_HF_segmented: COMMIT
2021-05-15 11:23:26.899787 (Thread-1): SQL status: SUCCESS 1 in 0.06 seconds
2021-05-15 11:23:26.901661 (Thread-1): finished collecting timing info
2021-05-15 11:23:26.901865 (Thread-1): On model.DBTTest.SF_HF_segmented: Close
2021-05-15 11:23:26.995979 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7a20166-e5bb-4dd0-9d85-8f351b3b407c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f0582a2d040>]}
2021-05-15 11:23:26.997093 (Thread-1): 11:23:26 | 2 of 3 OK created table model dbt_test_UAT_Testing.SF_HF_segmented... [SUCCESS 1 in 6.24s]
2021-05-15 11:23:26.997188 (Thread-1): Finished running node model.DBTTest.SF_HF_segmented
2021-05-15 11:23:26.997296 (Thread-1): Began running node model.DBTTest.Test_timeframe
2021-05-15 11:23:26.998093 (Thread-1): 11:23:26 | 3 of 3 START table model dbt_test_UAT_Testing.Test_timeframe......... [RUN]
2021-05-15 11:23:26.998336 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-15 11:23:26.998413 (Thread-1): Compiling model.DBTTest.Test_timeframe
2021-05-15 11:23:27.004936 (Thread-1): Writing injected SQL for node "model.DBTTest.Test_timeframe"
2021-05-15 11:23:27.017083 (Thread-1): finished collecting timing info
2021-05-15 11:23:27.021460 (Thread-1): Writing runtime SQL for node "model.DBTTest.Test_timeframe"
2021-05-15 11:23:27.037359 (Thread-1): Using snowflake connection "model.DBTTest.Test_timeframe".
2021-05-15 11:23:27.037445 (Thread-1): On model.DBTTest.Test_timeframe: BEGIN
2021-05-15 11:23:27.037506 (Thread-1): Opening a new connection, currently in state closed
2021-05-15 11:23:27.378784 (Thread-1): SQL status: SUCCESS 1 in 0.34 seconds
2021-05-15 11:23:27.378938 (Thread-1): Using snowflake connection "model.DBTTest.Test_timeframe".
2021-05-15 11:23:27.378991 (Thread-1): On model.DBTTest.Test_timeframe: /* {"app": "dbt", "dbt_version": "0.18.1", "profile_name": "user", "target_name": "default", "node_id": "model.DBTTest.Test_timeframe"} */


      create or replace transient table DATAFLOTEST_DATABASE.dbt_test_UAT_Testing.Test_timeframe  as
      (With timeframe AS (
  select TIMEFRAMEID,SOURCE_TYPE,year,week_start as start_date,week_end as end_date,'Week' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,WEEK_NUM as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(weekend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,month_start as start_date,month_end as end_date,'Month' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,MONTH_NAME as timeframe_type from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(monthend_flag)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,QUARTER_START as start_date,QUARTER_END as end_date,'Quarter' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER,QUTR_NUMBER as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(QUARTEREND_FLAG)='TRUE'
  union 
  select TIMEFRAMEID,SOURCE_TYPE,year,YEAR_START as start_date,YEAR_END as end_date,'Year' as type,WEEK_NUM,MONTH_NAME,QUTR_NUMBER, cast(year as varchar(10)) as timeframe_type  from DBT_SALESDATAFLO.DIM_TIMEFRAME where UPPER(YEAREND_FLAG)='TRUE'
  
  ),r_metric AS (
    select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            OPPORTUNITY.Source_type as r_Source_type, 
            timeframe.type as r_type,
            timeframe_type as r_timeframe_type,
            WEEK_NUM as r_week_num,MONTH_NAME as r_month_name,QUTR_NUMBER as r_qutr_num,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,timeframe --inner join timeframe on to_date(OPPORTUNITY.CREATED_DATE) = timeframe.TIMEFRAMEID
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between timeframe.start_date and timeframe.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7,8,9,10
 ),fs AS(
    select sum(count) as f_count,
            sum(AMOUNT) AS f_amount,
            metric_id AS f_metric_id,
            ENTITY_ID as f_entity_id, 
            TIMEFRAME_TYPE as f_timeframe_type,
            cast(tmf.year as varchar(1000)) as f_types_timeframe,
            tmf.year as f_year
          from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf  
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7

 ), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from fs inner join r_metric on fs.f_metric_id=r_metric.r_metric_id where fs.f_metric_id=r_metric.r_metric_id
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result where f_timeframe_type='Y' and f_metric_id=1  and f_entity_id='SF_RKLIVE_06012021'
      );
2021-05-15 11:23:27.647663 (Thread-756): handling poll request
2021-05-15 11:23:27.648071 (Thread-756): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735dd9bb0>]}
2021-05-15 11:23:27.650774 (Thread-756): sending response (<Response 13026 bytes [200 OK]>) to 10.0.17.122
2021-05-15 11:23:28.933456 (Thread-1): SQL status: SUCCESS 1 in 1.55 seconds
2021-05-15 11:23:28.936233 (Thread-1): On model.DBTTest.Test_timeframe: COMMIT
2021-05-15 11:23:28.936374 (Thread-1): Using snowflake connection "model.DBTTest.Test_timeframe".
2021-05-15 11:23:28.936423 (Thread-1): On model.DBTTest.Test_timeframe: COMMIT
2021-05-15 11:23:29.001920 (Thread-1): SQL status: SUCCESS 1 in 0.07 seconds
2021-05-15 11:23:29.003793 (Thread-1): finished collecting timing info
2021-05-15 11:23:29.003993 (Thread-1): On model.DBTTest.Test_timeframe: Close
2021-05-15 11:23:29.087287 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7a20166-e5bb-4dd0-9d85-8f351b3b407c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f05823eab80>]}
2021-05-15 11:23:29.088422 (Thread-1): 11:23:29 | 3 of 3 OK created table model dbt_test_UAT_Testing.Test_timeframe.... [SUCCESS 1 in 2.09s]
2021-05-15 11:23:29.088518 (Thread-1): Finished running node model.DBTTest.Test_timeframe
2021-05-15 11:23:29.089869 (MainThread): Acquiring new snowflake connection "master".
2021-05-15 11:23:29.090062 (MainThread): Using snowflake connection "master".
2021-05-15 11:23:29.090127 (MainThread): On master: BEGIN
2021-05-15 11:23:29.090208 (MainThread): Opening a new connection, currently in state closed
2021-05-15 11:23:29.439124 (MainThread): SQL status: SUCCESS 1 in 0.35 seconds
2021-05-15 11:23:29.439276 (MainThread): On master: COMMIT
2021-05-15 11:23:29.439369 (MainThread): Using snowflake connection "master".
2021-05-15 11:23:29.439413 (MainThread): On master: COMMIT
2021-05-15 11:23:29.578676 (MainThread): SQL status: SUCCESS 1 in 0.14 seconds
2021-05-15 11:23:29.578904 (MainThread): On master: Close
2021-05-15 11:23:29.723510 (Thread-757): handling poll request
2021-05-15 11:23:29.723926 (Thread-757): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724db52e0>]}
2021-05-15 11:23:29.726558 (Thread-757): sending response (<Response 6616 bytes [200 OK]>) to 10.0.15.49
2021-05-15 11:23:29.731533 (MainThread): 11:23:29 | 
2021-05-15 11:23:29.731659 (MainThread): 11:23:29 | Finished running 3 table models in 26.49s.
2021-05-15 11:23:29.731720 (MainThread): Connection 'master' was properly closed.
2021-05-15 11:23:29.731763 (MainThread): Connection 'model.DBTTest.Test_timeframe' was properly closed.
2021-05-15 11:23:29.788860 (MainThread): 
2021-05-15 11:23:29.789032 (MainThread): Completed successfully
2021-05-15 11:23:29.789097 (MainThread): 
Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
2021-05-15 11:23:31.268859 (Thread-758): handling poll request
2021-05-15 11:23:31.269298 (Thread-758): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735dd9490>]}
2021-05-15 11:23:31.279240 (Thread-758): sending response (<Response 99288 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:23:32.340060 (Thread-759): handling status request
2021-05-15 11:23:32.340486 (Thread-759): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724dbc190>]}
2021-05-15 11:23:32.362616 (Thread-759): sending response (<Response 82949 bytes [200 OK]>) to 10.0.41.124
2021-05-15 11:23:32.382837 (Thread-760): handling status request
2021-05-15 11:23:32.383144 (Thread-760): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb735dd9610>]}
2021-05-15 11:23:32.403762 (Thread-760): sending response (<Response 82949 bytes [200 OK]>) to 10.0.3.247
2021-05-15 11:23:32.404876 (Thread-761): handling status request
2021-05-15 11:23:32.405260 (Thread-761): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '6ac7dbe8-2329-4e40-9a78-ca7ba43d83a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb724a20af0>]}
2021-05-15 11:23:32.425548 (Thread-761): sending response (<Response 82949 bytes [200 OK]>) to 10.0.15.199
2021-05-15 16:28:10.544235 (MainThread): Running with dbt=0.18.1
2021-05-15 16:28:10.837252 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-15 16:28:10.849584 (MainThread): Tracking: tracking
2021-05-15 16:28:10.849791 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7dc97ae80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7d9a59a00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7d235f760>]}
2021-05-15 16:28:10.851906 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-15 16:28:10.860623 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-15 16:28:10.860857 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-15 16:28:11.557861 (Thread-1): Parsing macros/metrics.sql
2021-05-15 16:28:11.572416 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-15 16:28:11.578713 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-15 16:28:11.582791 (Thread-1): Parsing macros/adapters.sql
2021-05-15 16:28:11.610921 (Thread-1): Parsing macros/catalog.sql
2021-05-15 16:28:11.612910 (Thread-1): Parsing macros/materializations/table.sql
2021-05-15 16:28:11.616712 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-15 16:28:11.618682 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-15 16:28:11.627631 (Thread-1): Parsing macros/materializations/view.sql
2021-05-15 16:28:11.629885 (Thread-1): Parsing macros/core.sql
2021-05-15 16:28:11.633436 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-15 16:28:11.643463 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-15 16:28:11.665052 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-15 16:28:11.667380 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-15 16:28:11.691021 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-15 16:28:11.736462 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-15 16:28:11.745107 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-15 16:28:11.753755 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-15 16:28:11.783377 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-15 16:28:11.793245 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-15 16:28:11.796139 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-15 16:28:11.804700 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-15 16:28:11.806430 (Thread-1): Parsing macros/etc/query.sql
2021-05-15 16:28:11.807509 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-15 16:28:11.817153 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-15 16:28:11.818175 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-15 16:28:11.819840 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-15 16:28:11.821833 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-15 16:28:11.823353 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-15 16:28:11.826030 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-15 16:28:11.827910 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-15 16:28:11.829689 (Thread-1): Parsing macros/adapters/common.sql
2021-05-15 16:28:11.884921 (Thread-1): Parsing macros/staging_columns.sql
2021-05-15 16:28:11.912109 (Thread-1): Parsing macros/staging_columns.sql
2021-05-15 16:28:11.963082 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-15 16:28:11.968948 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-15 16:28:11.974557 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-15 16:28:11.980029 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-15 16:28:11.987561 (Thread-1): Parsing macros/sql/star.sql
2021-05-15 16:28:11.996334 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-15 16:28:12.004555 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-15 16:28:12.011412 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-15 16:28:12.019642 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-15 16:28:12.025185 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-15 16:28:12.036434 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-15 16:28:12.041986 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-15 16:28:12.047677 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-15 16:28:12.056479 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-15 16:28:12.091113 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-15 16:28:12.097128 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-15 16:28:12.108469 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-15 16:28:12.116427 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-15 16:28:12.123031 (Thread-1): Parsing macros/sql/union.sql
2021-05-15 16:28:12.137103 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-15 16:28:12.164297 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-15 16:28:12.169753 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-15 16:28:12.176211 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-15 16:28:12.181944 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-15 16:28:12.190685 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-15 16:28:12.196170 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-15 16:28:12.202229 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-15 16:28:12.207987 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-15 16:28:12.216047 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-15 16:28:12.221680 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-15 16:28:12.227470 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-15 16:28:12.233864 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-15 16:28:12.244470 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-15 16:28:12.250811 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-15 16:28:12.257712 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-15 16:28:12.263708 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-15 16:28:12.270170 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-15 16:28:12.275346 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-15 16:28:12.281726 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-15 16:28:12.287649 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-15 16:28:12.295500 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-15 16:28:12.301285 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-15 16:28:12.308595 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-15 16:28:12.314332 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-15 16:28:12.319937 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-15 16:28:12.326678 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-15 16:28:12.332398 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-15 16:28:12.338868 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-15 16:28:12.353410 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-15 16:28:12.360548 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-15 16:28:12.378846 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-15 16:28:12.384875 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-15 16:28:12.390435 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-15 16:28:12.396918 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-15 16:28:12.407399 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-15 16:28:12.413422 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-15 16:28:12.419194 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-15 16:28:12.425672 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-15 16:28:12.433910 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-15 16:28:12.442713 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-15 16:28:12.446251 (Thread-2): handling status request
2021-05-15 16:28:12.446646 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '4e2f2c0a-3708-40aa-b792-8ba5714671c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7d2289370>]}
2021-05-15 16:28:12.448360 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.46.218
2021-05-15 16:28:12.451819 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-15 16:28:12.463192 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-15 16:28:12.480415 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-15 16:28:12.502366 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-15 16:28:12.509641 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-15 16:28:12.520526 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-15 16:28:12.526989 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-15 16:28:12.542490 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-15 16:28:12.551117 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-15 16:28:12.561692 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-15 16:28:12.572015 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-15 16:28:12.598842 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-15 16:28:12.617760 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-15 16:28:12.626282 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-15 16:28:12.639100 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-15 16:28:12.666512 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-15 16:28:12.680041 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-15 16:28:12.684978 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-15 16:28:12.688389 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-15 16:28:12.692080 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-15 16:28:12.696997 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-15 16:28:12.701083 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-15 16:28:12.705627 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-15 16:28:12.708704 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-15 16:28:12.712633 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-15 16:28:12.715707 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-15 16:28:12.718647 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-15 16:28:12.721773 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-15 16:28:12.724643 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-15 16:28:12.729983 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-15 16:28:12.732808 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-15 16:28:12.735968 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-15 16:28:12.738941 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-15 16:28:12.741977 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-15 16:28:12.745506 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-15 16:28:12.748419 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-15 16:28:12.751248 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-15 16:28:12.755339 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-15 16:28:12.766465 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-15 16:28:12.772436 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-15 16:28:12.780882 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-15 16:28:12.786226 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-15 16:28:12.797552 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-15 16:28:12.803647 (Thread-1): Parsing macros/first_value.sql
2021-05-15 16:28:12.819023 (Thread-1): Parsing macros/json_extract.sql
2021-05-15 16:28:12.825654 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-15 16:28:12.944833 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-15 16:28:12.958717 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-15 16:28:12.966753 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-15 16:28:12.973809 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-15 16:28:12.982343 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-15 16:28:12.991659 (Thread-1): Parsing macros/percentile.sql
2021-05-15 16:28:12.998554 (Thread-1): Parsing macros/ceiling.sql
2021-05-15 16:28:13.004274 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-15 16:28:13.012832 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-15 16:28:13.018826 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-15 16:28:13.024340 (Thread-1): Parsing macros/string_agg.sql
2021-05-15 16:28:13.031469 (Thread-1): Parsing macros/array_agg.sql
2021-05-15 16:28:13.037124 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-15 16:28:13.043252 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-15 16:28:13.049255 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-15 16:28:13.055135 (Thread-1): Parsing macros/union_relations.sql
2021-05-15 16:28:13.072263 (Thread-1): Parsing macros/max_bool.sql
2021-05-15 16:28:13.204834 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-15 16:28:13.236792 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-15 16:28:13.253074 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-15 16:28:13.268947 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-15 16:28:13.287044 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-15 16:28:13.302817 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-15 16:28:13.318964 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 16:28:13.340095 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-15 16:28:13.379165 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-15 16:28:13.644807 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-15 16:28:13.692603 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-15 16:28:13.769864 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-15 16:28:13.800705 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-15 16:28:13.819531 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-15 16:28:13.838939 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-15 16:28:14.172795 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-15 16:28:14.192693 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-15 16:28:14.218924 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-15 16:28:14.326106 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 16:28:14.343773 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 16:28:14.362109 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 16:28:14.379039 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 16:28:14.395848 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 16:28:14.410602 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 16:28:14.425361 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 16:28:14.435987 (Thread-3): handling status request
2021-05-15 16:28:14.436486 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '4e2f2c0a-3708-40aa-b792-8ba5714671c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7d1397850>]}
2021-05-15 16:28:14.437425 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.199
2021-05-15 16:28:14.442437 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 16:28:14.458009 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 16:28:14.473060 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 16:28:14.488982 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 16:28:14.504028 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 16:28:14.519496 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-15 16:28:14.542307 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 16:28:14.559960 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 16:28:14.578228 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 16:28:14.596405 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 16:28:14.612976 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 16:28:14.628505 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 16:28:14.911891 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-15 16:28:14.936999 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-15 16:28:14.965809 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-15 16:28:14.999973 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-15 16:28:15.025709 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-15 16:28:15.055819 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-15 16:28:15.081930 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-15 16:28:15.099623 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-15 16:28:15.116422 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-15 16:28:15.133194 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-15 16:28:15.149522 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-15 16:28:15.165811 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-15 16:28:15.481329 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-15 16:28:15.500377 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-15 16:28:15.528752 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-15 16:28:15.917870 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-15 16:28:15.933587 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-15 16:28:15.948301 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-15 16:28:15.963238 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-15 16:28:16.161003 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-15 16:28:16.193911 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-15 16:28:16.218506 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-15 16:28:16.245457 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-15 16:28:16.293496 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-15 16:28:16.351991 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-15 16:28:16.367436 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-15 16:28:16.382323 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-15 16:28:16.398267 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-15 16:28:16.414012 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-15 16:28:16.423802 (Thread-4): handling status request
2021-05-15 16:28:16.424139 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '4e2f2c0a-3708-40aa-b792-8ba5714671c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7d176c460>]}
2021-05-15 16:28:16.424746 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.20.29
2021-05-15 16:28:16.891479 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-15 16:28:16.908100 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-15 16:28:16.923780 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-15 16:28:16.939638 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-15 16:28:16.977597 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-15 16:28:16.993700 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-15 16:28:17.011707 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-15 16:28:17.241893 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-15 16:28:17.257846 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-15 16:28:17.278503 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-15 16:28:17.294364 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-15 16:28:17.310741 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-15 16:28:17.327441 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-15 16:28:17.562648 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-15 16:28:17.586322 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-15 16:28:17.621162 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-15 16:28:17.664366 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-15 16:28:17.686514 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-15 16:28:17.703411 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-15 16:28:17.719737 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-15 16:28:17.735802 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-15 16:28:18.034893 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-15 16:28:18.051334 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-15 16:28:18.066206 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-15 16:28:18.095011 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-15 16:28:18.110888 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-15 16:28:18.382391 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-15 16:28:18.408093 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-15 16:28:18.439584 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-15 16:28:18.496864 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-15 16:28:18.540513 (Thread-5): handling status request
2021-05-15 16:28:18.540901 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '4e2f2c0a-3708-40aa-b792-8ba5714671c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7d13c9940>]}
2021-05-15 16:28:18.541564 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.19.219
2021-05-15 16:28:18.546987 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-15 16:28:18.601225 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-15 16:28:18.631184 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-15 16:28:18.647293 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-15 16:28:18.663305 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-15 16:28:18.679558 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-15 16:28:18.695775 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-15 16:28:18.714102 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-15 16:28:18.978194 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-15 16:28:18.995752 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-15 16:28:19.012141 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-15 16:28:19.035088 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-15 16:28:19.051471 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-15 16:28:19.344864 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-15 16:28:19.359997 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-15 16:28:19.382593 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-15 16:28:19.397961 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-15 16:28:19.636810 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-15 16:28:19.667302 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-15 16:28:19.685018 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-15 16:28:19.927236 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 16:28:20.230347 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Views
- models.DBTTest.marts
- models.DBTTest.Stage_Layer
- models.DBTTest.Targets
- models.DBTTest.utils
- models.DBTTest.sources
- seeds.DBTTest

2021-05-15 16:28:22.479880 (Thread-6): handling status request
2021-05-15 16:28:22.480298 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '4e2f2c0a-3708-40aa-b792-8ba5714671c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7d12a2820>]}
2021-05-15 16:28:22.511464 (Thread-6): sending response (<Response 81423 bytes [200 OK]>) to 10.0.46.218
2021-05-15 16:32:09.611383 (MainThread): Running with dbt=0.18.1
2021-05-15 16:32:09.899330 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-15 16:32:09.911989 (MainThread): Tracking: tracking
2021-05-15 16:32:09.912290 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4c4a6be80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4c1b96a00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4ba49e700>]}
2021-05-15 16:32:09.912748 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-15 16:32:09.915189 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-15 16:32:09.925034 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-15 16:32:10.442581 (Thread-1): Parsing macros/metrics.sql
2021-05-15 16:32:10.455652 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-15 16:32:10.459169 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-15 16:32:10.463959 (Thread-1): Parsing macros/adapters.sql
2021-05-15 16:32:10.495280 (Thread-1): Parsing macros/catalog.sql
2021-05-15 16:32:10.497358 (Thread-1): Parsing macros/materializations/table.sql
2021-05-15 16:32:10.501231 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-15 16:32:10.503157 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-15 16:32:10.512522 (Thread-1): Parsing macros/materializations/view.sql
2021-05-15 16:32:10.514728 (Thread-1): Parsing macros/core.sql
2021-05-15 16:32:10.518301 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-15 16:32:10.527102 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-15 16:32:10.541168 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-15 16:32:10.542897 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-15 16:32:10.558991 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-15 16:32:10.587234 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-15 16:32:10.592108 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-15 16:32:10.598183 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-15 16:32:10.618588 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-15 16:32:10.625058 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-15 16:32:10.626888 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-15 16:32:10.632767 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-15 16:32:10.634376 (Thread-1): Parsing macros/etc/query.sql
2021-05-15 16:32:10.635425 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-15 16:32:10.644309 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-15 16:32:10.645296 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-15 16:32:10.647090 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-15 16:32:10.649073 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-15 16:32:10.650582 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-15 16:32:10.653237 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-15 16:32:10.655095 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-15 16:32:10.656850 (Thread-1): Parsing macros/adapters/common.sql
2021-05-15 16:32:10.704755 (Thread-1): Parsing macros/staging_columns.sql
2021-05-15 16:32:10.722381 (Thread-1): Parsing macros/staging_columns.sql
2021-05-15 16:32:10.756073 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-15 16:32:10.759194 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-15 16:32:10.762076 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-15 16:32:10.765440 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-15 16:32:10.770556 (Thread-1): Parsing macros/sql/star.sql
2021-05-15 16:32:10.775971 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-15 16:32:10.781384 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-15 16:32:10.785949 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-15 16:32:10.792247 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-15 16:32:10.795554 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-15 16:32:10.804381 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-15 16:32:10.808028 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-15 16:32:10.811976 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-15 16:32:10.817040 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-15 16:32:10.821927 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-15 16:32:10.825364 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-15 16:32:10.833662 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-15 16:32:10.839617 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-15 16:32:10.843595 (Thread-1): Parsing macros/sql/union.sql
2021-05-15 16:32:10.853540 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-15 16:32:10.878537 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-15 16:32:10.882145 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-15 16:32:10.886655 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-15 16:32:10.890408 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-15 16:32:10.896193 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-15 16:32:10.899716 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-15 16:32:10.903693 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-15 16:32:10.907059 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-15 16:32:10.913203 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-15 16:32:10.917084 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-15 16:32:10.920962 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-15 16:32:10.925604 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-15 16:32:10.933899 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-15 16:32:10.939503 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-15 16:32:10.944420 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-15 16:32:10.947972 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-15 16:32:10.951854 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-15 16:32:10.955739 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-15 16:32:10.960503 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-15 16:32:10.964444 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-15 16:32:10.970469 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-15 16:32:10.974277 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-15 16:32:10.979390 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-15 16:32:10.983583 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-15 16:32:10.987407 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-15 16:32:10.992531 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-15 16:32:10.996223 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-15 16:32:11.000157 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-15 16:32:11.012201 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-15 16:32:11.017078 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-15 16:32:11.026228 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-15 16:32:11.030440 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-15 16:32:11.033897 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-15 16:32:11.038539 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-15 16:32:11.046191 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-15 16:32:11.050783 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-15 16:32:11.054798 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-15 16:32:11.058334 (Thread-2): handling status request
2021-05-15 16:32:11.058721 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4ba41ec10>]}
2021-05-15 16:32:11.060754 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.1.135
2021-05-15 16:32:11.062211 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-15 16:32:11.067526 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-15 16:32:11.073351 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-15 16:32:11.078939 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-15 16:32:11.087887 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-15 16:32:11.102119 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-15 16:32:11.122245 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-15 16:32:11.131233 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-15 16:32:11.139229 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-15 16:32:11.143256 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-15 16:32:11.156982 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-15 16:32:11.164042 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-15 16:32:11.171599 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-15 16:32:11.179763 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-15 16:32:11.200127 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-15 16:32:11.216872 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-15 16:32:11.223708 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-15 16:32:11.232617 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-15 16:32:11.258154 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-15 16:32:11.271793 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-15 16:32:11.276650 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-15 16:32:11.280728 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-15 16:32:11.285482 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-15 16:32:11.288899 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-15 16:32:11.293627 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-15 16:32:11.298362 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-15 16:32:11.302152 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-15 16:32:11.307243 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-15 16:32:11.310773 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-15 16:32:11.314027 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-15 16:32:11.317966 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-15 16:32:11.321731 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-15 16:32:11.326780 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-15 16:32:11.330655 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-15 16:32:11.334090 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-15 16:32:11.337792 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-15 16:32:11.341227 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-15 16:32:11.344857 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-15 16:32:11.348395 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-15 16:32:11.351395 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-15 16:32:11.356255 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-15 16:32:11.364606 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-15 16:32:11.368059 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-15 16:32:11.374223 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-15 16:32:11.378079 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-15 16:32:11.381249 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-15 16:32:11.386051 (Thread-1): Parsing macros/first_value.sql
2021-05-15 16:32:11.392999 (Thread-1): Parsing macros/json_extract.sql
2021-05-15 16:32:11.397520 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-15 16:32:11.405470 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-15 16:32:11.418314 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-15 16:32:11.425626 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-15 16:32:11.430588 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-15 16:32:11.435172 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-15 16:32:11.558205 (Thread-1): Parsing macros/percentile.sql
2021-05-15 16:32:11.563425 (Thread-1): Parsing macros/ceiling.sql
2021-05-15 16:32:11.567241 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-15 16:32:11.575069 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-15 16:32:11.579374 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-15 16:32:11.583226 (Thread-1): Parsing macros/string_agg.sql
2021-05-15 16:32:11.587859 (Thread-1): Parsing macros/array_agg.sql
2021-05-15 16:32:11.591948 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-15 16:32:11.596982 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-15 16:32:11.600553 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-15 16:32:11.604462 (Thread-1): Parsing macros/union_relations.sql
2021-05-15 16:32:11.616674 (Thread-1): Parsing macros/max_bool.sql
2021-05-15 16:32:11.736986 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-15 16:32:11.761931 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-15 16:32:11.775576 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-15 16:32:11.789493 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-15 16:32:11.803920 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-15 16:32:11.820540 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-15 16:32:11.836966 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-15 16:32:11.857923 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-15 16:32:11.897010 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-15 16:32:12.175954 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-15 16:32:12.221058 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-15 16:32:12.302046 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-15 16:32:12.331145 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-15 16:32:12.347869 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-15 16:32:12.364053 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-15 16:32:12.673186 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-15 16:32:12.688695 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-15 16:32:12.701387 (Thread-3): handling status request
2021-05-15 16:32:12.701748 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b9807eb0>]}
2021-05-15 16:32:12.702365 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.138
2021-05-15 16:32:12.707539 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-15 16:32:12.823484 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 16:32:12.839928 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 16:32:12.855740 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 16:32:12.871644 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 16:32:12.887309 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 16:32:12.902345 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 16:32:12.917672 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 16:32:12.935191 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 16:32:12.950664 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 16:32:12.965839 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 16:32:12.981994 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 16:32:12.997021 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 16:32:13.011899 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-15 16:32:13.031612 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-15 16:32:13.048946 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-15 16:32:13.065211 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-15 16:32:13.081919 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-15 16:32:13.097674 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-15 16:32:13.113529 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-15 16:32:13.393039 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-15 16:32:13.414784 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-15 16:32:13.440986 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-15 16:32:13.471531 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-15 16:32:13.493603 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-15 16:32:13.520552 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-15 16:32:13.543822 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-15 16:32:13.558797 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-15 16:32:13.574212 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-15 16:32:13.588597 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-15 16:32:13.602541 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-15 16:32:13.616265 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-15 16:32:13.929806 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-15 16:32:13.948222 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-15 16:32:13.976381 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-15 16:32:14.247148 (Thread-4): handling status request
2021-05-15 16:32:14.247603 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b92fd8e0>]}
2021-05-15 16:32:14.248453 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.19.219
2021-05-15 16:32:14.254006 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-15 16:32:14.269458 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-15 16:32:14.412148 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-15 16:32:14.427518 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-15 16:32:14.628587 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-15 16:32:14.660764 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-15 16:32:14.685634 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-15 16:32:14.712434 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-15 16:32:14.761069 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-15 16:32:14.824058 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-15 16:32:14.839309 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-15 16:32:14.854203 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-15 16:32:14.869407 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-15 16:32:14.884356 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-15 16:32:15.344206 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-15 16:32:15.361061 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-15 16:32:15.377147 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-15 16:32:15.392999 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-15 16:32:15.431077 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-15 16:32:15.447242 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-15 16:32:15.464050 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-15 16:32:15.674511 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-15 16:32:15.690166 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-15 16:32:15.710227 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-15 16:32:15.726335 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-15 16:32:15.742974 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-15 16:32:15.759839 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-15 16:32:15.829974 (Thread-5): handling status request
2021-05-15 16:32:15.850716 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b96ad5e0>]}
2021-05-15 16:32:15.854067 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.1.135
2021-05-15 16:32:15.990377 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-15 16:32:16.013910 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-15 16:32:16.047136 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-15 16:32:16.090329 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-15 16:32:16.112213 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-15 16:32:16.128692 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-15 16:32:16.144796 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-15 16:32:16.161466 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-15 16:32:16.449432 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-15 16:32:16.464005 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-15 16:32:16.479341 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-15 16:32:16.507960 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-15 16:32:16.522942 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-15 16:32:16.777212 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-15 16:32:16.803488 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-15 16:32:16.835390 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-15 16:32:16.891813 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-15 16:32:16.939957 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-15 16:32:16.993767 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-15 16:32:17.023038 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-15 16:32:17.039922 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-15 16:32:17.056709 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-15 16:32:17.073194 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-15 16:32:17.089707 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-15 16:32:17.106300 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-15 16:32:17.382898 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-15 16:32:17.399310 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-15 16:32:17.416467 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-15 16:32:17.438540 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-15 16:32:17.454766 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-15 16:32:17.496153 (Thread-6): handling status request
2021-05-15 16:32:17.511896 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b9a44100>]}
2021-05-15 16:32:17.517550 (Thread-6): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.201
2021-05-15 16:32:17.731656 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-15 16:32:17.746297 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-15 16:32:17.768546 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-15 16:32:17.782801 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-15 16:32:18.022576 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-15 16:32:18.055002 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-15 16:32:18.071616 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-15 16:32:18.302516 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 16:32:18.600645 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Stage_Layer
- models.DBTTest.Views
- models.DBTTest.Targets
- models.DBTTest.sources
- models.DBTTest.marts
- seeds.DBTTest

2021-05-15 16:32:20.225453 (Thread-7): handling status request
2021-05-15 16:32:20.225905 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b92bc190>]}
2021-05-15 16:32:20.246927 (Thread-7): sending response (<Response 81423 bytes [200 OK]>) to 10.0.20.29
2021-05-15 16:32:59.327037 (MainThread): Connection 'model.dbt_date.dates' was properly closed.
2021-05-15 16:33:00.400501 (Thread-9): handling status request
2021-05-15 16:33:00.401362 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b978a1f0>]}
2021-05-15 16:33:00.401610 (Thread-8): Got an acceptable cached parse result
2021-05-15 16:33:00.402101 (Thread-10): handling status request
2021-05-15 16:33:00.402844 (Thread-9): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.49
2021-05-15 16:33:00.403253 (Thread-11): handling status request
2021-05-15 16:33:00.424129 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b9790a90>]}
2021-05-15 16:33:00.441253 (Thread-10): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 16:33:00.441769 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b9790ac0>]}
2021-05-15 16:33:00.442795 (Thread-11): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.201
2021-05-15 16:33:00.464818 (Thread-8): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-15 16:33:02.104070 (Thread-12): handling status request
2021-05-15 16:33:02.115320 (Thread-13): handling status request
2021-05-15 16:33:02.115504 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b93a1a60>]}
2021-05-15 16:33:02.117800 (Thread-14): handling status request
2021-05-15 16:33:02.117931 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b948f580>]}
2021-05-15 16:33:02.118762 (Thread-12): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 16:33:02.119250 (Thread-14): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4ba48bb20>]}
2021-05-15 16:33:02.119896 (Thread-13): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-15 16:33:02.121243 (Thread-14): sending response (<Response 184 bytes [200 OK]>) to 10.0.40.42
2021-05-15 16:33:02.363000 (Thread-8): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-15 16:33:02.667313 (Thread-8): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.Stage_Layer
- models.DBTTest.Views
- models.DBTTest.Targets
- models.DBTTest.sources
- models.DBTTest.marts
- seeds.DBTTest

2021-05-15 16:33:03.707089 (Thread-15): handling status request
2021-05-15 16:33:03.707521 (Thread-15): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b9b18a60>]}
2021-05-15 16:33:03.708583 (Thread-15): sending response (<Response 1637 bytes [200 OK]>) to 10.0.18.95
2021-05-15 16:33:03.746483 (Thread-16): handling status request
2021-05-15 16:33:03.746905 (Thread-16): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b93cb4c0>]}
2021-05-15 16:33:03.747948 (Thread-16): sending response (<Response 1637 bytes [200 OK]>) to 10.0.22.198
2021-05-15 16:33:03.889986 (Thread-17): handling status request
2021-05-15 16:33:03.890422 (Thread-17): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4c844ec10>]}
2021-05-15 16:33:03.891462 (Thread-17): sending response (<Response 1637 bytes [200 OK]>) to 10.0.41.124
2021-05-15 16:33:59.456019 (Thread-18): handling status request
2021-05-15 16:33:59.458303 (Thread-18): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b95aae80>]}
2021-05-15 16:33:59.459416 (Thread-18): sending response (<Response 1637 bytes [200 OK]>) to 10.0.1.135
2021-05-15 16:34:00.033176 (Thread-19): handling run_sql request
2021-05-15 16:34:00.033611 (Thread-19): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b9a2c4f0>]}
2021-05-15 16:34:00.036281 (Thread-19): Connection 'model.DBTTest.ADS_FACT' was properly closed.
2021-05-15 16:34:01.088750 (Thread-19): sending response (<Response 137 bytes [200 OK]>) to 10.0.6.126
2021-05-15 16:34:01.119354 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 16:34:01.149736 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-15 16:34:01.150185 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-15 16:34:01.150302 (Thread-1): Compiling rpc.DBTTest.request
2021-05-15 16:34:01.164313 (Thread-1): finished collecting timing info
2021-05-15 16:34:01.165484 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-15 16:34:01.165564 (Thread-1): On rpc.DBTTest.request: With calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
)

select * from calendar
limit 500
/* limit added automatically by dbt cloud */
2021-05-15 16:34:01.165624 (Thread-1): Opening a new connection, currently in state init
2021-05-15 16:34:01.534787 (Thread-20): handling poll request
2021-05-15 16:34:01.535860 (Thread-20): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b9b6d550>]}
2021-05-15 16:34:01.539233 (Thread-20): sending response (<Response 3814 bytes [200 OK]>) to 10.0.4.10
2021-05-15 16:34:03.010517 (Thread-1): SQL status: SUCCESS 500 in 1.84 seconds
2021-05-15 16:34:03.030879 (Thread-1): finished collecting timing info
2021-05-15 16:34:03.031318 (Thread-1): On rpc.DBTTest.request: Close
2021-05-15 16:34:03.109038 (Thread-21): handling poll request
2021-05-15 16:34:03.109488 (Thread-21): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b989a940>]}
2021-05-15 16:34:03.110617 (Thread-21): sending response (<Response 1331 bytes [200 OK]>) to 10.0.45.155
2021-05-15 16:34:04.615653 (Thread-22): handling poll request
2021-05-15 16:34:04.616074 (Thread-22): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '073d7824-91b0-471f-a1ca-7490c18cd82f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4b93bb4f0>]}
2021-05-15 16:34:04.624171 (Thread-22): sending response (<Response 51976 bytes [200 OK]>) to 10.0.15.49
2021-05-16 09:36:10.066358 (MainThread): Running with dbt=0.18.1
2021-05-16 09:36:10.344896 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-16 09:36:10.357706 (MainThread): Tracking: tracking
2021-05-16 09:36:10.357930 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd988ce8d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd985e158e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd97e7183d0>]}
2021-05-16 09:36:10.358249 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-16 09:36:10.360424 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-16 09:36:10.369286 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-16 09:36:11.012344 (Thread-1): Parsing macros/metrics.sql
2021-05-16 09:36:11.026310 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-16 09:36:11.032770 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-16 09:36:11.036766 (Thread-1): Parsing macros/adapters.sql
2021-05-16 09:36:11.065589 (Thread-1): Parsing macros/catalog.sql
2021-05-16 09:36:11.067740 (Thread-1): Parsing macros/materializations/table.sql
2021-05-16 09:36:11.072444 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-16 09:36:11.074658 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-16 09:36:11.085296 (Thread-1): Parsing macros/materializations/view.sql
2021-05-16 09:36:11.087843 (Thread-1): Parsing macros/core.sql
2021-05-16 09:36:11.092054 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-16 09:36:11.101159 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-16 09:36:11.115541 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-16 09:36:11.117450 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-16 09:36:11.135203 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-16 09:36:11.162973 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-16 09:36:11.167864 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-16 09:36:11.174008 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-16 09:36:11.194550 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-16 09:36:11.200994 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-16 09:36:11.202787 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-16 09:36:11.208695 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-16 09:36:11.210268 (Thread-1): Parsing macros/etc/query.sql
2021-05-16 09:36:11.211326 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-16 09:36:11.219962 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-16 09:36:11.220938 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-16 09:36:11.222572 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-16 09:36:11.224514 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-16 09:36:11.226052 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-16 09:36:11.228705 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-16 09:36:11.230579 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-16 09:36:11.232319 (Thread-1): Parsing macros/adapters/common.sql
2021-05-16 09:36:11.281782 (Thread-1): Parsing macros/staging_columns.sql
2021-05-16 09:36:11.306706 (Thread-1): Parsing macros/staging_columns.sql
2021-05-16 09:36:11.357137 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-16 09:36:11.362899 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-16 09:36:11.368457 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-16 09:36:11.373693 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-16 09:36:11.381109 (Thread-1): Parsing macros/sql/star.sql
2021-05-16 09:36:11.389315 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-16 09:36:11.398172 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-16 09:36:11.407321 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-16 09:36:11.417678 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-16 09:36:11.423954 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-16 09:36:11.435459 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-16 09:36:11.442044 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-16 09:36:11.448150 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-16 09:36:11.456431 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-16 09:36:11.464024 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-16 09:36:11.469569 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-16 09:36:11.480546 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-16 09:36:11.489706 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-16 09:36:11.496269 (Thread-1): Parsing macros/sql/union.sql
2021-05-16 09:36:11.511123 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-16 09:36:11.539173 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-16 09:36:11.545971 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-16 09:36:11.554124 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-16 09:36:11.560563 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-16 09:36:11.569712 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-16 09:36:11.576631 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-16 09:36:11.582597 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-16 09:36:11.588629 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-16 09:36:11.596700 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-16 09:36:11.603129 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-16 09:36:11.609618 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-16 09:36:11.616503 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-16 09:36:11.627192 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-16 09:36:11.633776 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-16 09:36:11.641460 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-16 09:36:11.647999 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-16 09:36:11.654536 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-16 09:36:11.659788 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-16 09:36:11.666676 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-16 09:36:11.673875 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-16 09:36:11.682838 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-16 09:36:11.688064 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-16 09:36:11.694812 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-16 09:36:11.701419 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-16 09:36:11.708652 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-16 09:36:11.716617 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-16 09:36:11.722769 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-16 09:36:11.729237 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-16 09:36:11.744701 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-16 09:36:11.751719 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-16 09:36:11.764496 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-16 09:36:11.771985 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-16 09:36:11.778698 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-16 09:36:11.785390 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-16 09:36:11.796366 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-16 09:36:11.803704 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-16 09:36:11.810332 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-16 09:36:11.817602 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-16 09:36:11.824949 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-16 09:36:11.834037 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-16 09:36:11.842167 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-16 09:36:11.854037 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-16 09:36:11.872952 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-16 09:36:11.895312 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-16 09:36:11.905816 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-16 09:36:11.916355 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-16 09:36:11.923352 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-16 09:36:11.940104 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-16 09:36:11.949409 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-16 09:36:11.961986 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-16 09:36:11.973132 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-16 09:36:11.997429 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-16 09:36:12.017087 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-16 09:36:12.026958 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-16 09:36:12.039395 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-16 09:36:12.072242 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-16 09:36:12.088730 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-16 09:36:12.096122 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-16 09:36:12.101551 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-16 09:36:12.107473 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-16 09:36:12.112800 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-16 09:36:12.120513 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-16 09:36:12.128033 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-16 09:36:12.133909 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-16 09:36:12.140146 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-16 09:36:12.145471 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-16 09:36:12.150157 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-16 09:36:12.155976 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-16 09:36:12.161474 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-16 09:36:12.168939 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-16 09:36:12.173975 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-16 09:36:12.179720 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-16 09:36:12.185980 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-16 09:36:12.192283 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-16 09:36:12.198534 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-16 09:36:12.203813 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-16 09:36:12.209047 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-16 09:36:12.216388 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-16 09:36:12.227060 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-16 09:36:12.232600 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-16 09:36:12.240635 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-16 09:36:12.246066 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-16 09:36:12.252109 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-16 09:36:12.258756 (Thread-1): Parsing macros/first_value.sql
2021-05-16 09:36:12.267371 (Thread-1): Parsing macros/json_extract.sql
2021-05-16 09:36:12.274618 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-16 09:36:12.283273 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-16 09:36:12.297015 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-16 09:36:12.304294 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-16 09:36:12.311511 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-16 09:36:12.317548 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-16 09:36:12.437519 (Thread-1): Parsing macros/percentile.sql
2021-05-16 09:36:12.444454 (Thread-1): Parsing macros/ceiling.sql
2021-05-16 09:36:12.450597 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-16 09:36:12.458790 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-16 09:36:12.464289 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-16 09:36:12.470208 (Thread-1): Parsing macros/string_agg.sql
2021-05-16 09:36:12.476839 (Thread-1): Parsing macros/array_agg.sql
2021-05-16 09:36:12.482641 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-16 09:36:12.488239 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-16 09:36:12.494160 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-16 09:36:12.500119 (Thread-1): Parsing macros/union_relations.sql
2021-05-16 09:36:12.513413 (Thread-1): Parsing macros/max_bool.sql
2021-05-16 09:36:12.618841 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-16 09:36:12.646540 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-16 09:36:12.663457 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-16 09:36:12.679643 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-16 09:36:12.697602 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-16 09:36:12.711745 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-16 09:36:12.726770 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-16 09:36:12.742553 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-16 09:36:12.763365 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-16 09:36:12.802440 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-16 09:36:13.056597 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-16 09:36:13.100052 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-16 09:36:13.176146 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-16 09:36:13.207398 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-16 09:36:13.226288 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-16 09:36:13.245115 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-16 09:36:13.573681 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-16 09:36:13.591287 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-16 09:36:13.611033 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-16 09:36:13.715624 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-16 09:36:13.734038 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-16 09:36:13.752386 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-16 09:36:13.769360 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-16 09:36:13.786336 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-16 09:36:13.803213 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-16 09:36:13.821030 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-16 09:36:13.838912 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-16 09:36:13.856118 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-16 09:36:13.874568 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-16 09:36:13.891907 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-16 09:36:13.909790 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-16 09:36:13.927724 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-16 09:36:13.950880 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-16 09:36:13.972500 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-16 09:36:13.993217 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-16 09:36:14.011852 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-16 09:36:14.029837 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-16 09:36:14.046694 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-16 09:36:14.309517 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-16 09:36:14.333161 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-16 09:36:14.360717 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-16 09:36:14.392679 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-16 09:36:14.417058 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-16 09:36:14.444570 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-16 09:36:14.471452 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-16 09:36:14.488253 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-16 09:36:14.507974 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-16 09:36:14.523286 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-16 09:36:14.544351 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-16 09:36:14.566664 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-16 09:36:14.880940 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-16 09:36:14.898418 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-16 09:36:14.925522 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-16 09:36:15.185988 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-16 09:36:15.315740 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-16 09:36:15.333588 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-16 09:36:15.348636 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-16 09:36:15.536771 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-16 09:36:15.570100 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-16 09:36:15.592741 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-16 09:36:15.618223 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-16 09:36:15.665628 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-16 09:36:15.721255 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-16 09:36:15.735082 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-16 09:36:15.749382 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-16 09:36:15.763963 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-16 09:36:15.778159 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-16 09:36:16.233411 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-16 09:36:16.248354 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-16 09:36:16.263124 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-16 09:36:16.278053 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-16 09:36:16.314975 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-16 09:36:16.330985 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-16 09:36:16.346095 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-16 09:36:16.435174 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-16 09:36:16.449752 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-16 09:36:16.579900 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-16 09:36:16.594272 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-16 09:36:16.609876 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-16 09:36:16.625537 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-16 09:36:16.851876 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-16 09:36:16.873845 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-16 09:36:16.906541 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-16 09:36:16.947486 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-16 09:36:16.968171 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-16 09:36:16.983923 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-16 09:36:16.999042 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-16 09:36:17.014612 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-16 09:36:17.328888 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-16 09:36:17.345057 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-16 09:36:17.359110 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-16 09:36:17.386427 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-16 09:36:17.401278 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-16 09:36:17.543361 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-16 09:36:17.582631 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-16 09:36:17.741628 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-16 09:36:17.795029 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-16 09:36:17.843899 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-16 09:36:17.913291 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-16 09:36:17.945918 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-16 09:36:17.961868 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-16 09:36:17.977814 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-16 09:36:17.993357 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-16 09:36:18.008746 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-16 09:36:18.023786 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-16 09:36:18.278453 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-16 09:36:18.294088 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-16 09:36:18.310305 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-16 09:36:18.331526 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-16 09:36:18.345520 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-16 09:36:18.618819 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-16 09:36:18.632708 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-16 09:36:18.654536 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-16 09:36:18.668846 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-16 09:36:18.802107 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-16 09:36:18.952007 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-16 09:36:18.969658 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-16 09:36:19.215391 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-16 09:36:19.522536 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Targets
- models.DBTTest.Stage_Layer
- models.DBTTest.Views
- models.DBTTest.marts
- models.DBTTest.utils
- models.DBTTest.sources
- seeds.DBTTest

2021-05-17 03:17:26.171570 (MainThread): Running with dbt=0.18.1
2021-05-17 03:17:26.443556 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-17 03:17:26.455685 (MainThread): Tracking: tracking
2021-05-17 03:17:26.455904 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9dedf20dc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9deb0508e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9de4155670>]}
2021-05-17 03:17:26.456208 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-17 03:17:26.456576 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-17 03:17:26.463715 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-17 03:17:27.036410 (Thread-1): Parsing macros/metrics.sql
2021-05-17 03:17:27.049580 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-17 03:17:27.054155 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-17 03:17:27.058075 (Thread-1): Parsing macros/adapters.sql
2021-05-17 03:17:27.086277 (Thread-1): Parsing macros/catalog.sql
2021-05-17 03:17:27.088226 (Thread-1): Parsing macros/materializations/table.sql
2021-05-17 03:17:27.091937 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-17 03:17:27.093935 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-17 03:17:27.102733 (Thread-1): Parsing macros/materializations/view.sql
2021-05-17 03:17:27.104946 (Thread-1): Parsing macros/core.sql
2021-05-17 03:17:27.108925 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-17 03:17:27.118142 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-17 03:17:27.131871 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-17 03:17:27.133573 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-17 03:17:27.149522 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-17 03:17:27.177081 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-17 03:17:27.181862 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-17 03:17:27.187892 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-17 03:17:27.209046 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-17 03:17:27.215476 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-17 03:17:27.217287 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-17 03:17:27.223114 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-17 03:17:27.224680 (Thread-1): Parsing macros/etc/query.sql
2021-05-17 03:17:27.225715 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-17 03:17:27.234301 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-17 03:17:27.235252 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-17 03:17:27.236863 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-17 03:17:27.238808 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-17 03:17:27.240297 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-17 03:17:27.243047 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-17 03:17:27.244884 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-17 03:17:27.246628 (Thread-1): Parsing macros/adapters/common.sql
2021-05-17 03:17:27.293425 (Thread-1): Parsing macros/staging_columns.sql
2021-05-17 03:17:27.313671 (Thread-1): Parsing macros/staging_columns.sql
2021-05-17 03:17:27.348012 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-17 03:17:27.351750 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-17 03:17:27.356101 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-17 03:17:27.360638 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-17 03:17:27.366956 (Thread-1): Parsing macros/sql/star.sql
2021-05-17 03:17:27.372882 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-17 03:17:27.378528 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-17 03:17:27.383687 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-17 03:17:27.390388 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-17 03:17:27.394299 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-17 03:17:27.403871 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-17 03:17:27.407931 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-17 03:17:27.412509 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-17 03:17:27.419057 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-17 03:17:27.424775 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-17 03:17:27.428816 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-17 03:17:27.438414 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-17 03:17:27.445610 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-17 03:17:27.450466 (Thread-1): Parsing macros/sql/union.sql
2021-05-17 03:17:27.464369 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-17 03:17:27.490485 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-17 03:17:27.494447 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-17 03:17:27.499279 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-17 03:17:27.503632 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-17 03:17:27.509956 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-17 03:17:27.513925 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-17 03:17:27.517877 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-17 03:17:27.521772 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-17 03:17:27.528354 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-17 03:17:27.533538 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-17 03:17:27.538848 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-17 03:17:27.544325 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-17 03:17:27.552870 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-17 03:17:27.557888 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-17 03:17:27.563327 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-17 03:17:27.567391 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-17 03:17:27.571773 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-17 03:17:27.575879 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-17 03:17:27.582214 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-17 03:17:27.586324 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-17 03:17:27.592700 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-17 03:17:27.597143 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-17 03:17:27.602545 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-17 03:17:27.607848 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-17 03:17:27.613475 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-17 03:17:27.621389 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-17 03:17:27.626802 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-17 03:17:27.631681 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-17 03:17:27.651728 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-17 03:17:27.657888 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-17 03:17:27.670450 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-17 03:17:27.676199 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-17 03:17:27.681079 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-17 03:17:27.686583 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-17 03:17:27.695434 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-17 03:17:27.700578 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-17 03:17:27.704663 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-17 03:17:27.709795 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-17 03:17:27.715564 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-17 03:17:27.721673 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-17 03:17:27.728193 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-17 03:17:27.737791 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-17 03:17:27.753482 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-17 03:17:27.774886 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-17 03:17:27.784316 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-17 03:17:27.794186 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-17 03:17:27.799211 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-17 03:17:27.813732 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-17 03:17:27.821396 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-17 03:17:27.830281 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-17 03:17:27.839805 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-17 03:17:27.863210 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-17 03:17:27.880870 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-17 03:17:27.887678 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-17 03:17:27.897325 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-17 03:17:27.921979 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-17 03:17:27.936963 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-17 03:17:27.942936 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-17 03:17:27.946914 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-17 03:17:27.951380 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-17 03:17:27.954950 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-17 03:17:27.959680 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-17 03:17:27.964939 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-17 03:17:27.969685 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-17 03:17:27.975841 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-17 03:17:27.979696 (Thread-2): handling status request
2021-05-17 03:17:27.980269 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d780bc9-d899-4964-a929-ff0977524947', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9de402b820>]}
2021-05-17 03:17:27.982761 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.124
2021-05-17 03:17:27.982988 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-17 03:17:27.987869 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-17 03:17:27.992015 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-17 03:17:27.995753 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-17 03:17:28.001498 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-17 03:17:28.005367 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-17 03:17:28.010373 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-17 03:17:28.014988 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-17 03:17:28.018502 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-17 03:17:28.022404 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-17 03:17:28.025986 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-17 03:17:28.030184 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-17 03:17:28.035683 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-17 03:17:28.045265 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-17 03:17:28.049401 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-17 03:17:28.055516 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-17 03:17:28.059507 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-17 03:17:28.063504 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-17 03:17:28.068510 (Thread-1): Parsing macros/first_value.sql
2021-05-17 03:17:28.073998 (Thread-1): Parsing macros/json_extract.sql
2021-05-17 03:17:28.079376 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-17 03:17:28.085864 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-17 03:17:28.203816 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-17 03:17:28.210495 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-17 03:17:28.216451 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-17 03:17:28.220560 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-17 03:17:28.229420 (Thread-1): Parsing macros/percentile.sql
2021-05-17 03:17:28.234895 (Thread-1): Parsing macros/ceiling.sql
2021-05-17 03:17:28.239060 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-17 03:17:28.247596 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-17 03:17:28.252343 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-17 03:17:28.256917 (Thread-1): Parsing macros/string_agg.sql
2021-05-17 03:17:28.263101 (Thread-1): Parsing macros/array_agg.sql
2021-05-17 03:17:28.268757 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-17 03:17:28.273768 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-17 03:17:28.278242 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-17 03:17:28.282708 (Thread-1): Parsing macros/union_relations.sql
2021-05-17 03:17:28.294880 (Thread-1): Parsing macros/max_bool.sql
2021-05-17 03:17:28.400685 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-17 03:17:28.438095 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-17 03:17:28.454010 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-17 03:17:28.470283 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-17 03:17:28.488005 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-17 03:17:28.501060 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-17 03:17:28.515102 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-17 03:17:28.530927 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-17 03:17:28.551312 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-17 03:17:28.588384 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-17 03:17:28.848541 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-17 03:17:28.891645 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-17 03:17:28.965462 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-17 03:17:28.995372 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-17 03:17:29.013227 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-17 03:17:29.031201 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-17 03:17:29.410789 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-17 03:17:29.428185 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-17 03:17:29.448046 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-17 03:17:29.571833 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-17 03:17:29.590571 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-17 03:17:29.607310 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-17 03:17:29.623357 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-17 03:17:29.639649 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-17 03:17:29.657029 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-17 03:17:29.673496 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-17 03:17:29.689795 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-17 03:17:29.709559 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-17 03:17:29.736701 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-17 03:17:29.758337 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-17 03:17:29.789364 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-17 03:17:29.805311 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-17 03:17:29.827437 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-17 03:17:29.847261 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-17 03:17:29.866177 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-17 03:17:29.883392 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-17 03:17:29.900749 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-17 03:17:29.910642 (Thread-3): handling status request
2021-05-17 03:17:29.911009 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d780bc9-d899-4964-a929-ff0977524947', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9dde93f1f0>]}
2021-05-17 03:17:29.911637 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.4.10
2021-05-17 03:17:29.917716 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-17 03:17:30.215512 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-17 03:17:30.238334 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-17 03:17:30.267592 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-17 03:17:30.300328 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-17 03:17:30.323144 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-17 03:17:30.350350 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-17 03:17:30.375866 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-17 03:17:30.392488 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-17 03:17:30.408735 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-17 03:17:30.424481 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-17 03:17:30.438627 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-17 03:17:30.457646 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-17 03:17:30.769165 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-17 03:17:30.785329 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-17 03:17:30.811275 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-17 03:17:31.058056 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-17 03:17:31.191472 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-17 03:17:31.206592 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-17 03:17:31.221580 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-17 03:17:31.425817 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-17 03:17:31.459820 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-17 03:17:31.485344 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-17 03:17:31.515395 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-17 03:17:31.566388 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-17 03:17:31.622016 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-17 03:17:31.636249 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-17 03:17:31.651090 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-17 03:17:31.665892 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-17 03:17:31.679938 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-17 03:17:31.928266 (Thread-4): handling status request
2021-05-17 03:17:31.954458 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d780bc9-d899-4964-a929-ff0977524947', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ddefaa8b0>]}
2021-05-17 03:17:31.960363 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.199
2021-05-17 03:17:32.164802 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-17 03:17:32.180777 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-17 03:17:32.197017 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-17 03:17:32.214461 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-17 03:17:32.256310 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-17 03:17:32.273450 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-17 03:17:32.289481 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-17 03:17:32.376978 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-17 03:17:32.390944 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-17 03:17:32.533092 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-17 03:17:32.548205 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-17 03:17:32.565177 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-17 03:17:32.582117 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-17 03:17:32.828174 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-17 03:17:32.851626 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-17 03:17:32.885447 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-17 03:17:32.928336 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-17 03:17:32.950451 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-17 03:17:32.966688 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-17 03:17:32.983975 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-17 03:17:33.000321 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-17 03:17:33.295938 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-17 03:17:33.310790 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-17 03:17:33.326508 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-17 03:17:33.355881 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-17 03:17:33.370535 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-17 03:17:33.508117 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-17 03:17:33.533896 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-17 03:17:33.688482 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-17 03:17:33.739132 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-17 03:17:33.790900 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-17 03:17:33.844686 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-17 03:17:33.872569 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-17 03:17:33.888278 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-17 03:17:33.903728 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-17 03:17:33.913431 (Thread-5): handling status request
2021-05-17 03:17:33.913757 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d780bc9-d899-4964-a929-ff0977524947', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ddeeb48b0>]}
2021-05-17 03:17:33.914387 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.167
2021-05-17 03:17:33.919697 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-17 03:17:33.934888 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-17 03:17:33.950124 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-17 03:17:34.237134 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-17 03:17:34.253521 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-17 03:17:34.269375 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-17 03:17:34.290641 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-17 03:17:34.305124 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-17 03:17:34.573844 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-17 03:17:34.587687 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-17 03:17:34.608946 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-17 03:17:34.623335 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-17 03:17:34.746391 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-17 03:17:34.898791 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-17 03:17:34.914994 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-17 03:17:35.163477 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-17 03:17:35.487934 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Stage_Layer
- models.DBTTest.sources
- models.DBTTest.Targets
- models.DBTTest.utils
- models.DBTTest.marts
- models.DBTTest.Views
- seeds.DBTTest

2021-05-17 03:17:37.951061 (Thread-6): handling status request
2021-05-17 03:17:37.951477 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d780bc9-d899-4964-a929-ff0977524947', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ddea41100>]}
2021-05-17 03:17:37.972462 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.36.138
2021-05-18 07:47:00.711239 (MainThread): Running with dbt=0.18.1
2021-05-18 07:47:00.987234 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 07:47:00.999540 (MainThread): Tracking: tracking
2021-05-18 07:47:00.999795 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f35003bcf10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34fd4e6460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34f5dea850>]}
2021-05-18 07:47:01.000141 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-18 07:47:01.000565 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 07:47:01.008366 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 07:47:01.051449 (Thread-2): handling status request
2021-05-18 07:47:01.051827 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '983b0fdd-858c-4ee2-bd94-ebf7a6870bd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34f5e028b0>]}
2021-05-18 07:47:01.053549 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.81
2021-05-18 07:47:01.662556 (Thread-1): Parsing macros/metrics.sql
2021-05-18 07:47:01.678501 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 07:47:01.688214 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 07:47:01.692296 (Thread-1): Parsing macros/adapters.sql
2021-05-18 07:47:01.720153 (Thread-1): Parsing macros/catalog.sql
2021-05-18 07:47:01.722096 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 07:47:01.725902 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 07:47:01.727867 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 07:47:01.736816 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 07:47:01.738980 (Thread-1): Parsing macros/core.sql
2021-05-18 07:47:01.742514 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 07:47:01.751210 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 07:47:01.765129 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 07:47:01.766843 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 07:47:01.782814 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 07:47:01.810662 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 07:47:01.815641 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 07:47:01.822137 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 07:47:01.842753 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 07:47:01.849223 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 07:47:01.851018 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 07:47:01.856860 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 07:47:01.858468 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 07:47:01.859611 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 07:47:01.868233 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 07:47:01.869189 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 07:47:01.870812 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 07:47:01.872760 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 07:47:01.874271 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 07:47:01.876963 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 07:47:01.878824 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 07:47:01.880599 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 07:47:01.930069 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 07:47:01.952481 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 07:47:01.989456 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 07:47:01.997780 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 07:47:02.004217 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 07:47:02.010686 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 07:47:02.018910 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 07:47:02.027437 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 07:47:02.036065 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 07:47:02.044010 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 07:47:02.055052 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 07:47:02.062704 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 07:47:02.074975 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 07:47:02.081554 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 07:47:02.088160 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 07:47:02.097675 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 07:47:02.107288 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 07:47:02.115638 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 07:47:02.128191 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 07:47:02.138227 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 07:47:02.145626 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 07:47:02.159664 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 07:47:02.187948 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 07:47:02.194868 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 07:47:02.202757 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 07:47:02.210232 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 07:47:02.219656 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 07:47:02.227244 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 07:47:02.234389 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 07:47:02.241073 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 07:47:02.249883 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 07:47:02.258314 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 07:47:02.265822 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 07:47:02.274059 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 07:47:02.285992 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 07:47:02.295124 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 07:47:02.304125 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 07:47:02.312603 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 07:47:02.324980 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 07:47:02.332862 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 07:47:02.340362 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 07:47:02.348505 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 07:47:02.357447 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 07:47:02.363889 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 07:47:02.372495 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 07:47:02.380676 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 07:47:02.390968 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 07:47:02.400151 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 07:47:02.408452 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 07:47:02.416629 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 07:47:02.433299 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 07:47:02.440942 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 07:47:02.453297 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 07:47:02.462431 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 07:47:02.470868 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 07:47:02.480042 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 07:47:02.491306 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 07:47:02.499716 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 07:47:02.507966 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 07:47:02.516927 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 07:47:02.525334 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 07:47:02.537281 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 07:47:02.547383 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 07:47:02.563141 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 07:47:02.583555 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 07:47:02.611913 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 07:47:02.624476 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 07:47:02.636511 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 07:47:02.644817 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 07:47:02.663435 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 07:47:02.673650 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 07:47:02.685204 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 07:47:02.698009 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 07:47:02.717083 (Thread-3): handling status request
2021-05-18 07:47:02.717434 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '983b0fdd-858c-4ee2-bd94-ebf7a6870bd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34f5593d90>]}
2021-05-18 07:47:02.718129 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.212
2021-05-18 07:47:02.724199 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 07:47:02.745972 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 07:47:02.755852 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 07:47:02.769744 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 07:47:02.807671 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 07:47:02.824572 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 07:47:02.831998 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 07:47:02.839161 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 07:47:02.846172 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 07:47:02.853350 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 07:47:02.861799 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 07:47:02.869749 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 07:47:02.877599 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 07:47:02.885777 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 07:47:02.892066 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 07:47:02.898879 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 07:47:02.906323 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 07:47:02.913818 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 07:47:02.923098 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 07:47:02.930046 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 07:47:02.936516 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 07:47:02.943166 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 07:47:02.949621 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 07:47:02.956941 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 07:47:02.963006 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 07:47:02.970744 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 07:47:02.976764 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 07:47:02.991175 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 07:47:02.997495 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 07:47:03.007286 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 07:47:03.015967 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 07:47:03.023464 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 07:47:03.031899 (Thread-1): Parsing macros/first_value.sql
2021-05-18 07:47:03.040543 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 07:47:03.049374 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 07:47:03.177735 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 07:47:03.194929 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 07:47:03.205298 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 07:47:03.213474 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 07:47:03.220364 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 07:47:03.230466 (Thread-1): Parsing macros/percentile.sql
2021-05-18 07:47:03.238564 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 07:47:03.246036 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 07:47:03.255859 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 07:47:03.265434 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 07:47:03.272714 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 07:47:03.279875 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 07:47:03.286940 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 07:47:03.293931 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 07:47:03.300880 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 07:47:03.308778 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 07:47:03.323918 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 07:47:03.424713 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 07:47:03.458929 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 07:47:03.475462 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 07:47:03.491918 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 07:47:03.508515 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 07:47:03.521183 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 07:47:03.536883 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 07:47:03.553701 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 07:47:03.574972 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 07:47:03.613796 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 07:47:03.866176 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 07:47:03.912657 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 07:47:03.993473 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 07:47:04.027049 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 07:47:04.049680 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 07:47:04.069281 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 07:47:04.232190 (Thread-4): handling status request
2021-05-18 07:47:04.247850 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '983b0fdd-858c-4ee2-bd94-ebf7a6870bd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34f5100f40>]}
2021-05-18 07:47:04.253639 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.24.25
2021-05-18 07:47:04.393288 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 07:47:04.413821 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 07:47:04.434726 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 07:47:04.539512 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 07:47:04.555124 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 07:47:04.569949 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 07:47:04.585336 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 07:47:04.600902 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 07:47:04.615316 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 07:47:04.629935 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 07:47:04.645482 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 07:47:04.660427 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 07:47:04.675699 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 07:47:04.690518 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 07:47:04.704882 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 07:47:04.721249 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 07:47:04.741673 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 07:47:04.758010 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 07:47:04.776387 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 07:47:04.792778 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 07:47:04.808168 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 07:47:04.822505 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 07:47:05.087257 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 07:47:05.112012 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 07:47:05.140636 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 07:47:05.174730 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 07:47:05.198450 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 07:47:05.227522 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 07:47:05.254702 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 07:47:05.272081 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 07:47:05.288734 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 07:47:05.305664 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 07:47:05.323003 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 07:47:05.340222 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 07:47:05.658637 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 07:47:05.677441 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 07:47:05.705602 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 07:47:05.818262 (Thread-5): handling status request
2021-05-18 07:47:05.833865 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '983b0fdd-858c-4ee2-bd94-ebf7a6870bd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34f4eb76a0>]}
2021-05-18 07:47:05.834538 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.11.88
2021-05-18 07:47:06.069047 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 07:47:06.083571 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 07:47:06.097938 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 07:47:06.114659 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 07:47:06.297728 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 07:47:06.328292 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 07:47:06.351393 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 07:47:06.376686 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 07:47:06.423344 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 07:47:06.478354 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 07:47:06.491998 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 07:47:06.506491 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 07:47:06.520557 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 07:47:06.534596 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 07:47:07.146893 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 07:47:07.163381 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 07:47:07.179219 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 07:47:07.194891 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 07:47:07.234588 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 07:47:07.250583 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 07:47:07.266419 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 07:47:07.362312 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 07:47:07.371819 (Thread-6): handling status request
2021-05-18 07:47:07.372182 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '983b0fdd-858c-4ee2-bd94-ebf7a6870bd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34f4fcea30>]}
2021-05-18 07:47:07.372819 (Thread-6): sending response (<Response 184 bytes [200 OK]>) to 10.0.5.229
2021-05-18 07:47:07.377889 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 07:47:07.397122 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 07:47:07.412839 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 07:47:07.428134 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 07:47:07.443502 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 07:47:07.677237 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 07:47:07.699649 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 07:47:07.736577 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 07:47:07.778377 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 07:47:07.799744 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 07:47:07.820666 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 07:47:07.836469 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 07:47:07.851603 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 07:47:08.141269 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 07:47:08.273108 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 07:47:08.287108 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 07:47:08.314711 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 07:47:08.329558 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 07:47:08.464155 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 07:47:08.488747 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 07:47:08.518778 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 07:47:08.567550 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 07:47:08.613497 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 07:47:08.669720 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 07:47:08.698274 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 07:47:08.713529 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 07:47:08.729838 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 07:47:08.746900 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 07:47:08.762366 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 07:47:08.779847 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 07:47:08.920751 (Thread-7): handling status request
2021-05-18 07:47:08.941477 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '983b0fdd-858c-4ee2-bd94-ebf7a6870bd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f34f5452190>]}
2021-05-18 07:47:08.952324 (Thread-7): sending response (<Response 184 bytes [200 OK]>) to 10.0.9.201
2021-05-18 07:47:09.048896 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 07:47:09.065178 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 07:47:09.081809 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 07:47:09.106516 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 07:47:09.123189 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 07:47:09.535173 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 07:47:09.550559 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 07:47:09.577129 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 07:47:09.599681 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 07:47:09.727695 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 07:47:09.757690 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 07:47:09.773318 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 07:47:10.010346 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 07:47:10.318245 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.marts
- models.DBTTest.Views
- models.DBTTest.utils
- models.DBTTest.Stage_Layer
- models.DBTTest.sources
- models.DBTTest.Targets
- seeds.DBTTest

2021-05-18 07:47:10.956515 (Thread-8): handling status request
2021-05-18 07:47:10.956927 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '983b0fdd-858c-4ee2-bd94-ebf7a6870bd1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3503e413d0>]}
2021-05-18 07:47:10.978096 (Thread-8): sending response (<Response 81715 bytes [200 OK]>) to 10.0.47.20
2021-05-18 07:49:57.011722 (MainThread): Running with dbt=0.18.1
2021-05-18 07:49:57.289509 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 07:49:57.301847 (MainThread): Tracking: tracking
2021-05-18 07:49:57.302080 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69c066ff70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69bd79a4c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69b60a1970>]}
2021-05-18 07:49:57.302424 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-18 07:49:57.309698 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 07:49:57.313183 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 07:49:57.865323 (Thread-1): Parsing macros/metrics.sql
2021-05-18 07:49:57.878234 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 07:49:57.882833 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 07:49:57.886810 (Thread-1): Parsing macros/adapters.sql
2021-05-18 07:49:57.914816 (Thread-1): Parsing macros/catalog.sql
2021-05-18 07:49:57.916779 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 07:49:57.920563 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 07:49:57.922488 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 07:49:57.931426 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 07:49:57.933584 (Thread-1): Parsing macros/core.sql
2021-05-18 07:49:57.937160 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 07:49:57.945985 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 07:49:57.959802 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 07:49:57.961519 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 07:49:57.977558 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 07:49:58.004927 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 07:49:58.009758 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 07:49:58.015822 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 07:49:58.036101 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 07:49:58.042563 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 07:49:58.044375 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 07:49:58.050274 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 07:49:58.051874 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 07:49:58.052937 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 07:49:58.061557 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 07:49:58.062502 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 07:49:58.064147 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 07:49:58.066078 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 07:49:58.067605 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 07:49:58.070446 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 07:49:58.072322 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 07:49:58.074036 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 07:49:58.121735 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 07:49:58.144503 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 07:49:58.168623 (Thread-2): handling status request
2021-05-18 07:49:58.168998 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'ad84ea04-a1ac-4f92-ba6c-912eaed70a73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69b5fa5df0>]}
2021-05-18 07:49:58.170659 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.18.9
2021-05-18 07:49:58.190883 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 07:49:58.194967 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 07:49:58.198548 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 07:49:58.202417 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 07:49:58.208419 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 07:49:58.214707 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 07:49:58.220483 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 07:49:58.226002 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 07:49:58.233459 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 07:49:58.238160 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 07:49:58.247431 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 07:49:58.251846 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 07:49:58.256180 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 07:49:58.262653 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 07:49:58.267979 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 07:49:58.271990 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 07:49:58.281890 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 07:49:58.287949 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 07:49:58.291979 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 07:49:58.305483 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 07:49:58.331698 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 07:49:58.336329 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 07:49:58.341561 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 07:49:58.346748 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 07:49:58.353282 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 07:49:58.357739 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 07:49:58.361553 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 07:49:58.365903 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 07:49:58.372853 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 07:49:58.377800 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 07:49:58.382814 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 07:49:58.388011 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 07:49:58.397341 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 07:49:58.404089 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 07:49:58.412052 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 07:49:58.417162 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 07:49:58.423227 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 07:49:58.428507 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 07:49:58.435251 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 07:49:58.440608 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 07:49:58.450182 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 07:49:58.454545 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 07:49:58.462302 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 07:49:58.468189 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 07:49:58.473865 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 07:49:58.480935 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 07:49:58.486796 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 07:49:58.492028 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 07:49:58.505796 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 07:49:58.511392 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 07:49:58.522347 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 07:49:58.528139 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 07:49:58.532510 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 07:49:58.538398 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 07:49:58.547093 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 07:49:58.552373 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 07:49:58.557013 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 07:49:58.563804 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 07:49:58.570054 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 07:49:58.577476 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 07:49:58.588809 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 07:49:58.599083 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 07:49:58.615396 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 07:49:58.636799 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 07:49:58.645293 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 07:49:58.655150 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 07:49:58.660713 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 07:49:58.675476 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 07:49:58.683227 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 07:49:58.692185 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 07:49:58.702958 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 07:49:58.725982 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 07:49:58.743087 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 07:49:58.749816 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 07:49:58.760020 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 07:49:58.787271 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 07:49:58.801998 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 07:49:58.807621 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 07:49:58.811732 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 07:49:58.816153 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 07:49:58.819848 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 07:49:58.825130 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 07:49:58.831039 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 07:49:58.835098 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 07:49:58.839800 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 07:49:58.844024 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 07:49:58.847994 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 07:49:58.851908 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 07:49:58.855623 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 07:49:58.860935 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 07:49:58.864530 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 07:49:58.868588 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 07:49:58.872405 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 07:49:58.875872 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 07:49:58.879738 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 07:49:58.883538 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 07:49:58.886966 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 07:49:58.891737 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 07:49:58.900557 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 07:49:58.904448 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 07:49:58.910723 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 07:49:58.914831 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 07:49:58.918764 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 07:49:58.923284 (Thread-1): Parsing macros/first_value.sql
2021-05-18 07:49:58.931349 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 07:49:58.936710 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 07:49:58.943377 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 07:49:58.955859 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 07:49:58.961672 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 07:49:58.966996 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 07:49:58.970796 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 07:49:59.086418 (Thread-1): Parsing macros/percentile.sql
2021-05-18 07:49:59.091481 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 07:49:59.095767 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 07:49:59.103722 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 07:49:59.110546 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 07:49:59.114647 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 07:49:59.119863 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 07:49:59.124695 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 07:49:59.128931 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 07:49:59.133419 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 07:49:59.137862 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 07:49:59.150061 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 07:49:59.247035 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 07:49:59.276581 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 07:49:59.290937 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 07:49:59.306729 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 07:49:59.323426 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 07:49:59.336666 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 07:49:59.352501 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 07:49:59.367348 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 07:49:59.386966 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 07:49:59.434537 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 07:49:59.694352 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 07:49:59.744130 (Thread-3): handling status request
2021-05-18 07:49:59.744528 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'ad84ea04-a1ac-4f92-ba6c-912eaed70a73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69b5509970>]}
2021-05-18 07:49:59.745194 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.5.229
2021-05-18 07:49:59.752265 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 07:49:59.827460 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 07:49:59.855270 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 07:49:59.871515 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 07:49:59.888530 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 07:50:00.214176 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 07:50:00.230623 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 07:50:00.248478 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 07:50:00.348471 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 07:50:00.365707 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 07:50:00.380357 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 07:50:00.395173 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 07:50:00.409612 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 07:50:00.435118 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 07:50:00.449627 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 07:50:00.464595 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 07:50:00.479478 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 07:50:00.494760 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 07:50:00.514087 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 07:50:00.528137 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 07:50:00.542143 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 07:50:00.561187 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 07:50:00.577460 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 07:50:00.592805 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 07:50:00.608922 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 07:50:00.623804 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 07:50:00.638236 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 07:50:00.926282 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 07:50:00.947895 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 07:50:00.973946 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 07:50:01.004569 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 07:50:01.026571 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 07:50:01.054875 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 07:50:01.079746 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 07:50:01.094346 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 07:50:01.109533 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 07:50:01.123798 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 07:50:01.138079 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 07:50:01.152241 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 07:50:01.293363 (Thread-4): handling status request
2021-05-18 07:50:01.293748 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'ad84ea04-a1ac-4f92-ba6c-912eaed70a73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69b51b2d00>]}
2021-05-18 07:50:01.294382 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.9.201
2021-05-18 07:50:01.463111 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 07:50:01.478547 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 07:50:01.503797 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 07:50:01.879704 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 07:50:01.894201 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 07:50:01.908566 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 07:50:01.923170 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 07:50:02.113677 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 07:50:02.145708 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 07:50:02.168745 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 07:50:02.200006 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 07:50:02.263656 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 07:50:02.320621 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 07:50:02.336085 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 07:50:02.355666 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 07:50:02.370097 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 07:50:02.384344 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 07:50:02.840623 (Thread-5): handling status request
2021-05-18 07:50:02.856412 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'ad84ea04-a1ac-4f92-ba6c-912eaed70a73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69b51e9eb0>]}
2021-05-18 07:50:02.857195 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.24.25
2021-05-18 07:50:02.989444 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 07:50:03.006635 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 07:50:03.022079 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 07:50:03.038140 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 07:50:03.075823 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 07:50:03.091608 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 07:50:03.106825 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 07:50:03.200398 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 07:50:03.214341 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 07:50:03.233364 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 07:50:03.249248 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 07:50:03.268401 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 07:50:03.283755 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 07:50:03.511265 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 07:50:03.534146 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 07:50:03.566922 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 07:50:03.608173 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 07:50:03.629192 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 07:50:03.644806 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 07:50:03.660004 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 07:50:03.675155 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 07:50:03.961151 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 07:50:04.091856 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 07:50:04.113562 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 07:50:04.142373 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 07:50:04.157930 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 07:50:04.292778 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 07:50:04.318105 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 07:50:04.348955 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 07:50:04.403107 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 07:50:04.449999 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 07:50:04.502453 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 07:50:04.536209 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 07:50:04.552378 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 07:50:04.567640 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 07:50:04.582733 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 07:50:04.597695 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 07:50:04.613313 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 07:50:04.864641 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 07:50:04.880342 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 07:50:04.895936 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 07:50:04.917576 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 07:50:04.931829 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 07:50:05.323038 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 07:50:05.337763 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 07:50:05.360687 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 07:50:05.374856 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 07:50:05.493420 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 07:50:05.523744 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 07:50:05.541257 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 07:50:05.775900 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 07:50:06.075085 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Stage_Layer
- models.DBTTest.sources
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.utils
- models.DBTTest.marts
- seeds.DBTTest

2021-05-18 07:50:08.111831 (Thread-6): handling status request
2021-05-18 07:50:08.114036 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'ad84ea04-a1ac-4f92-ba6c-912eaed70a73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69b52a7e20>]}
2021-05-18 07:50:08.134832 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.47.20
2021-05-18 07:50:17.717984 (Thread-7): handling status request
2021-05-18 07:50:17.718417 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'ad84ea04-a1ac-4f92-ba6c-912eaed70a73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69b5197ca0>]}
2021-05-18 07:50:17.739727 (Thread-7): sending response (<Response 81715 bytes [200 OK]>) to 10.0.9.201
2021-05-18 07:50:18.660119 (Thread-8): handling run_sql request
2021-05-18 07:50:18.660539 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'ad84ea04-a1ac-4f92-ba6c-912eaed70a73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69b60d33a0>]}
2021-05-18 07:50:18.663157 (Thread-8): Connection 'model.dbt_date.dates' was properly closed.
2021-05-18 07:50:19.671347 (Thread-8): sending response (<Response 137 bytes [200 OK]>) to 10.0.18.9
2021-05-18 07:50:19.691973 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 07:50:19.714837 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 07:50:19.715287 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 07:50:19.715394 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 07:50:19.728779 (Thread-1): finished collecting timing info
2021-05-18 07:50:19.738338 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 07:50:19.738414 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='EMAIL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  --where 1=1
--r_timeframe_type='W'
--  and r_metric_id=66
--  and r_type='Month'
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 07:50:19.738487 (Thread-1): Opening a new connection, currently in state init
2021-05-18 07:50:20.218317 (Thread-9): handling poll request
2021-05-18 07:50:20.218766 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'ad84ea04-a1ac-4f92-ba6c-912eaed70a73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69b4da59a0>]}
2021-05-18 07:50:20.223409 (Thread-9): sending response (<Response 16813 bytes [200 OK]>) to 10.0.10.193
2021-05-18 07:50:21.339000 (Thread-1): Snowflake query id: 019c52f6-0000-1335-0000-00011b5e9995
2021-05-18 07:50:21.339136 (Thread-1): Snowflake error: 002003 (42S02): SQL compilation error:
Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.
2021-05-18 07:50:21.339293 (Thread-1): finished collecting timing info
2021-05-18 07:50:21.339658 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 07:50:21.576296 (Thread-1): Got an exception: Database Error
  002003 (42S02): SQL compilation error:
  Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 002003 (42S02): SQL compilation error:
Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  002003 (42S02): SQL compilation error:
  Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.
2021-05-18 07:50:21.577979 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  002003 (42S02): SQL compilation error:\n  Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing MEETING) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'EMAIL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result  --where 1=1\n--r_timeframe_type=\'W\'\n--  and r_metric_id=66\n--  and r_type=\'Month\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing MEETING) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'EMAIL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result  --where 1=1\n--r_timeframe_type=\'W\'\n--  and r_metric_id=66\n--  and r_type=\'Month\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  002003 (42S02): SQL compilation error:\n  Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing MEETING) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'EMAIL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result  --where 1=1\n--r_timeframe_type=\'W\'\n--  and r_metric_id=66\n--  and r_type=\'Month\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing MEETING) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'EMAIL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result  --where 1=1\n--r_timeframe_type=\'W\'\n--  and r_metric_id=66\n--  and r_type=\'Month\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-18 07:50:21.774486 (Thread-10): handling poll request
2021-05-18 07:50:21.774892 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'ad84ea04-a1ac-4f92-ba6c-912eaed70a73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f69b4da5370>]}
2021-05-18 07:50:21.776317 (Thread-10): sending response (<Response 109233 bytes [200 OK]>) to 10.0.37.9
2021-05-18 07:59:51.326970 (MainThread): Running with dbt=0.18.1
2021-05-18 07:59:51.584581 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 07:59:51.596870 (MainThread): Tracking: tracking
2021-05-18 07:59:51.597075 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0cc0f0e20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c921e310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c1b21760>]}
2021-05-18 07:59:51.597429 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-18 07:59:51.599599 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 07:59:51.608169 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 07:59:51.689971 (Thread-2): handling status request
2021-05-18 07:59:51.700577 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d4e82ac-8e28-4c91-a831-6f971892ef08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c1b48a00>]}
2021-05-18 07:59:51.706533 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.24.25
2021-05-18 07:59:52.066265 (Thread-1): Parsing macros/metrics.sql
2021-05-18 07:59:52.077665 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 07:59:52.080869 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 07:59:52.084837 (Thread-1): Parsing macros/adapters.sql
2021-05-18 07:59:52.114018 (Thread-1): Parsing macros/catalog.sql
2021-05-18 07:59:52.115984 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 07:59:52.119854 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 07:59:52.121803 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 07:59:52.130745 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 07:59:52.132931 (Thread-1): Parsing macros/core.sql
2021-05-18 07:59:52.136479 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 07:59:52.145080 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 07:59:52.158862 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 07:59:52.160601 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 07:59:52.176590 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 07:59:52.204494 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 07:59:52.209352 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 07:59:52.215398 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 07:59:52.235440 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 07:59:52.241896 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 07:59:52.250103 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 07:59:52.255968 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 07:59:52.257575 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 07:59:52.258646 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 07:59:52.267296 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 07:59:52.268247 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 07:59:52.269892 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 07:59:52.271847 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 07:59:52.273366 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 07:59:52.276035 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 07:59:52.277939 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 07:59:52.279723 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 07:59:52.325318 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 07:59:52.342888 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 07:59:52.376654 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 07:59:52.379283 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 07:59:52.381836 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 07:59:52.384316 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 07:59:52.389230 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 07:59:52.394753 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 07:59:52.399562 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 07:59:52.403275 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 07:59:52.410141 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 07:59:52.413164 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 07:59:52.421343 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 07:59:52.424361 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 07:59:52.427289 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 07:59:52.431546 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 07:59:52.435808 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 07:59:52.438620 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 07:59:52.446518 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 07:59:52.451852 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 07:59:52.454847 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 07:59:52.464339 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 07:59:52.488775 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 07:59:52.491733 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 07:59:52.495570 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 07:59:52.498533 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 07:59:52.503577 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 07:59:52.506348 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 07:59:52.509011 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 07:59:52.511669 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 07:59:52.516762 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 07:59:52.519968 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 07:59:52.523009 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 07:59:52.526500 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 07:59:52.534046 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 07:59:52.537978 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 07:59:52.542191 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 07:59:52.545334 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 07:59:52.548572 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 07:59:52.551345 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 07:59:52.555012 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 07:59:52.558105 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 07:59:52.563412 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 07:59:52.566296 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 07:59:52.570422 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 07:59:52.573635 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 07:59:52.576866 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 07:59:52.581067 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 07:59:52.583970 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 07:59:52.587481 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 07:59:52.601286 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 07:59:52.605638 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 07:59:52.613876 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 07:59:52.617683 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 07:59:52.620396 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 07:59:52.624359 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 07:59:52.633477 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 07:59:52.637065 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 07:59:52.640103 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 07:59:52.644137 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 07:59:52.648814 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 07:59:52.652490 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 07:59:52.657172 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 07:59:52.665508 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 07:59:52.679549 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 07:59:52.699292 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 07:59:52.706387 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 07:59:52.713005 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 07:59:52.716824 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 07:59:52.730740 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 07:59:52.737347 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 07:59:52.742863 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 07:59:52.749777 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 07:59:52.772302 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 07:59:52.788775 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 07:59:52.794644 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 07:59:52.802484 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 07:59:52.823293 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 07:59:52.836136 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 07:59:52.839990 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 07:59:52.842877 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 07:59:52.846213 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 07:59:52.849321 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 07:59:52.853727 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 07:59:52.857621 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 07:59:52.860148 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 07:59:52.863781 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 07:59:52.866516 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 07:59:52.869190 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 07:59:52.872185 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 07:59:52.874823 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 07:59:52.879422 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 07:59:52.882274 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 07:59:52.885257 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 07:59:52.888329 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 07:59:52.890887 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 07:59:52.894070 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 07:59:52.896702 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 07:59:52.899132 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 07:59:52.902725 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 07:59:52.910685 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 07:59:52.913883 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 07:59:52.919231 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 07:59:52.922240 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 07:59:52.925279 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 07:59:52.929115 (Thread-1): Parsing macros/first_value.sql
2021-05-18 07:59:52.933390 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 07:59:52.937472 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 07:59:53.044052 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 07:59:53.055620 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 07:59:53.060657 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 07:59:53.065249 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 07:59:53.068293 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 07:59:53.075012 (Thread-1): Parsing macros/percentile.sql
2021-05-18 07:59:53.078760 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 07:59:53.081960 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 07:59:53.087747 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 07:59:53.090967 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 07:59:53.093986 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 07:59:53.097838 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 07:59:53.100957 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 07:59:53.104575 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 07:59:53.108067 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 07:59:53.112316 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 07:59:53.129429 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 07:59:53.226691 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 07:59:53.252167 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 07:59:53.267719 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 07:59:53.280371 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 07:59:53.293407 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 07:59:53.307023 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 07:59:53.319116 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 07:59:53.331285 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 07:59:53.349330 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 07:59:53.385482 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 07:59:53.402235 (Thread-3): handling status request
2021-05-18 07:59:53.402702 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d4e82ac-8e28-4c91-a831-6f971892ef08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c0fd8550>]}
2021-05-18 07:59:53.403436 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.212
2021-05-18 07:59:53.652177 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 07:59:53.693694 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 07:59:53.767256 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 07:59:53.794249 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 07:59:53.809841 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 07:59:53.825603 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 07:59:54.128964 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 07:59:54.143860 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 07:59:54.160536 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 07:59:54.254950 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 07:59:54.270644 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 07:59:54.285739 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 07:59:54.300075 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 07:59:54.314516 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 07:59:54.328888 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 07:59:54.343131 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 07:59:54.358375 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 07:59:54.372560 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 07:59:54.387570 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 07:59:54.401873 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 07:59:54.416198 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 07:59:54.430315 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 07:59:54.449795 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 07:59:54.466041 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 07:59:54.482171 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 07:59:54.497528 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 07:59:54.513128 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 07:59:54.532490 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 07:59:54.818489 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 07:59:54.839478 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 07:59:54.865310 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 07:59:54.896127 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 07:59:54.918211 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 07:59:54.945072 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 07:59:54.969937 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 07:59:54.984243 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 07:59:54.998073 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 07:59:55.011662 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 07:59:55.025297 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 07:59:55.038814 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 07:59:55.089112 (Thread-4): handling status request
2021-05-18 07:59:55.105684 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d4e82ac-8e28-4c91-a831-6f971892ef08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c0af4ca0>]}
2021-05-18 07:59:55.116700 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.37.9
2021-05-18 07:59:55.335655 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 07:59:55.350666 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 07:59:55.375085 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 07:59:55.611415 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 07:59:55.627046 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 07:59:55.758463 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 07:59:55.774033 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 07:59:55.958918 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 07:59:55.993852 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 07:59:56.017801 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 07:59:56.043450 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 07:59:56.090169 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 07:59:56.146241 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 07:59:56.160329 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 07:59:56.174631 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 07:59:56.189301 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 07:59:56.203498 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 07:59:56.657336 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 07:59:56.673088 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 07:59:56.688595 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 07:59:56.703762 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 07:59:56.735877 (Thread-5): handling status request
2021-05-18 07:59:56.736220 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d4e82ac-8e28-4c91-a831-6f971892ef08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c1162520>]}
2021-05-18 07:59:56.736846 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.38.35
2021-05-18 07:59:56.741663 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 07:59:56.757497 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 07:59:56.773606 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 07:59:56.965887 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 07:59:56.980723 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 07:59:57.000074 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 07:59:57.014468 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 07:59:57.030124 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 07:59:57.046034 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 07:59:57.268783 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 07:59:57.291309 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 07:59:57.324121 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 07:59:57.365182 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 07:59:57.390012 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 07:59:57.405925 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 07:59:57.421253 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 07:59:57.436347 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 07:59:57.716672 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 07:59:57.732264 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 07:59:57.746477 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 07:59:57.777521 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 07:59:57.792665 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 07:59:58.035392 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 07:59:58.061227 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 07:59:58.090938 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 07:59:58.140855 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 07:59:58.187371 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 07:59:58.239121 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 07:59:58.266661 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 07:59:58.281925 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 07:59:58.297265 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 07:59:58.312488 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 07:59:58.327889 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 07:59:58.343170 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 07:59:58.592176 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 07:59:58.607856 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 07:59:58.623929 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 07:59:58.645468 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 07:59:58.659995 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 07:59:58.943457 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 07:59:58.957307 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 07:59:58.978491 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 07:59:58.992885 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 07:59:59.224058 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 07:59:59.254206 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 07:59:59.270263 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 07:59:59.493858 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 07:59:59.792503 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.sources
- models.DBTTest.Targets
- models.DBTTest.marts
- models.DBTTest.utils
- models.DBTTest.Stage_Layer
- models.DBTTest.Views
- seeds.DBTTest

2021-05-18 08:00:01.680554 (Thread-6): handling status request
2021-05-18 08:00:01.680992 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d4e82ac-8e28-4c91-a831-6f971892ef08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c1104250>]}
2021-05-18 08:00:01.702136 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.26.76
2021-05-18 08:00:15.103590 (Thread-7): handling status request
2021-05-18 08:00:15.105238 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d4e82ac-8e28-4c91-a831-6f971892ef08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c0a1a550>]}
2021-05-18 08:00:15.125998 (Thread-7): sending response (<Response 81715 bytes [200 OK]>) to 10.0.23.200
2021-05-18 08:00:15.739971 (Thread-8): handling run_sql request
2021-05-18 08:00:15.740481 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d4e82ac-8e28-4c91-a831-6f971892ef08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c0bc7850>]}
2021-05-18 08:00:15.743076 (Thread-8): Connection 'model.dbt_date.dates' was properly closed.
2021-05-18 08:00:16.747710 (Thread-8): sending response (<Response 137 bytes [200 OK]>) to 10.0.10.193
2021-05-18 08:00:16.767586 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:00:16.790376 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 08:00:16.790816 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:00:16.790924 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 08:00:16.804233 (Thread-1): finished collecting timing info
2021-05-18 08:00:16.805272 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 08:00:16.805331 (Thread-1): On rpc.DBTTest.request: With calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
)

select * from calendar
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 08:00:16.805385 (Thread-1): Opening a new connection, currently in state init
2021-05-18 08:00:17.346412 (Thread-9): handling poll request
2021-05-18 08:00:17.346893 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d4e82ac-8e28-4c91-a831-6f971892ef08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c1264a30>]}
2021-05-18 08:00:17.350690 (Thread-9): sending response (<Response 3814 bytes [200 OK]>) to 10.0.23.200
2021-05-18 08:00:18.932186 (Thread-10): handling poll request
2021-05-18 08:00:18.932634 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d4e82ac-8e28-4c91-a831-6f971892ef08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c0adaeb0>]}
2021-05-18 08:00:18.933538 (Thread-10): sending response (<Response 391 bytes [200 OK]>) to 10.0.37.9
2021-05-18 08:00:19.035714 (Thread-1): SQL status: SUCCESS 500 in 2.23 seconds
2021-05-18 08:00:19.056136 (Thread-1): finished collecting timing info
2021-05-18 08:00:19.056541 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 08:00:20.416521 (Thread-11): handling poll request
2021-05-18 08:00:20.417002 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '7d4e82ac-8e28-4c91-a831-6f971892ef08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa0c09a8f40>]}
2021-05-18 08:00:20.427376 (Thread-11): sending response (<Response 52916 bytes [200 OK]>) to 10.0.28.79
2021-05-18 08:16:27.307092 (MainThread): Running with dbt=0.18.1
2021-05-18 08:16:27.562663 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 08:16:27.574615 (MainThread): Tracking: tracking
2021-05-18 08:16:27.574839 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6fe69cf10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6fb7c7460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6f40cf910>]}
2021-05-18 08:16:27.575190 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-18 08:16:27.575551 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 08:16:27.577522 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 08:16:28.046795 (Thread-1): Parsing macros/metrics.sql
2021-05-18 08:16:28.058048 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 08:16:28.061164 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 08:16:28.065298 (Thread-1): Parsing macros/adapters.sql
2021-05-18 08:16:28.093371 (Thread-1): Parsing macros/catalog.sql
2021-05-18 08:16:28.095367 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 08:16:28.099115 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 08:16:28.101047 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 08:16:28.109932 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 08:16:28.112124 (Thread-1): Parsing macros/core.sql
2021-05-18 08:16:28.115708 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 08:16:28.124658 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 08:16:28.138397 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 08:16:28.140168 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 08:16:28.156122 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 08:16:28.183784 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 08:16:28.188578 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 08:16:28.194612 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 08:16:28.214970 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 08:16:28.221405 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 08:16:28.223213 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 08:16:28.229077 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 08:16:28.230667 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 08:16:28.231848 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 08:16:28.240488 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 08:16:28.241437 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 08:16:28.243094 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 08:16:28.245054 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 08:16:28.246552 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 08:16:28.249199 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 08:16:28.251076 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 08:16:28.252786 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 08:16:28.298797 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:16:28.314707 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:16:28.347178 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 08:16:28.349825 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 08:16:28.352604 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 08:16:28.355328 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 08:16:28.360095 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 08:16:28.364758 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 08:16:28.369484 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 08:16:28.373706 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 08:16:28.379822 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 08:16:28.382925 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 08:16:28.391310 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 08:16:28.394427 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 08:16:28.397210 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 08:16:28.402259 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 08:16:28.406988 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 08:16:28.410002 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 08:16:28.418227 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 08:16:28.423465 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 08:16:28.426890 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 08:16:28.436760 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 08:16:28.461579 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 08:16:28.464907 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 08:16:28.468950 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 08:16:28.472516 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 08:16:28.478298 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 08:16:28.481891 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 08:16:28.484693 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 08:16:28.487606 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 08:16:28.492950 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 08:16:28.496190 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 08:16:28.499247 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 08:16:28.502763 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 08:16:28.510378 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 08:16:28.514712 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 08:16:28.519471 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 08:16:28.522863 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 08:16:28.526333 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 08:16:28.529233 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 08:16:28.533203 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 08:16:28.536438 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 08:16:28.542257 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 08:16:28.545562 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 08:16:28.549918 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 08:16:28.553747 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 08:16:28.557125 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 08:16:28.561795 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 08:16:28.564933 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 08:16:28.568841 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 08:16:28.581309 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 08:16:28.586077 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 08:16:28.594876 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 08:16:28.598472 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 08:16:28.601661 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 08:16:28.605481 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 08:16:28.612891 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 08:16:28.616503 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 08:16:28.619606 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 08:16:28.624201 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 08:16:28.630466 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 08:16:28.634421 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 08:16:28.639112 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:16:28.647694 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:16:28.660806 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 08:16:28.680115 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:16:28.687199 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 08:16:28.693382 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:16:28.697450 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 08:16:28.710177 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 08:16:28.716474 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 08:16:28.721896 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:16:28.729074 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 08:16:28.748939 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:16:28.765188 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 08:16:28.771109 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 08:16:28.778978 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:16:28.799803 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 08:16:28.814641 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 08:16:28.818630 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 08:16:28.821803 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 08:16:28.825227 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 08:16:28.828032 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 08:16:28.832054 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 08:16:28.835986 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 08:16:28.839136 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 08:16:28.842769 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 08:16:28.845776 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 08:16:28.848876 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 08:16:28.851836 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 08:16:28.854659 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 08:16:28.859417 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 08:16:28.862386 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 08:16:28.865499 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 08:16:28.868374 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 08:16:28.871095 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 08:16:28.874159 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 08:16:28.876749 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 08:16:28.879188 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 08:16:28.882968 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 08:16:28.890579 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 08:16:28.893743 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 08:16:28.899004 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 08:16:28.902165 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 08:16:28.905036 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 08:16:28.908913 (Thread-1): Parsing macros/first_value.sql
2021-05-18 08:16:28.914079 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 08:16:28.919753 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 08:16:28.927325 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 08:16:28.943387 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 08:16:28.949739 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 08:16:28.955532 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 08:16:28.959364 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 08:16:29.079162 (Thread-1): Parsing macros/percentile.sql
2021-05-18 08:16:29.084531 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 08:16:29.088521 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 08:16:29.096497 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 08:16:29.100524 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 08:16:29.104269 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 08:16:29.109370 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 08:16:29.113675 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 08:16:29.117814 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 08:16:29.121299 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 08:16:29.124605 (Thread-2): handling status request
2021-05-18 08:16:29.124960 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '37472ff9-de64-481f-bfc5-6d13b74437a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6effb7ee0>]}
2021-05-18 08:16:29.126618 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.212
2021-05-18 08:16:29.128090 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 08:16:29.145782 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 08:16:29.247921 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 08:16:29.271708 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 08:16:29.284410 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 08:16:29.297275 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 08:16:29.309896 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 08:16:29.322859 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 08:16:29.335377 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 08:16:29.348015 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 08:16:29.369285 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 08:16:29.404517 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 08:16:29.655955 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 08:16:29.696680 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 08:16:29.768523 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 08:16:29.794988 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 08:16:29.810077 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 08:16:29.825840 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 08:16:30.128340 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 08:16:30.143918 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 08:16:30.160446 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 08:16:30.256710 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:16:30.272485 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:16:30.286986 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:16:30.302343 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:16:30.317150 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:16:30.331951 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:16:30.346968 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:16:30.362496 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:16:30.377801 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:16:30.393679 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:16:30.409938 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:16:30.428002 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:16:30.443288 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 08:16:30.463868 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:16:30.480616 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:16:30.497764 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:16:30.513879 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:16:30.530731 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:16:30.545738 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:16:30.788982 (Thread-3): handling status request
2021-05-18 08:16:30.804870 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '37472ff9-de64-481f-bfc5-6d13b74437a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6ef4da970>]}
2021-05-18 08:16:30.811950 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.79
2021-05-18 08:16:30.819623 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 08:16:30.840165 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 08:16:30.868594 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 08:16:30.898665 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 08:16:30.919106 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 08:16:30.944747 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 08:16:30.967627 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 08:16:30.981309 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 08:16:30.994493 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 08:16:31.007644 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 08:16:31.021996 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 08:16:31.037245 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 08:16:31.342991 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 08:16:31.358572 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 08:16:31.383086 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 08:16:31.727547 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 08:16:31.741801 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 08:16:31.755675 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 08:16:31.769327 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 08:16:31.954296 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 08:16:31.985643 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 08:16:32.008715 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 08:16:32.033832 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 08:16:32.082763 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 08:16:32.147165 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 08:16:32.170103 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 08:16:32.189716 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 08:16:32.204692 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 08:16:32.218883 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 08:16:32.392085 (Thread-4): handling status request
2021-05-18 08:16:32.413282 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '37472ff9-de64-481f-bfc5-6d13b74437a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6ef2ff130>]}
2021-05-18 08:16:32.424122 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.81
2021-05-18 08:16:32.699409 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 08:16:32.815966 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 08:16:32.835060 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 08:16:32.850385 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 08:16:32.888748 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 08:16:32.904133 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 08:16:32.919130 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 08:16:33.003592 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 08:16:33.017301 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 08:16:33.036379 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 08:16:33.051133 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 08:16:33.068761 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 08:16:33.084932 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 08:16:33.310656 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 08:16:33.332765 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 08:16:33.365630 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 08:16:33.406474 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 08:16:33.427286 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 08:16:33.442488 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 08:16:33.458106 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 08:16:33.473171 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 08:16:33.762261 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 08:16:33.776838 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 08:16:33.902405 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 08:16:33.944296 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 08:16:33.959627 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 08:16:34.089304 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 08:16:34.108610 (Thread-5): handling status request
2021-05-18 08:16:34.108943 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '37472ff9-de64-481f-bfc5-6d13b74437a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6ef588e20>]}
2021-05-18 08:16:34.109565 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.33.254
2021-05-18 08:16:34.114432 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 08:16:34.144797 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 08:16:34.199814 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 08:16:34.246299 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 08:16:34.299052 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 08:16:34.325825 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 08:16:34.341710 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 08:16:34.356769 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 08:16:34.371863 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 08:16:34.386759 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 08:16:34.402003 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 08:16:34.650343 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 08:16:34.666840 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 08:16:34.682359 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 08:16:34.703806 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 08:16:34.717918 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 08:16:35.094986 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 08:16:35.109517 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 08:16:35.130966 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 08:16:35.145037 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 08:16:35.259981 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 08:16:35.289240 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 08:16:35.304852 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 08:16:35.528971 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 08:16:35.827903 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.sources
- models.DBTTest.Stage_Layer
- models.DBTTest.Targets
- models.DBTTest.utils
- models.DBTTest.marts
- models.DBTTest.Views
- seeds.DBTTest

2021-05-18 08:16:40.892984 (Thread-6): handling status request
2021-05-18 08:16:40.895074 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '37472ff9-de64-481f-bfc5-6d13b74437a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6ef1f1eb0>]}
2021-05-18 08:16:40.915488 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.38.35
2021-05-18 08:19:35.075656 (MainThread): Running with dbt=0.18.1
2021-05-18 08:19:35.351029 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 08:19:35.364166 (MainThread): Tracking: tracking
2021-05-18 08:19:35.364484 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1ea817be50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1ea52a6520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1e9dbac9a0>]}
2021-05-18 08:19:35.364937 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-18 08:19:35.367322 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 08:19:35.372877 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 08:19:35.491636 (Thread-2): handling status request
2021-05-18 08:19:35.492066 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd67bc09d-fa22-41c1-8f39-b304759c1f21', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1e9dbdb760>]}
2021-05-18 08:19:35.493689 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.79
2021-05-18 08:19:35.900271 (Thread-1): Parsing macros/metrics.sql
2021-05-18 08:19:35.912589 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 08:19:35.916930 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 08:19:35.920898 (Thread-1): Parsing macros/adapters.sql
2021-05-18 08:19:35.948511 (Thread-1): Parsing macros/catalog.sql
2021-05-18 08:19:35.950457 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 08:19:35.954688 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 08:19:35.957551 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 08:19:35.968983 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 08:19:35.971938 (Thread-1): Parsing macros/core.sql
2021-05-18 08:19:35.977363 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 08:19:35.990372 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 08:19:36.010750 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 08:19:36.013328 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 08:19:36.038413 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 08:19:36.074597 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 08:19:36.079489 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 08:19:36.085524 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 08:19:36.106127 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 08:19:36.112593 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 08:19:36.114425 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 08:19:36.120315 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 08:19:36.121915 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 08:19:36.123014 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 08:19:36.132343 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 08:19:36.133358 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 08:19:36.134997 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 08:19:36.136971 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 08:19:36.138513 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 08:19:36.141188 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 08:19:36.143060 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 08:19:36.144833 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 08:19:36.190583 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:19:36.210895 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:19:36.243695 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 08:19:36.247138 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 08:19:36.250676 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 08:19:36.254081 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 08:19:36.259404 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 08:19:36.264689 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 08:19:36.270305 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 08:19:36.275358 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 08:19:36.282104 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 08:19:36.285951 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 08:19:36.295138 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 08:19:36.299249 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 08:19:36.303084 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 08:19:36.308578 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 08:19:36.316374 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 08:19:36.320560 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 08:19:36.329648 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 08:19:36.335788 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 08:19:36.339844 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 08:19:36.352209 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 08:19:36.379074 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 08:19:36.383162 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 08:19:36.388164 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 08:19:36.393077 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 08:19:36.399284 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 08:19:36.403111 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 08:19:36.407165 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 08:19:36.411076 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 08:19:36.417071 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 08:19:36.421357 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 08:19:36.425653 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 08:19:36.429896 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 08:19:36.438549 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 08:19:36.443692 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 08:19:36.449259 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 08:19:36.453522 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 08:19:36.458040 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 08:19:36.461936 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 08:19:36.466853 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 08:19:36.471182 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 08:19:36.477422 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 08:19:36.481174 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 08:19:36.486688 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 08:19:36.491654 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 08:19:36.496221 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 08:19:36.502388 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 08:19:36.507076 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 08:19:36.513190 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 08:19:36.531575 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 08:19:36.538507 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 08:19:36.551591 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 08:19:36.556997 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 08:19:36.561344 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 08:19:36.567373 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 08:19:36.578588 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 08:19:36.583668 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 08:19:36.587950 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 08:19:36.593724 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 08:19:36.601240 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 08:19:36.608552 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 08:19:36.616323 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:19:36.629269 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:19:36.652151 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 08:19:36.681759 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:19:36.689522 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 08:19:36.698125 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:19:36.703087 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 08:19:36.717061 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 08:19:36.724044 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 08:19:36.732008 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:19:36.746409 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 08:19:36.771957 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:19:36.789037 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 08:19:36.796050 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 08:19:36.809191 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:19:36.833124 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 08:19:36.847646 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 08:19:36.853532 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 08:19:36.857463 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 08:19:36.862243 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 08:19:36.866009 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 08:19:36.871304 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 08:19:36.876498 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 08:19:36.880400 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 08:19:36.885008 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 08:19:36.888744 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 08:19:36.892314 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 08:19:36.896091 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 08:19:36.900299 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 08:19:36.906339 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 08:19:36.910187 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 08:19:36.914839 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 08:19:36.919316 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 08:19:36.923004 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 08:19:36.927423 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 08:19:36.932068 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 08:19:36.937045 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 08:19:36.941814 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 08:19:36.950347 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 08:19:36.954127 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 08:19:36.960368 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 08:19:36.964448 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 08:19:36.968639 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 08:19:36.973265 (Thread-1): Parsing macros/first_value.sql
2021-05-18 08:19:36.978704 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 08:19:36.984328 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 08:19:37.099718 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 08:19:37.113996 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 08:19:37.117995 (Thread-3): handling status request
2021-05-18 08:19:37.118446 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd67bc09d-fa22-41c1-8f39-b304759c1f21', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1e9dbb8070>]}
2021-05-18 08:19:37.119209 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.47.20
2021-05-18 08:19:37.121792 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 08:19:37.127210 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 08:19:37.132140 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 08:19:37.139871 (Thread-1): Parsing macros/percentile.sql
2021-05-18 08:19:37.145097 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 08:19:37.149226 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 08:19:37.156108 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 08:19:37.160231 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 08:19:37.164233 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 08:19:37.168850 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 08:19:37.173161 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 08:19:37.177974 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 08:19:37.182186 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 08:19:37.186532 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 08:19:37.198504 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 08:19:37.317613 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 08:19:37.343516 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 08:19:37.357626 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 08:19:37.373463 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 08:19:37.390014 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 08:19:37.404593 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 08:19:37.417417 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 08:19:37.431952 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 08:19:37.451305 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 08:19:37.487889 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 08:19:37.734280 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 08:19:37.776835 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 08:19:37.850153 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 08:19:37.879191 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 08:19:37.901950 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 08:19:37.926772 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 08:19:38.313639 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 08:19:38.330152 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 08:19:38.350843 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 08:19:38.454280 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:19:38.469646 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:19:38.484464 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:19:38.500236 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:19:38.514590 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:19:38.528511 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:19:38.542391 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:19:38.557038 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:19:38.570858 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:19:38.585469 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:19:38.599446 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:19:38.613376 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:19:38.626998 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 08:19:38.645733 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:19:38.657283 (Thread-4): handling status request
2021-05-18 08:19:38.657677 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd67bc09d-fa22-41c1-8f39-b304759c1f21', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1e9cb5e130>]}
2021-05-18 08:19:38.658518 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.24.25
2021-05-18 08:19:38.662957 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:19:38.679215 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:19:38.694826 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:19:38.711004 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:19:38.726836 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:19:39.008436 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 08:19:39.029695 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 08:19:39.055779 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 08:19:39.086701 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 08:19:39.107701 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 08:19:39.133456 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 08:19:39.159482 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 08:19:39.173466 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 08:19:39.187518 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 08:19:39.201336 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 08:19:39.215320 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 08:19:39.228955 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 08:19:39.549078 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 08:19:39.565608 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 08:19:39.591593 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 08:19:39.936127 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 08:19:39.949975 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 08:19:39.963296 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 08:19:39.976695 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 08:19:40.156845 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 08:19:40.181706 (Thread-5): handling status request
2021-05-18 08:19:40.183845 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd67bc09d-fa22-41c1-8f39-b304759c1f21', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1e9cdf21c0>]}
2021-05-18 08:19:40.184512 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.212
2021-05-18 08:19:40.189287 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 08:19:40.211150 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 08:19:40.236282 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 08:19:40.282324 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 08:19:40.336990 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 08:19:40.350668 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 08:19:40.367291 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 08:19:40.381046 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 08:19:40.394749 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 08:19:40.954927 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 08:19:40.972061 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 08:19:40.987592 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 08:19:41.004430 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 08:19:41.041364 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 08:19:41.057908 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 08:19:41.073362 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 08:19:41.170786 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 08:19:41.184704 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 08:19:41.204128 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 08:19:41.219067 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 08:19:41.234499 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 08:19:41.249515 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 08:19:41.482696 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 08:19:41.504755 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 08:19:41.536948 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 08:19:41.578730 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 08:19:41.599764 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 08:19:41.615608 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 08:19:41.630599 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 08:19:41.645553 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 08:19:41.858859 (Thread-6): handling status request
2021-05-18 08:19:41.879639 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd67bc09d-fa22-41c1-8f39-b304759c1f21', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1e9c9ea100>]}
2021-05-18 08:19:41.885457 (Thread-6): sending response (<Response 184 bytes [200 OK]>) to 10.0.47.20
2021-05-18 08:19:41.935066 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 08:19:42.071614 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 08:19:42.085715 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 08:19:42.113673 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 08:19:42.128559 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 08:19:42.265616 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 08:19:42.289879 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 08:19:42.319299 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 08:19:42.367042 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 08:19:42.412417 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 08:19:42.463759 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 08:19:42.491607 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 08:19:42.506751 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 08:19:42.521487 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 08:19:42.536271 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 08:19:42.550939 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 08:19:42.566976 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 08:19:42.816243 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 08:19:42.832898 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 08:19:42.848165 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 08:19:42.869599 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 08:19:42.884266 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 08:19:43.297466 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 08:19:43.311623 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 08:19:43.333368 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 08:19:43.346530 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 08:19:43.462092 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 08:19:43.491143 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 08:19:43.507740 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 08:19:43.735507 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 08:19:44.066977 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Stage_Layer
- models.DBTTest.Targets
- models.DBTTest.utils
- models.DBTTest.marts
- models.DBTTest.sources
- models.DBTTest.Views
- seeds.DBTTest

2021-05-18 08:19:48.587571 (Thread-7): handling status request
2021-05-18 08:19:48.587989 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd67bc09d-fa22-41c1-8f39-b304759c1f21', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1e9d219a60>]}
2021-05-18 08:19:48.608694 (Thread-7): sending response (<Response 81715 bytes [200 OK]>) to 10.0.26.76
2021-05-18 08:25:52.583922 (MainThread): Running with dbt=0.18.1
2021-05-18 08:25:52.855922 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 08:25:52.869037 (MainThread): Tracking: tracking
2021-05-18 08:25:52.869363 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb61c64dfa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb6197784f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb61207d940>]}
2021-05-18 08:25:52.871774 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-18 08:25:52.882492 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 08:25:52.884410 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 08:25:53.280142 (Thread-2): handling status request
2021-05-18 08:25:53.280563 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb6120084f0>]}
2021-05-18 08:25:53.282280 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.3.3
2021-05-18 08:25:53.379505 (Thread-1): Parsing macros/metrics.sql
2021-05-18 08:25:53.392097 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 08:25:53.395154 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 08:25:53.399445 (Thread-1): Parsing macros/adapters.sql
2021-05-18 08:25:53.427848 (Thread-1): Parsing macros/catalog.sql
2021-05-18 08:25:53.429897 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 08:25:53.433753 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 08:25:53.435744 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 08:25:53.444844 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 08:25:53.447089 (Thread-1): Parsing macros/core.sql
2021-05-18 08:25:53.451074 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 08:25:53.459898 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 08:25:53.473738 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 08:25:53.475482 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 08:25:53.491643 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 08:25:53.520025 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 08:25:53.525377 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 08:25:53.531593 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 08:25:53.553180 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 08:25:53.560058 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 08:25:53.561955 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 08:25:53.568434 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 08:25:53.570089 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 08:25:53.571159 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 08:25:53.579960 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 08:25:53.580935 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 08:25:53.582596 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 08:25:53.584611 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 08:25:53.592523 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 08:25:53.595357 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 08:25:53.597272 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 08:25:53.599412 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 08:25:53.653338 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:25:53.669945 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:25:53.702727 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 08:25:53.705949 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 08:25:53.708686 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 08:25:53.711253 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 08:25:53.716061 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 08:25:53.720841 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 08:25:53.725647 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 08:25:53.729451 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 08:25:53.735373 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 08:25:53.738080 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 08:25:53.747065 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 08:25:53.750327 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 08:25:53.753193 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 08:25:53.757509 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 08:25:53.761832 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 08:25:53.764813 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 08:25:53.773503 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 08:25:53.779110 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 08:25:53.782373 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 08:25:53.792216 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 08:25:53.817604 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 08:25:53.820585 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 08:25:53.824968 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 08:25:53.828479 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 08:25:53.833780 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 08:25:53.836609 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 08:25:53.839403 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 08:25:53.842165 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 08:25:53.847290 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 08:25:53.850571 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 08:25:53.853737 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 08:25:53.857611 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 08:25:53.865735 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 08:25:53.870842 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 08:25:53.875454 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 08:25:53.878427 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 08:25:53.881724 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 08:25:53.884507 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 08:25:53.888555 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 08:25:53.892119 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 08:25:53.897775 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 08:25:53.900532 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 08:25:53.904815 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 08:25:53.908404 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 08:25:53.911655 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 08:25:53.915866 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 08:25:53.919778 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 08:25:53.923680 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 08:25:53.936532 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 08:25:53.941044 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 08:25:53.950517 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 08:25:53.954324 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 08:25:53.957189 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 08:25:53.961143 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 08:25:53.968798 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 08:25:53.973437 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 08:25:53.976529 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 08:25:53.980764 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 08:25:53.986666 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 08:25:53.990560 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 08:25:53.995255 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:25:54.003931 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:25:54.017513 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 08:25:54.036953 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:25:54.043767 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 08:25:54.050710 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:25:54.055047 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 08:25:54.069842 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 08:25:54.076662 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 08:25:54.082109 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:25:54.088833 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 08:25:54.109474 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:25:54.125667 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 08:25:54.131294 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 08:25:54.139216 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:25:54.161380 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 08:25:54.174429 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 08:25:54.178634 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 08:25:54.181820 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 08:25:54.186048 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 08:25:54.189418 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 08:25:54.193676 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 08:25:54.198884 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 08:25:54.202082 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 08:25:54.205744 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 08:25:54.208428 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 08:25:54.211010 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 08:25:54.214189 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 08:25:54.216830 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 08:25:54.221718 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 08:25:54.224302 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 08:25:54.227106 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 08:25:54.230110 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 08:25:54.232634 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 08:25:54.235493 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 08:25:54.238263 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 08:25:54.240985 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 08:25:54.245309 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 08:25:54.253648 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 08:25:54.256630 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 08:25:54.263441 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 08:25:54.267032 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 08:25:54.269898 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 08:25:54.273536 (Thread-1): Parsing macros/first_value.sql
2021-05-18 08:25:54.278335 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 08:25:54.282941 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 08:25:54.402602 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 08:25:54.416321 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 08:25:54.421643 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 08:25:54.426393 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 08:25:54.429432 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 08:25:54.436537 (Thread-1): Parsing macros/percentile.sql
2021-05-18 08:25:54.441221 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 08:25:54.445374 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 08:25:54.454346 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 08:25:54.458675 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 08:25:54.462533 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 08:25:54.467482 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 08:25:54.471236 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 08:25:54.475170 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 08:25:54.478403 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 08:25:54.481903 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 08:25:54.494683 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 08:25:54.603683 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 08:25:54.632381 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 08:25:54.647926 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 08:25:54.662593 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 08:25:54.678390 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 08:25:54.691765 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 08:25:54.704142 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 08:25:54.720651 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 08:25:54.751192 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 08:25:54.799964 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 08:25:55.096980 (Thread-3): handling status request
2021-05-18 08:25:55.103415 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb61204ef70>]}
2021-05-18 08:25:55.104223 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.79
2021-05-18 08:25:55.112659 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 08:25:55.163700 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 08:25:55.248026 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 08:25:55.276584 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 08:25:55.292539 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 08:25:55.309765 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 08:25:55.646206 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 08:25:55.663094 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 08:25:55.682516 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 08:25:55.785798 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:25:55.801878 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:25:55.818498 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:25:55.833170 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:25:55.848230 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:25:55.863911 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:25:55.888153 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:25:55.906480 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:25:55.934467 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:25:55.958648 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:25:55.982830 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:25:56.004376 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:25:56.027460 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 08:25:56.049832 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:25:56.067491 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:25:56.085292 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:25:56.101444 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:25:56.117755 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:25:56.132789 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:25:56.432781 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 08:25:56.471685 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 08:25:56.498997 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 08:25:56.530682 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 08:25:56.554960 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 08:25:56.581057 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 08:25:56.607018 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 08:25:56.623390 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 08:25:56.640669 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 08:25:56.656879 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 08:25:56.670304 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 08:25:56.685759 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 08:25:56.769320 (Thread-4): handling status request
2021-05-18 08:25:56.790331 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb6110390a0>]}
2021-05-18 08:25:56.796152 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.81
2021-05-18 08:25:57.001408 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 08:25:57.016811 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 08:25:57.041690 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 08:25:57.406918 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 08:25:57.421844 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 08:25:57.436033 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 08:25:57.450314 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 08:25:57.653774 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 08:25:57.687889 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 08:25:57.712278 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 08:25:57.742803 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 08:25:57.799723 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 08:25:57.862532 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 08:25:57.877319 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 08:25:57.892219 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 08:25:57.906914 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 08:25:57.921317 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 08:25:58.505900 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 08:25:58.521212 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 08:25:58.536174 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 08:25:58.551746 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 08:25:58.588676 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 08:25:58.604332 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 08:25:58.619758 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 08:25:58.707837 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 08:25:58.725393 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 08:25:58.745680 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 08:25:58.764906 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 08:25:58.780337 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 08:25:58.796841 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 08:25:59.031622 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 08:25:59.059134 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 08:25:59.075740 (Thread-5): handling status request
2021-05-18 08:25:59.088520 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb610f14580>]}
2021-05-18 08:25:59.089481 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.28.79
2021-05-18 08:25:59.094357 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 08:25:59.138890 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 08:25:59.161116 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 08:25:59.178640 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 08:25:59.195497 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 08:25:59.212021 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 08:25:59.517208 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 08:25:59.652597 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 08:25:59.667081 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 08:25:59.697438 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 08:25:59.713518 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 08:25:59.856276 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 08:25:59.882321 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 08:25:59.919066 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 08:25:59.974994 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 08:26:00.023325 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 08:26:00.082492 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 08:26:00.112833 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 08:26:00.128993 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 08:26:00.144551 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 08:26:00.159942 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 08:26:00.175103 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 08:26:00.191569 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 08:26:00.445970 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 08:26:00.461761 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 08:26:00.477342 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 08:26:00.499085 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 08:26:00.513420 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 08:26:00.920715 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 08:26:00.937348 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 08:26:00.959901 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 08:26:00.973762 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 08:26:01.106911 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 08:26:01.137871 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 08:26:01.154672 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 08:26:01.396821 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 08:26:01.712055 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Stage_Layer
- models.DBTTest.sources
- models.DBTTest.marts
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- seeds.DBTTest

2021-05-18 08:26:05.869327 (Thread-6): handling status request
2021-05-18 08:26:05.869751 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb6114940d0>]}
2021-05-18 08:26:05.891150 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.31.81
2021-05-18 08:26:20.817299 (Thread-7): handling status request
2021-05-18 08:26:20.818952 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb61100be80>]}
2021-05-18 08:26:20.842435 (Thread-7): sending response (<Response 81715 bytes [200 OK]>) to 10.0.3.3
2021-05-18 08:26:57.027758 (MainThread): Connection 'model.dbt_date.dates' was properly closed.
2021-05-18 08:26:57.487093 (Thread-8): Parsing macros/metrics.sql
2021-05-18 08:26:57.498654 (Thread-8): Parsing macros/generate_custom_schema_name.sql
2021-05-18 08:26:57.501456 (Thread-8): Parsing macros/datatype_conversion.sql
2021-05-18 08:26:57.505472 (Thread-8): Parsing macros/adapters.sql
2021-05-18 08:26:57.538828 (Thread-8): Parsing macros/catalog.sql
2021-05-18 08:26:57.541217 (Thread-8): Parsing macros/materializations/table.sql
2021-05-18 08:26:57.545404 (Thread-8): Parsing macros/materializations/merge.sql
2021-05-18 08:26:57.547400 (Thread-8): Parsing macros/materializations/incremental.sql
2021-05-18 08:26:57.558550 (Thread-8): Parsing macros/materializations/view.sql
2021-05-18 08:26:57.560767 (Thread-8): Parsing macros/core.sql
2021-05-18 08:26:57.564351 (Thread-8): Parsing macros/materializations/helpers.sql
2021-05-18 08:26:57.573047 (Thread-8): Parsing macros/materializations/common/merge.sql
2021-05-18 08:26:57.587112 (Thread-8): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 08:26:57.588935 (Thread-8): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 08:26:57.606124 (Thread-8): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 08:26:57.640646 (Thread-8): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 08:26:57.645596 (Thread-8): Parsing macros/materializations/view/view.sql
2021-05-18 08:26:57.651728 (Thread-8): Parsing macros/materializations/seed/seed.sql
2021-05-18 08:26:57.672364 (Thread-8): Parsing macros/materializations/table/table.sql
2021-05-18 08:26:57.679074 (Thread-8): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 08:26:57.680943 (Thread-8): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 08:26:57.687628 (Thread-8): Parsing macros/etc/is_incremental.sql
2021-05-18 08:26:57.689240 (Thread-8): Parsing macros/etc/query.sql
2021-05-18 08:26:57.690288 (Thread-8): Parsing macros/etc/datetime.sql
2021-05-18 08:26:57.836539 (Thread-8): Parsing macros/etc/get_custom_alias.sql
2021-05-18 08:26:57.837601 (Thread-8): Parsing macros/etc/get_custom_database.sql
2021-05-18 08:26:57.839281 (Thread-8): Parsing macros/etc/get_custom_schema.sql
2021-05-18 08:26:57.841261 (Thread-8): Parsing macros/schema_tests/not_null.sql
2021-05-18 08:26:57.842770 (Thread-8): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 08:26:57.845824 (Thread-8): Parsing macros/schema_tests/relationships.sql
2021-05-18 08:26:57.847686 (Thread-8): Parsing macros/schema_tests/unique.sql
2021-05-18 08:26:57.849406 (Thread-8): Parsing macros/adapters/common.sql
2021-05-18 08:26:57.897802 (Thread-8): Parsing macros/staging_columns.sql
2021-05-18 08:26:57.913862 (Thread-8): Parsing macros/staging_columns.sql
2021-05-18 08:26:57.946126 (Thread-8): Parsing macros/logger/pretty_time.sql
2021-05-18 08:26:57.948699 (Thread-8): Parsing macros/logger/log_info.sql
2021-05-18 08:26:57.951230 (Thread-8): Parsing macros/logger/pretty_log_format.sql
2021-05-18 08:26:57.953663 (Thread-8): Parsing macros/sql/pivot.sql
2021-05-18 08:26:57.957962 (Thread-8): Parsing macros/sql/star.sql
2021-05-18 08:26:57.962693 (Thread-8): Parsing macros/sql/surrogate_key.sql
2021-05-18 08:26:57.967325 (Thread-8): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 08:26:57.971332 (Thread-8): Parsing macros/sql/get_column_values.sql
2021-05-18 08:26:57.976798 (Thread-8): Parsing macros/sql/groupby.sql
2021-05-18 08:26:57.979459 (Thread-8): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 08:26:57.987468 (Thread-8): Parsing macros/sql/nullcheck_table.sql
2021-05-18 08:26:57.990454 (Thread-8): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 08:26:57.993153 (Thread-8): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 08:26:57.997136 (Thread-8): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 08:26:58.001236 (Thread-8): Parsing macros/sql/safe_add.sql
2021-05-18 08:26:58.004031 (Thread-8): Parsing macros/sql/unpivot.sql
2021-05-18 08:26:58.012113 (Thread-8): Parsing macros/sql/generate_series.sql
2021-05-18 08:26:58.017093 (Thread-8): Parsing macros/sql/nullcheck.sql
2021-05-18 08:26:58.026804 (Thread-8): Parsing macros/sql/union.sql
2021-05-18 08:26:58.036265 (Thread-8): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 08:26:58.059719 (Thread-9): handling status request
2021-05-18 08:26:58.060571 (Thread-10): handling status request
2021-05-18 08:26:58.060801 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb610ff9040>]}
2021-05-18 08:26:58.061215 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb610f31b20>]}
2021-05-18 08:26:58.061973 (Thread-9): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.212
2021-05-18 08:26:58.062175 (Thread-8): Parsing macros/web/get_url_parameter.sql
2021-05-18 08:26:58.062850 (Thread-10): sending response (<Response 184 bytes [200 OK]>) to 10.0.24.25
2021-05-18 08:26:58.066148 (Thread-8): Parsing macros/web/get_url_path.sql
2021-05-18 08:26:58.070523 (Thread-8): Parsing macros/web/get_url_host.sql
2021-05-18 08:26:58.073902 (Thread-8): Parsing macros/datetime/date_spine.sql
2021-05-18 08:26:58.078911 (Thread-8): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 08:26:58.079402 (Thread-11): handling status request
2021-05-18 08:26:58.080778 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb610f92c10>]}
2021-05-18 08:26:58.081394 (Thread-11): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.79
2021-05-18 08:26:58.082420 (Thread-8): Parsing macros/schema_tests/not_constant.sql
2021-05-18 08:26:58.085083 (Thread-8): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 08:26:58.088075 (Thread-8): Parsing macros/schema_tests/equality.sql
2021-05-18 08:26:58.093159 (Thread-8): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 08:26:58.096275 (Thread-8): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 08:26:58.099288 (Thread-8): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 08:26:58.102469 (Thread-8): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 08:26:58.109776 (Thread-8): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 08:26:58.113489 (Thread-8): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 08:26:58.117744 (Thread-8): Parsing macros/schema_tests/recency.sql
2021-05-18 08:26:58.120640 (Thread-8): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 08:26:58.123938 (Thread-8): Parsing macros/geo/haversine_distance.sql
2021-05-18 08:26:58.126644 (Thread-8): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 08:26:58.130470 (Thread-8): Parsing macros/cross_db_utils/length.sql
2021-05-18 08:26:58.134127 (Thread-8): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 08:26:58.139250 (Thread-8): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 08:26:58.142125 (Thread-8): Parsing macros/cross_db_utils/right.sql
2021-05-18 08:26:58.148211 (Thread-8): Parsing macros/cross_db_utils/hash.sql
2021-05-18 08:26:58.159252 (Thread-8): Parsing macros/cross_db_utils/replace.sql
2021-05-18 08:26:58.168325 (Thread-8): Parsing macros/cross_db_utils/concat.sql
2021-05-18 08:26:58.187144 (Thread-8): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 08:26:58.193265 (Thread-8): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 08:26:58.198217 (Thread-8): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 08:26:58.217906 (Thread-8): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 08:26:58.224174 (Thread-8): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 08:26:58.245230 (Thread-8): Parsing macros/cross_db_utils/position.sql
2021-05-18 08:26:58.250284 (Thread-8): Parsing macros/cross_db_utils/literal.sql
2021-05-18 08:26:58.253864 (Thread-8): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 08:26:58.259081 (Thread-8): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 08:26:58.266322 (Thread-8): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 08:26:58.269642 (Thread-8): Parsing macros/cross_db_utils/except.sql
2021-05-18 08:26:58.272539 (Thread-8): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 08:26:58.276527 (Thread-8): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 08:26:58.281923 (Thread-8): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 08:26:58.285398 (Thread-8): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 08:26:58.289878 (Thread-8): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:26:58.298532 (Thread-8): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:26:58.311775 (Thread-8): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 08:26:58.331326 (Thread-8): Parsing macros/get_account_history_columns.sql
2021-05-18 08:26:58.338119 (Thread-8): Parsing macros/get_staging_files.sql
2021-05-18 08:26:58.344436 (Thread-8): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:26:58.347967 (Thread-8): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 08:26:58.361112 (Thread-8): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 08:26:58.367908 (Thread-8): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 08:26:58.373145 (Thread-8): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:26:58.380226 (Thread-8): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 08:26:58.399596 (Thread-8): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:26:58.415160 (Thread-8): Parsing macros/get_basic_ad_columns.sql
2021-05-18 08:26:58.420646 (Thread-8): Parsing macros/get_ad_history_columns.sql
2021-05-18 08:26:58.428333 (Thread-8): Parsing macros/get_account_history_columns.sql
2021-05-18 08:26:58.448957 (Thread-8): Parsing macros/get_date_dimension.sql
2021-05-18 08:26:58.461968 (Thread-8): Parsing macros/get_base_dates.sql
2021-05-18 08:26:58.465790 (Thread-8): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 08:26:58.468519 (Thread-8): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 08:26:58.471756 (Thread-8): Parsing macros/calendar_date/yesterday.sql
2021-05-18 08:26:58.474175 (Thread-8): Parsing macros/calendar_date/month_name.sql
2021-05-18 08:26:58.477866 (Thread-8): Parsing macros/calendar_date/day_name.sql
2021-05-18 08:26:58.481769 (Thread-8): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 08:26:58.484424 (Thread-8): Parsing macros/calendar_date/date_part.sql
2021-05-18 08:26:58.487937 (Thread-8): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 08:26:58.490711 (Thread-8): Parsing macros/calendar_date/now.sql
2021-05-18 08:26:58.493496 (Thread-8): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 08:26:58.496130 (Thread-8): Parsing macros/calendar_date/this_week.sql
2021-05-18 08:26:58.498714 (Thread-8): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 08:26:58.503292 (Thread-8): Parsing macros/calendar_date/periods_since.sql
2021-05-18 08:26:58.505828 (Thread-8): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 08:26:58.508523 (Thread-8): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 08:26:58.511264 (Thread-8): Parsing macros/calendar_date/last_week.sql
2021-05-18 08:26:58.513528 (Thread-8): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 08:26:58.516502 (Thread-8): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 08:26:58.518984 (Thread-8): Parsing macros/calendar_date/today.sql
2021-05-18 08:26:58.521230 (Thread-8): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 08:26:58.524964 (Thread-8): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 08:26:58.532902 (Thread-8): Parsing macros/enabled_vars_one_true.sql
2021-05-18 08:26:58.535814 (Thread-8): Parsing macros/dummy_coalesce_value.sql
2021-05-18 08:26:58.540739 (Thread-8): Parsing macros/enabled_vars.sql
2021-05-18 08:26:58.545566 (Thread-8): Parsing macros/_get_utils_namespaces.sql
2021-05-18 08:26:58.548181 (Thread-8): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 08:26:58.552816 (Thread-8): Parsing macros/first_value.sql
2021-05-18 08:26:58.557639 (Thread-8): Parsing macros/json_extract.sql
2021-05-18 08:26:58.561696 (Thread-8): Parsing macros/generate_columns_macro.sql
2021-05-18 08:26:58.567203 (Thread-8): Parsing macros/timestamp_diff.sql
2021-05-18 08:26:58.579069 (Thread-8): Parsing macros/timestamp_add.sql
2021-05-18 08:26:58.583831 (Thread-8): Parsing macros/staging_models_automation.sql
2021-05-18 08:26:58.587862 (Thread-8): Parsing macros/snowflake_seed_data.sql
2021-05-18 08:26:58.590614 (Thread-8): Parsing macros/fill_staging_columns.sql
2021-05-18 08:26:58.597415 (Thread-8): Parsing macros/percentile.sql
2021-05-18 08:26:58.605975 (Thread-8): Parsing macros/ceiling.sql
2021-05-18 08:26:58.609184 (Thread-8): Parsing macros/get_columns_for_macro.sql
2021-05-18 08:26:58.615032 (Thread-8): Parsing macros/add_pass_through_columns.sql
2021-05-18 08:26:58.618220 (Thread-8): Parsing macros/pivot_json_extract.sql
2021-05-18 08:26:58.621238 (Thread-8): Parsing macros/string_agg.sql
2021-05-18 08:26:58.625017 (Thread-8): Parsing macros/array_agg.sql
2021-05-18 08:26:58.628097 (Thread-8): Parsing macros/fill_pass_through_columns.sql
2021-05-18 08:26:58.631897 (Thread-8): Parsing macros/empty_variable_warning.sql
2021-05-18 08:26:58.634663 (Thread-8): Parsing macros/seed_data_helper.sql
2021-05-18 08:26:58.637854 (Thread-8): Parsing macros/union_relations.sql
2021-05-18 08:26:58.648949 (Thread-8): Parsing macros/max_bool.sql
2021-05-18 08:26:58.735365 (Thread-8): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 08:26:58.748836 (Thread-8): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 08:26:58.764298 (Thread-8): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 08:26:58.776701 (Thread-8): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 08:26:58.788672 (Thread-8): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 08:26:58.800629 (Thread-8): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 08:26:58.813843 (Thread-8): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 08:26:58.825548 (Thread-8): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 08:26:58.838210 (Thread-8): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 08:26:58.855727 (Thread-8): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 08:26:59.119760 (Thread-8): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 08:26:59.137404 (Thread-8): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 08:26:59.162762 (Thread-8): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 08:26:59.181890 (Thread-8): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 08:26:59.197402 (Thread-8): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 08:26:59.212662 (Thread-8): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 08:26:59.495676 (Thread-8): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 08:26:59.514809 (Thread-8): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 08:26:59.530321 (Thread-8): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 08:26:59.575394 (Thread-12): handling status request
2021-05-18 08:26:59.596278 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb6110ff2b0>]}
2021-05-18 08:26:59.602150 (Thread-12): sending response (<Response 184 bytes [200 OK]>) to 10.0.24.25
2021-05-18 08:26:59.618597 (Thread-13): handling status request
2021-05-18 08:26:59.619090 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb6113c4f10>]}
2021-05-18 08:26:59.625010 (Thread-14): handling status request
2021-05-18 08:26:59.630964 (Thread-13): sending response (<Response 184 bytes [200 OK]>) to 10.0.37.9
2021-05-18 08:26:59.633667 (Thread-14): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb62012c5b0>]}
2021-05-18 08:26:59.634658 (Thread-14): sending response (<Response 184 bytes [200 OK]>) to 10.0.37.9
2021-05-18 08:26:59.645123 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:26:59.662456 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:26:59.678840 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:26:59.694098 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:26:59.709164 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:26:59.729575 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:26:59.746146 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:26:59.763835 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:26:59.778266 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:26:59.793359 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:26:59.807827 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:26:59.822277 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:26:59.837828 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 08:26:59.859559 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:26:59.880836 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:26:59.896200 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:26:59.911567 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:26:59.926810 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:26:59.941207 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:27:00.213878 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 08:27:00.229925 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 08:27:00.247460 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 08:27:00.265360 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 08:27:00.280869 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 08:27:00.302372 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 08:27:00.319466 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 08:27:00.333643 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 08:27:00.346845 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 08:27:00.360267 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 08:27:00.373477 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 08:27:00.387413 (Thread-8): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 08:27:00.682890 (Thread-8): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 08:27:00.698777 (Thread-8): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 08:27:00.724024 (Thread-8): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 08:27:01.105871 (Thread-8): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 08:27:01.120381 (Thread-8): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 08:27:01.134555 (Thread-8): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 08:27:01.148261 (Thread-8): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 08:27:01.254113 (Thread-15): handling status request
2021-05-18 08:27:01.277405 (Thread-15): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb611241310>]}
2021-05-18 08:27:01.283062 (Thread-16): handling status request
2021-05-18 08:27:01.288953 (Thread-15): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.212
2021-05-18 08:27:01.304699 (Thread-16): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb611105760>]}
2021-05-18 08:27:01.326148 (Thread-16): sending response (<Response 184 bytes [200 OK]>) to 10.0.33.254
2021-05-18 08:27:01.331439 (Thread-17): handling status request
2021-05-18 08:27:01.332222 (Thread-17): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb610fcfd60>]}
2021-05-18 08:27:01.332842 (Thread-17): sending response (<Response 184 bytes [200 OK]>) to 10.0.10.193
2021-05-18 08:27:01.341127 (Thread-8): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 08:27:01.364711 (Thread-8): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 08:27:01.382734 (Thread-8): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 08:27:01.401619 (Thread-8): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 08:27:01.432064 (Thread-8): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 08:27:01.460058 (Thread-8): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 08:27:01.474290 (Thread-8): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 08:27:01.488450 (Thread-8): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 08:27:01.503386 (Thread-8): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 08:27:01.517385 (Thread-8): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 08:27:01.994308 (Thread-8): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 08:27:02.013281 (Thread-8): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 08:27:02.029850 (Thread-8): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 08:27:02.046007 (Thread-8): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 08:27:02.067048 (Thread-8): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 08:27:02.087234 (Thread-8): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 08:27:02.103727 (Thread-8): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 08:27:02.193444 (Thread-8): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 08:27:02.207736 (Thread-8): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 08:27:02.227458 (Thread-8): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 08:27:02.384190 (Thread-8): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 08:27:02.403090 (Thread-8): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 08:27:02.420406 (Thread-8): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 08:27:02.696557 (Thread-8): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 08:27:02.719356 (Thread-8): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 08:27:02.759921 (Thread-8): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 08:27:02.794005 (Thread-8): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 08:27:02.818986 (Thread-8): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 08:27:02.835423 (Thread-8): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 08:27:02.852696 (Thread-8): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 08:27:02.868417 (Thread-8): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 08:27:03.163510 (Thread-8): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 08:27:03.177604 (Thread-8): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 08:27:03.192023 (Thread-8): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 08:27:03.218431 (Thread-8): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 08:27:03.232806 (Thread-8): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 08:27:03.361106 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 08:27:03.378974 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 08:27:03.399059 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 08:27:03.426209 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 08:27:03.451286 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 08:27:03.479882 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 08:27:03.503908 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 08:27:03.520419 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 08:27:03.537163 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 08:27:03.553139 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 08:27:03.568863 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 08:27:03.584408 (Thread-8): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 08:27:03.971078 (Thread-8): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 08:27:03.989333 (Thread-8): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 08:27:04.006126 (Thread-8): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 08:27:04.038013 (Thread-8): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 08:27:04.061841 (Thread-8): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 08:27:04.341072 (Thread-8): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 08:27:04.355416 (Thread-8): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 08:27:04.377895 (Thread-8): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 08:27:04.391815 (Thread-8): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 08:27:04.514239 (Thread-8): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 08:27:04.532186 (Thread-8): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 08:27:04.557072 (Thread-8): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 08:27:04.859405 (Thread-8): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 08:27:05.160679 (Thread-8): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Stage_Layer
- models.DBTTest.sources
- models.DBTTest.marts
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- seeds.DBTTest

2021-05-18 08:27:06.972440 (Thread-18): handling status request
2021-05-18 08:27:06.972899 (Thread-18): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb6111bdd90>]}
2021-05-18 08:27:06.993883 (Thread-18): sending response (<Response 81715 bytes [200 OK]>) to 10.0.3.3
2021-05-18 08:27:07.039681 (Thread-19): handling status request
2021-05-18 08:27:07.040050 (Thread-19): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb6200c2ca0>]}
2021-05-18 08:27:07.063702 (Thread-20): handling status request
2021-05-18 08:27:07.063932 (Thread-19): sending response (<Response 81715 bytes [200 OK]>) to 10.0.41.185
2021-05-18 08:27:07.064330 (Thread-20): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '014bddbe-fe4c-4734-9577-3f6bc134b062', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb610ddca30>]}
2021-05-18 08:27:07.085885 (Thread-20): sending response (<Response 81715 bytes [200 OK]>) to 10.0.41.185
2021-05-18 08:28:21.125397 (MainThread): Running with dbt=0.18.1
2021-05-18 08:28:21.393925 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 08:28:21.406022 (MainThread): Tracking: tracking
2021-05-18 08:28:21.406278 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f039b9a2e20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f0398ace370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f03913d0940>]}
2021-05-18 08:28:21.406649 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-18 08:28:21.409041 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 08:28:21.414437 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 08:28:21.957366 (Thread-1): Parsing macros/metrics.sql
2021-05-18 08:28:21.969330 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 08:28:21.973437 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 08:28:21.977295 (Thread-1): Parsing macros/adapters.sql
2021-05-18 08:28:22.004775 (Thread-1): Parsing macros/catalog.sql
2021-05-18 08:28:22.006669 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 08:28:22.010363 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 08:28:22.012247 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 08:28:22.020939 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 08:28:22.023043 (Thread-1): Parsing macros/core.sql
2021-05-18 08:28:22.026507 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 08:28:22.034961 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 08:28:22.048521 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 08:28:22.050217 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 08:28:22.065696 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 08:28:22.092548 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 08:28:22.097241 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 08:28:22.103146 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 08:28:22.122925 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 08:28:22.129254 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 08:28:22.131006 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 08:28:22.136819 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 08:28:22.138362 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 08:28:22.139399 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 08:28:22.147793 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 08:28:22.148737 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 08:28:22.150326 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 08:28:22.152337 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 08:28:22.153838 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 08:28:22.156431 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 08:28:22.158245 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 08:28:22.160002 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 08:28:22.205990 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:28:22.226560 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:28:22.275361 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 08:28:22.279560 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 08:28:22.283648 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 08:28:22.287851 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 08:28:22.295219 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 08:28:22.302404 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 08:28:22.309851 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 08:28:22.315968 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 08:28:22.325371 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 08:28:22.329958 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 08:28:22.343169 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 08:28:22.347923 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 08:28:22.353091 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 08:28:22.360136 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 08:28:22.366914 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 08:28:22.371748 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 08:28:22.382417 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 08:28:22.389469 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 08:28:22.394594 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 08:28:22.415175 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 08:28:22.449750 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 08:28:22.453913 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 08:28:22.459569 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 08:28:22.464429 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 08:28:22.474643 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 08:28:22.479321 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 08:28:22.483224 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 08:28:22.487023 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 08:28:22.493239 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 08:28:22.497576 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 08:28:22.501942 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 08:28:22.506574 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 08:28:22.515802 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 08:28:22.520542 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 08:28:22.526099 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 08:28:22.530367 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 08:28:22.535330 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 08:28:22.539133 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 08:28:22.544054 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 08:28:22.548420 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 08:28:22.554823 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 08:28:22.558596 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 08:28:22.564290 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 08:28:22.570194 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 08:28:22.574593 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 08:28:22.579827 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 08:28:22.584057 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 08:28:22.588769 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 08:28:22.603665 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 08:28:22.609107 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 08:28:22.618788 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 08:28:22.623335 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 08:28:22.627248 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 08:28:22.633568 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 08:28:22.641615 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 08:28:22.646194 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 08:28:22.650315 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 08:28:22.655488 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 08:28:22.661227 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 08:28:22.668083 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 08:28:22.673858 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:28:22.683101 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:28:22.699463 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 08:28:22.719365 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:28:22.728577 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 08:28:22.737515 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:28:22.742378 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 08:28:22.756073 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 08:28:22.762983 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 08:28:22.771299 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:28:22.780893 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 08:28:22.803701 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:28:22.820377 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 08:28:22.827131 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 08:28:22.837142 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:28:22.864585 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 08:28:22.878399 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 08:28:22.884213 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 08:28:22.888356 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 08:28:22.892907 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 08:28:22.896678 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 08:28:22.901929 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 08:28:22.907080 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 08:28:22.911291 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 08:28:22.916242 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 08:28:22.920644 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 08:28:22.924160 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 08:28:22.928246 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 08:28:22.932073 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 08:28:22.938260 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 08:28:22.942017 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 08:28:22.946176 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 08:28:22.949847 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 08:28:22.953425 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 08:28:22.957359 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 08:28:22.961188 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 08:28:22.964703 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 08:28:22.969378 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 08:28:22.979460 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 08:28:22.983424 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 08:28:22.989569 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 08:28:22.993671 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 08:28:22.997422 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 08:28:23.001895 (Thread-1): Parsing macros/first_value.sql
2021-05-18 08:28:23.007358 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 08:28:23.012699 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 08:28:23.019321 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 08:28:23.031425 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 08:28:23.037206 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 08:28:23.042430 (Thread-2): handling status request
2021-05-18 08:28:23.042821 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'a747f122-a426-457a-a535-cc2c2b09e08d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f03912b89d0>]}
2021-05-18 08:28:23.044557 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.212
2021-05-18 08:28:23.045370 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 08:28:23.143802 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 08:28:23.151352 (Thread-1): Parsing macros/percentile.sql
2021-05-18 08:28:23.156389 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 08:28:23.160765 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 08:28:23.168169 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 08:28:23.172377 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 08:28:23.176687 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 08:28:23.181893 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 08:28:23.186774 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 08:28:23.191460 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 08:28:23.195637 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 08:28:23.201451 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 08:28:23.213944 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 08:28:23.313785 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 08:28:23.339737 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 08:28:23.353996 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 08:28:23.369376 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 08:28:23.385286 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 08:28:23.397919 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 08:28:23.410962 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 08:28:23.425293 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 08:28:23.447947 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 08:28:23.492875 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 08:28:23.747753 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 08:28:23.791193 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 08:28:23.865509 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 08:28:23.892875 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 08:28:23.909043 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 08:28:23.925719 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 08:28:24.222521 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 08:28:24.237745 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 08:28:24.255357 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 08:28:24.353071 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:28:24.368993 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:28:24.384065 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:28:24.399624 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:28:24.414747 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:28:24.430664 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:28:24.448394 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:28:24.465066 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:28:24.480882 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:28:24.499149 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:28:24.518005 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:28:24.534276 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:28:24.554740 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 08:28:24.574933 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:28:24.592148 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:28:24.608566 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:28:24.625795 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:28:24.641073 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:28:24.654978 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:28:24.916388 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 08:28:24.937291 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 08:28:24.948233 (Thread-3): handling status request
2021-05-18 08:28:24.957903 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'a747f122-a426-457a-a535-cc2c2b09e08d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f03908b9850>]}
2021-05-18 08:28:24.958582 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.26.76
2021-05-18 08:28:24.963822 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 08:28:24.993854 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 08:28:25.016582 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 08:28:25.042736 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 08:28:25.067252 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 08:28:25.081696 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 08:28:25.096509 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 08:28:25.110970 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 08:28:25.131943 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 08:28:25.146365 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 08:28:25.453096 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 08:28:25.470127 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 08:28:25.496005 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 08:28:25.841387 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 08:28:25.855890 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 08:28:25.871749 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 08:28:25.885373 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 08:28:26.065769 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 08:28:26.096409 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 08:28:26.118451 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 08:28:26.143267 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 08:28:26.189082 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 08:28:26.242994 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 08:28:26.256417 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 08:28:26.270297 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 08:28:26.284077 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 08:28:26.297731 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 08:28:26.880753 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 08:28:26.895865 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 08:28:26.911091 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 08:28:26.925469 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 08:28:26.962343 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 08:28:26.977348 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 08:28:26.991835 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 08:28:27.077724 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 08:28:27.091064 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 08:28:27.109403 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 08:28:27.124134 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 08:28:27.139730 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 08:28:27.154457 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 08:28:27.376446 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 08:28:27.397977 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 08:28:27.429910 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 08:28:27.469587 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 08:28:27.490046 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 08:28:27.505945 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 08:28:27.520912 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 08:28:27.535632 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 08:28:27.837503 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 08:28:27.963889 (Thread-4): handling status request
2021-05-18 08:28:27.964302 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'a747f122-a426-457a-a535-cc2c2b09e08d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f039066c310>]}
2021-05-18 08:28:27.964914 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.11.88
2021-05-18 08:28:27.968884 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 08:28:27.983858 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 08:28:28.011082 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 08:28:28.025532 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 08:28:28.153634 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 08:28:28.176942 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 08:28:28.209918 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 08:28:28.256830 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 08:28:28.301370 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 08:28:28.351004 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 08:28:28.377015 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 08:28:28.391494 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 08:28:28.406232 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 08:28:28.420760 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 08:28:28.435334 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 08:28:28.449887 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 08:28:28.696883 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 08:28:28.711903 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 08:28:28.727012 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 08:28:28.747770 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 08:28:28.761862 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 08:28:29.129290 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 08:28:29.142965 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 08:28:29.164507 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 08:28:29.177874 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 08:28:29.290691 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 08:28:29.319123 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 08:28:29.335271 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 08:28:29.562081 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 08:28:29.889186 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.sources
- models.DBTTest.Stage_Layer
- models.DBTTest.marts
- models.DBTTest.Views
- models.DBTTest.Targets
- seeds.DBTTest

2021-05-18 08:28:37.985110 (Thread-5): handling status request
2021-05-18 08:28:37.986936 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'a747f122-a426-457a-a535-cc2c2b09e08d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f0390249a60>]}
2021-05-18 08:28:38.007854 (Thread-5): sending response (<Response 81715 bytes [200 OK]>) to 10.0.28.79
2021-05-18 08:28:59.318453 (Thread-6): handling status request
2021-05-18 08:28:59.320228 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'a747f122-a426-457a-a535-cc2c2b09e08d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f03903c2220>]}
2021-05-18 08:28:59.340765 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.15.212
2021-05-18 08:28:59.945528 (Thread-7): handling run_sql request
2021-05-18 08:28:59.945949 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'a747f122-a426-457a-a535-cc2c2b09e08d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f0390399400>]}
2021-05-18 08:28:59.948542 (Thread-7): Connection 'model.dbt_date.dates' was properly closed.
2021-05-18 08:29:00.995580 (Thread-7): sending response (<Response 137 bytes [200 OK]>) to 10.0.10.193
2021-05-18 08:29:01.015177 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:29:01.038965 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 08:29:01.039389 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:29:01.039493 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 08:29:01.052140 (Thread-1): finished collecting timing info
2021-05-18 08:29:01.053156 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 08:29:01.053216 (Thread-1): On rpc.DBTTest.request: With calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_ads AS (

)

select * from calendar
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 08:29:01.053268 (Thread-1): Opening a new connection, currently in state init
2021-05-18 08:29:01.606973 (Thread-8): handling poll request
2021-05-18 08:29:01.607457 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'a747f122-a426-457a-a535-cc2c2b09e08d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f0390740040>]}
2021-05-18 08:29:01.611221 (Thread-8): sending response (<Response 3832 bytes [200 OK]>) to 10.0.10.193
2021-05-18 08:29:02.541547 (Thread-1): Snowflake query id: 019c531d-0000-133f-0000-00011b5ea2c1
2021-05-18 08:29:02.541687 (Thread-1): Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 12 at position 0 unexpected ')'.
2021-05-18 08:29:02.541814 (Thread-1): finished collecting timing info
2021-05-18 08:29:02.542179 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 08:29:02.773903 (Thread-1): Got an exception: Database Error
  001003 (42000): SQL compilation error:
  syntax error line 12 at position 0 unexpected ')'.
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 001003 (42000): SQL compilation error:
syntax error line 12 at position 0 unexpected ')'.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  001003 (42000): SQL compilation error:
  syntax error line 12 at position 0 unexpected ')'.
2021-05-18 08:29:02.775530 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  001003 (42000): SQL compilation error:\n  syntax error line 12 at position 0 unexpected ')'.", 'raw_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS (\n\n)\n\nselect * from calendar\nlimit 500\n/* limit added automatically by dbt cloud */", 'compiled_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS (\n\n)\n\nselect * from calendar\nlimit 500\n/* limit added automatically by dbt cloud */", 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  001003 (42000): SQL compilation error:\n  syntax error line 12 at position 0 unexpected ')'.", 'raw_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS (\n\n)\n\nselect * from calendar\nlimit 500\n/* limit added automatically by dbt cloud */", 'compiled_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS (\n\n)\n\nselect * from calendar\nlimit 500\n/* limit added automatically by dbt cloud */", 'tags': None}, None)
2021-05-18 08:29:03.146597 (Thread-9): handling poll request
2021-05-18 08:29:03.147052 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'a747f122-a426-457a-a535-cc2c2b09e08d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f0390411ca0>]}
2021-05-18 08:29:03.148021 (Thread-9): sending response (<Response 15635 bytes [200 OK]>) to 10.0.24.25
2021-05-18 08:29:35.854714 (MainThread): Running with dbt=0.18.1
2021-05-18 08:29:36.142459 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 08:29:36.156579 (MainThread): Tracking: tracking
2021-05-18 08:29:36.156927 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f66259fefa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f6622b284f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661b42d9d0>]}
2021-05-18 08:29:36.157418 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-18 08:29:36.159840 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 08:29:36.168847 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 08:29:36.620010 (Thread-2): handling status request
2021-05-18 08:29:36.620404 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661b3ea9a0>]}
2021-05-18 08:29:36.622428 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.212
2021-05-18 08:29:36.763151 (Thread-1): Parsing macros/metrics.sql
2021-05-18 08:29:36.774758 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 08:29:36.778593 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 08:29:36.782574 (Thread-1): Parsing macros/adapters.sql
2021-05-18 08:29:36.811869 (Thread-1): Parsing macros/catalog.sql
2021-05-18 08:29:36.813829 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 08:29:36.817575 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 08:29:36.819537 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 08:29:36.828886 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 08:29:36.831445 (Thread-1): Parsing macros/core.sql
2021-05-18 08:29:36.834994 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 08:29:36.843761 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 08:29:36.857777 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 08:29:36.859575 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 08:29:36.877826 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 08:29:36.907000 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 08:29:36.913061 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 08:29:36.919444 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 08:29:36.941215 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 08:29:36.947950 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 08:29:36.949892 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 08:29:36.956740 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 08:29:36.958391 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 08:29:36.959900 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 08:29:36.971468 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 08:29:36.972488 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 08:29:36.974737 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 08:29:36.977518 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 08:29:36.979856 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 08:29:36.983094 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 08:29:36.985637 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 08:29:36.988130 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 08:29:37.040362 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:29:37.058120 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:29:37.093184 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 08:29:37.095938 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 08:29:37.098532 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 08:29:37.101030 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 08:29:37.106192 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 08:29:37.110765 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 08:29:37.115931 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 08:29:37.119677 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 08:29:37.126329 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 08:29:37.129524 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 08:29:37.138043 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 08:29:37.141071 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 08:29:37.143912 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 08:29:37.148584 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 08:29:37.154211 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 08:29:37.157541 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 08:29:37.166517 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 08:29:37.171951 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 08:29:37.175175 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 08:29:37.186247 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 08:29:37.211729 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 08:29:37.215516 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 08:29:37.220103 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 08:29:37.223410 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 08:29:37.228917 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 08:29:37.231786 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 08:29:37.235339 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 08:29:37.238156 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 08:29:37.243448 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 08:29:37.246835 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 08:29:37.250089 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 08:29:37.253604 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 08:29:37.261755 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 08:29:37.266207 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 08:29:37.270749 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 08:29:37.273857 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 08:29:37.277318 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 08:29:37.280742 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 08:29:37.285175 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 08:29:37.288406 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 08:29:37.294076 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 08:29:37.297171 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 08:29:37.301730 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 08:29:37.305532 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 08:29:37.308803 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 08:29:37.313372 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 08:29:37.317070 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 08:29:37.321211 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 08:29:37.333656 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 08:29:37.338821 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 08:29:37.347110 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 08:29:37.350749 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 08:29:37.354051 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 08:29:37.358738 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 08:29:37.368091 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 08:29:37.371608 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 08:29:37.374800 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 08:29:37.378870 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 08:29:37.383860 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 08:29:37.387796 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 08:29:37.392768 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:29:37.401097 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:29:37.421405 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 08:29:37.452976 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:29:37.460235 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 08:29:37.466618 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:29:37.471011 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 08:29:37.484245 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 08:29:37.491152 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 08:29:37.496633 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:29:37.504413 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 08:29:37.525293 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:29:37.548239 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 08:29:37.556374 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 08:29:37.566151 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:29:37.588519 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 08:29:37.601894 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 08:29:37.605991 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 08:29:37.608922 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 08:29:37.612217 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 08:29:37.615206 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 08:29:37.619433 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 08:29:37.623480 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 08:29:37.626330 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 08:29:37.630528 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 08:29:37.633415 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 08:29:37.636275 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 08:29:37.639111 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 08:29:37.641694 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 08:29:37.646602 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 08:29:37.649356 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 08:29:37.652271 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 08:29:37.655013 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 08:29:37.657866 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 08:29:37.660887 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 08:29:37.663415 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 08:29:37.666156 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 08:29:37.669859 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 08:29:37.678859 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 08:29:37.682166 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 08:29:37.687649 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 08:29:37.690756 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 08:29:37.693546 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 08:29:37.697041 (Thread-1): Parsing macros/first_value.sql
2021-05-18 08:29:37.701361 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 08:29:37.705694 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 08:29:37.827102 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 08:29:37.840219 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 08:29:37.846067 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 08:29:37.851136 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 08:29:37.854318 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 08:29:37.861205 (Thread-1): Parsing macros/percentile.sql
2021-05-18 08:29:37.865457 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 08:29:37.868849 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 08:29:37.875575 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 08:29:37.878730 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 08:29:37.881723 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 08:29:37.885488 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 08:29:37.888887 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 08:29:37.892927 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 08:29:37.896117 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 08:29:37.900013 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 08:29:37.914897 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 08:29:38.022797 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 08:29:38.047801 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 08:29:38.060198 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 08:29:38.072549 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 08:29:38.085863 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 08:29:38.100635 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 08:29:38.114889 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 08:29:38.128884 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 08:29:38.151011 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 08:29:38.193981 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 08:29:38.221919 (Thread-3): handling status request
2021-05-18 08:29:38.222302 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a8c8ee0>]}
2021-05-18 08:29:38.223223 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.28.79
2021-05-18 08:29:38.478382 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 08:29:38.520965 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 08:29:38.601917 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 08:29:38.632074 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 08:29:38.648301 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 08:29:38.665363 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 08:29:39.014473 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 08:29:39.030279 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 08:29:39.047832 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 08:29:39.149411 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:29:39.166802 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:29:39.182450 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:29:39.201717 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:29:39.223851 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:29:39.239714 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:29:39.255126 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:29:39.271360 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:29:39.297347 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:29:39.313311 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:29:39.328922 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:29:39.344372 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:29:39.361622 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 08:29:39.382762 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:29:39.399454 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:29:39.419280 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:29:39.437611 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:29:39.458874 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:29:39.476625 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:29:39.768565 (Thread-4): handling status request
2021-05-18 08:29:39.769051 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a41f580>]}
2021-05-18 08:29:39.770056 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.10.193
2021-05-18 08:29:39.776783 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 08:29:39.803553 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 08:29:39.832844 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 08:29:39.864296 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 08:29:39.887544 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 08:29:39.915722 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 08:29:39.940588 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 08:29:39.957450 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 08:29:39.972935 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 08:29:39.987047 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 08:29:40.001740 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 08:29:40.015106 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 08:29:40.332497 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 08:29:40.347858 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 08:29:40.373291 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 08:29:40.644902 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 08:29:40.661505 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 08:29:40.794260 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 08:29:40.811982 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 08:29:41.012253 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 08:29:41.045241 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 08:29:41.070959 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 08:29:41.102225 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 08:29:41.160608 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 08:29:41.224764 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 08:29:41.240624 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 08:29:41.256861 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 08:29:41.276888 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 08:29:41.294957 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 08:29:41.365168 (Thread-5): handling status request
2021-05-18 08:29:41.377732 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a9f1d60>]}
2021-05-18 08:29:41.378379 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.26.76
2021-05-18 08:29:41.824629 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 08:29:41.842675 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 08:29:41.860124 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 08:29:41.876885 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 08:29:41.922206 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 08:29:41.948127 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 08:29:41.969762 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 08:29:42.184599 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 08:29:42.199950 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 08:29:42.220022 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 08:29:42.237404 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 08:29:42.254223 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 08:29:42.270789 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 08:29:42.524458 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 08:29:42.547510 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 08:29:42.582259 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 08:29:42.632840 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 08:29:42.655787 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 08:29:42.672670 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 08:29:42.691358 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 08:29:42.707933 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 08:29:43.020373 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 08:29:43.038712 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 08:29:43.055805 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 08:29:43.087343 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 08:29:43.102547 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 08:29:43.364585 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 08:29:43.397405 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 08:29:43.428516 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 08:29:43.481812 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 08:29:43.535690 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 08:29:43.591380 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 08:29:43.620389 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 08:29:43.637340 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 08:29:43.653250 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 08:29:43.669306 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 08:29:43.685945 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 08:29:43.703043 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 08:29:43.999933 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 08:29:44.017287 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 08:29:44.039073 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 08:29:44.062404 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 08:29:44.078970 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 08:29:44.378512 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 08:29:44.393563 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 08:29:44.420494 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 08:29:44.438079 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 08:29:44.688752 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 08:29:44.722499 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 08:29:44.739356 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 08:29:44.977737 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 08:29:45.314415 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Targets
- models.DBTTest.sources
- models.DBTTest.utils
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- models.DBTTest.marts
- seeds.DBTTest

2021-05-18 08:29:45.723773 (Thread-6): handling status request
2021-05-18 08:29:45.724220 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a27ed90>]}
2021-05-18 08:29:45.746452 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.23.200
2021-05-18 08:30:05.977527 (Thread-7): handling status request
2021-05-18 08:30:05.979364 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a27eee0>]}
2021-05-18 08:30:06.002346 (Thread-7): sending response (<Response 81715 bytes [200 OK]>) to 10.0.33.254
2021-05-18 08:30:06.563536 (Thread-8): handling run_sql request
2021-05-18 08:30:06.563950 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a2c8370>]}
2021-05-18 08:30:06.566542 (Thread-8): Connection 'model.dbt_date.dates' was properly closed.
2021-05-18 08:30:07.652313 (Thread-8): sending response (<Response 137 bytes [200 OK]>) to 10.0.18.9
2021-05-18 08:30:07.672321 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:30:07.696846 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 08:30:07.697403 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:30:07.697547 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 08:30:07.711567 (Thread-1): finished collecting timing info
2021-05-18 08:30:07.712877 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 08:30:07.712988 (Thread-1): On rpc.DBTTest.request: With calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

)

select * from calendar
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 08:30:07.713070 (Thread-1): Opening a new connection, currently in state init
2021-05-18 08:30:08.162349 (Thread-9): handling poll request
2021-05-18 08:30:08.162803 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a3eb880>]}
2021-05-18 08:30:08.166592 (Thread-9): sending response (<Response 3816 bytes [200 OK]>) to 10.0.15.212
2021-05-18 08:30:09.722570 (Thread-10): handling poll request
2021-05-18 08:30:09.722997 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a3ebd90>]}
2021-05-18 08:30:09.723948 (Thread-10): sending response (<Response 390 bytes [200 OK]>) to 10.0.9.201
2021-05-18 08:30:09.939932 (Thread-1): SQL status: SUCCESS 500 in 2.23 seconds
2021-05-18 08:30:09.961255 (Thread-1): finished collecting timing info
2021-05-18 08:30:09.961689 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 08:30:11.220862 (Thread-11): handling poll request
2021-05-18 08:30:11.221294 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a70adf0>]}
2021-05-18 08:30:11.229528 (Thread-11): sending response (<Response 52926 bytes [200 OK]>) to 10.0.33.254
2021-05-18 08:35:11.116001 (Thread-12): handling status request
2021-05-18 08:35:11.117591 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a70ac70>]}
2021-05-18 08:35:11.138618 (Thread-12): sending response (<Response 81715 bytes [200 OK]>) to 10.0.47.20
2021-05-18 08:35:11.605083 (Thread-13): handling run_sql request
2021-05-18 08:35:11.605502 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a70a4c0>]}
2021-05-18 08:35:12.636418 (Thread-13): sending response (<Response 137 bytes [200 OK]>) to 10.0.24.25
2021-05-18 08:35:12.656157 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:35:12.681094 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 08:35:12.681635 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:35:12.681802 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 08:35:12.699912 (Thread-1): finished collecting timing info
2021-05-18 08:35:12.700546 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 08:35:12.700641 (Thread-1): On rpc.DBTTest.request: select * from DBT_SALESDATAFLO.Stg_Session
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 08:35:12.700722 (Thread-1): Opening a new connection, currently in state init
2021-05-18 08:35:13.143651 (Thread-14): handling poll request
2021-05-18 08:35:13.144112 (Thread-14): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a4faf70>]}
2021-05-18 08:35:13.146240 (Thread-14): sending response (<Response 2907 bytes [200 OK]>) to 10.0.28.79
2021-05-18 08:35:14.641391 (Thread-1): SQL status: SUCCESS 500 in 1.94 seconds
2021-05-18 08:35:14.672795 (Thread-15): handling poll request
2021-05-18 08:35:14.673287 (Thread-15): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661aa0b520>]}
2021-05-18 08:35:14.674321 (Thread-15): sending response (<Response 667 bytes [200 OK]>) to 10.0.47.20
2021-05-18 08:35:14.674931 (Thread-1): finished collecting timing info
2021-05-18 08:35:14.675408 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 08:35:16.142638 (Thread-16): handling poll request
2021-05-18 08:35:16.143087 (Thread-16): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fec57f30-74ec-4f9c-b777-3e54a207c066', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f661a7ab640>]}
2021-05-18 08:35:16.154119 (Thread-16): sending response (<Response 98445 bytes [200 OK]>) to 10.0.24.25
2021-05-18 08:39:39.953631 (MainThread): Running with dbt=0.18.1
2021-05-18 08:39:40.211218 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 08:39:40.219740 (MainThread): Tracking: tracking
2021-05-18 08:39:40.219950 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bed81c0a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bf6d83eb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bed86c730>]}
2021-05-18 08:39:40.223820 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-18 08:39:40.224213 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 08:39:40.226174 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 08:39:40.354515 (Thread-2): handling status request
2021-05-18 08:39:40.354926 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bec776430>]}
2021-05-18 08:39:40.356582 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.28.79
2021-05-18 08:39:40.701499 (Thread-1): Parsing macros/metrics.sql
2021-05-18 08:39:40.718630 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 08:39:40.723009 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 08:39:40.729365 (Thread-1): Parsing macros/adapters.sql
2021-05-18 08:39:40.774751 (Thread-1): Parsing macros/catalog.sql
2021-05-18 08:39:40.777753 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 08:39:40.783638 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 08:39:40.786552 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 08:39:40.799597 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 08:39:40.801963 (Thread-1): Parsing macros/core.sql
2021-05-18 08:39:40.806419 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 08:39:40.819215 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 08:39:40.833597 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 08:39:40.835397 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 08:39:40.851578 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 08:39:40.879718 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 08:39:40.884660 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 08:39:40.890702 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 08:39:40.910824 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 08:39:40.917297 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 08:39:40.919157 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 08:39:40.925136 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 08:39:40.926720 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 08:39:40.927795 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 08:39:40.936524 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 08:39:40.937473 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 08:39:40.939116 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 08:39:40.941080 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 08:39:40.942608 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 08:39:40.945331 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 08:39:40.947228 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 08:39:40.948983 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 08:39:40.994093 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:39:41.009787 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:39:41.041757 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 08:39:41.044472 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 08:39:41.046915 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 08:39:41.049545 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 08:39:41.053945 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 08:39:41.058683 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 08:39:41.063304 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 08:39:41.066921 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 08:39:41.072775 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 08:39:41.075453 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 08:39:41.083533 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 08:39:41.086563 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 08:39:41.089256 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 08:39:41.093506 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 08:39:41.097733 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 08:39:41.100463 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 08:39:41.108793 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 08:39:41.113686 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 08:39:41.116552 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 08:39:41.126097 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 08:39:41.150486 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 08:39:41.153307 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 08:39:41.157365 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 08:39:41.160646 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 08:39:41.165864 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 08:39:41.168808 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 08:39:41.172254 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 08:39:41.174885 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 08:39:41.180107 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 08:39:41.183338 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 08:39:41.186474 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 08:39:41.189859 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 08:39:41.197235 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 08:39:41.201371 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 08:39:41.205709 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 08:39:41.208815 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 08:39:41.212312 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 08:39:41.216214 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 08:39:41.220995 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 08:39:41.224458 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 08:39:41.229696 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 08:39:41.232799 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 08:39:41.236976 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 08:39:41.241220 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 08:39:41.244331 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 08:39:41.248334 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 08:39:41.251979 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 08:39:41.255643 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 08:39:41.267366 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 08:39:41.271868 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 08:39:41.280261 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 08:39:41.284310 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 08:39:41.287533 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 08:39:41.291300 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 08:39:41.298531 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 08:39:41.304288 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 08:39:41.308082 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 08:39:41.313279 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 08:39:41.319677 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 08:39:41.324198 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 08:39:41.330277 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:39:41.342137 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:39:41.361356 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 08:39:41.381812 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:39:41.388506 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 08:39:41.394747 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:39:41.399727 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 08:39:41.417106 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 08:39:41.425549 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 08:39:41.432790 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:39:41.439504 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 08:39:41.459063 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:39:41.474870 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 08:39:41.480390 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 08:39:41.488494 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:39:41.509102 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 08:39:41.521762 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 08:39:41.525501 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 08:39:41.528437 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 08:39:41.531725 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 08:39:41.534372 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 08:39:41.538243 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 08:39:41.542156 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 08:39:41.545115 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 08:39:41.548554 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 08:39:41.551235 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 08:39:41.553831 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 08:39:41.556491 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 08:39:41.558809 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 08:39:41.563249 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 08:39:41.566273 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 08:39:41.569142 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 08:39:41.571741 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 08:39:41.574247 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 08:39:41.577774 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 08:39:41.580705 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 08:39:41.583238 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 08:39:41.587033 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 08:39:41.595022 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 08:39:41.598038 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 08:39:41.603303 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 08:39:41.606590 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 08:39:41.609352 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 08:39:41.612663 (Thread-1): Parsing macros/first_value.sql
2021-05-18 08:39:41.616830 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 08:39:41.620922 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 08:39:41.732826 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 08:39:41.744238 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 08:39:41.749368 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 08:39:41.753795 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 08:39:41.757011 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 08:39:41.763580 (Thread-1): Parsing macros/percentile.sql
2021-05-18 08:39:41.767753 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 08:39:41.770984 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 08:39:41.776679 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 08:39:41.780233 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 08:39:41.783198 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 08:39:41.787059 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 08:39:41.790164 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 08:39:41.793848 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 08:39:41.796801 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 08:39:41.800219 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 08:39:41.811129 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 08:39:41.905877 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 08:39:41.929038 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 08:39:41.941108 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 08:39:41.953303 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 08:39:41.965407 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 08:39:41.973123 (Thread-3): handling status request
2021-05-18 08:39:41.973481 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bec479a00>]}
2021-05-18 08:39:41.974134 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.38.35
2021-05-18 08:39:41.979035 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 08:39:41.991591 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 08:39:42.004583 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 08:39:42.023674 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 08:39:42.060390 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 08:39:42.315347 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 08:39:42.358963 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 08:39:42.433772 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 08:39:42.461022 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 08:39:42.476508 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 08:39:42.501766 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 08:39:42.823067 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 08:39:42.838582 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 08:39:42.855064 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 08:39:42.950767 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:39:42.967119 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:39:42.982233 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:39:42.999820 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:39:43.014098 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:39:43.028076 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:39:43.042185 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:39:43.057385 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:39:43.071591 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:39:43.086979 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:39:43.101101 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:39:43.115457 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:39:43.130100 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 08:39:43.149170 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:39:43.165275 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:39:43.180954 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:39:43.196017 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:39:43.211230 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:39:43.230151 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:39:43.481647 (Thread-4): handling status request
2021-05-18 08:39:43.482106 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1be77b8ee0>]}
2021-05-18 08:39:43.483041 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.24.25
2021-05-18 08:39:43.488975 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 08:39:43.509210 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 08:39:43.534891 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 08:39:43.564514 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 08:39:43.585021 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 08:39:43.610072 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 08:39:43.632772 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 08:39:43.645893 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 08:39:43.658901 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 08:39:43.672051 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 08:39:43.685013 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 08:39:43.698256 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 08:39:43.991544 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 08:39:44.007083 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 08:39:44.032069 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 08:39:44.272596 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 08:39:44.399200 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 08:39:44.414192 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 08:39:44.428136 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 08:39:44.612196 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 08:39:44.645286 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 08:39:44.668017 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 08:39:44.693658 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 08:39:44.744826 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 08:39:44.801414 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 08:39:44.815622 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 08:39:44.830171 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 08:39:44.844320 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 08:39:44.858637 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 08:39:45.173349 (Thread-5): handling status request
2021-05-18 08:39:45.183977 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bec576160>]}
2021-05-18 08:39:45.189795 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.33.254
2021-05-18 08:39:45.316720 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 08:39:45.332125 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 08:39:45.347110 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 08:39:45.362194 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 08:39:45.399941 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 08:39:45.416840 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 08:39:45.432950 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 08:39:45.517232 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 08:39:45.535721 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 08:39:45.682119 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 08:39:45.697144 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 08:39:45.714065 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 08:39:45.730961 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 08:39:45.953911 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 08:39:45.976727 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 08:39:46.010320 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 08:39:46.051676 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 08:39:46.072628 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 08:39:46.088240 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 08:39:46.103567 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 08:39:46.118778 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 08:39:46.402212 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 08:39:46.416545 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 08:39:46.430761 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 08:39:46.459694 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 08:39:46.474059 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 08:39:46.603033 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 08:39:46.628557 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 08:39:46.768218 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 08:39:46.818299 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 08:39:46.869220 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 08:39:46.921571 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 08:39:46.948971 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 08:39:46.963949 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 08:39:46.978978 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 08:39:46.993899 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 08:39:47.009104 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 08:39:47.024136 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 08:39:47.275946 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 08:39:47.292227 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 08:39:47.307924 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 08:39:47.331610 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 08:39:47.345939 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 08:39:47.629029 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 08:39:47.642977 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 08:39:47.664375 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 08:39:47.679580 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 08:39:47.798031 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 08:39:47.945732 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 08:39:47.961974 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 08:39:48.181280 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 08:39:48.499515 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.marts
- models.DBTTest.Views
- models.DBTTest.Targets
- models.DBTTest.Stage_Layer
- models.DBTTest.sources
- models.DBTTest.utils
- seeds.DBTTest

2021-05-18 08:39:50.404020 (Thread-6): handling status request
2021-05-18 08:39:50.404459 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bec34fee0>]}
2021-05-18 08:39:50.425845 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.10.193
2021-05-18 08:40:22.309171 (MainThread): Connection 'model.dbt_date.dates' was properly closed.
2021-05-18 08:40:23.190526 (Thread-7): Got an acceptable cached parse result
2021-05-18 08:40:23.242021 (Thread-7): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 08:40:23.345903 (Thread-8): handling status request
2021-05-18 08:40:23.348986 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bfa8984c0>]}
2021-05-18 08:40:23.349432 (Thread-9): handling status request
2021-05-18 08:40:23.361230 (Thread-8): sending response (<Response 184 bytes [200 OK]>) to 10.0.11.88
2021-05-18 08:40:23.379388 (Thread-10): handling status request
2021-05-18 08:40:23.379561 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bfa8be310>]}
2021-05-18 08:40:23.514261 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1be74dac70>]}
2021-05-18 08:40:23.515047 (Thread-9): sending response (<Response 184 bytes [200 OK]>) to 10.0.37.9
2021-05-18 08:40:23.515811 (Thread-10): sending response (<Response 184 bytes [200 OK]>) to 10.0.18.9
2021-05-18 08:40:24.985204 (Thread-7): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 08:40:25.067311 (Thread-12): handling status request
2021-05-18 08:40:25.072889 (Thread-11): handling status request
2021-05-18 08:40:25.078385 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bfa899610>]}
2021-05-18 08:40:25.088917 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bec23be50>]}
2021-05-18 08:40:25.094768 (Thread-12): sending response (<Response 184 bytes [200 OK]>) to 10.0.37.9
2021-05-18 08:40:25.109921 (Thread-13): handling status request
2021-05-18 08:40:25.120833 (Thread-11): sending response (<Response 184 bytes [200 OK]>) to 10.0.26.76
2021-05-18 08:40:25.126807 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bec572df0>]}
2021-05-18 08:40:25.148223 (Thread-13): sending response (<Response 184 bytes [200 OK]>) to 10.0.26.76
2021-05-18 08:40:25.305047 (Thread-7): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.marts
- models.DBTTest.Views
- models.DBTTest.Targets
- models.DBTTest.Stage_Layer
- models.DBTTest.sources
- models.DBTTest.utils
- seeds.DBTTest

2021-05-18 08:40:33.044716 (Thread-14): handling status request
2021-05-18 08:40:33.045153 (Thread-14): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1be77d1d60>]}
2021-05-18 08:40:33.046236 (Thread-14): sending response (<Response 1637 bytes [200 OK]>) to 10.0.18.9
2021-05-18 08:40:33.064713 (Thread-15): handling status request
2021-05-18 08:40:33.065010 (Thread-15): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bec562400>]}
2021-05-18 08:40:33.065937 (Thread-15): sending response (<Response 1637 bytes [200 OK]>) to 10.0.31.81
2021-05-18 08:40:33.107923 (Thread-16): handling status request
2021-05-18 08:40:33.108237 (Thread-16): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bec283040>]}
2021-05-18 08:40:33.109180 (Thread-16): sending response (<Response 1637 bytes [200 OK]>) to 10.0.41.185
2021-05-18 08:40:35.080830 (Thread-17): handling status request
2021-05-18 08:40:35.081256 (Thread-17): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bfa94e160>]}
2021-05-18 08:40:35.082306 (Thread-17): sending response (<Response 1637 bytes [200 OK]>) to 10.0.37.9
2021-05-18 08:40:35.635320 (Thread-18): handling run_sql request
2021-05-18 08:40:35.635741 (Thread-18): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1bec0c8580>]}
2021-05-18 08:40:35.638405 (Thread-18): Connection 'model.DBTTest.ADS_FACT' was properly closed.
2021-05-18 08:40:36.646208 (Thread-18): sending response (<Response 137 bytes [200 OK]>) to 10.0.3.3
2021-05-18 08:40:36.666236 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:40:36.687883 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 08:40:36.688309 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:40:36.688416 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 08:40:36.701866 (Thread-1): finished collecting timing info
2021-05-18 08:40:36.703256 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 08:40:36.703320 (Thread-1): On rpc.DBTTest.request: With calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_ads AS(

      select
           
            Sum(SESSIONS_PER_USER) as r_value,
            139 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
      from DBT_SALESDATAFLO.Stg_Session eng inner join calendar on to_date(DATE)=CLDR_DATE
         where 
         and timeframe_type is not null
         and to_date(DATE) between calendar.start_date and calendar.end_date 
         group by 3,4,5,6
)

select * from r_ads
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 08:40:36.703489 (Thread-1): Opening a new connection, currently in state init
2021-05-18 08:40:37.229681 (Thread-19): handling poll request
2021-05-18 08:40:37.230777 (Thread-19): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1be75e0820>]}
2021-05-18 08:40:37.234161 (Thread-19): sending response (<Response 4350 bytes [200 OK]>) to 10.0.10.193
2021-05-18 08:40:38.182900 (Thread-1): Snowflake query id: 019c5328-0000-133f-0000-00011b5ea3d1
2021-05-18 08:40:38.183044 (Thread-1): Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 22 at position 9 unexpected 'and'.
2021-05-18 08:40:38.183174 (Thread-1): finished collecting timing info
2021-05-18 08:40:38.183595 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 08:40:38.409872 (Thread-1): Got an exception: Database Error
  001003 (42000): SQL compilation error:
  syntax error line 22 at position 9 unexpected 'and'.
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 001003 (42000): SQL compilation error:
syntax error line 22 at position 9 unexpected 'and'.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  001003 (42000): SQL compilation error:
  syntax error line 22 at position 9 unexpected 'and'.
2021-05-18 08:40:38.411571 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  001003 (42000): SQL compilation error:\n  syntax error line 22 at position 9 unexpected 'and'.", 'raw_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS(\n\n      select\n           \n            Sum(SESSIONS_PER_USER) as r_value,\n            139 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n      from DBT_SALESDATAFLO.Stg_Session eng inner join calendar on to_date(DATE)=CLDR_DATE\n         where \n         and timeframe_type is not null\n         and to_date(DATE) between calendar.start_date and calendar.end_date \n         group by 3,4,5,6\n)\n\nselect * from r_ads\nlimit 500\n/* limit added automatically by dbt cloud */", 'compiled_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS(\n\n      select\n           \n            Sum(SESSIONS_PER_USER) as r_value,\n            139 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n      from DBT_SALESDATAFLO.Stg_Session eng inner join calendar on to_date(DATE)=CLDR_DATE\n         where \n         and timeframe_type is not null\n         and to_date(DATE) between calendar.start_date and calendar.end_date \n         group by 3,4,5,6\n)\n\nselect * from r_ads\nlimit 500\n/* limit added automatically by dbt cloud */", 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  001003 (42000): SQL compilation error:\n  syntax error line 22 at position 9 unexpected 'and'.", 'raw_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS(\n\n      select\n           \n            Sum(SESSIONS_PER_USER) as r_value,\n            139 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n      from DBT_SALESDATAFLO.Stg_Session eng inner join calendar on to_date(DATE)=CLDR_DATE\n         where \n         and timeframe_type is not null\n         and to_date(DATE) between calendar.start_date and calendar.end_date \n         group by 3,4,5,6\n)\n\nselect * from r_ads\nlimit 500\n/* limit added automatically by dbt cloud */", 'compiled_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS(\n\n      select\n           \n            Sum(SESSIONS_PER_USER) as r_value,\n            139 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n      from DBT_SALESDATAFLO.Stg_Session eng inner join calendar on to_date(DATE)=CLDR_DATE\n         where \n         and timeframe_type is not null\n         and to_date(DATE) between calendar.start_date and calendar.end_date \n         group by 3,4,5,6\n)\n\nselect * from r_ads\nlimit 500\n/* limit added automatically by dbt cloud */", 'tags': None}, None)
2021-05-18 08:40:38.754493 (Thread-20): handling poll request
2021-05-18 08:40:38.754925 (Thread-20): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'fae5ee49-4350-4ba1-86cf-04e9f5a072e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1be75e0d00>]}
2021-05-18 08:40:38.755895 (Thread-20): sending response (<Response 19327 bytes [200 OK]>) to 10.0.31.81
2021-05-18 08:50:15.403078 (MainThread): Running with dbt=0.18.1
2021-05-18 08:50:15.676070 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 08:50:15.688207 (MainThread): Tracking: tracking
2021-05-18 08:50:15.688405 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8d351cf10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8d0646460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8c8f4a8e0>]}
2021-05-18 08:50:15.688754 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=16
2021-05-18 08:50:15.690815 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 08:50:15.696210 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 08:50:16.322859 (Thread-1): Parsing macros/metrics.sql
2021-05-18 08:50:16.335633 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 08:50:16.340868 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 08:50:16.344802 (Thread-1): Parsing macros/adapters.sql
2021-05-18 08:50:16.373191 (Thread-1): Parsing macros/catalog.sql
2021-05-18 08:50:16.375217 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 08:50:16.379275 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 08:50:16.381205 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 08:50:16.390149 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 08:50:16.392355 (Thread-1): Parsing macros/core.sql
2021-05-18 08:50:16.395996 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 08:50:16.404636 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 08:50:16.418797 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 08:50:16.420606 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 08:50:16.436722 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 08:50:16.463943 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 08:50:16.468746 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 08:50:16.474795 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 08:50:16.495080 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 08:50:16.501565 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 08:50:16.503382 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 08:50:16.509231 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 08:50:16.510821 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 08:50:16.511862 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 08:50:16.520478 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 08:50:16.521415 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 08:50:16.523080 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 08:50:16.525014 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 08:50:16.526552 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 08:50:16.529170 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 08:50:16.531035 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 08:50:16.532743 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 08:50:16.580331 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:50:16.603086 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 08:50:16.652640 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 08:50:16.658042 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 08:50:16.662324 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 08:50:16.667727 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 08:50:16.674415 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 08:50:16.681059 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 08:50:16.688315 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 08:50:16.694222 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 08:50:16.702194 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 08:50:16.707129 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 08:50:16.716765 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 08:50:16.722264 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 08:50:16.726917 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 08:50:16.733848 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 08:50:16.740131 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 08:50:16.744988 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 08:50:16.755018 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 08:50:16.762567 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 08:50:16.768856 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 08:50:16.782190 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 08:50:16.808402 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 08:50:16.813150 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 08:50:16.818689 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 08:50:16.823576 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 08:50:16.830660 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 08:50:16.835324 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 08:50:16.840247 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 08:50:16.844961 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 08:50:16.852033 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 08:50:16.857471 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 08:50:16.862625 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 08:50:16.870920 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 08:50:16.880183 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 08:50:16.885829 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 08:50:16.893058 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 08:50:16.897971 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 08:50:16.903931 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 08:50:16.908824 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 08:50:16.914403 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 08:50:16.919625 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 08:50:16.926954 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 08:50:16.932675 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 08:50:16.940111 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 08:50:16.945720 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 08:50:16.951355 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 08:50:16.957430 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 08:50:16.962882 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 08:50:16.968407 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 08:50:16.981769 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 08:50:16.988442 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 08:50:16.999547 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 08:50:17.004947 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 08:50:17.009512 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 08:50:17.014987 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 08:50:17.024414 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 08:50:17.029610 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 08:50:17.034684 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 08:50:17.041101 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 08:50:17.047691 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 08:50:17.056059 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 08:50:17.062371 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:50:17.181693 (Thread-2): handling status request
2021-05-18 08:50:17.182120 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8c8ec1cd0>]}
2021-05-18 08:50:17.183749 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.38.35
2021-05-18 08:50:17.186246 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:50:17.202735 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 08:50:17.223964 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:50:17.233434 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 08:50:17.243555 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:50:17.250020 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 08:50:17.264850 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 08:50:17.272826 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 08:50:17.282619 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 08:50:17.293008 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 08:50:17.316682 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 08:50:17.334556 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 08:50:17.341917 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 08:50:17.352216 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 08:50:17.382479 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 08:50:17.398222 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 08:50:17.404205 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 08:50:17.409317 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 08:50:17.414365 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 08:50:17.418972 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 08:50:17.424847 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 08:50:17.431058 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 08:50:17.435804 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 08:50:17.441387 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 08:50:17.446393 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 08:50:17.450942 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 08:50:17.455695 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 08:50:17.460269 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 08:50:17.466874 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 08:50:17.472268 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 08:50:17.476914 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 08:50:17.482512 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 08:50:17.487405 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 08:50:17.491949 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 08:50:17.497227 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 08:50:17.501950 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 08:50:17.508385 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 08:50:17.518446 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 08:50:17.523597 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 08:50:17.531011 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 08:50:17.535833 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 08:50:17.540372 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 08:50:17.545591 (Thread-1): Parsing macros/first_value.sql
2021-05-18 08:50:17.551812 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 08:50:17.557492 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 08:50:17.565765 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 08:50:17.578773 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 08:50:17.585685 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 08:50:17.592189 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 08:50:17.597147 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 08:50:17.605668 (Thread-1): Parsing macros/percentile.sql
2021-05-18 08:50:17.611458 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 08:50:17.617293 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 08:50:17.625206 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 08:50:17.630554 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 08:50:17.635609 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 08:50:17.641109 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 08:50:17.646138 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 08:50:17.651649 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 08:50:17.656156 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 08:50:17.661143 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 08:50:17.674459 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 08:50:17.780553 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 08:50:17.812155 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 08:50:17.827931 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 08:50:17.844021 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 08:50:17.862131 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 08:50:17.879510 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 08:50:17.895678 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 08:50:17.911005 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 08:50:17.932734 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 08:50:17.970702 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 08:50:18.239933 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 08:50:18.283486 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 08:50:18.358203 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 08:50:18.387428 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 08:50:18.405289 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 08:50:18.422922 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 08:50:18.742683 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 08:50:18.761303 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 08:50:18.779891 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 08:50:18.790412 (Thread-3): handling status request
2021-05-18 08:50:18.790779 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8c84f6e80>]}
2021-05-18 08:50:18.791405 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.185
2021-05-18 08:50:18.888846 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:50:18.907470 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:50:18.926541 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:50:18.946320 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:50:18.964166 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:50:19.091424 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:50:19.107812 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:50:19.124981 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:50:19.142216 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:50:19.158792 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:50:19.175333 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:50:19.191875 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:50:19.210037 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 08:50:19.232537 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 08:50:19.250778 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 08:50:19.268127 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 08:50:19.285784 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 08:50:19.304727 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 08:50:19.321992 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 08:50:19.487051 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 08:50:19.512612 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 08:50:19.540446 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 08:50:19.573153 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 08:50:19.597336 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 08:50:19.625162 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 08:50:19.650046 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 08:50:19.666003 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 08:50:19.681152 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 08:50:19.698627 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 08:50:19.713798 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 08:50:19.730740 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 08:50:20.060503 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 08:50:20.078554 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 08:50:20.106342 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 08:50:20.429582 (Thread-4): handling status request
2021-05-18 08:50:20.429998 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8c80c52b0>]}
2021-05-18 08:50:20.430729 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.11.88
2021-05-18 08:50:20.499865 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 08:50:20.514631 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 08:50:20.533527 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 08:50:20.553617 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 08:50:20.744276 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 08:50:20.779015 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 08:50:20.804035 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 08:50:20.831225 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 08:50:20.881573 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 08:50:20.941256 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 08:50:20.956304 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 08:50:20.971044 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 08:50:20.986277 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 08:50:21.000649 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 08:50:21.464828 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 08:50:21.602568 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 08:50:21.618480 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 08:50:21.634267 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 08:50:21.672526 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 08:50:21.688650 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 08:50:21.704180 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 08:50:21.797975 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 08:50:21.812884 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 08:50:21.832741 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 08:50:21.847789 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 08:50:21.864698 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 08:50:21.880764 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 08:50:22.016123 (Thread-5): handling status request
2021-05-18 08:50:22.036914 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8c8050880>]}
2021-05-18 08:50:22.042787 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.81
2021-05-18 08:50:22.119899 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 08:50:22.143832 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 08:50:22.180767 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 08:50:22.224947 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 08:50:22.247416 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 08:50:22.264308 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 08:50:22.280843 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 08:50:22.296811 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 08:50:22.596032 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 08:50:22.739590 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 08:50:22.754876 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 08:50:22.783738 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 08:50:22.799742 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 08:50:22.939347 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 08:50:22.965163 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 08:50:22.996952 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 08:50:23.055492 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 08:50:23.106592 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 08:50:23.160351 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 08:50:23.189241 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 08:50:23.205569 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 08:50:23.221394 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 08:50:23.237174 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 08:50:23.253037 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 08:50:23.268844 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 08:50:23.526744 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 08:50:23.543342 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 08:50:23.559616 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 08:50:23.582128 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 08:50:23.597355 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 08:50:23.742111 (Thread-6): handling status request
2021-05-18 08:50:23.768089 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8bbc7f670>]}
2021-05-18 08:50:23.773932 (Thread-6): sending response (<Response 184 bytes [200 OK]>) to 10.0.5.229
2021-05-18 08:50:24.009838 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 08:50:24.024772 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 08:50:24.048408 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 08:50:24.063249 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 08:50:24.185140 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 08:50:24.215950 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 08:50:24.232776 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 08:50:24.473507 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 08:50:24.774665 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.sources
- models.DBTTest.utils
- models.DBTTest.marts
- models.DBTTest.Stage_Layer
- models.DBTTest.Targets
- models.DBTTest.Views
- seeds.DBTTest

2021-05-18 08:50:30.229389 (Thread-7): handling status request
2021-05-18 08:50:30.231917 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8c80b1e20>]}
2021-05-18 08:50:30.252473 (Thread-7): sending response (<Response 81715 bytes [200 OK]>) to 10.0.34.79
2021-05-18 08:50:48.132585 (Thread-8): handling status request
2021-05-18 08:50:48.134580 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8c8182730>]}
2021-05-18 08:50:48.155488 (Thread-8): sending response (<Response 81715 bytes [200 OK]>) to 10.0.18.9
2021-05-18 08:50:48.838778 (Thread-9): handling run_sql request
2021-05-18 08:50:48.839225 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8c8182400>]}
2021-05-18 08:50:48.841824 (Thread-9): Connection 'model.dbt_date.dates' was properly closed.
2021-05-18 08:50:49.887920 (Thread-9): sending response (<Response 137 bytes [200 OK]>) to 10.0.47.20
2021-05-18 08:50:49.909285 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:50:49.934071 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 08:50:49.934634 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 08:50:49.934751 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 08:50:49.948582 (Thread-1): finished collecting timing info
2021-05-18 08:50:49.950016 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 08:50:49.950113 (Thread-1): On rpc.DBTTest.request: With calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_ads AS(

      select
           
            Sum(SESSIONS_PER_USER) as r_value,
            139 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
      from DBT_SALESDATAFLO.Stg_Session eng inner join calendar on to_date(DATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(DATE) between calendar.start_date and calendar.end_date 
         group by 3,4,5,6
)

select * from r_ads
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 08:50:49.950192 (Thread-1): Opening a new connection, currently in state init
2021-05-18 08:50:50.434006 (Thread-10): handling poll request
2021-05-18 08:50:50.434516 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8bbec6af0>]}
2021-05-18 08:50:50.438421 (Thread-10): sending response (<Response 4345 bytes [200 OK]>) to 10.0.33.254
2021-05-18 08:50:51.785103 (Thread-1): SQL status: SUCCESS 59 in 1.83 seconds
2021-05-18 08:50:51.789328 (Thread-1): finished collecting timing info
2021-05-18 08:50:51.789717 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 08:50:51.932736 (Thread-11): handling poll request
2021-05-18 08:50:51.933160 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8bbcbd820>]}
2021-05-18 08:50:51.934347 (Thread-11): sending response (<Response 1328 bytes [200 OK]>) to 10.0.10.193
2021-05-18 08:50:53.482708 (Thread-12): handling poll request
2021-05-18 08:50:53.483141 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '05452b9b-4395-469c-a4da-4a4ee1ff4939', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8bbf44820>]}
2021-05-18 08:50:53.487463 (Thread-12): sending response (<Response 13458 bytes [200 OK]>) to 10.0.28.79
2021-05-18 09:09:55.321591 (MainThread): Running with dbt=0.18.1
2021-05-18 09:09:55.583219 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 09:09:55.595625 (MainThread): Tracking: tracking
2021-05-18 09:09:55.595869 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccf7ed4e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccf50023a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcced905820>]}
2021-05-18 09:09:55.596206 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=16
2021-05-18 09:09:55.603832 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 09:09:55.609994 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 09:09:56.090854 (Thread-1): Parsing macros/metrics.sql
2021-05-18 09:09:56.102310 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 09:09:56.106547 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 09:09:56.110649 (Thread-1): Parsing macros/adapters.sql
2021-05-18 09:09:56.132543 (Thread-2): handling status request
2021-05-18 09:09:56.140660 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcced043d90>]}
2021-05-18 09:09:56.142467 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.79
2021-05-18 09:09:56.142689 (Thread-1): Parsing macros/catalog.sql
2021-05-18 09:09:56.145393 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 09:09:56.149305 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 09:09:56.151300 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 09:09:56.160244 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 09:09:56.162471 (Thread-1): Parsing macros/core.sql
2021-05-18 09:09:56.166042 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 09:09:56.174817 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 09:09:56.188773 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 09:09:56.190561 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 09:09:56.206666 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 09:09:56.240188 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 09:09:56.245290 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 09:09:56.253485 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 09:09:56.282887 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 09:09:56.289433 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 09:09:56.291300 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 09:09:56.297216 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 09:09:56.298832 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 09:09:56.299887 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 09:09:56.308659 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 09:09:56.309615 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 09:09:56.311286 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 09:09:56.313216 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 09:09:56.314775 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 09:09:56.317434 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 09:09:56.319315 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 09:09:56.321062 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 09:09:56.370070 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 09:09:56.386265 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 09:09:56.419638 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 09:09:56.422651 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 09:09:56.425544 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 09:09:56.428537 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 09:09:56.433447 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 09:09:56.438371 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 09:09:56.443361 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 09:09:56.447553 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 09:09:56.453763 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 09:09:56.457112 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 09:09:56.465448 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 09:09:56.468857 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 09:09:56.471925 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 09:09:56.476490 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 09:09:56.481895 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 09:09:56.485084 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 09:09:56.493435 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 09:09:56.499050 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 09:09:56.502374 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 09:09:56.512297 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 09:09:56.537250 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 09:09:56.540389 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 09:09:56.544477 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 09:09:56.548175 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 09:09:56.553733 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 09:09:56.556902 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 09:09:56.559976 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 09:09:56.563178 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 09:09:56.568721 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 09:09:56.572294 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 09:09:56.575694 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 09:09:56.579263 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 09:09:56.587522 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 09:09:56.592413 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 09:09:56.597213 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 09:09:56.600393 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 09:09:56.603880 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 09:09:56.607172 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 09:09:56.611330 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 09:09:56.614754 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 09:09:56.620445 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 09:09:56.623265 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 09:09:56.627591 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 09:09:56.631047 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 09:09:56.634479 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 09:09:56.639142 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 09:09:56.642314 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 09:09:56.646025 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 09:09:56.658348 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 09:09:56.663190 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 09:09:56.672083 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 09:09:56.675814 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 09:09:56.678925 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 09:09:56.683278 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 09:09:56.690538 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 09:09:56.694232 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 09:09:56.697483 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 09:09:56.701694 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 09:09:56.706622 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 09:09:56.710855 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 09:09:56.715601 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 09:09:56.724151 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 09:09:56.737671 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 09:09:56.757750 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 09:09:56.765704 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 09:09:56.772731 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 09:09:56.776678 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 09:09:56.789584 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 09:09:56.795843 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 09:09:56.802354 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 09:09:56.809248 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 09:09:56.828979 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 09:09:56.847866 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 09:09:56.853635 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 09:09:56.861785 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 09:09:56.882646 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 09:09:56.895587 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 09:09:56.899705 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 09:09:56.902740 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 09:09:56.906340 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 09:09:56.908992 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 09:09:56.920982 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 09:09:56.925056 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 09:09:56.927951 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 09:09:56.942229 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 09:09:56.945329 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 09:09:56.948126 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 09:09:56.951096 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 09:09:56.953896 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 09:09:56.958916 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 09:09:56.961711 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 09:09:56.964619 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 09:09:56.967529 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 09:09:56.970218 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 09:09:56.973109 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 09:09:56.975849 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 09:09:56.978557 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 09:09:56.982476 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 09:09:56.990234 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 09:09:56.993377 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 09:09:56.998698 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 09:09:57.001747 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 09:09:57.004712 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 09:09:57.008403 (Thread-1): Parsing macros/first_value.sql
2021-05-18 09:09:57.012940 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 09:09:57.017186 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 09:09:57.122128 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 09:09:57.134481 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 09:09:57.139519 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 09:09:57.143921 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 09:09:57.146980 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 09:09:57.153580 (Thread-1): Parsing macros/percentile.sql
2021-05-18 09:09:57.157633 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 09:09:57.160993 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 09:09:57.166986 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 09:09:57.170559 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 09:09:57.173812 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 09:09:57.178139 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 09:09:57.181635 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 09:09:57.185398 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 09:09:57.188517 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 09:09:57.192004 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 09:09:57.202970 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 09:09:57.301657 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 09:09:57.325881 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 09:09:57.338616 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 09:09:57.351315 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 09:09:57.372983 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 09:09:57.385953 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 09:09:57.398295 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 09:09:57.410266 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 09:09:57.428458 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 09:09:57.464040 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 09:09:57.707232 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 09:09:57.747586 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 09:09:57.787813 (Thread-3): handling status request
2021-05-18 09:09:57.798584 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecd6a520>]}
2021-05-18 09:09:57.810005 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.24.25
2021-05-18 09:09:57.821411 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 09:09:57.858419 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 09:09:57.873881 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 09:09:57.890258 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 09:09:58.203526 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 09:09:58.218352 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 09:09:58.235329 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 09:09:58.331108 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 09:09:58.346752 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 09:09:58.362410 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 09:09:58.377145 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 09:09:58.391688 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 09:09:58.406154 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 09:09:58.420563 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 09:09:58.436057 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 09:09:58.450722 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 09:09:58.466348 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 09:09:58.480930 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 09:09:58.495641 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 09:09:58.510666 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 09:09:58.530736 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 09:09:58.547954 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 09:09:58.564706 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 09:09:58.580934 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 09:09:58.597112 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 09:09:58.611628 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 09:09:58.886327 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 09:09:58.907148 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 09:09:58.933164 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 09:09:58.963108 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 09:09:58.983847 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 09:09:59.009072 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 09:09:59.032076 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 09:09:59.045421 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 09:09:59.058782 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 09:09:59.072267 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 09:09:59.085748 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 09:09:59.098995 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 09:09:59.362342 (Thread-4): handling status request
2021-05-18 09:09:59.378022 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecb82550>]}
2021-05-18 09:09:59.383823 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.24.25
2021-05-18 09:09:59.397298 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 09:09:59.412743 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 09:09:59.438442 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 09:09:59.679302 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 09:09:59.811931 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 09:09:59.829459 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 09:09:59.847030 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 09:10:00.029865 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 09:10:00.063092 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 09:10:00.086709 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 09:10:00.113548 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 09:10:00.162669 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 09:10:00.220653 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 09:10:00.239723 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 09:10:00.255022 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 09:10:00.269885 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 09:10:00.284814 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 09:10:00.755556 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 09:10:00.771307 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 09:10:00.786670 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 09:10:00.801959 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 09:10:00.840815 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 09:10:00.857768 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 09:10:00.872942 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 09:10:00.958813 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 09:10:00.973463 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 09:10:01.106408 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 09:10:01.121238 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 09:10:01.137288 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 09:10:01.153528 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 09:10:01.378799 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 09:10:01.401951 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 09:10:01.435390 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 09:10:01.477214 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 09:10:01.500349 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 09:10:01.516323 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 09:10:01.531787 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 09:10:01.547040 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 09:10:01.854132 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 09:10:01.869266 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 09:10:01.883315 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 09:10:01.911230 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 09:10:01.925697 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 09:10:02.055381 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 09:10:02.081653 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 09:10:02.229834 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 09:10:02.297524 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 09:10:02.353047 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 09:10:02.407347 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 09:10:02.435552 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 09:10:02.451233 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 09:10:02.466541 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 09:10:02.482155 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 09:10:02.498540 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 09:10:02.522099 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 09:10:02.781761 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 09:10:02.797910 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 09:10:02.814265 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 09:10:02.836243 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 09:10:02.851116 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 09:10:03.134778 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 09:10:03.149544 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 09:10:03.171978 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 09:10:03.186674 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 09:10:03.298823 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 09:10:03.450143 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 09:10:03.466459 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 09:10:03.696693 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 09:10:04.001430 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Views
- models.DBTTest.marts
- models.DBTTest.sources
- models.DBTTest.Targets
- models.DBTTest.utils
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-18 09:10:07.488710 (Thread-5): handling status request
2021-05-18 09:10:07.489197 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecd99d00>]}
2021-05-18 09:10:07.510942 (Thread-5): sending response (<Response 81715 bytes [200 OK]>) to 10.0.33.254
2021-05-18 09:10:28.061190 (Thread-6): handling status request
2021-05-18 09:10:28.061644 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecd998e0>]}
2021-05-18 09:10:28.083668 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.47.20
2021-05-18 09:10:28.588817 (Thread-7): handling run_sql request
2021-05-18 09:10:28.589245 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecd99ac0>]}
2021-05-18 09:10:28.591956 (Thread-7): Connection 'model.dbt_date.dates' was properly closed.
2021-05-18 09:10:29.607780 (Thread-7): sending response (<Response 137 bytes [200 OK]>) to 10.0.26.76
2021-05-18 09:10:29.626385 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 09:10:29.649494 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 09:10:29.649941 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 09:10:29.650048 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 09:10:29.663120 (Thread-1): finished collecting timing info
2021-05-18 09:10:29.664489 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 09:10:29.664551 (Thread-1): On rpc.DBTTest.request: With calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_ads AS(

      select
           
            Sum(cost_in_local_currency) as r_value,
            172 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
      from DBT_SALESDATAFLO.Stg_Ad_Analytics_By_Creative eng inner join calendar on to_date(DAY)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(DAY) between calendar.start_date and calendar.end_date 
         group by 3,4,5,6
),

select * from r_ads
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 09:10:29.664605 (Thread-1): Opening a new connection, currently in state init
2021-05-18 09:10:30.117675 (Thread-8): handling poll request
2021-05-18 09:10:30.118141 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecd27a90>]}
2021-05-18 09:10:30.121979 (Thread-8): sending response (<Response 4367 bytes [200 OK]>) to 10.0.18.9
2021-05-18 09:10:31.134091 (Thread-1): Snowflake query id: 019c5346-0000-1335-0000-00011b5eb771
2021-05-18 09:10:31.134266 (Thread-1): Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 27 at position 0 unexpected 'select'.
2021-05-18 09:10:31.134401 (Thread-1): finished collecting timing info
2021-05-18 09:10:31.134772 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 09:10:31.362795 (Thread-1): Got an exception: Database Error
  001003 (42000): SQL compilation error:
  syntax error line 27 at position 0 unexpected 'select'.
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 001003 (42000): SQL compilation error:
syntax error line 27 at position 0 unexpected 'select'.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  001003 (42000): SQL compilation error:
  syntax error line 27 at position 0 unexpected 'select'.
2021-05-18 09:10:31.364526 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  001003 (42000): SQL compilation error:\n  syntax error line 27 at position 0 unexpected 'select'.", 'raw_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS(\n\n      select\n           \n            Sum(cost_in_local_currency) as r_value,\n            172 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n      from DBT_SALESDATAFLO.Stg_Ad_Analytics_By_Creative eng inner join calendar on to_date(DAY)=CLDR_DATE\n         where \n         timeframe_type is not null\n         and to_date(DAY) between calendar.start_date and calendar.end_date \n         group by 3,4,5,6\n),\n\nselect * from r_ads\nlimit 500\n/* limit added automatically by dbt cloud */", 'compiled_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS(\n\n      select\n           \n            Sum(cost_in_local_currency) as r_value,\n            172 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n      from DBT_SALESDATAFLO.Stg_Ad_Analytics_By_Creative eng inner join calendar on to_date(DAY)=CLDR_DATE\n         where \n         timeframe_type is not null\n         and to_date(DAY) between calendar.start_date and calendar.end_date \n         group by 3,4,5,6\n),\n\nselect * from r_ads\nlimit 500\n/* limit added automatically by dbt cloud */", 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  001003 (42000): SQL compilation error:\n  syntax error line 27 at position 0 unexpected 'select'.", 'raw_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS(\n\n      select\n           \n            Sum(cost_in_local_currency) as r_value,\n            172 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n      from DBT_SALESDATAFLO.Stg_Ad_Analytics_By_Creative eng inner join calendar on to_date(DAY)=CLDR_DATE\n         where \n         timeframe_type is not null\n         and to_date(DAY) between calendar.start_date and calendar.end_date \n         group by 3,4,5,6\n),\n\nselect * from r_ads\nlimit 500\n/* limit added automatically by dbt cloud */", 'compiled_sql': "With calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_ads AS(\n\n      select\n           \n            Sum(cost_in_local_currency) as r_value,\n            172 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n      from DBT_SALESDATAFLO.Stg_Ad_Analytics_By_Creative eng inner join calendar on to_date(DAY)=CLDR_DATE\n         where \n         timeframe_type is not null\n         and to_date(DAY) between calendar.start_date and calendar.end_date \n         group by 3,4,5,6\n),\n\nselect * from r_ads\nlimit 500\n/* limit added automatically by dbt cloud */", 'tags': None}, None)
2021-05-18 09:10:31.711278 (Thread-9): handling poll request
2021-05-18 09:10:31.711703 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccf17c1790>]}
2021-05-18 09:10:31.712655 (Thread-9): sending response (<Response 19467 bytes [200 OK]>) to 10.0.38.35
2021-05-18 09:10:42.441006 (Thread-10): handling status request
2021-05-18 09:10:42.441493 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccec8b64c0>]}
2021-05-18 09:10:42.463600 (Thread-10): sending response (<Response 81715 bytes [200 OK]>) to 10.0.34.79
2021-05-18 09:10:42.940909 (Thread-11): handling run_sql request
2021-05-18 09:10:42.941316 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecdd5400>]}
2021-05-18 09:10:43.982642 (Thread-11): sending response (<Response 137 bytes [200 OK]>) to 10.0.10.193
2021-05-18 09:10:44.001854 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 09:10:44.023723 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 09:10:44.024209 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 09:10:44.024320 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 09:10:44.038086 (Thread-1): finished collecting timing info
2021-05-18 09:10:44.039660 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 09:10:44.039728 (Thread-1): On rpc.DBTTest.request: With calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_ads AS(

      select
           
            Sum(cost_in_local_currency) as r_value,
            172 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
      from DBT_SALESDATAFLO.Stg_Ad_Analytics_By_Creative eng inner join calendar on to_date(DAY)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(DAY) between calendar.start_date and calendar.end_date 
         group by 3,4,5,6
)

select * from r_ads
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 09:10:44.039785 (Thread-1): Opening a new connection, currently in state init
2021-05-18 09:10:44.613368 (Thread-12): handling poll request
2021-05-18 09:10:44.613836 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecda8a30>]}
2021-05-18 09:10:44.615969 (Thread-12): sending response (<Response 4366 bytes [200 OK]>) to 10.0.9.201
2021-05-18 09:10:46.182448 (Thread-13): handling poll request
2021-05-18 09:10:46.182867 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecda8dc0>]}
2021-05-18 09:10:46.183770 (Thread-13): sending response (<Response 391 bytes [200 OK]>) to 10.0.15.212
2021-05-18 09:10:46.403404 (Thread-1): SQL status: SUCCESS 9 in 2.36 seconds
2021-05-18 09:10:46.407100 (Thread-1): finished collecting timing info
2021-05-18 09:10:46.407508 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 09:10:47.819970 (Thread-14): handling poll request
2021-05-18 09:10:47.820506 (Thread-14): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecd6ee20>]}
2021-05-18 09:10:47.824822 (Thread-14): sending response (<Response 11271 bytes [200 OK]>) to 10.0.18.9
2021-05-18 09:23:06.471064 (Thread-15): Got an acceptable cached parse result
2021-05-18 09:23:06.506333 (Thread-16): handling status request
2021-05-18 09:23:06.506937 (Thread-16): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccec8f12b0>]}
2021-05-18 09:23:06.507753 (Thread-16): sending response (<Response 184 bytes [200 OK]>) to 10.0.10.193
2021-05-18 09:23:06.508203 (Thread-17): handling status request
2021-05-18 09:23:06.509556 (Thread-18): handling status request
2021-05-18 09:23:06.509953 (Thread-17): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccec7380d0>]}
2021-05-18 09:23:06.510130 (Thread-18): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccec8f12b0>]}
2021-05-18 09:23:06.510729 (Thread-17): sending response (<Response 184 bytes [200 OK]>) to 10.0.10.193
2021-05-18 09:23:06.511375 (Thread-18): sending response (<Response 184 bytes [200 OK]>) to 10.0.41.185
2021-05-18 09:23:06.532532 (Thread-15): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 09:23:08.076568 (Thread-19): handling status request
2021-05-18 09:23:08.079988 (Thread-19): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecd38520>]}
2021-05-18 09:23:08.080575 (Thread-20): handling status request
2021-05-18 09:23:08.081616 (Thread-19): sending response (<Response 184 bytes [200 OK]>) to 10.0.24.25
2021-05-18 09:23:08.082340 (Thread-21): handling status request
2021-05-18 09:23:08.082959 (Thread-20): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccec8442e0>]}
2021-05-18 09:23:08.083892 (Thread-21): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccecd38520>]}
2021-05-18 09:23:08.084633 (Thread-20): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.212
2021-05-18 09:23:08.085390 (Thread-21): sending response (<Response 184 bytes [200 OK]>) to 10.0.47.20
2021-05-18 09:23:08.360471 (Thread-15): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 09:23:08.687677 (Thread-15): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Views
- models.DBTTest.marts
- models.DBTTest.sources
- models.DBTTest.Targets
- models.DBTTest.utils
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-18 09:23:09.606206 (Thread-22): handling status request
2021-05-18 09:23:09.606785 (Thread-22): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccfb994af0>]}
2021-05-18 09:23:09.608093 (Thread-22): sending response (<Response 1641 bytes [200 OK]>) to 10.0.9.201
2021-05-18 09:23:09.630722 (Thread-23): handling status request
2021-05-18 09:23:09.631016 (Thread-23): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccec8a0640>]}
2021-05-18 09:23:09.631930 (Thread-23): sending response (<Response 1641 bytes [200 OK]>) to 10.0.37.9
2021-05-18 09:23:09.633859 (Thread-24): handling status request
2021-05-18 09:23:09.634139 (Thread-24): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'dc0e30e3-705a-4716-a940-7aa39ed8aa34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccec5853a0>]}
2021-05-18 09:23:09.635022 (Thread-24): sending response (<Response 1641 bytes [200 OK]>) to 10.0.15.212
2021-05-18 11:11:44.982923 (MainThread): Running with dbt=0.18.1
2021-05-18 11:11:45.233457 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 11:11:45.248580 (MainThread): Tracking: tracking
2021-05-18 11:11:45.248817 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd098041f40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd09516d430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08da758e0>]}
2021-05-18 11:11:45.249143 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-18 11:11:45.259166 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 11:11:45.259475 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 11:11:45.708876 (Thread-1): Parsing macros/metrics.sql
2021-05-18 11:11:45.721719 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 11:11:45.725000 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 11:11:45.728986 (Thread-1): Parsing macros/adapters.sql
2021-05-18 11:11:45.756891 (Thread-1): Parsing macros/catalog.sql
2021-05-18 11:11:45.758826 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 11:11:45.762551 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 11:11:45.764468 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 11:11:45.773194 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 11:11:45.775355 (Thread-1): Parsing macros/core.sql
2021-05-18 11:11:45.778839 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 11:11:45.787353 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 11:11:45.800957 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 11:11:45.802733 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 11:11:45.818591 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 11:11:45.845611 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 11:11:45.850389 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 11:11:45.856804 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 11:11:45.876912 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 11:11:45.883203 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 11:11:45.884970 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 11:11:45.891317 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 11:11:45.892865 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 11:11:45.893879 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 11:11:45.902466 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 11:11:45.903458 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 11:11:45.905085 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 11:11:45.907003 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 11:11:45.908501 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 11:11:45.911141 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 11:11:45.912993 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 11:11:45.914851 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 11:11:45.960877 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 11:11:45.977782 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 11:11:46.015634 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 11:11:46.018713 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 11:11:46.021772 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 11:11:46.024673 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 11:11:46.030549 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 11:11:46.036353 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 11:11:46.042460 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 11:11:46.047106 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 11:11:46.054401 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 11:11:46.057527 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 11:11:46.067751 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 11:11:46.071071 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 11:11:46.074427 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 11:11:46.079616 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 11:11:46.084960 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 11:11:46.088311 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 11:11:46.098836 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 11:11:46.105557 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 11:11:46.109209 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 11:11:46.121872 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 11:11:46.155952 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 11:11:46.159674 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 11:11:46.164819 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 11:11:46.168835 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 11:11:46.175395 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 11:11:46.178529 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 11:11:46.181651 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 11:11:46.184770 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 11:11:46.190518 (Thread-2): handling status request
2021-05-18 11:11:46.191141 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08d984c10>]}
2021-05-18 11:11:46.193311 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.10.193
2021-05-18 11:11:46.194509 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 11:11:46.198403 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 11:11:46.201836 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 11:11:46.205362 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 11:11:46.212900 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 11:11:46.217572 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 11:11:46.224223 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 11:11:46.227668 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 11:11:46.231439 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 11:11:46.234421 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 11:11:46.239115 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 11:11:46.243923 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 11:11:46.250354 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 11:11:46.253240 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 11:11:46.258410 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 11:11:46.262408 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 11:11:46.266078 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 11:11:46.271375 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 11:11:46.274851 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 11:11:46.279264 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 11:11:46.294845 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 11:11:46.300245 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 11:11:46.426294 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 11:11:46.429792 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 11:11:46.432576 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 11:11:46.436479 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 11:11:46.443655 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 11:11:46.447080 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 11:11:46.450294 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 11:11:46.454124 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 11:11:46.458595 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 11:11:46.462306 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 11:11:46.467050 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 11:11:46.475331 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 11:11:46.489157 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 11:11:46.509151 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 11:11:46.515870 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 11:11:46.521902 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 11:11:46.526025 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 11:11:46.540057 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 11:11:46.547323 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 11:11:46.553400 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 11:11:46.559797 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 11:11:46.580893 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 11:11:46.597145 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 11:11:46.602456 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 11:11:46.609979 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 11:11:46.630041 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 11:11:46.642561 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 11:11:46.646685 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 11:11:46.649608 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 11:11:46.652817 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 11:11:46.655347 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 11:11:46.659022 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 11:11:46.662836 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 11:11:46.665396 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 11:11:46.669138 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 11:11:46.671789 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 11:11:46.674173 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 11:11:46.676806 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 11:11:46.679333 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 11:11:46.683911 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 11:11:46.686629 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 11:11:46.689545 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 11:11:46.692312 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 11:11:46.694813 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 11:11:46.697527 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 11:11:46.699972 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 11:11:46.702253 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 11:11:46.705909 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 11:11:46.713260 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 11:11:46.716157 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 11:11:46.721285 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 11:11:46.724163 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 11:11:46.726947 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 11:11:46.730474 (Thread-1): Parsing macros/first_value.sql
2021-05-18 11:11:46.734810 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 11:11:46.738928 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 11:11:46.744413 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 11:11:46.755214 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 11:11:46.759887 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 11:11:46.763892 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 11:11:46.766639 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 11:11:46.773129 (Thread-1): Parsing macros/percentile.sql
2021-05-18 11:11:46.777077 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 11:11:46.780378 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 11:11:46.786233 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 11:11:46.789419 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 11:11:46.792366 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 11:11:46.796193 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 11:11:46.800190 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 11:11:46.804971 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 11:11:46.808547 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 11:11:46.812874 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 11:11:46.831347 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 11:11:46.962795 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 11:11:46.999121 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 11:11:47.011780 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 11:11:47.024060 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 11:11:47.036260 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 11:11:47.049410 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 11:11:47.061289 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 11:11:47.073388 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 11:11:47.092124 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 11:11:47.126884 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 11:11:47.378384 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 11:11:47.418971 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 11:11:47.490636 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 11:11:47.516735 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 11:11:47.532020 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 11:11:47.547654 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 11:11:47.721200 (Thread-3): handling status request
2021-05-18 11:11:47.721567 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08cda2700>]}
2021-05-18 11:11:47.722175 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.37.9
2021-05-18 11:11:47.841657 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 11:11:47.856241 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 11:11:47.872653 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 11:11:47.971432 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 11:11:47.987034 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 11:11:48.001989 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 11:11:48.122946 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 11:11:48.137798 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 11:11:48.152339 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 11:11:48.166584 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 11:11:48.181948 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 11:11:48.196005 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 11:11:48.210935 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 11:11:48.225354 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 11:11:48.239746 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 11:11:48.256582 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 11:11:48.275067 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 11:11:48.290936 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 11:11:48.305880 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 11:11:48.320819 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 11:11:48.336153 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 11:11:48.351549 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 11:11:48.501160 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 11:11:48.520530 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 11:11:48.545571 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 11:11:48.573054 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 11:11:48.594632 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 11:11:48.618984 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 11:11:48.641338 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 11:11:48.654416 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 11:11:48.667345 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 11:11:48.680163 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 11:11:48.693161 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 11:11:48.706133 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 11:11:48.997297 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 11:11:49.012223 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 11:11:49.037197 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 11:11:49.340822 (Thread-4): handling status request
2021-05-18 11:11:49.341374 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08ca7b070>]}
2021-05-18 11:11:49.342107 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.11.88
2021-05-18 11:11:49.398877 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 11:11:49.412690 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 11:11:49.426455 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 11:11:49.440407 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 11:11:49.618152 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 11:11:49.648371 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 11:11:49.671171 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 11:11:49.696259 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 11:11:49.741639 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 11:11:49.796154 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 11:11:49.809899 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 11:11:49.823531 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 11:11:49.837788 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 11:11:49.851747 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 11:11:50.296795 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 11:11:50.420196 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 11:11:50.435203 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 11:11:50.451556 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 11:11:50.488491 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 11:11:50.503536 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 11:11:50.518242 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 11:11:50.602399 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 11:11:50.615741 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 11:11:50.633994 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 11:11:50.648008 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 11:11:50.663551 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 11:11:50.678366 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 11:11:50.894882 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 11:11:50.917752 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 11:11:50.949637 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 11:11:50.989493 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 11:11:51.009680 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 11:11:51.024894 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 11:11:51.039602 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 11:11:51.054230 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 11:11:51.282524 (Thread-5): handling status request
2021-05-18 11:11:51.298163 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08c79f340>]}
2021-05-18 11:11:51.309024 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.9.201
2021-05-18 11:11:51.332878 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 11:11:51.457980 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 11:11:51.472162 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 11:11:51.499140 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 11:11:51.513465 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 11:11:51.639628 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 11:11:51.663400 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 11:11:51.696916 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 11:11:51.744410 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 11:11:51.789389 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 11:11:51.846956 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 11:11:51.874989 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 11:11:51.890058 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 11:11:51.904696 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 11:11:51.919209 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 11:11:51.934101 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 11:11:51.949589 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 11:11:52.190822 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 11:11:52.206269 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 11:11:52.221772 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 11:11:52.242757 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 11:11:52.257590 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 11:11:52.652151 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 11:11:52.666218 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 11:11:52.687811 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 11:11:52.701481 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 11:11:52.812920 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 11:11:52.860045 (Thread-6): handling status request
2021-05-18 11:11:52.860471 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08c904f40>]}
2021-05-18 11:11:52.861135 (Thread-6): sending response (<Response 184 bytes [200 OK]>) to 10.0.9.201
2021-05-18 11:11:52.866118 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 11:11:52.883593 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 11:11:53.120902 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 11:11:53.415870 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Views
- models.DBTTest.sources
- models.DBTTest.marts
- models.DBTTest.Stage_Layer
- models.DBTTest.utils
- models.DBTTest.Targets
- seeds.DBTTest

2021-05-18 11:11:54.344843 (Thread-7): handling status request
2021-05-18 11:11:54.345258 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08cdb24c0>]}
2021-05-18 11:11:54.366030 (Thread-7): sending response (<Response 81715 bytes [200 OK]>) to 10.0.5.229
2021-05-18 11:12:32.785694 (Thread-8): handling status request
2021-05-18 11:12:32.787608 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08cda3e20>]}
2021-05-18 11:12:32.807475 (Thread-8): sending response (<Response 81715 bytes [200 OK]>) to 10.0.34.79
2021-05-18 11:12:33.585593 (Thread-9): handling run_sql request
2021-05-18 11:12:33.586010 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08cde48e0>]}
2021-05-18 11:12:33.588726 (Thread-9): Connection 'model.dbt_date.dates' was properly closed.
2021-05-18 11:12:34.579603 (Thread-9): sending response (<Response 137 bytes [200 OK]>) to 10.0.38.35
2021-05-18 11:12:34.600153 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 11:12:34.622840 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 11:12:34.623290 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 11:12:34.623397 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 11:12:34.636510 (Thread-1): finished collecting timing info
2021-05-18 11:12:34.645950 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 11:12:34.646022 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='EMAIL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
--  and r_metric_id=66
  and r_type='Year'
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 11:12:34.646078 (Thread-1): Opening a new connection, currently in state init
2021-05-18 11:12:35.095036 (Thread-10): handling poll request
2021-05-18 11:12:35.095506 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08ce1ae80>]}
2021-05-18 11:12:35.099193 (Thread-10): sending response (<Response 16807 bytes [200 OK]>) to 10.0.18.9
2021-05-18 11:12:36.220599 (Thread-1): Snowflake query id: 019c53c0-0000-1335-0000-00011b5ed1fd
2021-05-18 11:12:36.220726 (Thread-1): Snowflake error: 002003 (42S02): SQL compilation error:
Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.
2021-05-18 11:12:36.220862 (Thread-1): finished collecting timing info
2021-05-18 11:12:36.221254 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 11:12:36.460266 (Thread-1): Got an exception: Database Error
  002003 (42S02): SQL compilation error:
  Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 161, in exception_handler
    yield
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 78, in add_query
    cursor.execute(sql, bindings)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/cursor.py", line 595, in execute
    Error.errorhandler_wrapper(self.connection, self,
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 97, in errorhandler_wrapper
    cursor.errorhandler(connection, cursor, errorclass, errorvalue)
  File "/usr/local/lib/python3.8/dist-packages/snowflake/connector/errors.py", line 68, in default_errorhandler
    raise errorclass(
snowflake.connector.errors.ProgrammingError: 002003 (42S02): SQL compilation error:
Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 333, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 276, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 378, in run
    return self.execute(compiled_node, manifest)
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 84, in execute
    _, execute_result = self.adapter.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/base/impl.py", line 224, in execute
    return self.connections.execute(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 123, in execute
    _, cursor = self.add_query(sql, auto_begin)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 309, in add_query
    connection, cursor = super().add_query(
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/sql/connections.py", line 86, in add_query
    return connection, cursor
  File "/usr/lib/python3.8/contextlib.py", line 131, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/lib/python3.8/dist-packages/dbt/adapters/snowflake/connections.py", line 178, in exception_handler
    raise DatabaseException(msg)
dbt.exceptions.DatabaseException: Database Error
  002003 (42S02): SQL compilation error:
  Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.
2021-05-18 11:12:36.461854 (Thread-1): Got exception RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  002003 (42S02): SQL compilation error:\n  Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing MEETING) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'EMAIL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result  where 1=1\n--r_timeframe_type=\'W\'\n--  and r_metric_id=66\n  and r_type=\'Year\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing MEETING) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'EMAIL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result  where 1=1\n--r_timeframe_type=\'W\'\n--  and r_metric_id=66\n  and r_type=\'Year\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/rpc/sql_commands.py", line 145, in _in_thread
    self.node_results.append(runner.safe_run(self.manifest))
  File "/usr/local/lib/python3.8/dist-packages/dbt/task/base.py", line 349, in safe_run
    result = self.error_result(ctx.node, error, started, [])
  File "/usr/local/lib/python3.8/dist-packages/dbt/rpc/node_runners.py", line 52, in error_result
    raise error
dbt.rpc.error.RPCException: RPCException(10003, Database Error, {'type': 'DatabaseException', 'message': "Database Error in rpc request (from remote system)\n  002003 (42S02): SQL compilation error:\n  Object 'DATAFLOTEST_DATABASE.DBT_SALESDATAFLO.FACT_SALES' does not exist or not authorized.", 'raw_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing MEETING) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'EMAIL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result  where 1=1\n--r_timeframe_type=\'W\'\n--  and r_metric_id=66\n  and r_type=\'Year\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'compiled_sql': 'WITH PERIOD AS(\n     Select TYPE,start_date,end_date,\n            CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Year\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD\n       union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n           WHEN TYPE=\'Month\' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,\'FY \')[0],\'"\', \'\')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        union\n        Select TYPE,start_date,end_date,\n        CASE\n             WHEN TYPE=\'Year\' OR TYPE=\'Quarter\' or TYPE=\'Month\' THEN cast (split(FULLY_QUALIFIED_LABEL,\'FY \')[1] as varchar(1100)) \n            ELSE NULL end as year ,\n        CASE\n             WHEN TYPE=\'Quarter\'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD\n        \n),calendar AS(\n      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,\'Year\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR \n     union\n     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,\'Month\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n    union\n     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,\'Week\'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT(\'W\',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n     union\n     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,\'Quarter\' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR\n\n),r_metric AS (\n    --- SF  oppor_won-1\n       select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'true\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n         --and to_date(close_date) between \'2017-01-01\' and \'2021-03-31\'\n        group by 4,5,6,7\n\n         union   --Oppor loss -10\n        select \n            count(source_id) as r_count,\n            sum(OPPORTUNITY.AMOUNT) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  \n        where OPPORTUNITY.IS_WON=\'false\'\n         and OPPORTUNITY.IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --converted_leads-3\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            3 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'TRUE\'\n         and timeframe_type is not null\n         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       union --new leads -4\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            4 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  \n        where UPPER(IS_CONVERTED) = \'FALSE\'\n         and upper(status)=\'NEW\'\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --accounts -27\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            27 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Account,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n        union --contact -29\n        select \n            count(source_id) as r_count,\n            0 AS r_amount,\n            29 AS r_metric_id,\n            Source_type as r_Source_type, \n            PERIOD.TYPE as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  \n        where 1=1\n         and timeframe_type is not null\n         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date\n        group by 4,5,6,7\n\n       --HS\n        union   --deal won -1 PROPERTY_HS_CREATEDATE\n        select\n           \n            count(Source_DEAL_ID) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            1 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year \n        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%WON%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n       \n        union   -- Deal Los -10\n        select\n           \n            COALESCE(count(Source_DEAL_ID),0) as r_count,\n            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,\n            10 AS r_metric_id,\n            Source_type as r_Source_type,\n            type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE\n         where Upper(DEAL_PIPELINE_STAGE_ID) like \'%CLOSED%LOS%\' \n         and PROPERTY_HS_IS_CLOSED=\'true\'\n         and timeframe_type is not null\n         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n      union -- calls -39\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            39 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'CALL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7\n\n    union -- Task completed -89\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            89 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'TASK\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7     \n\n    union -- (Marketing MEETING) -71\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            71 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'MEETING\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7      \n\n    union -- (Notes) -76\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            76 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'NOTE\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7       \n\n    union -- (Emails Logged) -66\n        select\n           \n            count(Source_ID) as r_count,\n            0 AS r_amount,\n            66 AS r_metric_id,\n            Source_type as r_Source_type,\n            calendar.type as r_type,\n            timeframe_type as r_timeframe_type,\n            year as r_year\n        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE\n         where Upper(eng.TYPE) =\'EMAIL\'\n         and timeframe_type is not null\n         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date \n         group by 4,5,6,7            \n\n\n\n\n\n\n\n\n),fs AS(\n    select sum(count) as f_count,\n    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf\n    where \n        TIMEFRAME_TYPE=\'Y\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.year_end\n        and Yearend_flag=\'TRUE\'\n    group by 3,4,5,6,7\n union\n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,\n    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'M\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.MONTH_END\n        and MONTHEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'Q\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.QUARTER_END\n        and QUARTEREND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7\n\n  union \n  \n    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf\n    where \n        TIMEFRAME_TYPE=\'W\'\n        and sf.entity_id = tmf.source_type\n        and REPORT_DATE=tmf.WEEK_END\n        and WEEKEND_FLAG=\'TRUE\'\n    group by 3,4,5,6,7  \n   \n\n), compare_result AS(\n    select \n    r_count,\n    f_count,\n    r_amount,\n    f_amount,\n    r_metric_id,\n    f_metric_id,\n    r_Source_type,\n    f_entity_id,\n    r_type,\n    f_timeframe_type,\n    r_timeframe_type,\n    f_types_timeframe,\n    r_year,\n    f_year,\n    CASE\n            WHEN r_count <> f_count THEN \'YES\'\n            WHEN r_amount <> f_amount THEN \'YES\'\n            WHEN r_metric_id <> f_metric_id THEN \'YES\'\n            WHEN r_Source_type <> f_entity_id THEN \'YES\'\n            WHEN case when r_type=\'Year\' then \'Y\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Month\' then \'M\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Quarter\' then \'Q\' else null end <> f_timeframe_type THEN \'YES\'\n            WHEN case when r_type=\'Week\' then \'W\' else null end <> f_timeframe_type THEN \'YES\' --Month,Year,Quarter,Week\n            WHEN r_timeframe_type <> f_types_timeframe THEN \'YES\'\n            WHEN r_year <> f_year THEN \'YES\'\n            ELSE \'NO\'\n            END as value_mismatch\n\n    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id \n    --and case when r_type=\'Year\' then cast(\'Y\' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) =\'Y\'\n    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type\n    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)\n    and r_year=f_year\n    and r_Source_type=f_entity_id\n\n\n)\n\nselect * from compare_result  where 1=1\n--r_timeframe_type=\'W\'\n--  and r_metric_id=66\n  and r_type=\'Year\'\nlimit 500\n/* limit added automatically by dbt cloud */', 'tags': None}, None)
2021-05-18 11:12:36.622158 (Thread-11): handling poll request
2021-05-18 11:12:36.622570 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08c92ef40>]}
2021-05-18 11:12:36.624308 (Thread-11): sending response (<Response 64760 bytes [200 OK]>) to 10.0.5.229
2021-05-18 11:12:38.115497 (Thread-12): handling poll request
2021-05-18 11:12:38.115905 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '0ebf2f2b-d035-4d3d-ba80-c64b43c71dc9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd08ccb4700>]}
2021-05-18 11:12:38.117226 (Thread-12): sending response (<Response 109198 bytes [200 OK]>) to 10.0.3.3
2021-05-18 11:14:19.084868 (MainThread): Running with dbt=0.18.1
2021-05-18 11:14:19.351560 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 11:14:19.364394 (MainThread): Tracking: tracking
2021-05-18 11:14:19.364606 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73c379ce20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73c08ca370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73b91cdb80>]}
2021-05-18 11:14:19.373976 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=16
2021-05-18 11:14:19.374344 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 11:14:19.374584 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 11:14:19.877775 (Thread-1): Parsing macros/metrics.sql
2021-05-18 11:14:19.890874 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 11:14:19.895654 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 11:14:19.899497 (Thread-1): Parsing macros/adapters.sql
2021-05-18 11:14:19.930523 (Thread-1): Parsing macros/catalog.sql
2021-05-18 11:14:19.932431 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 11:14:19.936115 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 11:14:19.937977 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 11:14:19.946680 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 11:14:19.948765 (Thread-1): Parsing macros/core.sql
2021-05-18 11:14:19.952294 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 11:14:19.960753 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 11:14:19.974228 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 11:14:19.975884 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 11:14:19.991582 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 11:14:20.018325 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 11:14:20.023070 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 11:14:20.028886 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 11:14:20.048783 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 11:14:20.055105 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 11:14:20.056813 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 11:14:20.062537 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 11:14:20.064052 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 11:14:20.065057 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 11:14:20.073465 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 11:14:20.074498 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 11:14:20.076072 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 11:14:20.077970 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 11:14:20.079569 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 11:14:20.082228 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 11:14:20.084025 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 11:14:20.085679 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 11:14:20.134170 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 11:14:20.155774 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 11:14:20.178732 (Thread-2): handling status request
2021-05-18 11:14:20.179611 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '02bd1ee1-c8d7-408c-91fe-3888df0b2270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73b912e490>]}
2021-05-18 11:14:20.181276 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.34.79
2021-05-18 11:14:20.201196 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 11:14:20.205939 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 11:14:20.210248 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 11:14:20.214501 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 11:14:20.222542 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 11:14:20.228818 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 11:14:20.235575 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 11:14:20.241089 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 11:14:20.248779 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 11:14:20.253110 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 11:14:20.262498 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 11:14:20.267448 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 11:14:20.271876 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 11:14:20.277824 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 11:14:20.283851 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 11:14:20.288239 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 11:14:20.297926 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 11:14:20.304573 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 11:14:20.309385 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 11:14:20.324932 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 11:14:20.350517 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 11:14:20.355604 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 11:14:20.361559 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 11:14:20.366495 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 11:14:20.373456 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 11:14:20.378814 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 11:14:20.383667 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 11:14:20.388230 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 11:14:20.395625 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 11:14:20.410552 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 11:14:20.417752 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 11:14:20.424716 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 11:14:20.441954 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 11:14:20.452025 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 11:14:20.460363 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 11:14:20.466472 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 11:14:20.472764 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 11:14:20.478166 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 11:14:20.485633 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 11:14:20.492053 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 11:14:20.501855 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 11:14:20.507589 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 11:14:20.516032 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 11:14:20.522405 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 11:14:20.528744 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 11:14:20.536646 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 11:14:20.542915 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 11:14:20.548374 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 11:14:20.565035 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 11:14:20.571445 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 11:14:20.582011 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 11:14:20.587958 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 11:14:20.592407 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 11:14:20.598019 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 11:14:20.606999 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 11:14:20.612052 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 11:14:20.617878 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 11:14:20.724764 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 11:14:20.731733 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 11:14:20.739224 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 11:14:20.745337 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 11:14:20.755124 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 11:14:20.782274 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 11:14:20.802762 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 11:14:20.810795 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 11:14:20.819512 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 11:14:20.824786 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 11:14:20.838900 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 11:14:20.846808 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 11:14:20.854901 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 11:14:20.869892 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 11:14:20.895141 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 11:14:20.912060 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 11:14:20.919320 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 11:14:20.930243 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 11:14:20.958837 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 11:14:20.986066 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 11:14:20.991846 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 11:14:20.996237 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 11:14:21.001234 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 11:14:21.005355 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 11:14:21.010788 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 11:14:21.016309 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 11:14:21.020672 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 11:14:21.026088 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 11:14:21.030401 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 11:14:21.035002 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 11:14:21.039919 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 11:14:21.044102 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 11:14:21.050086 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 11:14:21.054634 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 11:14:21.060436 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 11:14:21.064785 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 11:14:21.069045 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 11:14:21.073596 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 11:14:21.077767 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 11:14:21.082092 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 11:14:21.087632 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 11:14:21.097422 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 11:14:21.101848 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 11:14:21.108438 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 11:14:21.113125 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 11:14:21.117578 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 11:14:21.122840 (Thread-1): Parsing macros/first_value.sql
2021-05-18 11:14:21.128432 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 11:14:21.134351 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 11:14:21.141079 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 11:14:21.153875 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 11:14:21.160642 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 11:14:21.166481 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 11:14:21.171215 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 11:14:21.182233 (Thread-1): Parsing macros/percentile.sql
2021-05-18 11:14:21.188360 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 11:14:21.193320 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 11:14:21.200893 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 11:14:21.226998 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 11:14:21.231860 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 11:14:21.238249 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 11:14:21.243693 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 11:14:21.249011 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 11:14:21.254355 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 11:14:21.260597 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 11:14:21.282637 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 11:14:21.407153 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 11:14:21.436267 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 11:14:21.451627 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 11:14:21.470227 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 11:14:21.486543 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 11:14:21.499322 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 11:14:21.512555 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 11:14:21.538494 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 11:14:21.557719 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 11:14:21.593365 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 11:14:21.648747 (Thread-3): handling status request
2021-05-18 11:14:21.660787 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '02bd1ee1-c8d7-408c-91fe-3888df0b2270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73b8550c70>]}
2021-05-18 11:14:21.661700 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.26.76
2021-05-18 11:14:21.852519 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 11:14:21.894490 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 11:14:21.965047 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 11:14:21.991986 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 11:14:22.008396 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 11:14:22.025060 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 11:14:22.334792 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 11:14:22.353425 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 11:14:22.372538 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 11:14:22.475337 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 11:14:22.490948 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 11:14:22.504951 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 11:14:22.519719 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 11:14:22.653967 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 11:14:22.669614 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 11:14:22.684261 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 11:14:22.700287 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 11:14:22.714948 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 11:14:22.729821 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 11:14:22.744494 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 11:14:22.759376 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 11:14:22.775061 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 11:14:22.794798 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 11:14:22.811582 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 11:14:22.826980 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 11:14:22.842502 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 11:14:22.858446 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 11:14:22.878336 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 11:14:23.042082 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 11:14:23.065146 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 11:14:23.093007 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 11:14:23.123520 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 11:14:23.146026 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 11:14:23.173608 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 11:14:23.192716 (Thread-4): handling status request
2021-05-18 11:14:23.193099 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '02bd1ee1-c8d7-408c-91fe-3888df0b2270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73b81da880>]}
2021-05-18 11:14:23.194000 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.37.9
2021-05-18 11:14:23.198559 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 11:14:23.214030 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 11:14:23.229430 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 11:14:23.244977 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 11:14:23.262254 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 11:14:23.280276 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 11:14:23.587904 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 11:14:23.605493 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 11:14:23.632691 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 11:14:24.026691 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 11:14:24.042857 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 11:14:24.057024 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 11:14:24.070998 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 11:14:24.254972 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 11:14:24.286195 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 11:14:24.310583 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 11:14:24.338221 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 11:14:24.388792 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 11:14:24.447230 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 11:14:24.462556 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 11:14:24.477037 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 11:14:24.492258 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 11:14:24.506287 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 11:14:24.982019 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 11:14:25.125161 (Thread-5): handling status request
2021-05-18 11:14:25.125623 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '02bd1ee1-c8d7-408c-91fe-3888df0b2270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73b87b85e0>]}
2021-05-18 11:14:25.126433 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.38.35
2021-05-18 11:14:25.131071 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 11:14:25.146530 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 11:14:25.161845 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 11:14:25.200422 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 11:14:25.215925 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 11:14:25.233080 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 11:14:25.329557 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 11:14:25.344020 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 11:14:25.364060 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 11:14:25.378798 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 11:14:25.395593 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 11:14:25.412272 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 11:14:25.655890 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 11:14:25.681860 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 11:14:25.714444 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 11:14:25.760009 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 11:14:25.782548 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 11:14:25.800509 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 11:14:25.818937 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 11:14:25.834627 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 11:14:26.120713 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 11:14:26.136793 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 11:14:26.281865 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 11:14:26.309963 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 11:14:26.324777 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 11:14:26.460140 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 11:14:26.484406 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 11:14:26.519480 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 11:14:26.569583 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 11:14:26.615064 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 11:14:26.666125 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 11:14:26.693111 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 11:14:26.709723 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 11:14:26.725277 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 11:14:26.740904 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 11:14:26.756245 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 11:14:26.771896 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 11:14:26.888946 (Thread-6): handling status request
2021-05-18 11:14:26.909773 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '02bd1ee1-c8d7-408c-91fe-3888df0b2270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73b8246fa0>]}
2021-05-18 11:14:26.915648 (Thread-6): sending response (<Response 184 bytes [200 OK]>) to 10.0.9.201
2021-05-18 11:14:27.034805 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 11:14:27.051678 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 11:14:27.067563 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 11:14:27.090284 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 11:14:27.104947 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 11:14:27.542261 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 11:14:27.559117 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 11:14:27.581584 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 11:14:27.596811 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 11:14:27.719413 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 11:14:27.750890 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 11:14:27.768104 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 11:14:28.027403 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 11:14:28.317040 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.marts
- models.DBTTest.utils
- models.DBTTest.Views
- models.DBTTest.Targets
- models.DBTTest.Stage_Layer
- models.DBTTest.sources
- seeds.DBTTest

2021-05-18 11:14:28.799527 (Thread-7): handling status request
2021-05-18 11:14:28.799968 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '02bd1ee1-c8d7-408c-91fe-3888df0b2270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73b83a16a0>]}
2021-05-18 11:14:28.820360 (Thread-7): sending response (<Response 81715 bytes [200 OK]>) to 10.0.15.212
2021-05-18 11:14:45.283866 (MainThread): Running with dbt=0.18.1
2021-05-18 11:14:45.542791 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 11:14:45.555159 (MainThread): Tracking: tracking
2021-05-18 11:14:45.555366 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd71ab17eb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd717c42400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7105499a0>]}
2021-05-18 11:14:45.555681 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=16
2021-05-18 11:14:45.557768 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 11:14:45.566381 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 11:14:45.752510 (Thread-2): handling status request
2021-05-18 11:14:45.752895 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd71057f640>]}
2021-05-18 11:14:45.754500 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.28.79
2021-05-18 11:14:46.084019 (Thread-1): Parsing macros/metrics.sql
2021-05-18 11:14:46.096941 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 11:14:46.101702 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 11:14:46.106624 (Thread-1): Parsing macros/adapters.sql
2021-05-18 11:14:46.135986 (Thread-1): Parsing macros/catalog.sql
2021-05-18 11:14:46.137986 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 11:14:46.141891 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 11:14:46.143898 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 11:14:46.153089 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 11:14:46.155377 (Thread-1): Parsing macros/core.sql
2021-05-18 11:14:46.159065 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 11:14:46.168043 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 11:14:46.182077 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 11:14:46.183832 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 11:14:46.199901 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 11:14:46.229607 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 11:14:46.234430 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 11:14:46.240490 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 11:14:46.260669 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 11:14:46.267111 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 11:14:46.268900 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 11:14:46.274745 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 11:14:46.276327 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 11:14:46.277368 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 11:14:46.285916 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 11:14:46.286852 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 11:14:46.288494 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 11:14:46.290441 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 11:14:46.291982 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 11:14:46.294608 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 11:14:46.296466 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 11:14:46.298212 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 11:14:46.345735 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 11:14:46.364200 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 11:14:46.398633 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 11:14:46.402638 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 11:14:46.408889 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 11:14:46.412843 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 11:14:46.418894 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 11:14:46.425297 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 11:14:46.431613 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 11:14:46.437130 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 11:14:46.444886 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 11:14:46.449124 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 11:14:46.458646 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 11:14:46.463106 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 11:14:46.467783 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 11:14:46.473250 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 11:14:46.479063 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 11:14:46.483393 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 11:14:46.492969 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 11:14:46.499808 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 11:14:46.504584 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 11:14:46.518480 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 11:14:46.545663 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 11:14:46.550274 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 11:14:46.556677 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 11:14:46.561660 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 11:14:46.568499 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 11:14:46.573263 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 11:14:46.577597 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 11:14:46.581742 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 11:14:46.588638 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 11:14:46.593576 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 11:14:46.598389 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 11:14:46.603361 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 11:14:46.612484 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 11:14:46.617944 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 11:14:46.623838 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 11:14:46.628500 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 11:14:46.633525 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 11:14:46.638051 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 11:14:46.643590 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 11:14:46.648419 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 11:14:46.655770 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 11:14:46.660151 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 11:14:46.666216 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 11:14:46.671529 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 11:14:46.676564 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 11:14:46.682387 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 11:14:46.686950 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 11:14:46.692681 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 11:14:46.706799 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 11:14:46.712915 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 11:14:46.722984 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 11:14:46.728112 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 11:14:46.732715 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 11:14:46.738080 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 11:14:46.747195 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 11:14:46.752342 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 11:14:46.756911 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 11:14:46.762494 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 11:14:46.768587 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 11:14:46.774039 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 11:14:46.780155 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 11:14:46.790057 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 11:14:46.806804 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 11:14:46.827597 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 11:14:46.835934 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 11:14:46.843809 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 11:14:46.849375 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 11:14:46.863975 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 11:14:46.871706 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 11:14:46.878414 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 11:14:46.888608 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 11:14:46.912170 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 11:14:46.929680 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 11:14:46.936667 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 11:14:46.947076 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 11:14:46.969786 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 11:14:46.984327 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 11:14:46.989796 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 11:14:46.994189 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 11:14:46.998795 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 11:14:47.003213 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 11:14:47.008863 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 11:14:47.014228 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 11:14:47.018532 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 11:14:47.023636 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 11:14:47.028082 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 11:14:47.032187 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 11:14:47.036355 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 11:14:47.040192 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 11:14:47.046349 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 11:14:47.050661 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 11:14:47.055187 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 11:14:47.059577 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 11:14:47.063541 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 11:14:47.067933 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 11:14:47.072225 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 11:14:47.076196 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 11:14:47.081362 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 11:14:47.090664 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 11:14:47.095308 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 11:14:47.101772 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 11:14:47.106123 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 11:14:47.110473 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 11:14:47.115695 (Thread-1): Parsing macros/first_value.sql
2021-05-18 11:14:47.121323 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 11:14:47.126970 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 11:14:47.232159 (Thread-3): handling status request
2021-05-18 11:14:47.232544 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd710442610>]}
2021-05-18 11:14:47.233190 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.26.76
2021-05-18 11:14:47.235900 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 11:14:47.248760 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 11:14:47.255389 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 11:14:47.261166 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 11:14:47.265693 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 11:14:47.274341 (Thread-1): Parsing macros/percentile.sql
2021-05-18 11:14:47.279653 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 11:14:47.284182 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 11:14:47.290478 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 11:14:47.295334 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 11:14:47.299711 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 11:14:47.305528 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 11:14:47.310190 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 11:14:47.315860 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 11:14:47.320914 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 11:14:47.326598 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 11:14:47.339383 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 11:14:47.439668 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 11:14:47.466475 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 11:14:47.481599 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 11:14:47.500921 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 11:14:47.521420 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 11:14:47.535710 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 11:14:47.548981 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 11:14:47.563890 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 11:14:47.583965 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 11:14:47.620512 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 11:14:47.866914 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 11:14:47.909183 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 11:14:47.983525 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 11:14:48.011468 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 11:14:48.029185 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 11:14:48.054855 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 11:14:48.365187 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 11:14:48.381267 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 11:14:48.399109 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 11:14:48.496349 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 11:14:48.511744 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 11:14:48.526801 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 11:14:48.541288 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 11:14:48.555637 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 11:14:48.571340 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 11:14:48.587362 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 11:14:48.612285 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 11:14:48.627976 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 11:14:48.645433 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 11:14:48.660552 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 11:14:48.674923 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 11:14:48.689545 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 11:14:48.708514 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 11:14:48.724757 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 11:14:48.741196 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 11:14:48.756846 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 11:14:48.772470 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 11:14:48.773231 (Thread-4): handling status request
2021-05-18 11:14:48.787631 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 11:14:48.791799 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd70b66ee80>]}
2021-05-18 11:14:48.801923 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.38.35
2021-05-18 11:14:49.055383 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 11:14:49.077013 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 11:14:49.103430 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 11:14:49.135007 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 11:14:49.156341 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 11:14:49.182832 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 11:14:49.205850 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 11:14:49.218684 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 11:14:49.233568 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 11:14:49.246719 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 11:14:49.259825 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 11:14:49.273597 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 11:14:49.562855 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 11:14:49.578100 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 11:14:49.604515 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 11:14:49.949317 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 11:14:49.963696 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 11:14:49.978109 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 11:14:49.992106 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 11:14:50.173042 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 11:14:50.204751 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 11:14:50.227334 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 11:14:50.252753 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 11:14:50.295052 (Thread-5): handling status request
2021-05-18 11:14:50.295392 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd70b6fb790>]}
2021-05-18 11:14:50.295997 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.31.81
2021-05-18 11:14:50.300812 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 11:14:50.356194 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 11:14:50.370159 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 11:14:50.384665 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 11:14:50.398877 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 11:14:50.412870 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 11:14:50.967280 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 11:14:50.982786 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 11:14:50.999875 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 11:14:51.015229 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 11:14:51.051983 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 11:14:51.067281 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 11:14:51.082022 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 11:14:51.167135 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 11:14:51.181055 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 11:14:51.200385 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 11:14:51.215278 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 11:14:51.230584 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 11:14:51.245782 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 11:14:51.465019 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 11:14:51.487166 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 11:14:51.520064 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 11:14:51.561104 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 11:14:51.582141 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 11:14:51.597657 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 11:14:51.612544 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 11:14:51.627727 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 11:14:51.912631 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 11:14:52.033004 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 11:14:52.052596 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 11:14:52.098363 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 11:14:52.121131 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 11:14:52.262470 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 11:14:52.287089 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 11:14:52.317002 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 11:14:52.370755 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 11:14:52.418103 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 11:14:52.473013 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 11:14:52.500448 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 11:14:52.515437 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 11:14:52.530401 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 11:14:52.545736 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 11:14:52.561410 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 11:14:52.576437 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 11:14:52.825909 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 11:14:52.841939 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 11:14:52.857638 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 11:14:52.879123 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 11:14:52.893231 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 11:14:53.276155 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 11:14:53.290712 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 11:14:53.313008 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 11:14:53.327624 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 11:14:53.442613 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 11:14:53.472224 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 11:14:53.487750 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 11:14:53.708509 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 11:14:54.031987 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.marts
- models.DBTTest.sources
- models.DBTTest.utils
- models.DBTTest.Targets
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-18 11:14:54.698243 (Thread-6): handling status request
2021-05-18 11:14:54.698691 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7103807f0>]}
2021-05-18 11:14:54.719106 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.23.200
2021-05-18 11:14:57.239377 (Thread-7): handling status request
2021-05-18 11:14:57.239807 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd710118670>]}
2021-05-18 11:14:57.260170 (Thread-7): sending response (<Response 81715 bytes [200 OK]>) to 10.0.10.193
2021-05-18 11:14:58.296145 (Thread-8): handling run_sql request
2021-05-18 11:14:58.296577 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7100ecf10>]}
2021-05-18 11:14:58.299218 (Thread-8): Connection 'model.dbt_date.dates' was properly closed.
2021-05-18 11:14:59.315906 (Thread-8): sending response (<Response 137 bytes [200 OK]>) to 10.0.41.185
2021-05-18 11:14:59.335123 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 11:14:59.358652 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 11:14:59.359109 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 11:14:59.359218 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 11:14:59.372539 (Thread-1): finished collecting timing info
2021-05-18 11:14:59.381204 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 11:14:59.381279 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company inner join calendar on to_date(PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from segr_metric where r_type='Year' and r_metric_id= 7
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 11:14:59.381335 (Thread-1): Opening a new connection, currently in state init
2021-05-18 11:14:59.843377 (Thread-9): handling poll request
2021-05-18 11:14:59.843857 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd70b21e130>]}
2021-05-18 11:14:59.848564 (Thread-9): sending response (<Response 15327 bytes [200 OK]>) to 10.0.38.35
2021-05-18 11:15:01.413037 (Thread-10): handling poll request
2021-05-18 11:15:01.413466 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd70b78f4c0>]}
2021-05-18 11:15:01.414365 (Thread-10): sending response (<Response 398 bytes [200 OK]>) to 10.0.3.3
2021-05-18 11:15:02.665797 (Thread-1): SQL status: SUCCESS 500 in 3.28 seconds
2021-05-18 11:15:02.682982 (Thread-1): finished collecting timing info
2021-05-18 11:15:02.683398 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 11:15:02.973095 (Thread-11): handling poll request
2021-05-18 11:15:02.973534 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7101bbe50>]}
2021-05-18 11:15:02.974689 (Thread-11): sending response (<Response 1338 bytes [200 OK]>) to 10.0.24.25
2021-05-18 11:15:04.417647 (Thread-12): handling poll request
2021-05-18 11:15:04.418082 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd70b4604f0>]}
2021-05-18 11:15:04.425467 (Thread-12): sending response (<Response 109678 bytes [200 OK]>) to 10.0.28.79
2021-05-18 11:15:33.795370 (Thread-13): handling status request
2021-05-18 11:15:33.797455 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd70b21e0a0>]}
2021-05-18 11:15:33.818464 (Thread-13): sending response (<Response 81715 bytes [200 OK]>) to 10.0.24.25
2021-05-18 11:15:34.675829 (Thread-14): handling run_sql request
2021-05-18 11:15:34.676249 (Thread-14): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd710350f40>]}
2021-05-18 11:15:35.689363 (Thread-14): sending response (<Response 137 bytes [200 OK]>) to 10.0.41.185
2021-05-18 11:15:35.709015 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 11:15:35.732289 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-18 11:15:35.732738 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-18 11:15:35.732847 (Thread-1): Compiling rpc.DBTTest.request
2021-05-18 11:15:35.746354 (Thread-1): finished collecting timing info
2021-05-18 11:15:35.754988 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-18 11:15:35.755085 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE,CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE,CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),segr_metric AS (
    --- SF  New Leads by industry 7
       select 
            count(source_id) as r_count,
            0 AS r_amount,
            7 AS r_metric_id,
            INDUSTRY as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8

         -- New Leads by Lead Source 18
     union
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            18 AS r_metric_id,
            LEAD_SOURCE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --New Leads by Lead Status 19      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            19 AS r_metric_id,
            STATUS as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 

      union    --Accounts by Type 28      
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            28 AS r_metric_id,
            acc.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account acc ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8 
       
      union    --Leads by emp_id= 30     
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            30 AS r_metric_id,
            owner_id as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8  

      union    --Leads by location= 31   
     select 
            count(source_id) as r_count,
            0 AS r_amount,
            31 AS r_metric_id,
            concat(led.street,' ',led.city,' ',led.state,' ',led.postal_code,' ',led.country) as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead as led ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
     
      union    --Opportunities by type = 32  
     select 
            count(source_id) as r_count,
            sum(oppo.AMOUNT) AS r_amount,
            32 AS r_metric_id,
            oppo.TYPE as r_segment_name,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as oppo ,PERIOD  
        where 
         timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7,8   
  -- HS
       union    --Deals by Original Source Data= 52 
      select 
            count(deal.Source_deal_id) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            52 AS r_metric_id,
            OPPORTUNITY_STG.Source as r_segment_name,
            deal.Source_type as r_Source_type, 
            calendar.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal left join DBT_SALESDATAFLO.Stg_Deal_Stage as OPPORTUNITY_STG on OPPORTUNITY_STG.SOURCE_DEAL_ID = deal.Source_DEAL_ID 
        and OPPORTUNITY_STG.Source_type = deal.Source_type  inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
        where 
         timeframe_type is not null
         and to_date(deal.PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date
        group by 4,5,6,7,8   
    
    union   --Deals Created by Pipeline 62

        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            62 AS r_metric_id,
            DEAL_PIPELINE_STAGE_ID as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(deal.PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8
    
    union   --Revenue by Company 85

        select
           
            count(Source_ID) as r_count,
            COALESCE(sum(PROPERTY_ANNUALREVENUE),0) AS r_amount,
            85 AS r_metric_id,
            PROPERTY_NAME as r_segment_name,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Company inner join calendar on to_date(PROPERTY_CREATEDATE)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(PROPERTY_CREATEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7,8



 

),seg_fs AS(
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(10)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7,8
    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe  from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7,8

    union
    select sum(count) as f_count,sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id,
    metric_id as f_metric_id,segment_name as f_segment_name,tmf.year as f_year,timeframe_type as f_timeframe_type,
    tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES_SEGMENTED as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME as tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7,8

),compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_segment_name,
    f_segment_name,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES'
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from segr_metric ,seg_fs where segr_metric.r_metric_id=seg_fs.f_metric_id 
    and r_segment_name = f_segment_name
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)


select * from compare_result where r_type='Year' and r_metric_id= 7
limit 500
/* limit added automatically by dbt cloud */
2021-05-18 11:15:35.755145 (Thread-1): Opening a new connection, currently in state init
2021-05-18 11:15:36.154369 (Thread-15): handling poll request
2021-05-18 11:15:36.154843 (Thread-15): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd70b7690d0>]}
2021-05-18 11:15:36.157079 (Thread-15): sending response (<Response 15330 bytes [200 OK]>) to 10.0.31.81
2021-05-18 11:15:37.626498 (Thread-16): handling poll request
2021-05-18 11:15:37.626930 (Thread-16): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd70b769430>]}
2021-05-18 11:15:37.627831 (Thread-16): sending response (<Response 398 bytes [200 OK]>) to 10.0.38.35
2021-05-18 11:15:39.120615 (Thread-17): handling poll request
2021-05-18 11:15:39.121076 (Thread-17): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd70b769b20>]}
2021-05-18 11:15:39.121959 (Thread-17): sending response (<Response 398 bytes [200 OK]>) to 10.0.23.200
2021-05-18 11:15:40.461268 (Thread-1): SQL status: SUCCESS 500 in 4.71 seconds
2021-05-18 11:15:40.488497 (Thread-1): finished collecting timing info
2021-05-18 11:15:40.488908 (Thread-1): On rpc.DBTTest.request: Close
2021-05-18 11:15:40.831191 (Thread-18): handling poll request
2021-05-18 11:15:40.831625 (Thread-18): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd70b6d0f70>]}
2021-05-18 11:15:40.832867 (Thread-18): sending response (<Response 1338 bytes [200 OK]>) to 10.0.47.20
2021-05-18 11:15:42.309474 (Thread-19): handling poll request
2021-05-18 11:15:42.309909 (Thread-19): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '76e18058-1460-4aa2-b2a6-850a923a080a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd710287cd0>]}
2021-05-18 11:15:42.319292 (Thread-19): sending response (<Response 156590 bytes [200 OK]>) to 10.0.5.229
2021-05-18 16:09:34.790142 (MainThread): Running with dbt=0.18.1
2021-05-18 16:09:35.090557 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-18 16:09:35.107176 (MainThread): Tracking: tracking
2021-05-18 16:09:35.108457 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f89504f8ee0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f894d623430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8945f2ab20>]}
2021-05-18 16:09:35.114127 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=16
2021-05-18 16:09:35.124441 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-18 16:09:35.124822 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-18 16:09:35.721568 (Thread-1): Parsing macros/metrics.sql
2021-05-18 16:09:35.735282 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-18 16:09:35.740722 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-18 16:09:35.745093 (Thread-1): Parsing macros/adapters.sql
2021-05-18 16:09:35.774275 (Thread-1): Parsing macros/catalog.sql
2021-05-18 16:09:35.776661 (Thread-1): Parsing macros/materializations/table.sql
2021-05-18 16:09:35.780566 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-18 16:09:35.782516 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-18 16:09:35.791619 (Thread-1): Parsing macros/materializations/view.sql
2021-05-18 16:09:35.793958 (Thread-1): Parsing macros/core.sql
2021-05-18 16:09:35.797558 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-18 16:09:35.806644 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-18 16:09:35.820994 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-18 16:09:35.822816 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-18 16:09:35.839479 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-18 16:09:35.868350 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-18 16:09:35.873437 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-18 16:09:35.879877 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-18 16:09:35.901305 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-18 16:09:35.908194 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-18 16:09:35.910237 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-18 16:09:35.916266 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-18 16:09:35.917951 (Thread-1): Parsing macros/etc/query.sql
2021-05-18 16:09:35.919111 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-18 16:09:35.927922 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-18 16:09:35.928946 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-18 16:09:35.930726 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-18 16:09:35.932763 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-18 16:09:35.934301 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-18 16:09:35.937038 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-18 16:09:35.938944 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-18 16:09:35.940734 (Thread-1): Parsing macros/adapters/common.sql
2021-05-18 16:09:35.990956 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 16:09:36.014925 (Thread-1): Parsing macros/staging_columns.sql
2021-05-18 16:09:36.031509 (Thread-2): handling status request
2021-05-18 16:09:36.041363 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '955cd77c-c9af-4ae2-9838-9cfc0768c265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8945e8a370>]}
2021-05-18 16:09:36.043119 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.23.200
2021-05-18 16:09:36.064020 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-18 16:09:36.069165 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-18 16:09:36.074234 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-18 16:09:36.079613 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-18 16:09:36.086790 (Thread-1): Parsing macros/sql/star.sql
2021-05-18 16:09:36.093893 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-18 16:09:36.101402 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-18 16:09:36.108716 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-18 16:09:36.117220 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-18 16:09:36.123012 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-18 16:09:36.133670 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-18 16:09:36.139049 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-18 16:09:36.144206 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-18 16:09:36.150885 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-18 16:09:36.157859 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-18 16:09:36.163089 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-18 16:09:36.173803 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-18 16:09:36.181326 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-18 16:09:36.186807 (Thread-1): Parsing macros/sql/union.sql
2021-05-18 16:09:36.200245 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-18 16:09:36.232292 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-18 16:09:36.238016 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-18 16:09:36.244587 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-18 16:09:36.250389 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-18 16:09:36.259718 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-18 16:09:36.265144 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-18 16:09:36.270359 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-18 16:09:36.275554 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-18 16:09:36.283370 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-18 16:09:36.288879 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-18 16:09:36.294333 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-18 16:09:36.300486 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-18 16:09:36.310711 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-18 16:09:36.317195 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-18 16:09:36.324320 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-18 16:09:36.330079 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-18 16:09:36.335724 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-18 16:09:36.341011 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-18 16:09:36.347419 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-18 16:09:36.353078 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-18 16:09:36.361113 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-18 16:09:36.366354 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-18 16:09:36.373096 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-18 16:09:36.379402 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-18 16:09:36.385024 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-18 16:09:36.392184 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-18 16:09:36.397901 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-18 16:09:36.404219 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-18 16:09:36.418864 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-18 16:09:36.426459 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-18 16:09:36.438764 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-18 16:09:36.446064 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-18 16:09:36.451586 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-18 16:09:36.458347 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-18 16:09:36.468367 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-18 16:09:36.474420 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-18 16:09:36.480030 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-18 16:09:36.618260 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-18 16:09:36.626507 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-18 16:09:36.635212 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-18 16:09:36.643013 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 16:09:36.654390 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 16:09:36.672392 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-18 16:09:36.694675 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 16:09:36.704678 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-18 16:09:36.715590 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 16:09:36.723554 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-18 16:09:36.738834 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-18 16:09:36.747514 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-18 16:09:36.757444 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-18 16:09:36.768121 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-18 16:09:36.792197 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-18 16:09:36.811067 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-18 16:09:36.820661 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-18 16:09:36.832194 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-18 16:09:36.862338 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-18 16:09:36.878187 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-18 16:09:36.884791 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-18 16:09:36.890050 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-18 16:09:36.896161 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-18 16:09:36.901211 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-18 16:09:36.908015 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-18 16:09:36.914699 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-18 16:09:36.920262 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-18 16:09:36.927652 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-18 16:09:36.933899 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-18 16:09:36.939265 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-18 16:09:36.945125 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-18 16:09:36.950366 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-18 16:09:36.959331 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-18 16:09:36.964827 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-18 16:09:36.975242 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-18 16:09:36.980828 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-18 16:09:36.985620 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-18 16:09:36.990721 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-18 16:09:36.995624 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-18 16:09:37.000793 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-18 16:09:37.007129 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-18 16:09:37.017453 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-18 16:09:37.022728 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-18 16:09:37.030250 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-18 16:09:37.035442 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-18 16:09:37.040639 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-18 16:09:37.046320 (Thread-1): Parsing macros/first_value.sql
2021-05-18 16:09:37.053031 (Thread-1): Parsing macros/json_extract.sql
2021-05-18 16:09:37.059255 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-18 16:09:37.066868 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-18 16:09:37.081439 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-18 16:09:37.088862 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-18 16:09:37.095304 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-18 16:09:37.100522 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-18 16:09:37.109832 (Thread-1): Parsing macros/percentile.sql
2021-05-18 16:09:37.117437 (Thread-1): Parsing macros/ceiling.sql
2021-05-18 16:09:37.123826 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-18 16:09:37.134833 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-18 16:09:37.140363 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-18 16:09:37.145785 (Thread-1): Parsing macros/string_agg.sql
2021-05-18 16:09:37.151909 (Thread-1): Parsing macros/array_agg.sql
2021-05-18 16:09:37.157851 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-18 16:09:37.164401 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-18 16:09:37.169867 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-18 16:09:37.175841 (Thread-1): Parsing macros/union_relations.sql
2021-05-18 16:09:37.189242 (Thread-1): Parsing macros/max_bool.sql
2021-05-18 16:09:37.309646 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-18 16:09:37.338699 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-18 16:09:37.355165 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-18 16:09:37.371944 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-18 16:09:37.389454 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-18 16:09:37.402893 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-18 16:09:37.418624 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-18 16:09:37.435279 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-18 16:09:37.456157 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-18 16:09:37.501728 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-18 16:09:37.761805 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-18 16:09:37.806343 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-18 16:09:37.883119 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-18 16:09:37.913734 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-18 16:09:37.932565 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-18 16:09:37.951793 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-18 16:09:37.963168 (Thread-3): handling status request
2021-05-18 16:09:37.963787 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '955cd77c-c9af-4ae2-9838-9cfc0768c265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f89451297f0>]}
2021-05-18 16:09:37.964463 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.3.3
2021-05-18 16:09:38.279650 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-18 16:09:38.298022 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-18 16:09:38.318454 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-18 16:09:38.423463 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 16:09:38.441716 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 16:09:38.461153 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 16:09:38.483566 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 16:09:38.634854 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 16:09:38.650273 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 16:09:38.665604 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 16:09:38.682614 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 16:09:38.698138 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 16:09:38.714574 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 16:09:38.731937 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 16:09:38.747452 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 16:09:38.763966 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-18 16:09:38.784847 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-18 16:09:38.802741 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-18 16:09:38.819572 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-18 16:09:38.836068 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-18 16:09:38.860383 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-18 16:09:38.885294 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-18 16:09:39.082621 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-18 16:09:39.106790 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-18 16:09:39.137339 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-18 16:09:39.172271 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-18 16:09:39.196687 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-18 16:09:39.226306 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-18 16:09:39.253358 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-18 16:09:39.270512 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-18 16:09:39.287145 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-18 16:09:39.303617 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-18 16:09:39.320237 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-18 16:09:39.336787 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-18 16:09:39.651410 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-18 16:09:39.667547 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-18 16:09:39.694045 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-18 16:09:40.037545 (Thread-4): handling status request
2021-05-18 16:09:40.037953 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '955cd77c-c9af-4ae2-9838-9cfc0768c265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8944f36eb0>]}
2021-05-18 16:09:40.038644 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.33.254
2021-05-18 16:09:40.112449 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-18 16:09:40.133804 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-18 16:09:40.148315 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-18 16:09:40.162627 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-18 16:09:40.355171 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-18 16:09:40.387105 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-18 16:09:40.411221 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-18 16:09:40.437507 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-18 16:09:40.485275 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-18 16:09:40.544408 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-18 16:09:40.561133 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-18 16:09:40.575759 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-18 16:09:40.591966 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-18 16:09:40.606626 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-18 16:09:41.088262 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-18 16:09:41.228836 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-18 16:09:41.245552 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-18 16:09:41.261268 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-18 16:09:41.303737 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-18 16:09:41.321178 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-18 16:09:41.338995 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-18 16:09:41.441170 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-18 16:09:41.457253 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-18 16:09:41.477898 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-18 16:09:41.492689 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-18 16:09:41.513819 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-18 16:09:41.529811 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-18 16:09:41.768895 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-18 16:09:41.792605 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-18 16:09:41.827683 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-18 16:09:41.872664 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-18 16:09:41.895204 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-18 16:09:41.911920 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-18 16:09:41.928337 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-18 16:09:41.943951 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-18 16:09:42.257955 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-18 16:09:42.400409 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-18 16:09:42.417525 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-18 16:09:42.447192 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-18 16:09:42.463580 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-18 16:09:42.597840 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-18 16:09:42.623707 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-18 16:09:42.659465 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-18 16:09:42.709376 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-18 16:09:42.756476 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-18 16:09:42.808988 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-18 16:09:42.836700 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-18 16:09:42.852245 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-18 16:09:42.867664 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-18 16:09:42.883109 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-18 16:09:42.898346 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-18 16:09:42.913919 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-18 16:09:43.175048 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-18 16:09:43.191302 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-18 16:09:43.207480 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-18 16:09:43.229964 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-18 16:09:43.245252 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-18 16:09:43.669300 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-18 16:09:43.684041 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-18 16:09:43.707097 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-18 16:09:43.721656 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-18 16:09:43.845164 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-18 16:09:43.875746 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-18 16:09:43.891686 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-18 16:09:44.129247 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-18 16:09:44.459369 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Targets
- models.DBTTest.marts
- models.DBTTest.sources
- models.DBTTest.Stage_Layer
- models.DBTTest.Views
- models.DBTTest.utils
- seeds.DBTTest

2021-05-18 16:09:50.047320 (Thread-5): handling status request
2021-05-18 16:09:50.047757 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '955cd77c-c9af-4ae2-9838-9cfc0768c265', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f89454e0f70>]}
2021-05-18 16:09:50.068280 (Thread-5): sending response (<Response 81715 bytes [200 OK]>) to 10.0.31.81
2021-05-19 01:36:34.414654 (MainThread): Running with dbt=0.18.1
2021-05-19 01:36:34.679328 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-19 01:36:34.691466 (MainThread): Tracking: tracking
2021-05-19 01:36:34.691707 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f19b32f0e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f19b041e3a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f19a8d23640>]}
2021-05-19 01:36:34.692023 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=16
2021-05-19 01:36:34.693976 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-19 01:36:34.702468 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-19 01:36:35.260965 (Thread-1): Parsing macros/metrics.sql
2021-05-19 01:36:35.274484 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-19 01:36:35.278940 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-19 01:36:35.283094 (Thread-1): Parsing macros/adapters.sql
2021-05-19 01:36:35.311261 (Thread-1): Parsing macros/catalog.sql
2021-05-19 01:36:35.313234 (Thread-1): Parsing macros/materializations/table.sql
2021-05-19 01:36:35.317138 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-19 01:36:35.319115 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-19 01:36:35.328010 (Thread-1): Parsing macros/materializations/view.sql
2021-05-19 01:36:35.330204 (Thread-1): Parsing macros/core.sql
2021-05-19 01:36:35.333789 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-19 01:36:35.342716 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-19 01:36:35.356683 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-19 01:36:35.358408 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-19 01:36:35.374527 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-19 01:36:35.401862 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-19 01:36:35.406654 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-19 01:36:35.412726 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-19 01:36:35.433031 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-19 01:36:35.439455 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-19 01:36:35.441273 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-19 01:36:35.447098 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-19 01:36:35.448684 (Thread-1): Parsing macros/etc/query.sql
2021-05-19 01:36:35.449728 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-19 01:36:35.458336 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-19 01:36:35.459284 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-19 01:36:35.460952 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-19 01:36:35.462881 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-19 01:36:35.464400 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-19 01:36:35.467117 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-19 01:36:35.469020 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-19 01:36:35.470742 (Thread-1): Parsing macros/adapters/common.sql
2021-05-19 01:36:35.518703 (Thread-1): Parsing macros/staging_columns.sql
2021-05-19 01:36:35.541771 (Thread-1): Parsing macros/staging_columns.sql
2021-05-19 01:36:35.587524 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-19 01:36:35.592598 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-19 01:36:35.596560 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-19 01:36:35.600427 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-19 01:36:35.606491 (Thread-1): Parsing macros/sql/star.sql
2021-05-19 01:36:35.612882 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-19 01:36:35.618742 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-19 01:36:35.623856 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-19 01:36:35.632995 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-19 01:36:35.638612 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-19 01:36:35.649520 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-19 01:36:35.654487 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-19 01:36:35.659074 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-19 01:36:35.665917 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-19 01:36:35.672442 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-19 01:36:35.678109 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-19 01:36:35.687659 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-19 01:36:35.694157 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-19 01:36:35.699026 (Thread-1): Parsing macros/sql/union.sql
2021-05-19 01:36:35.712713 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-19 01:36:35.739374 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-19 01:36:35.743811 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-19 01:36:35.750229 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-19 01:36:35.754704 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-19 01:36:35.761077 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-19 01:36:35.766735 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-19 01:36:35.771252 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-19 01:36:35.777580 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-19 01:36:35.784108 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-19 01:36:35.789912 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-19 01:36:35.795410 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-19 01:36:35.800331 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-19 01:36:35.809410 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-19 01:36:35.814657 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-19 01:36:35.821328 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-19 01:36:35.825925 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-19 01:36:35.831505 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-19 01:36:35.836064 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-19 01:36:35.841200 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-19 01:36:35.845892 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-19 01:36:35.852856 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-19 01:36:35.857033 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-19 01:36:35.862855 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-19 01:36:35.867625 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-19 01:36:35.873107 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-19 01:36:35.878672 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-19 01:36:35.883250 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-19 01:36:35.889797 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-19 01:36:35.903875 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-19 01:36:35.910449 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-19 01:36:35.920816 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-19 01:36:35.925846 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-19 01:36:35.930164 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-19 01:36:35.935498 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-19 01:36:35.945674 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-19 01:36:35.950500 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-19 01:36:35.955137 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-19 01:36:35.960613 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-19 01:36:35.966716 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-19 01:36:35.974404 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-19 01:36:35.981886 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 01:36:35.991640 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-19 01:36:36.007532 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-19 01:36:36.028101 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-19 01:36:36.037159 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-19 01:36:36.047200 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 01:36:36.054407 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-19 01:36:36.069653 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-19 01:36:36.078637 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-19 01:36:36.088811 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 01:36:36.100381 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-19 01:36:36.123853 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-19 01:36:36.141217 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-19 01:36:36.149091 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-19 01:36:36.159694 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-19 01:36:36.189278 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-19 01:36:36.203892 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-19 01:36:36.210056 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-19 01:36:36.215494 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-19 01:36:36.220304 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-19 01:36:36.224423 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-19 01:36:36.230842 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-19 01:36:36.237385 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-19 01:36:36.241690 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-19 01:36:36.246781 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-19 01:36:36.251837 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-19 01:36:36.256010 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-19 01:36:36.261216 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-19 01:36:36.265294 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-19 01:36:36.272940 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-19 01:36:36.277078 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-19 01:36:36.282305 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-19 01:36:36.287370 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-19 01:36:36.291974 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-19 01:36:36.297282 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-19 01:36:36.302700 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-19 01:36:36.306700 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-19 01:36:36.312164 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-19 01:36:36.322660 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-19 01:36:36.327144 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-19 01:36:36.334120 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-19 01:36:36.338848 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-19 01:36:36.344204 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-19 01:36:36.350514 (Thread-1): Parsing macros/first_value.sql
2021-05-19 01:36:36.356229 (Thread-1): Parsing macros/json_extract.sql
2021-05-19 01:36:36.361711 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-19 01:36:36.368771 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-19 01:36:36.387011 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-19 01:36:36.395286 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-19 01:36:36.402526 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-19 01:36:36.407468 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-19 01:36:36.511709 (Thread-1): Parsing macros/percentile.sql
2021-05-19 01:36:36.517153 (Thread-1): Parsing macros/ceiling.sql
2021-05-19 01:36:36.521949 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-19 01:36:36.529260 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-19 01:36:36.534053 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-19 01:36:36.538824 (Thread-1): Parsing macros/string_agg.sql
2021-05-19 01:36:36.544467 (Thread-1): Parsing macros/array_agg.sql
2021-05-19 01:36:36.550271 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-19 01:36:36.554929 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-19 01:36:36.560110 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-19 01:36:36.564893 (Thread-1): Parsing macros/union_relations.sql
2021-05-19 01:36:36.577192 (Thread-1): Parsing macros/max_bool.sql
2021-05-19 01:36:36.675910 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-19 01:36:36.702776 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-19 01:36:36.718625 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-19 01:36:36.733786 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-19 01:36:36.749951 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-19 01:36:36.765202 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-19 01:36:36.778698 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-19 01:36:36.796628 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-19 01:36:36.817947 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-19 01:36:36.854203 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-19 01:36:37.096180 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-19 01:36:37.138782 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-19 01:36:37.211297 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-19 01:36:37.239278 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-19 01:36:37.255974 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-19 01:36:37.273035 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-19 01:36:37.585019 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-19 01:36:37.600823 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-19 01:36:37.618488 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-19 01:36:37.724110 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 01:36:37.742061 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 01:36:37.760989 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 01:36:37.779988 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 01:36:37.795800 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 01:36:37.811632 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 01:36:37.827075 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 01:36:37.843441 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 01:36:37.859865 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 01:36:37.877169 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 01:36:37.893141 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 01:36:37.908752 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 01:36:37.924628 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-19 01:36:37.944785 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 01:36:37.963235 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 01:36:37.980724 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 01:36:37.997956 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 01:36:38.015148 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 01:36:38.030682 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 01:36:38.292722 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-19 01:36:38.317606 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-19 01:36:38.343626 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-19 01:36:38.374441 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-19 01:36:38.396146 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-19 01:36:38.423375 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-19 01:36:38.450659 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-19 01:36:38.466653 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-19 01:36:38.480987 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-19 01:36:38.495253 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-19 01:36:38.509802 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-19 01:36:38.526736 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-19 01:36:38.841861 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-19 01:36:38.858580 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-19 01:36:38.885494 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-19 01:36:39.250750 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-19 01:36:39.267030 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-19 01:36:39.282594 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-19 01:36:39.297691 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-19 01:36:39.496516 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-19 01:36:39.530187 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-19 01:36:39.554945 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-19 01:36:39.581638 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-19 01:36:39.630127 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-19 01:36:39.687108 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-19 01:36:39.702954 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-19 01:36:39.718715 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-19 01:36:39.735966 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-19 01:36:39.752013 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-19 01:36:40.224482 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-19 01:36:40.242341 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-19 01:36:40.259939 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-19 01:36:40.279134 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-19 01:36:40.321171 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-19 01:36:40.339855 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-19 01:36:40.356968 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-19 01:36:40.554009 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-19 01:36:40.570110 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-19 01:36:40.591887 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-19 01:36:40.607772 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-19 01:36:40.625323 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-19 01:36:40.642611 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-19 01:36:40.877803 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-19 01:36:40.903569 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-19 01:36:40.938333 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-19 01:36:40.982915 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-19 01:36:41.005399 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-19 01:36:41.022200 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-19 01:36:41.041114 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-19 01:36:41.060242 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-19 01:36:41.358913 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-19 01:36:41.378622 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-19 01:36:41.502538 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-19 01:36:41.534838 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-19 01:36:41.550911 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-19 01:36:41.688701 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-19 01:36:41.714503 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-19 01:36:41.750419 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-19 01:36:41.807914 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-19 01:36:41.855099 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-19 01:36:41.909095 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-19 01:36:41.938565 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-19 01:36:41.955584 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-19 01:36:41.972975 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-19 01:36:41.990182 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-19 01:36:42.006708 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-19 01:36:42.023660 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-19 01:36:42.313249 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-19 01:36:42.331601 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-19 01:36:42.350082 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-19 01:36:42.377074 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-19 01:36:42.393596 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-19 01:36:42.783713 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-19 01:36:42.799179 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-19 01:36:42.822297 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-19 01:36:42.837956 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-19 01:36:42.967171 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-19 01:36:42.999028 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-19 01:36:43.016221 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-19 01:36:43.260593 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-19 01:36:43.559561 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.sources
- models.DBTTest.marts
- models.DBTTest.Views
- models.DBTTest.utils
- models.DBTTest.Stage_Layer
- models.DBTTest.Targets
- seeds.DBTTest

2021-05-19 01:58:02.345102 (MainThread): Running with dbt=0.18.1
2021-05-19 01:58:02.622969 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-19 01:58:02.638171 (MainThread): Tracking: tracking
2021-05-19 01:58:02.650393 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb43144b20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb402a8fa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb402d0910>]}
2021-05-19 01:58:02.651040 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-19 01:58:02.651687 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-19 01:58:02.652139 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-19 01:58:03.222771 (Thread-1): Parsing macros/metrics.sql
2021-05-19 01:58:03.236361 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-19 01:58:03.241959 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-19 01:58:03.245986 (Thread-1): Parsing macros/adapters.sql
2021-05-19 01:58:03.274217 (Thread-1): Parsing macros/catalog.sql
2021-05-19 01:58:03.276207 (Thread-1): Parsing macros/materializations/table.sql
2021-05-19 01:58:03.279990 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-19 01:58:03.281941 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-19 01:58:03.290929 (Thread-1): Parsing macros/materializations/view.sql
2021-05-19 01:58:03.293143 (Thread-1): Parsing macros/core.sql
2021-05-19 01:58:03.296700 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-19 01:58:03.305221 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-19 01:58:03.318926 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-19 01:58:03.320684 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-19 01:58:03.336592 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-19 01:58:03.364536 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-19 01:58:03.369479 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-19 01:58:03.375736 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-19 01:58:03.397191 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-19 01:58:03.404173 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-19 01:58:03.406173 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-19 01:58:03.413660 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-19 01:58:03.416337 (Thread-1): Parsing macros/etc/query.sql
2021-05-19 01:58:03.418265 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-19 01:58:03.432824 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-19 01:58:03.434571 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-19 01:58:03.437449 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-19 01:58:03.440770 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-19 01:58:03.443240 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-19 01:58:03.447570 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-19 01:58:03.450713 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-19 01:58:03.453639 (Thread-1): Parsing macros/adapters/common.sql
2021-05-19 01:58:03.503229 (Thread-1): Parsing macros/staging_columns.sql
2021-05-19 01:58:03.524895 (Thread-1): Parsing macros/staging_columns.sql
2021-05-19 01:58:03.541448 (Thread-2): handling status request
2021-05-19 01:58:03.549918 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3f1dc220>]}
2021-05-19 01:58:03.551680 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.39.25
2021-05-19 01:58:03.563823 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-19 01:58:03.569153 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-19 01:58:03.574275 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-19 01:58:03.579277 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-19 01:58:03.588730 (Thread-1): Parsing macros/sql/star.sql
2021-05-19 01:58:03.596931 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-19 01:58:03.604187 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-19 01:58:03.610493 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-19 01:58:03.619947 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-19 01:58:03.626688 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-19 01:58:03.639960 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-19 01:58:03.646110 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-19 01:58:03.651919 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-19 01:58:03.658896 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-19 01:58:03.665958 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-19 01:58:03.671599 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-19 01:58:03.682111 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-19 01:58:03.690630 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-19 01:58:03.696487 (Thread-1): Parsing macros/sql/union.sql
2021-05-19 01:58:03.710562 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-19 01:58:03.737807 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-19 01:58:03.743245 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-19 01:58:03.753021 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-19 01:58:03.758854 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-19 01:58:03.766500 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-19 01:58:03.771993 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-19 01:58:03.777335 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-19 01:58:03.784496 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-19 01:58:03.792084 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-19 01:58:03.797848 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-19 01:58:03.804002 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-19 01:58:03.810216 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-19 01:58:03.820817 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-19 01:58:03.827645 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-19 01:58:03.834450 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-19 01:58:03.840514 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-19 01:58:03.846825 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-19 01:58:03.851914 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-19 01:58:03.858149 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-19 01:58:03.863651 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-19 01:58:03.871820 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-19 01:58:03.878104 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-19 01:58:03.884640 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-19 01:58:03.890529 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-19 01:58:03.896048 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-19 01:58:03.902642 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-19 01:58:03.909222 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-19 01:58:03.915054 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-19 01:58:03.931820 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-19 01:58:03.939418 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-19 01:58:03.950541 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-19 01:58:03.956438 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-19 01:58:03.961758 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-19 01:58:03.967690 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-19 01:58:03.977138 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-19 01:58:03.982871 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-19 01:58:03.987961 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-19 01:58:04.097633 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-19 01:58:04.104373 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-19 01:58:04.111935 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-19 01:58:04.119085 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 01:58:04.130016 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-19 01:58:04.146746 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-19 01:58:04.167517 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-19 01:58:04.174171 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-19 01:58:04.183726 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 01:58:04.190849 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-19 01:58:04.205757 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-19 01:58:04.214010 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-19 01:58:04.225484 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 01:58:04.240426 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-19 01:58:04.264331 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-19 01:58:04.282051 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-19 01:58:04.289882 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-19 01:58:04.305516 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-19 01:58:04.331902 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-19 01:58:04.344427 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-19 01:58:04.348492 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-19 01:58:04.351552 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-19 01:58:04.354901 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-19 01:58:04.357905 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-19 01:58:04.362647 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-19 01:58:04.366696 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-19 01:58:04.369639 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-19 01:58:04.373362 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-19 01:58:04.376452 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-19 01:58:04.379031 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-19 01:58:04.382165 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-19 01:58:04.384821 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-19 01:58:04.389837 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-19 01:58:04.392921 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-19 01:58:04.395919 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-19 01:58:04.399189 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-19 01:58:04.402077 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-19 01:58:04.405323 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-19 01:58:04.409661 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-19 01:58:04.412259 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-19 01:58:04.416040 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-19 01:58:04.425474 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-19 01:58:04.431459 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-19 01:58:04.439071 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-19 01:58:04.444270 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-19 01:58:04.459108 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-19 01:58:04.464953 (Thread-1): Parsing macros/first_value.sql
2021-05-19 01:58:04.473266 (Thread-1): Parsing macros/json_extract.sql
2021-05-19 01:58:04.480098 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-19 01:58:04.487630 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-19 01:58:04.501272 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-19 01:58:04.508268 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-19 01:58:04.514891 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-19 01:58:04.520136 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-19 01:58:04.528816 (Thread-1): Parsing macros/percentile.sql
2021-05-19 01:58:04.535851 (Thread-1): Parsing macros/ceiling.sql
2021-05-19 01:58:04.541526 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-19 01:58:04.549924 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-19 01:58:04.555563 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-19 01:58:04.560761 (Thread-1): Parsing macros/string_agg.sql
2021-05-19 01:58:04.567230 (Thread-1): Parsing macros/array_agg.sql
2021-05-19 01:58:04.572814 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-19 01:58:04.578621 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-19 01:58:04.583804 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-19 01:58:04.591322 (Thread-1): Parsing macros/union_relations.sql
2021-05-19 01:58:04.604265 (Thread-1): Parsing macros/max_bool.sql
2021-05-19 01:58:04.703978 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-19 01:58:04.731143 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-19 01:58:04.746323 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-19 01:58:04.763201 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-19 01:58:04.780279 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-19 01:58:04.793009 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-19 01:58:04.807111 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-19 01:58:04.822773 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-19 01:58:04.842532 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-19 01:58:04.879074 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-19 01:58:05.127122 (Thread-3): handling status request
2021-05-19 01:58:05.138531 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e6e99d0>]}
2021-05-19 01:58:05.139241 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.43.16
2021-05-19 01:58:05.148388 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-19 01:58:05.191236 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-19 01:58:05.272372 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-19 01:58:05.306137 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-19 01:58:05.326449 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-19 01:58:05.346180 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-19 01:58:05.659281 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-19 01:58:05.675525 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-19 01:58:05.694640 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-19 01:58:05.804992 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 01:58:05.821983 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 01:58:05.838238 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 01:58:05.855419 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 01:58:05.995237 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 01:58:06.010705 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 01:58:06.025830 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 01:58:06.042107 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 01:58:06.057122 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 01:58:06.071515 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 01:58:06.085642 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 01:58:06.101443 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 01:58:06.118394 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-19 01:58:06.137365 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 01:58:06.153993 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 01:58:06.169753 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 01:58:06.188371 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 01:58:06.206750 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 01:58:06.225494 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 01:58:06.415835 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-19 01:58:06.439741 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-19 01:58:06.470150 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-19 01:58:06.504241 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-19 01:58:06.526624 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-19 01:58:06.554388 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-19 01:58:06.583918 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-19 01:58:06.605839 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-19 01:58:06.628810 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-19 01:58:06.653131 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-19 01:58:06.670578 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-19 01:58:06.687032 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-19 01:58:06.718218 (Thread-4): handling status request
2021-05-19 01:58:06.718681 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e7c0e20>]}
2021-05-19 01:58:06.719423 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.22.221
2021-05-19 01:58:07.003054 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-19 01:58:07.024889 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-19 01:58:07.051876 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-19 01:58:07.468459 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-19 01:58:07.483584 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-19 01:58:07.498197 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-19 01:58:07.512783 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-19 01:58:07.706352 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-19 01:58:07.757700 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-19 01:58:07.781645 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-19 01:58:07.807973 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-19 01:58:07.858584 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-19 01:58:07.917020 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-19 01:58:07.933057 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-19 01:58:07.948802 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-19 01:58:07.963951 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-19 01:58:07.978797 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-19 01:58:08.244971 (Thread-5): handling status request
2021-05-19 01:58:08.265949 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e250760>]}
2021-05-19 01:58:08.272009 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.30.81
2021-05-19 01:58:08.570149 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-19 01:58:08.585813 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-19 01:58:08.601781 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-19 01:58:08.618089 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-19 01:58:08.659071 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-19 01:58:08.675760 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-19 01:58:08.692177 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-19 01:58:08.788566 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-19 01:58:08.803038 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-19 01:58:08.823470 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-19 01:58:08.839466 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-19 01:58:08.855255 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-19 01:58:08.871935 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-19 01:58:09.105059 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-19 01:58:09.126621 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-19 01:58:09.158548 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-19 01:58:09.198144 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-19 01:58:09.218753 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-19 01:58:09.234185 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-19 01:58:09.248967 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-19 01:58:09.264112 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-19 01:58:09.563891 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-19 01:58:09.690379 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-19 01:58:09.704083 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-19 01:58:09.731383 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-19 01:58:09.746478 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-19 01:58:09.889545 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-19 01:58:09.914132 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-19 01:58:09.948584 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-19 01:58:09.996875 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-19 01:58:10.042645 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-19 01:58:10.094038 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-19 01:58:10.121218 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-19 01:58:10.136488 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-19 01:58:10.151589 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-19 01:58:10.166974 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-19 01:58:10.182986 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-19 01:58:10.200924 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-19 01:58:10.460004 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-19 01:58:10.476575 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-19 01:58:10.492306 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-19 01:58:10.513405 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-19 01:58:10.527830 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-19 01:58:10.925003 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-19 01:58:10.940798 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-19 01:58:10.963180 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-19 01:58:10.977073 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-19 01:58:11.093138 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-19 01:58:11.123304 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-19 01:58:11.141413 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-19 01:58:11.393027 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-19 01:58:11.635565 (Thread-6): handling status request
2021-05-19 01:58:11.646280 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb4d31d820>]}
2021-05-19 01:58:11.657252 (Thread-6): sending response (<Response 184 bytes [200 OK]>) to 10.0.9.2
2021-05-19 01:58:11.699428 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.marts
- models.DBTTest.sources
- models.DBTTest.Targets
- models.DBTTest.utils
- models.DBTTest.Views
- models.DBTTest.Stage_Layer
- seeds.DBTTest

2021-05-19 01:58:15.585128 (Thread-7): handling status request
2021-05-19 01:58:15.585582 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e90c9a0>]}
2021-05-19 01:58:15.606399 (Thread-7): sending response (<Response 81715 bytes [200 OK]>) to 10.0.28.30
2021-05-19 01:59:50.547382 (Thread-8): handling status request
2021-05-19 01:59:50.549699 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e654eb0>]}
2021-05-19 01:59:50.569501 (Thread-8): sending response (<Response 81715 bytes [200 OK]>) to 10.0.16.22
2021-05-19 01:59:51.082391 (Thread-9): handling run_sql request
2021-05-19 01:59:51.082831 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e5c8610>]}
2021-05-19 01:59:51.085413 (Thread-9): Connection 'model.dbt_date.dates' was properly closed.
2021-05-19 01:59:52.109832 (Thread-9): sending response (<Response 137 bytes [200 OK]>) to 10.0.11.26
2021-05-19 01:59:52.129404 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-19 01:59:52.153941 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-19 01:59:52.154358 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-19 01:59:52.154464 (Thread-1): Compiling rpc.DBTTest.request
2021-05-19 01:59:52.167452 (Thread-1): finished collecting timing info
2021-05-19 01:59:52.168882 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-19 01:59:52.168946 (Thread-1): On rpc.DBTTest.request: With calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_ads AS(

      select
           
            Sum(cost_in_local_currency) as r_value,
            172 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
      from DBT_SALESDATAFLO.Stg_Ad_Analytics_By_Creative eng inner join calendar on to_date(DAY)=CLDR_DATE
         where 
         timeframe_type is not null
         and to_date(DAY) between calendar.start_date and calendar.end_date 
         group by 3,4,5,6
)

select * from r_ads
limit 500
/* limit added automatically by dbt cloud */
2021-05-19 01:59:52.168998 (Thread-1): Opening a new connection, currently in state init
2021-05-19 01:59:52.646714 (Thread-10): handling poll request
2021-05-19 01:59:52.647230 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e6ef640>]}
2021-05-19 01:59:52.651019 (Thread-10): sending response (<Response 4366 bytes [200 OK]>) to 10.0.18.250
2021-05-19 01:59:54.234914 (Thread-11): handling poll request
2021-05-19 01:59:54.235341 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e54cdc0>]}
2021-05-19 01:59:54.236191 (Thread-11): sending response (<Response 391 bytes [200 OK]>) to 10.0.9.2
2021-05-19 01:59:54.769808 (Thread-1): SQL status: SUCCESS 9 in 2.60 seconds
2021-05-19 01:59:54.773135 (Thread-1): finished collecting timing info
2021-05-19 01:59:54.773536 (Thread-1): On rpc.DBTTest.request: Close
2021-05-19 01:59:55.788183 (Thread-12): handling poll request
2021-05-19 01:59:55.788769 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e8442b0>]}
2021-05-19 01:59:55.793455 (Thread-12): sending response (<Response 11271 bytes [200 OK]>) to 10.0.22.221
2021-05-19 02:00:26.696192 (Thread-13): handling status request
2021-05-19 02:00:26.698383 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e8060d0>]}
2021-05-19 02:00:26.720211 (Thread-13): sending response (<Response 81715 bytes [200 OK]>) to 10.0.37.250
2021-05-19 02:00:27.496378 (Thread-14): handling run_sql request
2021-05-19 02:00:27.496875 (Thread-14): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e8de850>]}
2021-05-19 02:00:28.590031 (Thread-14): sending response (<Response 137 bytes [200 OK]>) to 10.0.14.149
2021-05-19 02:00:28.614231 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-19 02:00:28.637836 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-19 02:00:28.638387 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-19 02:00:28.638505 (Thread-1): Compiling rpc.DBTTest.request
2021-05-19 02:00:28.652448 (Thread-1): finished collecting timing info
2021-05-19 02:00:28.662276 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-19 02:00:28.662397 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='EMAIL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  --where 1=1
--r_timeframe_type='W'
--  and r_metric_id=66
--  and r_type='Month'
limit 500
/* limit added automatically by dbt cloud */
2021-05-19 02:00:28.662459 (Thread-1): Opening a new connection, currently in state init
2021-05-19 02:00:29.169582 (Thread-15): handling poll request
2021-05-19 02:00:29.170116 (Thread-15): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': '246eb332-f0e0-4d22-b0f9-f9a430ad1f35', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcb3e2b4dc0>]}
2021-05-19 02:00:29.172237 (Thread-15): sending response (<Response 16813 bytes [200 OK]>) to 10.0.43.16
2021-05-19 02:00:39.304563 (Thread-1): SQL status: SUCCESS 449 in 10.64 seconds
2021-05-19 02:00:39.322953 (Thread-1): finished collecting timing info
2021-05-19 02:00:39.323372 (Thread-1): On rpc.DBTTest.request: Close
2021-05-19 02:01:41.311701 (MainThread): Running with dbt=0.18.1
2021-05-19 02:01:41.582528 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-19 02:01:41.595409 (MainThread): Tracking: tracking
2021-05-19 02:01:41.600733 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c40299f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c3d3c3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c35cd0130>]}
2021-05-19 02:01:41.605394 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-19 02:01:41.605745 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-19 02:01:41.605958 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-19 02:01:41.973016 (Thread-2): handling status request
2021-05-19 02:01:41.973469 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c35cb2820>]}
2021-05-19 02:01:41.975468 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.182
2021-05-19 02:01:42.155672 (Thread-1): Parsing macros/metrics.sql
2021-05-19 02:01:42.169245 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-19 02:01:42.173981 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-19 02:01:42.177990 (Thread-1): Parsing macros/adapters.sql
2021-05-19 02:01:42.205811 (Thread-1): Parsing macros/catalog.sql
2021-05-19 02:01:42.207782 (Thread-1): Parsing macros/materializations/table.sql
2021-05-19 02:01:42.211572 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-19 02:01:42.213538 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-19 02:01:42.222499 (Thread-1): Parsing macros/materializations/view.sql
2021-05-19 02:01:42.224664 (Thread-1): Parsing macros/core.sql
2021-05-19 02:01:42.228227 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-19 02:01:42.236770 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-19 02:01:42.250518 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-19 02:01:42.252230 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-19 02:01:42.268223 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-19 02:01:42.295825 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-19 02:01:42.300693 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-19 02:01:42.306769 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-19 02:01:42.326895 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-19 02:01:42.333338 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-19 02:01:42.335148 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-19 02:01:42.341456 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-19 02:01:42.343037 (Thread-1): Parsing macros/etc/query.sql
2021-05-19 02:01:42.344111 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-19 02:01:42.352776 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-19 02:01:42.353763 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-19 02:01:42.355404 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-19 02:01:42.357373 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-19 02:01:42.358915 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-19 02:01:42.361573 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-19 02:01:42.363439 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-19 02:01:42.365194 (Thread-1): Parsing macros/adapters/common.sql
2021-05-19 02:01:42.408975 (Thread-3): handling poll request
2021-05-19 02:01:42.409331 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c354328e0>]}
2021-05-19 02:01:42.412368 (Thread-3): sending response (<Response 304 bytes [200 OK]>) to 10.0.36.182
2021-05-19 02:01:42.415846 (Thread-1): Parsing macros/staging_columns.sql
2021-05-19 02:01:42.438996 (Thread-1): Parsing macros/staging_columns.sql
2021-05-19 02:01:42.489809 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-19 02:01:42.494491 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-19 02:01:42.498877 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-19 02:01:42.503284 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-19 02:01:42.509545 (Thread-1): Parsing macros/sql/star.sql
2021-05-19 02:01:42.516386 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-19 02:01:42.522858 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-19 02:01:42.528364 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-19 02:01:42.535946 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-19 02:01:42.540709 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-19 02:01:42.550915 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-19 02:01:42.556137 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-19 02:01:42.560838 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-19 02:01:42.566800 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-19 02:01:42.572856 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-19 02:01:42.577428 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-19 02:01:42.587443 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-19 02:01:42.594791 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-19 02:01:42.599750 (Thread-1): Parsing macros/sql/union.sql
2021-05-19 02:01:42.613233 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-19 02:01:42.639515 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-19 02:01:42.644275 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-19 02:01:42.650176 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-19 02:01:42.655367 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-19 02:01:42.664859 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-19 02:01:42.669851 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-19 02:01:42.674636 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-19 02:01:42.679215 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-19 02:01:42.686681 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-19 02:01:42.691969 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-19 02:01:42.697384 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-19 02:01:42.702640 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-19 02:01:42.711805 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-19 02:01:42.717602 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-19 02:01:42.723721 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-19 02:01:42.728899 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-19 02:01:42.733929 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-19 02:01:42.738450 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-19 02:01:42.744068 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-19 02:01:42.749073 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-19 02:01:42.756649 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-19 02:01:42.761169 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-19 02:01:42.767403 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-19 02:01:42.772776 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-19 02:01:42.778168 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-19 02:01:42.785257 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-19 02:01:42.790130 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-19 02:01:42.796799 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-19 02:01:42.814104 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-19 02:01:42.820756 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-19 02:01:42.832068 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-19 02:01:42.837580 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-19 02:01:42.843010 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-19 02:01:42.848767 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-19 02:01:42.857768 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-19 02:01:42.863081 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-19 02:01:42.868370 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-19 02:01:42.974204 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-19 02:01:42.980869 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-19 02:01:42.989765 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-19 02:01:42.996284 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 02:01:43.006534 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-19 02:01:43.025547 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-19 02:01:43.047053 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-19 02:01:43.056470 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-19 02:01:43.066750 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 02:01:43.072663 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-19 02:01:43.087590 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-19 02:01:43.096094 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-19 02:01:43.106490 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 02:01:43.118069 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-19 02:01:43.141807 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-19 02:01:43.159663 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-19 02:01:43.168334 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-19 02:01:43.179315 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-19 02:01:43.208843 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-19 02:01:43.223486 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-19 02:01:43.229815 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-19 02:01:43.234775 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-19 02:01:43.239933 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-19 02:01:43.244986 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-19 02:01:43.251698 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-19 02:01:43.257563 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-19 02:01:43.262451 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-19 02:01:43.267925 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-19 02:01:43.272323 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-19 02:01:43.277015 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-19 02:01:43.281734 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-19 02:01:43.286346 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-19 02:01:43.293959 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-19 02:01:43.298964 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-19 02:01:43.303800 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-19 02:01:43.308562 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-19 02:01:43.312739 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-19 02:01:43.317535 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-19 02:01:43.322206 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-19 02:01:43.326450 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-19 02:01:43.332145 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-19 02:01:43.342665 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-19 02:01:43.347552 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-19 02:01:43.354875 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-19 02:01:43.359978 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-19 02:01:43.364506 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-19 02:01:43.369766 (Thread-1): Parsing macros/first_value.sql
2021-05-19 02:01:43.375704 (Thread-1): Parsing macros/json_extract.sql
2021-05-19 02:01:43.381577 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-19 02:01:43.388694 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-19 02:01:43.402149 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-19 02:01:43.409137 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-19 02:01:43.415336 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-19 02:01:43.420144 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-19 02:01:43.428657 (Thread-1): Parsing macros/percentile.sql
2021-05-19 02:01:43.434398 (Thread-1): Parsing macros/ceiling.sql
2021-05-19 02:01:43.439234 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-19 02:01:43.446753 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-19 02:01:43.448865 (Thread-4): handling status request
2021-05-19 02:01:43.449239 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c35cfdcd0>]}
2021-05-19 02:01:43.449912 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.36.182
2021-05-19 02:01:43.452871 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-19 02:01:43.457889 (Thread-1): Parsing macros/string_agg.sql
2021-05-19 02:01:43.464245 (Thread-1): Parsing macros/array_agg.sql
2021-05-19 02:01:43.469557 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-19 02:01:43.474857 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-19 02:01:43.479752 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-19 02:01:43.486359 (Thread-1): Parsing macros/union_relations.sql
2021-05-19 02:01:43.506329 (Thread-1): Parsing macros/max_bool.sql
2021-05-19 02:01:43.644114 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-19 02:01:43.670167 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-19 02:01:43.686958 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-19 02:01:43.703205 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-19 02:01:43.720096 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-19 02:01:43.734560 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-19 02:01:43.748585 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-19 02:01:43.765937 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-19 02:01:43.786520 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-19 02:01:43.823098 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-19 02:01:44.074079 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-19 02:01:44.116198 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-19 02:01:44.191135 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-19 02:01:44.219084 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-19 02:01:44.236228 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-19 02:01:44.253697 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-19 02:01:44.582839 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-19 02:01:44.600535 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-19 02:01:44.624679 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-19 02:01:44.732879 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 02:01:44.750170 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 02:01:44.766672 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 02:01:44.887156 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 02:01:44.904421 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 02:01:44.920810 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 02:01:44.937653 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 02:01:44.954835 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 02:01:44.970987 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 02:01:44.987018 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 02:01:45.003346 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 02:01:45.009205 (Thread-5): handling status request
2021-05-19 02:01:45.013198 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c34eccf70>]}
2021-05-19 02:01:45.014013 (Thread-5): sending response (<Response 184 bytes [200 OK]>) to 10.0.37.250
2021-05-19 02:01:45.020504 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 02:01:45.037373 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-19 02:01:45.058111 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 02:01:45.077425 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 02:01:45.099507 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 02:01:45.118760 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 02:01:45.136980 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 02:01:45.154593 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 02:01:45.318272 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-19 02:01:45.340867 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-19 02:01:45.368891 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-19 02:01:45.399382 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-19 02:01:45.421723 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-19 02:01:45.453218 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-19 02:01:45.479943 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-19 02:01:45.495200 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-19 02:01:45.509863 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-19 02:01:45.525231 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-19 02:01:45.550899 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-19 02:01:45.566095 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-19 02:01:45.884832 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-19 02:01:45.902188 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-19 02:01:45.928737 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-19 02:01:46.291565 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-19 02:01:46.306046 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-19 02:01:46.320146 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-19 02:01:46.334110 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-19 02:01:46.522324 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-19 02:01:46.540047 (Thread-6): handling status request
2021-05-19 02:01:46.548975 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c353c3c70>]}
2021-05-19 02:01:46.554825 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-19 02:01:46.556631 (Thread-6): sending response (<Response 184 bytes [200 OK]>) to 10.0.28.30
2021-05-19 02:01:46.581041 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-19 02:01:46.607932 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-19 02:01:46.655348 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-19 02:01:46.711781 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-19 02:01:46.727693 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-19 02:01:46.743160 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-19 02:01:46.758010 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-19 02:01:46.772469 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-19 02:01:47.230340 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-19 02:01:47.356815 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-19 02:01:47.372713 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-19 02:01:47.388370 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-19 02:01:47.426340 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-19 02:01:47.442046 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-19 02:01:47.457567 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-19 02:01:47.551214 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-19 02:01:47.565262 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-19 02:01:47.584221 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-19 02:01:47.598666 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-19 02:01:47.614836 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-19 02:01:47.630402 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-19 02:01:47.863177 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-19 02:01:47.885636 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-19 02:01:47.918510 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-19 02:01:47.959731 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-19 02:01:47.980990 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-19 02:01:47.996742 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-19 02:01:48.012195 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-19 02:01:48.027548 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-19 02:01:48.082486 (Thread-7): handling status request
2021-05-19 02:01:48.098138 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c34b79a30>]}
2021-05-19 02:01:48.103913 (Thread-7): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.220
2021-05-19 02:01:48.317639 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-19 02:01:48.442945 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-19 02:01:48.457160 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-19 02:01:48.489304 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-19 02:01:48.504657 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-19 02:01:48.641796 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-19 02:01:48.666853 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-19 02:01:48.697053 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-19 02:01:48.746279 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-19 02:01:48.793203 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-19 02:01:48.847116 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-19 02:01:48.874995 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-19 02:01:48.890738 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-19 02:01:48.906984 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-19 02:01:48.922688 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-19 02:01:48.938699 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-19 02:01:48.954220 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-19 02:01:49.211308 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-19 02:01:49.227029 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-19 02:01:49.242762 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-19 02:01:49.264677 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-19 02:01:49.279151 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-19 02:01:49.664103 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-19 02:01:49.678989 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-19 02:01:49.701236 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-19 02:01:49.715212 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-19 02:01:49.812628 (Thread-8): handling status request
2021-05-19 02:01:49.826638 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c35265f10>]}
2021-05-19 02:01:49.827588 (Thread-8): sending response (<Response 184 bytes [200 OK]>) to 10.0.15.220
2021-05-19 02:01:49.835831 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-19 02:01:49.867603 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-19 02:01:49.884176 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-19 02:01:50.133677 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-19 02:01:50.451116 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.utils
- models.DBTTest.sources
- models.DBTTest.Stage_Layer
- models.DBTTest.Views
- models.DBTTest.Targets
- models.DBTTest.marts
- seeds.DBTTest

2021-05-19 02:01:56.012163 (Thread-9): handling status request
2021-05-19 02:01:56.014502 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c34bdefa0>]}
2021-05-19 02:01:56.034976 (Thread-9): sending response (<Response 81715 bytes [200 OK]>) to 10.0.37.250
2021-05-19 02:02:04.174043 (Thread-10): handling status request
2021-05-19 02:02:04.174468 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c34fcff70>]}
2021-05-19 02:02:04.196238 (Thread-10): sending response (<Response 81715 bytes [200 OK]>) to 10.0.36.182
2021-05-19 02:02:05.020125 (Thread-11): handling run_sql request
2021-05-19 02:02:05.020559 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c39b85c40>]}
2021-05-19 02:02:05.023240 (Thread-11): Connection 'model.dbt_date.dates' was properly closed.
2021-05-19 02:02:06.121028 (Thread-11): sending response (<Response 137 bytes [200 OK]>) to 10.0.30.71
2021-05-19 02:02:06.141786 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-19 02:02:06.165769 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-19 02:02:06.166242 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-19 02:02:06.166354 (Thread-1): Compiling rpc.DBTTest.request
2021-05-19 02:02:06.180019 (Thread-1): finished collecting timing info
2021-05-19 02:02:06.189448 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-19 02:02:06.189537 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='EMAIL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
  and r_metric_id=1
 and r_type='Year'
limit 500
/* limit added automatically by dbt cloud */
2021-05-19 02:02:06.189595 (Thread-1): Opening a new connection, currently in state init
2021-05-19 02:02:06.677316 (Thread-12): handling poll request
2021-05-19 02:02:06.677781 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c34f48d30>]}
2021-05-19 02:02:06.680098 (Thread-12): sending response (<Response 16804 bytes [200 OK]>) to 10.0.9.37
2021-05-19 02:02:08.171600 (Thread-13): handling poll request
2021-05-19 02:02:08.172055 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c34f485b0>]}
2021-05-19 02:02:08.173005 (Thread-13): sending response (<Response 393 bytes [200 OK]>) to 10.0.9.37
2021-05-19 02:02:09.712997 (Thread-14): handling poll request
2021-05-19 02:02:09.713423 (Thread-14): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c34f48e50>]}
2021-05-19 02:02:09.714605 (Thread-14): sending response (<Response 393 bytes [200 OK]>) to 10.0.37.250
2021-05-19 02:02:11.263430 (Thread-15): handling poll request
2021-05-19 02:02:11.263851 (Thread-15): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c34f489d0>]}
2021-05-19 02:02:11.264711 (Thread-15): sending response (<Response 392 bytes [200 OK]>) to 10.0.30.81
2021-05-19 02:02:11.985693 (Thread-1): SQL status: SUCCESS 2 in 5.80 seconds
2021-05-19 02:02:11.987454 (Thread-1): finished collecting timing info
2021-05-19 02:02:11.987832 (Thread-1): On rpc.DBTTest.request: Close
2021-05-19 02:02:12.985564 (Thread-16): handling poll request
2021-05-19 02:02:12.986018 (Thread-16): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'd8382784-751c-4773-84b8-8a7e32e3d4ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9c34f48760>]}
2021-05-19 02:02:12.990519 (Thread-16): sending response (<Response 73284 bytes [200 OK]>) to 10.0.43.16
2021-05-19 02:12:40.270728 (MainThread): Running with dbt=0.18.1
2021-05-19 02:12:40.564669 (MainThread): running dbt with arguments Namespace(cls=<class 'dbt.task.rpc.server.RPCServerTask'>, debug=False, defer=None, exclude=None, host='0.0.0.0', log_cache_events=False, log_format='default', models=None, partial_parse=True, port=8580, profile='user', profiles_dir='/usr/src/develop/.dbt', project_dir=None, record_timing_info=None, rpc_method=None, single_threaded=False, state=None, strict=False, target=None, test_new_parser=False, threads=None, use_cache=True, use_colors=None, vars='{}', version_check=True, warn_error=False, which='rpc', write_json=True)
2021-05-19 02:12:40.577051 (MainThread): Tracking: tracking
2021-05-19 02:12:40.577297 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f7076ae0f40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f7073c0a430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f706c510880>]}
2021-05-19 02:12:40.577661 (MainThread): Serving RPC server at 0.0.0.0:8580, pid=15
2021-05-19 02:12:40.578077 (MainThread): Supported methods: ['cli_args', 'compile', 'compile_sql', 'deps', 'docs.generate', 'gc', 'get-manifest', 'kill', 'poll', 'ps', 'run', 'run-operation', 'run_sql', 'seed', 'snapshot', 'snapshot-freshness', 'status', 'test']
2021-05-19 02:12:40.580204 (MainThread): Send requests to http://localhost:8580/jsonrpc
2021-05-19 02:12:41.140635 (Thread-1): Parsing macros/metrics.sql
2021-05-19 02:12:41.154095 (Thread-1): Parsing macros/generate_custom_schema_name.sql
2021-05-19 02:12:41.159690 (Thread-1): Parsing macros/datatype_conversion.sql
2021-05-19 02:12:41.163869 (Thread-1): Parsing macros/adapters.sql
2021-05-19 02:12:41.192201 (Thread-1): Parsing macros/catalog.sql
2021-05-19 02:12:41.194235 (Thread-1): Parsing macros/materializations/table.sql
2021-05-19 02:12:41.198058 (Thread-1): Parsing macros/materializations/merge.sql
2021-05-19 02:12:41.200181 (Thread-1): Parsing macros/materializations/incremental.sql
2021-05-19 02:12:41.210003 (Thread-1): Parsing macros/materializations/view.sql
2021-05-19 02:12:41.212210 (Thread-1): Parsing macros/core.sql
2021-05-19 02:12:41.216223 (Thread-1): Parsing macros/materializations/helpers.sql
2021-05-19 02:12:41.225552 (Thread-1): Parsing macros/materializations/common/merge.sql
2021-05-19 02:12:41.240360 (Thread-1): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-05-19 02:12:41.242241 (Thread-1): Parsing macros/materializations/snapshot/strategies.sql
2021-05-19 02:12:41.259234 (Thread-1): Parsing macros/materializations/snapshot/snapshot.sql
2021-05-19 02:12:41.288023 (Thread-1): Parsing macros/materializations/view/create_or_replace_view.sql
2021-05-19 02:12:41.292913 (Thread-1): Parsing macros/materializations/view/view.sql
2021-05-19 02:12:41.299084 (Thread-1): Parsing macros/materializations/seed/seed.sql
2021-05-19 02:12:41.319842 (Thread-1): Parsing macros/materializations/table/table.sql
2021-05-19 02:12:41.326392 (Thread-1): Parsing macros/materializations/incremental/helpers.sql
2021-05-19 02:12:41.328223 (Thread-1): Parsing macros/materializations/incremental/incremental.sql
2021-05-19 02:12:41.334130 (Thread-1): Parsing macros/etc/is_incremental.sql
2021-05-19 02:12:41.335704 (Thread-1): Parsing macros/etc/query.sql
2021-05-19 02:12:41.336776 (Thread-1): Parsing macros/etc/datetime.sql
2021-05-19 02:12:41.345466 (Thread-1): Parsing macros/etc/get_custom_alias.sql
2021-05-19 02:12:41.346421 (Thread-1): Parsing macros/etc/get_custom_database.sql
2021-05-19 02:12:41.348094 (Thread-1): Parsing macros/etc/get_custom_schema.sql
2021-05-19 02:12:41.350074 (Thread-1): Parsing macros/schema_tests/not_null.sql
2021-05-19 02:12:41.351577 (Thread-1): Parsing macros/schema_tests/accepted_values.sql
2021-05-19 02:12:41.354257 (Thread-1): Parsing macros/schema_tests/relationships.sql
2021-05-19 02:12:41.356220 (Thread-1): Parsing macros/schema_tests/unique.sql
2021-05-19 02:12:41.358014 (Thread-1): Parsing macros/adapters/common.sql
2021-05-19 02:12:41.404506 (Thread-1): Parsing macros/staging_columns.sql
2021-05-19 02:12:41.424938 (Thread-1): Parsing macros/staging_columns.sql
2021-05-19 02:12:41.458276 (Thread-1): Parsing macros/logger/pretty_time.sql
2021-05-19 02:12:41.462175 (Thread-1): Parsing macros/logger/log_info.sql
2021-05-19 02:12:41.465989 (Thread-1): Parsing macros/logger/pretty_log_format.sql
2021-05-19 02:12:41.469914 (Thread-1): Parsing macros/sql/pivot.sql
2021-05-19 02:12:41.475709 (Thread-1): Parsing macros/sql/star.sql
2021-05-19 02:12:41.482430 (Thread-1): Parsing macros/sql/surrogate_key.sql
2021-05-19 02:12:41.488283 (Thread-1): Parsing macros/sql/get_query_results_as_dict.sql
2021-05-19 02:12:41.493595 (Thread-1): Parsing macros/sql/get_column_values.sql
2021-05-19 02:12:41.501259 (Thread-1): Parsing macros/sql/groupby.sql
2021-05-19 02:12:41.505648 (Thread-1): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-05-19 02:12:41.515588 (Thread-1): Parsing macros/sql/nullcheck_table.sql
2021-05-19 02:12:41.520289 (Thread-1): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-05-19 02:12:41.524660 (Thread-1): Parsing macros/sql/get_relations_by_pattern.sql
2021-05-19 02:12:41.530214 (Thread-1): Parsing macros/sql/get_relations_by_prefix.sql
2021-05-19 02:12:41.535975 (Thread-1): Parsing macros/sql/safe_add.sql
2021-05-19 02:12:41.540601 (Thread-1): Parsing macros/sql/unpivot.sql
2021-05-19 02:12:41.549809 (Thread-1): Parsing macros/sql/generate_series.sql
2021-05-19 02:12:41.556906 (Thread-1): Parsing macros/sql/nullcheck.sql
2021-05-19 02:12:41.561520 (Thread-1): Parsing macros/sql/union.sql
2021-05-19 02:12:41.575136 (Thread-1): Parsing macros/materializations/insert_by_period_materialization.sql
2021-05-19 02:12:41.602571 (Thread-1): Parsing macros/web/get_url_parameter.sql
2021-05-19 02:12:41.606684 (Thread-1): Parsing macros/web/get_url_path.sql
2021-05-19 02:12:41.611905 (Thread-1): Parsing macros/web/get_url_host.sql
2021-05-19 02:12:41.616512 (Thread-1): Parsing macros/datetime/date_spine.sql
2021-05-19 02:12:41.623302 (Thread-1): Parsing macros/schema_tests/expression_is_true.sql
2021-05-19 02:12:41.627654 (Thread-1): Parsing macros/schema_tests/not_constant.sql
2021-05-19 02:12:41.631701 (Thread-1): Parsing macros/schema_tests/at_least_one.sql
2021-05-19 02:12:41.635868 (Thread-1): Parsing macros/schema_tests/equality.sql
2021-05-19 02:12:41.643353 (Thread-1): Parsing macros/schema_tests/test_not_null_where.sql
2021-05-19 02:12:41.648397 (Thread-1): Parsing macros/schema_tests/equal_rowcount.sql
2021-05-19 02:12:41.652816 (Thread-1): Parsing macros/schema_tests/test_unique_where.sql
2021-05-19 02:12:41.657477 (Thread-1): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-05-19 02:12:41.666035 (Thread-1): Parsing macros/schema_tests/relationships_where.sql
2021-05-19 02:12:41.671513 (Thread-1): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-05-19 02:12:41.677213 (Thread-1): Parsing macros/schema_tests/recency.sql
2021-05-19 02:12:41.681919 (Thread-1): Parsing macros/schema_tests/cardinality_equality.sql
2021-05-19 02:12:41.686336 (Thread-1): Parsing macros/geo/haversine_distance.sql
2021-05-19 02:12:41.690512 (Thread-1): Parsing macros/cross_db_utils/split_part.sql
2021-05-19 02:12:41.696216 (Thread-1): Parsing macros/cross_db_utils/length.sql
2021-05-19 02:12:41.700932 (Thread-1): Parsing macros/cross_db_utils/current_timestamp.sql
2021-05-19 02:12:41.708026 (Thread-1): Parsing macros/cross_db_utils/_get_utils_namespaces.sql
2021-05-19 02:12:41.712249 (Thread-1): Parsing macros/cross_db_utils/right.sql
2021-05-19 02:12:41.717863 (Thread-1): Parsing macros/cross_db_utils/hash.sql
2021-05-19 02:12:41.723007 (Thread-1): Parsing macros/cross_db_utils/replace.sql
2021-05-19 02:12:41.727696 (Thread-1): Parsing macros/cross_db_utils/concat.sql
2021-05-19 02:12:41.733352 (Thread-1): Parsing macros/cross_db_utils/_is_relation.sql
2021-05-19 02:12:41.737660 (Thread-1): Parsing macros/cross_db_utils/identifier.sql
2021-05-19 02:12:41.742818 (Thread-1): Parsing macros/cross_db_utils/datediff.sql
2021-05-19 02:12:41.757638 (Thread-1): Parsing macros/cross_db_utils/dateadd.sql
2021-05-19 02:12:41.763443 (Thread-1): Parsing macros/cross_db_utils/datatypes.sql
2021-05-19 02:12:41.773855 (Thread-1): Parsing macros/cross_db_utils/position.sql
2021-05-19 02:12:41.778787 (Thread-1): Parsing macros/cross_db_utils/literal.sql
2021-05-19 02:12:41.782886 (Thread-1): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-05-19 02:12:41.787904 (Thread-1): Parsing macros/cross_db_utils/width_bucket.sql
2021-05-19 02:12:41.796838 (Thread-1): Parsing macros/cross_db_utils/date_trunc.sql
2021-05-19 02:12:41.801627 (Thread-1): Parsing macros/cross_db_utils/except.sql
2021-05-19 02:12:41.806074 (Thread-1): Parsing macros/cross_db_utils/safe_cast.sql
2021-05-19 02:12:41.812107 (Thread-1): Parsing macros/cross_db_utils/last_day.sql
2021-05-19 02:12:41.818110 (Thread-1): Parsing macros/cross_db_utils/intersect.sql
2021-05-19 02:12:41.825859 (Thread-1): Parsing macros/get_campaign_group_history_columns.sql
2021-05-19 02:12:41.831874 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 02:12:41.841438 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-19 02:12:41.857537 (Thread-1): Parsing macros/get_ad_analytics_by_creative_columns.sql
2021-05-19 02:12:41.878358 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-19 02:12:41.885775 (Thread-1): Parsing macros/get_staging_files.sql
2021-05-19 02:12:41.896305 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 02:12:41.901807 (Thread-1): Parsing macros/get_pin_promotion_report_columns.sql
2021-05-19 02:12:41.916619 (Thread-1): Parsing macros/get_pin_promotion_history_columns.sql
2021-05-19 02:12:41.923953 (Thread-1): Parsing macros/get_ad_group_history_columns.sql
2021-05-19 02:12:41.932652 (Thread-1): Parsing macros/get_campaign_history_columns.sql
2021-05-19 02:12:41.943647 (Thread-1): Parsing macros/get_ad_set_history_columns.sql
2021-05-19 02:12:41.966005 (Thread-1): Parsing macros/get_creative_history_columns.sql
2021-05-19 02:12:41.983496 (Thread-1): Parsing macros/get_basic_ad_columns.sql
2021-05-19 02:12:41.990486 (Thread-1): Parsing macros/get_ad_history_columns.sql
2021-05-19 02:12:42.000189 (Thread-1): Parsing macros/get_account_history_columns.sql
2021-05-19 02:12:42.031941 (Thread-1): Parsing macros/get_date_dimension.sql
2021-05-19 02:12:42.045033 (Thread-1): Parsing macros/get_base_dates.sql
2021-05-19 02:12:42.048850 (Thread-1): Parsing macros/calendar_date/n_weeks_ago.sql
2021-05-19 02:12:42.051811 (Thread-1): Parsing macros/calendar_date/to_unixtimestamp.sql
2021-05-19 02:12:42.054917 (Thread-1): Parsing macros/calendar_date/yesterday.sql
2021-05-19 02:12:42.057358 (Thread-1): Parsing macros/calendar_date/month_name.sql
2021-05-19 02:12:42.061595 (Thread-1): Parsing macros/calendar_date/day_name.sql
2021-05-19 02:12:42.065312 (Thread-1): Parsing macros/calendar_date/_get_utils_namespaces.sql
2021-05-19 02:12:42.068258 (Thread-1): Parsing macros/calendar_date/date_part.sql
2021-05-19 02:12:42.071983 (Thread-1): Parsing macros/calendar_date/n_days_ago.sql
2021-05-19 02:12:42.082075 (Thread-1): Parsing macros/calendar_date/now.sql
2021-05-19 02:12:42.084456 (Thread-1): Parsing macros/calendar_date/n_months_ago.sql
2021-05-19 02:12:42.087409 (Thread-1): Parsing macros/calendar_date/this_week.sql
2021-05-19 02:12:42.089695 (Thread-1): Parsing macros/calendar_date/convert_timezone.sql
2021-05-19 02:12:42.094208 (Thread-1): Parsing macros/calendar_date/periods_since.sql
2021-05-19 02:12:42.096794 (Thread-1): Parsing macros/calendar_date/n_months_away.sql
2021-05-19 02:12:42.099488 (Thread-1): Parsing macros/calendar_date/n_days_away.sql
2021-05-19 02:12:42.102048 (Thread-1): Parsing macros/calendar_date/last_week.sql
2021-05-19 02:12:42.104376 (Thread-1): Parsing macros/calendar_date/n_weeks_away.sql
2021-05-19 02:12:42.107353 (Thread-1): Parsing macros/calendar_date/tomorrow.sql
2021-05-19 02:12:42.109863 (Thread-1): Parsing macros/calendar_date/today.sql
2021-05-19 02:12:42.112324 (Thread-1): Parsing macros/fiscal_date/get_fiscal_periods.sql
2021-05-19 02:12:42.116033 (Thread-1): Parsing macros/fiscal_date/get_fiscal_year_dates.sql
2021-05-19 02:12:42.122990 (Thread-1): Parsing macros/enabled_vars_one_true.sql
2021-05-19 02:12:42.125800 (Thread-1): Parsing macros/dummy_coalesce_value.sql
2021-05-19 02:12:42.130751 (Thread-1): Parsing macros/enabled_vars.sql
2021-05-19 02:12:42.133488 (Thread-1): Parsing macros/_get_utils_namespaces.sql
2021-05-19 02:12:42.136404 (Thread-1): Parsing macros/remove_prefix_from_columns.sql
2021-05-19 02:12:42.139756 (Thread-1): Parsing macros/first_value.sql
2021-05-19 02:12:42.143805 (Thread-1): Parsing macros/json_extract.sql
2021-05-19 02:12:42.147778 (Thread-1): Parsing macros/generate_columns_macro.sql
2021-05-19 02:12:42.153055 (Thread-1): Parsing macros/timestamp_diff.sql
2021-05-19 02:12:42.164255 (Thread-1): Parsing macros/timestamp_add.sql
2021-05-19 02:12:42.168299 (Thread-2): handling status request
2021-05-19 02:12:42.168717 (Thread-2): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f706c3dde80>]}
2021-05-19 02:12:42.170445 (Thread-2): sending response (<Response 184 bytes [200 OK]>) to 10.0.39.25
2021-05-19 02:12:42.171188 (Thread-1): Parsing macros/staging_models_automation.sql
2021-05-19 02:12:42.280116 (Thread-1): Parsing macros/snowflake_seed_data.sql
2021-05-19 02:12:42.283027 (Thread-1): Parsing macros/fill_staging_columns.sql
2021-05-19 02:12:42.289518 (Thread-1): Parsing macros/percentile.sql
2021-05-19 02:12:42.293537 (Thread-1): Parsing macros/ceiling.sql
2021-05-19 02:12:42.305777 (Thread-1): Parsing macros/get_columns_for_macro.sql
2021-05-19 02:12:42.311345 (Thread-1): Parsing macros/add_pass_through_columns.sql
2021-05-19 02:12:42.321635 (Thread-1): Parsing macros/pivot_json_extract.sql
2021-05-19 02:12:42.324380 (Thread-1): Parsing macros/string_agg.sql
2021-05-19 02:12:42.335488 (Thread-1): Parsing macros/array_agg.sql
2021-05-19 02:12:42.345750 (Thread-1): Parsing macros/fill_pass_through_columns.sql
2021-05-19 02:12:42.356145 (Thread-1): Parsing macros/empty_variable_warning.sql
2021-05-19 02:12:42.359047 (Thread-1): Parsing macros/seed_data_helper.sql
2021-05-19 02:12:42.362385 (Thread-1): Parsing macros/union_relations.sql
2021-05-19 02:12:42.373401 (Thread-1): Parsing macros/max_bool.sql
2021-05-19 02:12:42.486857 (Thread-1): Acquiring new snowflake connection "model.DBTTest.month_wise_metric_validation".
2021-05-19 02:12:42.511863 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_metric_validation".
2021-05-19 02:12:42.525013 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Quarter_wise".
2021-05-19 02:12:42.537992 (Thread-1): Acquiring new snowflake connection "model.DBTTest.yearwise_segment_fact_sales".
2021-05-19 02:12:42.550847 (Thread-1): Acquiring new snowflake connection "model.DBTTest.HS_SF_FACT".
2021-05-19 02:12:42.564059 (Thread-1): Acquiring new snowflake connection "model.DBTTest.ADS_FACT".
2021-05-19 02:12:42.576183 (Thread-1): Acquiring new snowflake connection "model.DBTTest.Test_timeframe".
2021-05-19 02:12:42.588880 (Thread-1): Acquiring new snowflake connection "model.DBTTest.SF_HF_segmented".
2021-05-19 02:12:42.606987 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.opportunity_snapshot_check".
2021-05-19 02:12:42.644547 (Thread-1): Acquiring new snowflake connection "snapshot.DBTTest.account_snapshot_check".
2021-05-19 02:12:42.927300 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance".
2021-05-19 02:12:42.971739 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance".
2021-05-19 02:12:43.048409 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance".
2021-05-19 02:12:43.075106 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__click_performance_tmp".
2021-05-19 02:12:43.090690 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__final_url_performance_tmp".
2021-05-19 02:12:43.107640 (Thread-1): Acquiring new snowflake connection "model.google_ads_source.stg_google_ads__criteria_performance_tmp".
2021-05-19 02:12:43.425798 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__click_performance".
2021-05-19 02:12:43.441489 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__url_ad_adapter".
2021-05-19 02:12:43.459073 (Thread-1): Acquiring new snowflake connection "model.google_ads.google_ads__criteria_ad_adapter".
2021-05-19 02:12:43.556860 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 02:12:43.572926 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 02:12:43.588888 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 02:12:43.603970 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 02:12:43.619733 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 02:12:43.634682 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 02:12:43.649476 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 02:12:43.665038 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 02:12:43.679431 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 02:12:43.703594 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 02:12:43.718408 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 02:12:43.732778 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 02:12:43.747048 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.utils__facebook_ads__numbers".
2021-05-19 02:12:43.766140 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__app_link".
2021-05-19 02:12:43.782858 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__url_tag".
2021-05-19 02:12:43.799445 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__creative_history_asset_feed_spec_link_url".
2021-05-19 02:12:43.833139 (Thread-3): handling status request
2021-05-19 02:12:43.833694 (Thread-3): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f706757e8e0>]}
2021-05-19 02:12:43.834374 (Thread-3): sending response (<Response 184 bytes [200 OK]>) to 10.0.28.30
2021-05-19 02:12:43.838680 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.int__facebook_ads__carousel_media_prep".
2021-05-19 02:12:43.856165 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media".
2021-05-19 02:12:43.870485 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_creative_history.stg_facebook_ads__carousel_media_url_tags".
2021-05-19 02:12:44.144547 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report".
2021-05-19 02:12:44.165854 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history".
2021-05-19 02:12:44.192180 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history".
2021-05-19 02:12:44.222412 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history".
2021-05-19 02:12:44.242861 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url".
2021-05-19 02:12:44.268034 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history".
2021-05-19 02:12:44.291621 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_report_tmp".
2021-05-19 02:12:44.305063 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__campaign_history_tmp".
2021-05-19 02:12:44.318554 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__line_item_history_tmp".
2021-05-19 02:12:44.331708 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__promoted_tweet_history_tmp".
2021-05-19 02:12:44.344657 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__tweet_url_tmp".
2021-05-19 02:12:44.358059 (Thread-1): Acquiring new snowflake connection "model.twitter_ads_source.stg_twitter_ads__account_history_tmp".
2021-05-19 02:12:44.654495 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__line_item_report".
2021-05-19 02:12:44.670312 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__ad_adapter".
2021-05-19 02:12:44.694931 (Thread-1): Acquiring new snowflake connection "model.twitter_ads.twitter__campaign_report".
2021-05-19 02:12:44.938280 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__account_ad_report".
2021-05-19 02:12:44.953124 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_ad_report".
2021-05-19 02:12:45.080371 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__campaign_group_ad_report".
2021-05-19 02:12:45.095210 (Thread-1): Acquiring new snowflake connection "model.linkedin.linkedin__ad_adapter".
2021-05-19 02:12:45.295282 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history".
2021-05-19 02:12:45.327545 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history".
2021-05-19 02:12:45.351585 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history".
2021-05-19 02:12:45.377640 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history".
2021-05-19 02:12:45.425817 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative".
2021-05-19 02:12:45.470374 (Thread-4): handling status request
2021-05-19 02:12:45.477122 (Thread-4): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f706c2d10a0>]}
2021-05-19 02:12:45.477807 (Thread-4): sending response (<Response 184 bytes [200 OK]>) to 10.0.30.81
2021-05-19 02:12:45.482855 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_history_tmp".
2021-05-19 02:12:45.498737 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__campaign_group_history_tmp".
2021-05-19 02:12:45.513369 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__account_history_tmp".
2021-05-19 02:12:45.527757 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__creative_history_tmp".
2021-05-19 02:12:45.542056 (Thread-1): Acquiring new snowflake connection "model.linkedin_source.stg_linkedin__ad_analytics_by_creative_tmp".
2021-05-19 02:12:45.996329 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_linkedin_ads".
2021-05-19 02:12:46.011647 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_pinterest_ads".
2021-05-19 02:12:46.026642 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_microsoft_ads".
2021-05-19 02:12:46.041671 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.ad_reporting".
2021-05-19 02:12:46.079088 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_facebook_ads".
2021-05-19 02:12:46.094671 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_twitter_ads".
2021-05-19 02:12:46.110486 (Thread-1): Acquiring new snowflake connection "model.ad_reporting.stg_google_ads".
2021-05-19 02:12:46.321743 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__campaign_ad_report".
2021-05-19 02:12:46.336409 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_adapter".
2021-05-19 02:12:46.355329 (Thread-1): Acquiring new snowflake connection "model.pinterest.pinterest_ads__ad_group_ad_report".
2021-05-19 02:12:46.369625 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_pin_promotion".
2021-05-19 02:12:46.384652 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_ad_group".
2021-05-19 02:12:46.400842 (Thread-1): Acquiring new snowflake connection "model.pinterest.int_pinterest_ads__most_recent_campaign".
2021-05-19 02:12:46.627745 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history".
2021-05-19 02:12:46.651060 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history".
2021-05-19 02:12:46.684636 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report".
2021-05-19 02:12:46.727179 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history".
2021-05-19 02:12:46.749041 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__ad_group_history_tmp".
2021-05-19 02:12:46.764199 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_history_tmp".
2021-05-19 02:12:46.779908 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__pin_promotion_report_tmp".
2021-05-19 02:12:46.795354 (Thread-1): Acquiring new snowflake connection "model.pinterest_source.stg_pinterest_ads__campaign_history_tmp".
2021-05-19 02:12:47.083385 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__campaign_report".
2021-05-19 02:12:47.098935 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_set_report".
2021-05-19 02:12:47.112950 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__ad_adapter".
2021-05-19 02:12:47.141322 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__account_report".
2021-05-19 02:12:47.155752 (Thread-1): Acquiring new snowflake connection "model.facebook_ads.facebook_ads__creative_history_prep".
2021-05-19 02:12:47.405028 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad".
2021-05-19 02:12:47.430706 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history".
2021-05-19 02:12:47.460305 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history".
2021-05-19 02:12:47.515232 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history".
2021-05-19 02:12:47.561883 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history".
2021-05-19 02:12:47.614298 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history".
2021-05-19 02:12:47.642078 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_history_tmp".
2021-05-19 02:12:47.657859 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__basic_ad_tmp".
2021-05-19 02:12:47.673430 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__account_history_tmp".
2021-05-19 02:12:47.688878 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__creative_history_tmp".
2021-05-19 02:12:47.704773 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__ad_set_history_tmp".
2021-05-19 02:12:47.720661 (Thread-1): Acquiring new snowflake connection "model.facebook_ads_source.stg_facebook_ads__campaign_history_tmp".
2021-05-19 02:12:47.976803 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_group_history".
2021-05-19 02:12:47.993050 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__account_history".
2021-05-19 02:12:48.010062 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_history".
2021-05-19 02:12:48.031799 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__ad_performance_daily_report".
2021-05-19 02:12:48.047845 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads_source.stg_microsoft_ads__campaign_history".
2021-05-19 02:12:48.321483 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__campaign_report".
2021-05-19 02:12:48.335550 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_adapter".
2021-05-19 02:12:48.357114 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__account_report".
2021-05-19 02:12:48.371925 (Thread-1): Acquiring new snowflake connection "model.microsoft_ads.microsoft_ads__ad_group_report".
2021-05-19 02:12:48.607665 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date_fiscal".
2021-05-19 02:12:48.637804 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dim_date".
2021-05-19 02:12:48.653711 (Thread-1): Acquiring new snowflake connection "model.dbt_date.dates".
2021-05-19 02:12:48.889846 (Thread-1): WARNING: Found documentation for resource "google_ads__ad_adapter" which was not found or is disabled
2021-05-19 02:12:49.190897 (Thread-1): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 7 unused configuration paths:
- models.DBTTest.Stage_Layer
- models.DBTTest.Targets
- models.DBTTest.marts
- models.DBTTest.sources
- models.DBTTest.utils
- models.DBTTest.Views
- seeds.DBTTest

2021-05-19 02:12:51.573401 (Thread-5): handling status request
2021-05-19 02:12:51.575353 (Thread-5): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70676ad280>]}
2021-05-19 02:12:51.596769 (Thread-5): sending response (<Response 81715 bytes [200 OK]>) to 10.0.37.250
2021-05-19 02:13:23.025731 (Thread-6): handling status request
2021-05-19 02:13:23.027734 (Thread-6): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70674a81c0>]}
2021-05-19 02:13:23.048232 (Thread-6): sending response (<Response 81715 bytes [200 OK]>) to 10.0.9.2
2021-05-19 02:13:23.774366 (Thread-7): handling run_sql request
2021-05-19 02:13:23.774783 (Thread-7): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f7067742eb0>]}
2021-05-19 02:13:23.777418 (Thread-7): Connection 'model.dbt_date.dates' was properly closed.
2021-05-19 02:13:24.793997 (Thread-7): sending response (<Response 137 bytes [200 OK]>) to 10.0.37.250
2021-05-19 02:13:24.815014 (MainThread): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-19 02:13:24.838953 (MainThread): Found 100 models, 66 tests, 2 snapshots, 0 analyses, 399 macros, 0 operations, 0 seed files, 29 sources
2021-05-19 02:13:24.839378 (Thread-1): Acquiring new snowflake connection "rpc.DBTTest.request".
2021-05-19 02:13:24.839482 (Thread-1): Compiling rpc.DBTTest.request
2021-05-19 02:13:24.852953 (Thread-1): finished collecting timing info
2021-05-19 02:13:24.862382 (Thread-1): Using snowflake connection "rpc.DBTTest.request".
2021-05-19 02:13:24.862454 (Thread-1): On rpc.DBTTest.request: WITH PERIOD AS(
     Select TYPE,start_date,end_date,
            CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Year' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as timeframe_type from SF_RKLIVE_06012021.PERIOD
       union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
           WHEN TYPE='Month' THEN UPPER(LTRIM(RTRIM(REPLACE(split(FULLY_QUALIFIED_LABEL,'FY ')[0],'"', '')))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        union
        Select TYPE,start_date,end_date,
        CASE
             WHEN TYPE='Year' OR TYPE='Quarter' or TYPE='Month' THEN cast (split(FULLY_QUALIFIED_LABEL,'FY ')[1] as varchar(1100)) 
            ELSE NULL end as year ,
        CASE
             WHEN TYPE='Quarter'  THEN UPPER(LTRIM(RTRIM(CAST(SUBSTRING(FULLY_QUALIFIED_LABEL, 2, 3) AS varchar(100))))) ELSE NULL END as timeframe_type from SF_RKLIVE_06012021.PERIOD
        
),calendar AS(
      select CLDR_DATE, CLDR_YEAR_START_DT as start_date,CLDR_YEAR_END_DT as end_date,year,'Year' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,cast(year as varchar(1000)) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR 
     union
     select CLDR_DATE, CLDR_MNTH_STRT_DT as start_date,CLDR_MNTH_END_DT as end_date,year,'Month' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(MONTH_NAME) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
    union
     select CLDR_DATE,WEEK_START_DATE as start_date,WEEK_END_DATE as end_date,year,'Week'as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,CONCAT('W',cast(CLDR_WEEK_NUM as varchar(1000))) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR
     union
     select CLDR_DATE,CLDR_QTR_STRT_DT as start_date,CLDR_QTR_END_DT as end_date,year,'Quarter' as type,MONTH_NAME,CLDR_WEEK_NUM,CLDR_QTR,UPPER(CLDR_QTR) as timeframe_type from DBT_SALESDATAFLO.DIM_CALENDAR

),r_metric AS (
    --- SF  oppor_won-1
       select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='true'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
         --and to_date(close_date) between '2017-01-01' and '2021-03-31'
        group by 4,5,6,7

         union   --Oppor loss -10
        select 
            count(source_id) as r_count,
            sum(OPPORTUNITY.AMOUNT) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Opportunity as OPPORTUNITY,PERIOD  
        where OPPORTUNITY.IS_WON='false'
         and OPPORTUNITY.IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(close_date) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --converted_leads-3
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            3 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'TRUE'
         and timeframe_type is not null
         and to_date(CONVERTED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       union --new leads -4
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            4 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Lead,PERIOD  
        where UPPER(IS_CONVERTED) = 'FALSE'
         and upper(status)='NEW'
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --accounts -27
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            27 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Account,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

        union --contact -29
        select 
            count(source_id) as r_count,
            0 AS r_amount,
            29 AS r_metric_id,
            Source_type as r_Source_type, 
            PERIOD.TYPE as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Contact,PERIOD  
        where 1=1
         and timeframe_type is not null
         and to_date(CREATED_DATE) between PERIOD.start_date and PERIOD.end_date
        group by 4,5,6,7

       --HS
        union   --deal won -1 PROPERTY_HS_CREATEDATE
        select
           
            count(Source_DEAL_ID) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            1 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year 
        from DBT_SALESDATAFLO.Stg_Deal deal inner join calendar on to_date(PROPERTY_CLOSEDATE)=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%WON%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7
       
        union   -- Deal Los -10
        select
           
            COALESCE(count(Source_DEAL_ID),0) as r_count,
            COALESCE(sum(PROPERTY_AMOUNT),0) AS r_amount,
            10 AS r_metric_id,
            Source_type as r_Source_type,
            type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Deal deal  inner join calendar on deal.PROPERTY_CLOSEDATE=CLDR_DATE
         where Upper(DEAL_PIPELINE_STAGE_ID) like '%CLOSED%LOS%' 
         and PROPERTY_HS_IS_CLOSED='true'
         and timeframe_type is not null
         and to_date(PROPERTY_CLOSEDATE) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

      union -- calls -39
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            39 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='CALL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7

    union -- Task completed -89
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            89 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='TASK'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7     

    union -- (Marketing MEETING) -71
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            71 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='MEETING'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7      

    union -- (Notes) -76
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            76 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='NOTE'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7       

    union -- (Emails Logged) -66
        select
           
            count(Source_ID) as r_count,
            0 AS r_amount,
            66 AS r_metric_id,
            Source_type as r_Source_type,
            calendar.type as r_type,
            timeframe_type as r_timeframe_type,
            year as r_year
        from DBT_SALESDATAFLO.Stg_Engagement eng inner join calendar on to_date(CREATED_AT)=CLDR_DATE
         where Upper(eng.TYPE) ='EMAIL'
         and timeframe_type is not null
         and to_date(CREATED_AT) between calendar.start_date and calendar.end_date 
         group by 4,5,6,7            








),fs AS(
    select sum(count) as f_count,
    sum(amount)as f_amount,cast(entity_id as varchar(1000)) as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    cast(tmf.year as varchar(1000)) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME tmf
    where 
        TIMEFRAME_TYPE='Y'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.year_end
        and Yearend_flag='TRUE'
    group by 3,4,5,6,7
 union
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,
    UPPER(MONTH_NAME) as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='M'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.MONTH_END
        and MONTHEND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.QUTR_NUMBER as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='Q'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.QUARTER_END
        and QUARTEREND_FLAG='TRUE'
    group by 3,4,5,6,7

  union 
  
    select sum(count) as f_count,sum(amount)as f_amount,entity_id as f_entity_id ,metric_id as f_metric_id,tmf.year as f_year,timeframe_type as f_timeframe_type,tmf.WEEK_NUM as f_types_timeframe from DBT_SALESDATAFLO.FACT_SALES as sf,DBT_SALESDATAFLO.DIM_TIMEFRAME  tmf
    where 
        TIMEFRAME_TYPE='W'
        and sf.entity_id = tmf.source_type
        and REPORT_DATE=tmf.WEEK_END
        and WEEKEND_FLAG='TRUE'
    group by 3,4,5,6,7  
   

), compare_result AS(
    select 
    r_count,
    f_count,
    r_amount,
    f_amount,
    r_metric_id,
    f_metric_id,
    r_Source_type,
    f_entity_id,
    r_type,
    f_timeframe_type,
    r_timeframe_type,
    f_types_timeframe,
    r_year,
    f_year,
    CASE
            WHEN r_count <> f_count THEN 'YES'
            WHEN r_amount <> f_amount THEN 'YES'
            WHEN r_metric_id <> f_metric_id THEN 'YES'
            WHEN r_Source_type <> f_entity_id THEN 'YES'
            WHEN case when r_type='Year' then 'Y' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Month' then 'M' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Quarter' then 'Q' else null end <> f_timeframe_type THEN 'YES'
            WHEN case when r_type='Week' then 'W' else null end <> f_timeframe_type THEN 'YES' --Month,Year,Quarter,Week
            WHEN r_timeframe_type <> f_types_timeframe THEN 'YES'
            WHEN r_year <> f_year THEN 'YES'
            ELSE 'NO'
            END as value_mismatch

    from r_metric ,fs where r_metric.r_metric_id=fs.f_metric_id 
    --and case when r_type='Year' then cast('Y' as varchar(100)) else null end = cast(f_timeframe_type as varchar(1000)) ='Y'
    and SUBSTRING(CAST(r_type AS varchar(1100)),1,1) = f_timeframe_type
    and TRIM(r_timeframe_type)= TRIM(f_types_timeframe)
    and r_year=f_year
    and r_Source_type=f_entity_id


)

select * from compare_result  where 1=1
--r_timeframe_type='W'
  and r_metric_id=1
 and r_type='Year'
limit 500
/* limit added automatically by dbt cloud */
2021-05-19 02:13:24.862510 (Thread-1): Opening a new connection, currently in state init
2021-05-19 02:13:25.273476 (Thread-8): handling poll request
2021-05-19 02:13:25.273926 (Thread-8): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70675244c0>]}
2021-05-19 02:13:25.277761 (Thread-8): sending response (<Response 16808 bytes [200 OK]>) to 10.0.11.26
2021-05-19 02:13:26.772008 (Thread-9): handling poll request
2021-05-19 02:13:26.772458 (Thread-9): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f7067524be0>]}
2021-05-19 02:13:26.773466 (Thread-9): sending response (<Response 393 bytes [200 OK]>) to 10.0.11.26
2021-05-19 02:13:28.283282 (Thread-10): handling poll request
2021-05-19 02:13:28.283717 (Thread-10): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f7067524af0>]}
2021-05-19 02:13:28.284670 (Thread-10): sending response (<Response 393 bytes [200 OK]>) to 10.0.37.250
2021-05-19 02:13:29.825418 (Thread-11): handling poll request
2021-05-19 02:13:29.825858 (Thread-11): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f7067524130>]}
2021-05-19 02:13:29.826719 (Thread-11): sending response (<Response 393 bytes [200 OK]>) to 10.0.28.30
2021-05-19 02:13:30.449018 (Thread-1): SQL status: SUCCESS 3 in 5.59 seconds
2021-05-19 02:13:30.450884 (Thread-1): finished collecting timing info
2021-05-19 02:13:30.451270 (Thread-1): On rpc.DBTTest.request: Close
2021-05-19 02:13:31.279112 (Thread-12): handling poll request
2021-05-19 02:13:31.279544 (Thread-12): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70676ede20>]}
2021-05-19 02:13:31.284095 (Thread-12): sending response (<Response 73431 bytes [200 OK]>) to 10.0.16.22
2021-05-19 02:14:12.562315 (Thread-13): handling status request
2021-05-19 02:14:12.564045 (Thread-13): Sending event: {'category': 'dbt', 'action': 'rpc_request', 'label': 'f231e21f-8aab-4585-a20b-0a1d013ffef9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f706c3605b0>]}
2021-05-19 02:14:12.585795 (Thread-13): sending response (<Response 81715 bytes [200 OK]>) to 10.0.11.26
